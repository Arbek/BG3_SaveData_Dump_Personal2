Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_HasItemEvent(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a);
DB_GiveItemToEventWithClear(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, COL_KethericShowdown_State_GiveNetherstone_43fda06c-4deb-4e2e-955b-96fe9f3c759d);
SetOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, 0);
DB_GLO_DefeatCounter(S_COL_ShowdownNecromite_01_9499f6fb-6cd7-4e7e-a954-d4c7ffa0e6a4, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownNecromite_02_ceb7b3cb-8a7b-4cd0-b531-99fae0e67473, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownNecromite_03_c1db9cf0-4d8a-4e91-8611-3fd826b5e207, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownNecromite_04_bdf2c1a8-6438-454d-a957-4538b714b5fe, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownMindflayer_01_614345f7-8420-4d09-a233-744087eb0af7, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownIntDev_01_3ade155b-2ee8-41ba-9710-ca8e043ee5a1, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownIntDev_02_7460ee43-9fb9-47d4-ae1d-a09d75a85640, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownIntDev_03_9425d831-ef6e-4915-99b9-0a381f7435d2, "COL_KethericShowdown_KillCounter_Minion");
DB_GLO_DefeatCounter(S_COL_ShowdownIntDev_04_09ad9993-a279-4aa9-89cf-6d9b7a51ebad, "COL_KethericShowdown_KillCounter_Minion");
DB_COL_KethericShowdown_CurrentPhase(1);
DB_DeadEvent(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, GLO_Ketheric_State_Dead_668558ed-0052-0777-64f7-a8a197c40cc5);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_01_cb73c1b8-bd68-4fd1-9e8f-dc94d23f8dc3);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_02_93495963-1b9f-4c59-8231-fda3a1b59ceb);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(2);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(6);
PROC_TriggerRegisterForParty(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);
TriggerRegisterForCharacter(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TriggerRegisterForCharacter(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_TriggerRegisterForParty(S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6);
DB_Inclusion_NPCDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_Inclusion_NPCDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
DB_Inclusion_NPCDialog(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_AddCharactersInTriggerToDialog(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6, 1, 1, 1, 1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, 1, 1, 1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, 1, 1, 1);
DB_AddCharactersInTriggerToDialog(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, 1, 1, 1);
SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b, 0);
SetOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d, 0);
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 0);
AddPreferredAiTargetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, ACT2_MOO_KETHERIC_01d32285-432f-4430-a85b-c50ddf98d9d2);
AddPreferredAiTargetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, APOSTLE_OF_MYRKUL_7fb75b00-68b1-4217-874e-6ce1812d20e8);
DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_COL_ChosenThreeOverrides(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d);
DB_COL_ChosenThreeOverrides(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
DB_GLO_Cinematic_PositionedDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, "COL_KethericIntro");
DB_GLO_Cinematic_PositionFlags("COL_KethericIntro", S_COL_KethericShowdown_KethericIntro_Backside_Trigger_c48f3c83-0dd2-4651-a4bb-ccf1b6a5a0e4, COL_KethericShowdown_Event_KethericIntro_BacksideApproach_193a69b5-be17-435b-8174-9258ec67a87a);
PROC_TriggerRegisterForPlayers(S_COL_KethericShowdown_KethericIntro_Backside_Trigger_c48f3c83-0dd2-4651-a4bb-ccf1b6a5a0e4);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8, 0, "", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae, 0, "", 0, NULL_00000000-0000-0000-0000-000000000000);
DB_FlagReactionAfterDialog(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33, COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391);
PROC_TriggerRegisterForParty(S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb);
DB_GlobalFlagReactionAfterDialog(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d);
DB_GlobalFlagReactionAfterDialog(ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9, COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f);
DB_FlagReactionAfterDialog(COL_EntranceDoor_State_Open_437c3db8-2383-326c-37af-0ae96cb7fb71, COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391);
DB_COL_KethericShowdown_IntellectDevourers(S_COL_ShowdownIntDev_01_3ade155b-2ee8-41ba-9710-ca8e043ee5a1);
DB_COL_KethericShowdown_IntellectDevourers(S_COL_ShowdownIntDev_02_7460ee43-9fb9-47d4-ae1d-a09d75a85640);
DB_COL_KethericShowdown_IntellectDevourers(S_COL_ShowdownIntDev_03_9425d831-ef6e-4915-99b9-0a381f7435d2);
DB_COL_KethericShowdown_IntellectDevourers(S_COL_ShowdownIntDev_04_09ad9993-a279-4aa9-89cf-6d9b7a51ebad);
DB_COL_KethericShowdown_CineOnlyCharacters(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac);
DB_COL_KethericShowdown_CineOnlyCharacters(S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101);
DB_COL_KethericShowdown_CineOnlyCharacters(S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03);
DB_PartyDialogSuppressionZone(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);
PROC_COL_KethericShowdown_PreInit();

KBSECTION
IF
FlagSet(COL_KethericShowdown_Debug_Start_96d49abf-d7c7-e4c0-d699-f7d6045848f3, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_Debug_Start();
ClearFlag(COL_KethericShowdown_Debug_Start_96d49abf-d7c7-e4c0-d699-f7d6045848f3);

IF
TextEvent("KethericShowdown_Start", _, _, _, _)
THEN
PROC_COL_KethericShowdown_Debug_Start();

PROC
PROC_COL_KethericShowdown_Debug_Start()
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
PROC_TeleportPartiesTo(S_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155, "");
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

IF
TextEvent("KethericShowdown_ChosenThree", _, _, _, _)
THEN
NOT DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
PROC_TeleportPartiesTo(S_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155, "");

IF
TextEvent("KethericShowdown_FreeNightsong", _, _, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

IF
TextEvent("KethericShowdown_NightsongDowned", _, _, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(1);

IF
TextEvent("KethericShowdown_KillNightsong", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetHostCharacter(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_PreventPermaDefeated(S_SHA_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SHA_Nightsong_PermaKill(_Var1);
Die(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0);
TimerLaunch("COL_KethericShowdown_NightsongCheck", 1000);

IF
TimerFinished("COL_KethericShowdown_NightsongCheck", _, _, _, _)
THEN
PROC_COL_KethericShowdown_NightsongPresentCheck();

IF
TextEvent("KethericShowdown_IsobelPresent", _, _, _, _)
THEN
SetFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise");
TimerLaunch("COL_KethericShowdown_IsobelCheck", 1000);

IF
FlagSet(COL_KethericShowdown_Debug_AudienceRoute_e09091b7-25d9-9c24-409c-ef463acb966e, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_Debug_AudienceRoute();
ClearFlag(COL_KethericShowdown_Debug_AudienceRoute_e09091b7-25d9-9c24-409c-ef463acb966e);

IF
TextEvent("KethericShowdown_AudienceRoute", _, _, _, _)
THEN
PROC_COL_KethericShowdown_Debug_AudienceRoute();

IF
TimerFinished("COL_KethericShowdown_IsobelCheck", _, _, _, _)
THEN
PROC_COL_KethericShowdown_IsobelPresentCheck();

IF
FlagSet(COL_KethericShowdown_Debug_AssaultRoute_b30dbb8d-122f-2553-dedb-1691f455c4d5, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_Debug_AssaultRoute();
ClearFlag(COL_KethericShowdown_Debug_AssaultRoute_b30dbb8d-122f-2553-dedb-1691f455c4d5);

IF
TextEvent("KethericShowdown_AssaultRoute", _, _, _, _)
THEN
PROC_COL_KethericShowdown_Debug_AssaultRoute();

PROC
PROC_COL_KethericShowdown_Debug_AudienceRoute()
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_COL_KethericShowdown_Debug_AudienceRoute()
THEN
SetFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
SetFlag(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45);
ClearFlag(MOO_Assault_State_ConvincedKetheric_dffdf447-f3d6-32ad-2bbb-8f87402fef74);
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise");
TimerLaunch("COL_KethericShowdown_IsobelCheck", 1000);

PROC
PROC_COL_KethericShowdown_Debug_AssaultRoute()
AND
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_COL_KethericShowdown_Debug_AssaultRoute()
THEN
ClearFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce);
ClearFlag(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45);
SetFlag(MOO_Assault_State_ConvincedKetheric_dffdf447-f3d6-32ad-2bbb-8f87402fef74);
PROC_COL_KethericShowdown_Init();

IF
FlagSet(COL_KethericShowdown_Debug_Transform_c1e2755b-3ce0-cbf9-3a08-74c00d342b2b, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_Debug_Transform();
ClearFlag(COL_KethericShowdown_Debug_Transform_c1e2755b-3ce0-cbf9-3a08-74c00d342b2b);

IF
TextEvent("KethericShowdown_Transform", _, _, _, _)
THEN
PROC_COL_KethericShowdown_Debug_Transform();

PROC
PROC_COL_KethericShowdown_Debug_Transform()
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

PROC
PROC_COL_KethericShowdown_Debug_Transform()
THEN
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_COL_KethericShowdown_SetPhase(1);
TimerLaunch("COL_KethericShowdown_Transform", 2000);
PROC_TeleportPartiesTo(S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2, "");

IF
TimerFinished("COL_KethericShowdown_Transform", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ForceStopDialog(_Var1);

IF
TimerFinished("COL_KethericShowdown_Transform", _, _, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);
PROC_ForceStopDialog(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
SetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);

IF
TextEvent("KethericShowdown_Phase2", _, _, _, _)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_PHASE3_NECROMITE_HELPER");
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut");

IF
TextEvent("KethericShowdown_Phase3", _, _, _, _)
THEN
PROC_COL_KethericShowdown_EnterPhase_3();

IF
FlagSet(COL_KethericShowdown_Debug_Defeat_5d42b035-661c-c1e4-7668-3230745c2894, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_Debug_Defeat();
ClearFlag(COL_KethericShowdown_Debug_Defeat_5d42b035-661c-c1e4-7668-3230745c2894);

IF
TextEvent("KethericShowdown_Defeat", _, _, _, _)
THEN
PROC_COL_KethericShowdown_Debug_Defeat();

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
DB_GLO_DefeatCounter(_Var1, "COL_KethericShowdown_KillCounter_Minion", _Var1, _Var1, _Var1)
THEN
Die(_Var1, 0, 1);

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
GetEquippedItem(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Breast", _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_KethericArmor(_Var1);
TeleportTo(_Var1, S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8, "", 0, 0, 0, 0, 1);
SetOnStage(_Var1, 0);

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND
IsDead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0, _, _, _)
THEN
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "INVULNERABLE_NOT_SHOWN");
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "PARALYZED");
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "STUNNED");
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
SetFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_TeleportPartiesTo(S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2, "");

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();
PROC_COL_KethericShowdown_Init();

PROC
PROC_COL_KethericShowdown_Debug_Defeat()
THEN
DB_OnlyOnce("COL_KethericShowdown_ChosenThree");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE");
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0);
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);
PROC_COL_KethericShowdown_SetPhase(3);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", -1, 1);
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 1);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_ShowdownKethericPhase3_Pos_6ec38505-b588-4ea0-8b33-8deec08c2eff);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_PHASE3_NECROMITE_HELPER", -1, 1);
TimerLaunch("COL_KethericShowdown_Defeat", 1000);

IF
TimerFinished("COL_KethericShowdown_Defeat", _, _, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1, 1);

PROC
PROC_COL_KethericShowdown_SetPhase(_, _, _, _, _)
AND
DB_COL_KethericShowdown_CurrentPhase(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_CurrentPhase(_Var2);

PROC
PROC_COL_KethericShowdown_SetPhase((INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
DB_COL_KethericShowdown_CurrentPhase(_Var1);

PROC
PROC_COL_KethericShowdown_CueCinematic((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
DB_InRegion(_Var2, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_FadeEvents(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
SetEntityEventReal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "GLO_CombatWait", 4);
ScreenFadeTo(_Var2, 2, 0, _Var1);
TimerCancel(_Var1);
TimerLaunch(_Var1, 2000);
DB_COL_KethericShowdown_FadeEvents(_Var2, _Var1);

IF
ScreenFadeDone(_, (STRING)_Var2, _, _, _)
AND
DB_COL_KethericShowdown_FadeEvents(_Var3, _Var2, _, _, _)
THEN
ClearScreenFade(_Var3, 2, _Var2);
SetEntityEvent(_Var3, _Var2);

IF
EntityEvent((GUIDSTRING)_Var1, (STRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_FadeEvents(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_FadeEvents(_Var1, _Var2);

IF
FlagSet(COL_NecromancerLab_Knows_KethericLocation_fccb0429-b0dd-670a-659a-3584fbb5ab22, _, _, _, _)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_Knows_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad, _, _, _, _)
THEN
SetFlag(COL_KethericShowdown_Knows_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad);

IF
FlagSet(COL_KethericShowdown_State_ToldKethericLocation_73c66afd-6ffa-a08c-0230-71cfd7513aad, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
AND
DB_Players(_Var3, _, _, _, _)
THEN
PROC_ShowMarker(_Var3, "COL_KethericShowdown_EntranceDoor");

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_HideMarker(_Var1, "COL_KethericShowdown_EntranceDoor");

PROC
PROC_COL_KethericShowdown_PreInit()
AND
DB_COL_KethericShowdown_CineOnlyCharacters(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetImmortal(_Var1, 1);

PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03);
PROC_GlobalSetFlagAndCache(HAV_Siege_State_NoMoreSiege_2129857a-bfa2-49c4-a853-c7e08a2fa632);
PROC_COL_KethericShowdown_IsobelPresentCheck();
PROC_COL_KethericShowdown_NightsongPresentCheck();

PROC
PROC_COL_KethericShowdown_Init()
AND
GetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_KethericHealth(_Var1);

PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_CharacterFullRestore(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
RealtimeObjectTimerLaunch(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "COL_KethericShowdown_RememberHealth", 1000);

IF
ObjectTimerFinished(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "COL_KethericShowdown_RememberHealth", _, _, _)
AND NOT
QRY_COL_KethericShowdown_RememberedKethericHealth_IsInvulnerable()
THEN
PROC_COL_KethericShowdown_SetRememberedKethericHealth();

QRY
QRY_COL_KethericShowdown_RememberedKethericHealth_IsInvulnerable()
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", 1, _, _)
THEN
DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1);
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", _, _, _)
AND
DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1, _, _, _, _)
THEN
PROC_COL_KethericShowdown_SetRememberedKethericHealth();
NOT DB_COL_KethericShowdown_RememberedKethericHealth_HandleInvulnerability(1);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", -1, 1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_SetRememberedKethericHealth()
AND
DB_COL_KethericShowdown_KethericHealth(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 > 60
THEN
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1);
NOT DB_COL_KethericShowdown_KethericHealth(_Var1);

PROC
PROC_COL_KethericShowdown_SetRememberedKethericHealth()
AND
DB_COL_KethericShowdown_KethericHealth(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 < 60.00001
THEN
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 60);
NOT DB_COL_KethericShowdown_KethericHealth(_Var1);

PROC
PROC_COL_KethericShowdown_Init()
AND NOT
GetEquippedItem(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Melee Main Weapon", _, _, _)
AND
CreateAtObject(WPN_HUM_Flail_Myrkul_A_0_4c86f6ac-5829-41f2-a3f0-d3e893334961, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, 0, "", 0, _Var2, _, _, _)
THEN
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var2, 1, 0, 1);

PROC
PROC_COL_KethericShowdown_Init()
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_SetOnStage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1);
SetFaction(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd);
SetCanJoinCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1);
PROC_SetCanFight(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1);
ToInventory(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
ClearTag(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, ACT2_MOO_KETHERIC_BLOCKCOMMAND_e97caba7-e96d-46d6-a1ac-01bade846aeb);
SetAiHint(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, AI_HINT_UNIQUE_1902723d-dd16-4e7a-87d6-7b07f63add79);
SetStayInAiHints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1);
PROC_COL_KethericShowdown_SetSpotting(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_Showdown_KethericInitial_Pos_320a0b2e-5bd4-49ca-aed9-2f2e88fde2c4);
SetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "775a7162-7b0d-aa73-4d6d-3fd0a1cdecc7");
PROC_SceneOver("MOO_Execution");

PROC
PROC_CharacterRegisterCrime_Success(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _, _, _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
THEN
DB_CRIME_InvestigationNoWalkingTalking(1);

PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE");

PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND NOT
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", 1, _, _)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_NightsongPresentCheck()
AND NOT
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
PROC_SetRelationToPlayers(ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
PROC_SetHitpointsPercentageMinimum(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 50);
SetForceUpdate(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
PROC_SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "MOO_NIGHTSONG_MOONBEAM", NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_COL_Showdown_NightsongInitial_Pos_a86ed251-ef22-4bab-8e64-97d13425eb55);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);
SetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol");
PROC_COL_KethericShowdown_SetNightsongCaged(1);

PROC
PROC_COL_KethericShowdown_IsobelPresentCheck()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
DB_Dead(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
SetTag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140);

PROC
PROC_COL_KethericShowdown_IsobelPresentCheck()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
THEN
PROC_CharacterFullRestore(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_RemoveAllDialogEntriesForSpeaker(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
PROC_SetOnStage(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);
SetCanJoinCombat(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 1);
RemoveStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_ISOBEL_MOONRITUAL", NULL_00000000-0000-0000-0000-000000000000);
TeleportTo(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_COL_KethericShowdown_Isobel_Point_c5737105-0262-4323-911c-8954bc86888a);
SetFaction(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd);
PROC_COL_KethericShowdown_SetSpotting(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211);
SetCombatGroupID(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "775a7162-7b0d-aa73-4d6d-3fd0a1cdecc7");
SetTag(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, ILLITHID_1eec74e8-3673-4500-abec-57b7ed8469ed);
ApplyStatus(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "COL_ISOBEL_ENEMY_VFX", -1, 0, NULL_00000000-0000-0000-0000-000000000000);

IF
Dying(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
AND
DB_InRegion(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _, _, _)
THEN
SetFlag(COL_KethericShowdown_State_IsobelDiedInCOL_59810510-848e-46f3-2a7f-3f490407d954);

PROC
PROC_COL_KethericShowdown_Init()
AND
DB_GLO_DefeatCounter(_Var1, "COL_KethericShowdown_KillCounter_Minion", _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_SetSpotting(_Var1);

PROC
PROC_COL_KethericShowdown_SetSpotting((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_SpotPlayers(_Var1, "COL_KethericShowdown", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_IncludeWildshapedPlayers(_Var1, "COL_KethericShowdown");
DB_SpotPlayers_IncludeSummons(_Var1, "COL_KethericShowdown");

PROC
PROC_COL_KethericShowdown_StopSpotting()
AND
DB_SpotPlayers(_Var1, "COL_KethericShowdown", _, _, _Var1)
THEN
NOT DB_SpotPlayers(_Var1, "COL_KethericShowdown", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_SpotPlayers_IncludeWildshapedPlayers(_Var1, "COL_KethericShowdown");
NOT DB_SpotPlayers_IncludeSummons(_Var1, "COL_KethericShowdown");

IF
UseFinished((CHARACTER)_Var1, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, 1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
QRY_KethericShowdown_DoReadyCheck(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
OpenMessageBox(_Var1, "ReadyCheck_PartyMemberNotReady");

IF
UseFinished((CHARACTER)_Var1, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, 1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_StartEntry(_Var1);

IF
UseFinished((GUIDSTRING)_Var1, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, 1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_Entrance_CanInteract(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
TimerLaunch("COL_TadpoleDoors_Interaction", 50);
DB_COL_TadpoleDoors_Interaction(_Var1, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc);

QRY
QRY_COL_KethericShowdown_Entrance_CanInteract((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND NOT
QRY_KethericShowdown_DoReadyCheck(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_Entrance_CanInteract((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
TimerFinished("COL_TadpoleDoors_Interaction", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_TadpoleDoors_Interaction(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, _Var2, _Var1, _Var1, _Var1)
THEN
DB_COL_Entrance_Speaker(_Var1);
NOT DB_COL_TadpoleDoors_Interaction(_Var1, _Var2);

IF
DialogStarted(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, _, _, _, _)
AND
DB_COL_Entrance_Speaker(_Var2, _, _, _, _)
THEN
NOT DB_COL_Entrance_Speaker(_Var2);

PROC
PROC_DialogFlagSetup(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb, _Var1, _Var1, _Var1)
THEN
SetFlag(COL_EntranceDoor_State_Inside_c84cd9d6-c62f-87f3-e644-9d2c99c7ab64, _Var1, 1);

PROC
PROC_DialogFlagSetup(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_InRegion(_Var1, S_COL_KethericShowdown_Door_InsideTrigger_f15f508f-d81e-4903-ad1d-9cc96ef952bb, _Var1, _Var1, _Var1)
THEN
ClearFlag(COL_EntranceDoor_State_Inside_c84cd9d6-c62f-87f3-e644-9d2c99c7ab64, _Var1, 1);

IF
DialogEnded(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33, _Var2, 0, _Var1, _Var1)
THEN
ClearScreenFade(_Var2, 1, "COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391", 1);

IF
DialogEnded(COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33, _Var2, 1, _Var1, _Var1)
THEN
ClearFlag(COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33, _Var2);

PROC
PROC_FlagReactionAfterDialog(S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, COL_EntranceDoor_State_Open_437c3db8-2383-326c-37af-0ae96cb7fb71, _, _, _)
THEN
SetOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d, 1);
Unlock(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d);
Open(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d);
SetCanInteract(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d, 0);

IF
WentOnStage(S_COL_KethericShowdown_Door_Unlocked_596a0957-ac17-4f6d-8a90-de2c2483a79d, 1, _, _, _)
THEN
SetOnStage(S_COL_KethericShowdown_Door_378bd363-b818-4326-9883-d5a9cd5a1fcc, 0);

PROC
PROC_FlagReactionAfterDialog((GUIDSTRING)_Var1, COL_KethericShowdown_Event_Entry_489d4c55-be3c-fa14-2418-fa145dbd6f33, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_COL_KethericShowdown_StartEntry(_Var1);
DB_COL_KethericShowdown_EntryInitiator(_Var1);

PROC
PROC_COL_KethericShowdown_StartEntry((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_InRegion(_Var2, S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_FadeEntry(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
RealtimeObjectTimerLaunch(_Var2, "COL_KethericShowdown_Entrance", 1000);
DB_COL_KethericShowdown_FadeEntry(_Var2);

QRY
QRY_KethericShowdown_DoReadyCheck((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 != _Var1
AND
DB_CantTalk_IgnoreStatusesDead(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "COL_KethericShowdown_Entrance", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_FadeEntry(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
RealtimeObjectTimerLaunch(_Var1, "COL_KethericShowdown_Entrance_FadeIn", 5000);
PROC_COL_KethericShowdown_TeleportPlayerToEntrance(_Var1);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "COL_KethericShowdown_Entrance_FadeIn", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearScreenFade(_Var1, 2, "COL_EntranceDoor_a7ad5aaa-fd26-0ca3-0b4d-61654fd06391", 1);
NOT DB_COL_KethericShowdown_FadeEntry(_Var1);

PROC
PROC_COL_KethericShowdown_TeleportPlayerToEntrance((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_ReadyTrigger_873b22c0-98b0-455c-95f0-b85ef6dcf1b6, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, S_DEBUG_COL_ShowdownStartPoint_cd12947b-cd64-4985-9dbb-b8dcb2cd2155, "", 1, 1, 1, 1, 1);

QRY
QRY_SpeakerIsInDialogRange(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _, _, _)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
DB_NOOP(1);

QRY
QRY_SpeakerIsInDialogRange(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
AND
DB_InRegion(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _, _, _)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_AnyPlayerInChamber()
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("COL_KethericShowdown_ChosenThree", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_EnteredChamber();

PROC
PROC_COL_KethericShowdown_EnteredChamber()
THEN
PROC_COL_KethericShowdown_Init();

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND NOT
DB_COL_KethericShowdown_EntryInitiator(_, _, _, _, _)
AND
QRY_GetClosestAvailableCharacterTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _, _, _)
AND
DB_ClosestAvailableCharacterTo_PreferAvatar(_Var2, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, 1, _)
AND NOT
DB_COL_KethericShowdown_EntryInitiator(_, _, _, _, _)
THEN
DB_COL_KethericShowdown_EntryInitiator(_Var2);

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND NOT
DB_COL_KethericShowdown_EntryInitiator(_, _, _, _, _)
AND
DB_ClosestAvailableCharacterTo(_Var2, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _)
AND NOT
DB_COL_KethericShowdown_EntryInitiator(_, _, _, _, _)
THEN
DB_COL_KethericShowdown_EntryInitiator(_Var2);

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND
DB_COL_KethericShowdown_EntryInitiator(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_EntryInitiatorOverride(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_StartDialogCustom(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, S_GLO_Orin_bf24e0ec-a3a6-4905-bd2d-45dc8edf8101, S_COL_ElderBrain_f0747a7b-1ed8-479a-bf44-a809de84364e, S_GLO_Ravengard_f6620372-ebd0-4511-a39d-8c2d4ad03f03, _Var2, 0, 0, 0, 0, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

PROC
PROC_COL_KethericShowdown_EnteredChamber()
AND NOT
DB_COL_KethericShowdown_EntryInitiator(_, _, _, _, _)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

PROC
PROC_StartDialog_AddExtraSpeakers(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_PartyMembers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var2, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, _Var2, 0, 1);
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar(_Var2, _Var1);

IF
DB_DialogName(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_DialogEnding(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _Var1, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, _Var2, 1, 0);

PROC
PROC_DialogAddSpeakingActor((INTEGER)_Var1, (GUIDSTRING)_Var2, _, _, (INTEGER)_Var1)
AND
DB_DialogName(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2);

IF
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var1);

IF
DialogActorJoinFailed(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _, (GUIDSTRING)_Var2, _, _)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2);

IF
DialogActorLeft(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _, (GUIDSTRING)_Var2, _, _)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2);

IF
DialogEnded(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _, _, _, _)
AND
DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_ChosenThree_PartyMemberSpeakers(_Var2);

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((GUIDSTRING)_Var1, (INTEGER)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Var1, 0);

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((GUIDSTRING)_Var1, (INTEGER)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_DialogRequestCache_SpeakerList_Players(_, _Var2, _Var4, 1, _Var1)
AND
DB_Avatars(_Var4, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var1, _Var4, _Var1, _Var1, _Var1)
THEN
SetFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Var1, 0);

PROC
PROC_COL_KethericShowdown_ChosenThree_CheckIfLinkedToAvatar((CHARACTER)_Var1, (INTEGER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_DialogPlayers(_Var2, _Var3, 1, _Var1, _Var1)
AND
DB_Avatars(_Var3, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var1, _Var3, _Var1, _Var1, _Var1)
THEN
SetFlag(COL_KethericShowdown_State_ControlledByActiveSpeakerAvatar_668e06c3-f61a-a58b-b31e-e7cbcb07883d, _Var1, 0);

PROC
PROC_GlobalFlagReactionAfterDialog(ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9, _, _, _, _)
THEN
DB_COL_KethericShowdown_GaleExplosionCredits(1);
PROC_StartMovie("Credits");

IF
CreditsEnded()
AND
DB_COL_KethericShowdown_GaleExplosionCredits(1, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_GaleExplosionCredits(1);
PROC_GameEndWithMovie("");

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_KethericShowdown_EntryInitiator(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_MizorasRescue_PlayerEnteredShowdown(_Var1);
NOT DB_COL_KethericShowdown_EntryInitiator(_Var1);

IF
DialogEnded(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_COL_KethericShowdown_ChosenThree_CleanUp();

PROC
PROC_COL_KethericShowdown_ChosenThree_CleanUp()
AND
DB_COL_KethericShowdown_CineOnlyCharacters(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetOnStage(_Var1, 0);
PROC_COL_KethericShowdown_CleanUpCineCharacter(_Var1);

IF
LeftLevel((CHARACTER)_Var1, "SCL_Main_A", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_KethericShowdown_CineOnlyCharacters(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_CleanUpCineCharacter(_Var1);

PROC
PROC_COL_KethericShowdown_CleanUpCineCharacter((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
SetImmortal(_Var1, 0);
NOT DB_COL_KethericShowdown_CineOnlyCharacters(_Var1);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride(_, _, _, _, _)
AND
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var2, _, _, _, _)
THEN
NOT DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var2);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_ChosenThreeOverrides(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var1);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_ChosenThreeOverrides(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var2, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var2);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_ChosenThreeOverrides(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var2, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var2);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_ChosenThreeOverrides(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_GetBestAvatarForCompanion(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_GetBestAvatarForCompanion(_Var2, _Var4, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var4, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var4, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var4);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_ChosenThreeOverrides(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(_Var3, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var3, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, 1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var3);

QRY
QRY_COL_KethericShowdown_EntryInitiatorOverride((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_KethericShowdown_EntryInitiatorOverride(_Var1);

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(COL_MizorasRescue_State_SavedMizora_148bcec2-5367-2b72-3c93-29fb32fc0181, _Var1, _Var1, _Var1, _Var1)
AND
DB_PartOfTheTeam(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_MizoraRescue_StartWyllDeath(_Var1);

PROC
PROC_COL_MizoraRescue_StartWyllDeath(_, (CHARACTER)_, (CHARACTER)_, (CHARACTER)_, (CHARACTER)_)
THEN
DB_COL_MizoraRescue_WyllDeath(1);
PROC_ClearOriginMoment(COL_MizorasRescue_OM_Wyll_COM_AOM_OOM_a988e571-00eb-904b-f8f5-0d767dd1aacb);
RealtimeObjectTimerLaunch(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "COL_MizoraRescue_WyllDeath_FadeTimeout", 2000);

PROC
PROC_COL_MizoraRescue_StartWyllDeath((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_StartDialog(COL_WyllDeath_cc3747c9-7160-cb21-fb1b-a578192d2c3b, S_COL_TadpoleChamber_Thralls_Pod_003_b051e95c-8a5d-4cf3-badd-5c9112cb5739, S_GLO_Wyll_Cambion_491a7686-3081-405b-983c-289ec8781e0a, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown(_, _, _, _, _)
AND NOT
DB_COL_MizoraRescue_WyllDeath(1, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_Event_ColonyExplosion_7ff2626a-c1ff-829a-8bcf-90d763e8b2e9, _, _, _, _)
AND
DB_Players(_Var2, _, _, _, _)
THEN
ClearScreenFade(_Var2, 1, "COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f", 1);

IF
ObjectTimerFinished(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "COL_MizoraRescue_WyllDeath_FadeTimeout", (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _, _Var1, _Var1)
AND
DB_Players(_Var3, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_DialogPlayers(_Var1, _Var3, _, _Var1, _Var1)
THEN
ClearScreenFade(_Var3, 1, "COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f", 1);

IF
ObjectTimerFinished(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, "COL_MizoraRescue_WyllDeath_FadeTimeout", _, _, _)
AND NOT
DB_DialogPlayers(_, S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, _, _, _)
AND
DB_Players(_Var3, _, _, _, _)
THEN
ClearScreenFade(_Var3, 1, "COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f", 1);

PROC
PROC_COL_MizorasRescue_PlayerEnteredShowdown(_, _, _, _, _)
AND
DB_COL_MizoraRescue_WyllDeath(1, _, _, _, _)
THEN
NOT DB_COL_MizoraRescue_WyllDeath(1);

PROC
PROC_SpotPlayers_Spotted((GUIDSTRING)_Var1, "COL_KethericShowdown", (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_COL_KethericShowdown_PrimarySpeaker(_, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, 1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Var2);
DB_COL_KethericShowdown_CheckKethericIntroTrigger(1);
PROC_COL_KethericShowdown_StopSpotting();

IF
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_, _, _, _, _)
AND
QRY_COL_KethericShowdown_NotPastPhase1()
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_, _, _, _, _)
THEN
DB_COL_KethericShowdown_CheckKethericIntroTrigger(1);

IF
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _, _, _, _)
AND NOT
DB_DialogName(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _, _, _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_KethericIntro", _, _, _, _)
THEN
PROC_COL_KethericShowdown_TryStartIntroDialog(_Var2);

IF
DialogStarted(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _, _, _, _)
AND
DB_COL_KethericShowdown_CheckKethericIntroTrigger(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_CheckKethericIntroTrigger(_Var2);

IF
CombatRoundStarted((GUIDSTRING)_Var1, 1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_NotPastPhase1()
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_AnyPlayersInCombat(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_TryStartIntroDialog(_Var2);

IF
CombatRoundStarted((GUIDSTRING)_Var1, 1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_KethericIntro", _Var1, _Var1, _Var1, _Var1)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");

QRY
QRY_COL_KethericShowdown_NotPastPhase1()
AND NOT
DB_COL_KethericShowdown_CurrentPhase(_, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_NotPastPhase1()
AND
DB_COL_KethericShowdown_CurrentPhase(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 < 2
THEN
DB_NOOP(1);

PROC
PROC_COL_KethericShowdown_TryStartIntroDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
QRY_COL_KethericShowdown_KethericPhase1Defeated()
AND NOT
DB_OnlyOnce("COL_KethericShowdown_KethericIntro", _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, 0, 0, 0, 0, _Var1, _Var1, _Var1)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");

PROC
PROC_COL_KethericShowdown_TryStartIntroDialog(_, _, _, _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_KethericIntro", _, _, _, _)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro");
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_SetRelationToPlayers(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, 0);

IF
DialogEnded(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");

IF
DialogEnded(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
THEN
ClearScreenFade(_Var2, 1, "COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d", 1);

IF
DialogRequestFailed(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished");
PROC_SetRelationToPlayers(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, 0);

QRY
QRY_COL_KethericShowdown_AnyPlayersInCombat((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_PrimarySpeaker(_, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, 1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Var2);

QRY
QRY_COL_KethericShowdown_AnyPlayersInCombat((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_PrimarySpeaker(_, _, _, _, _)
AND
DB_DialogName(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _Var2, _, _, _)
AND
DB_DialogPlayers(_Var2, _Var3, _, _, _)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Var3);

PROC
PROC_GlobalFlagReactionAfterDialog(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _, _, _, _)
THEN
TimerLaunch("COL_KethericShowdown_Phase2_FadeOut", 0);
SetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);

IF
DialogEnded(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _, _, _, _)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Var2);

PROC
PROC_StartDialog_AddExtraSpeakers(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_Inclusion_NPCDialog(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _Var2, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var2, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, 1, 0, 0, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, _Var2);

PROC
PROC_COL_KethericShowdown_Init()
AND NOT
DB_COL_KethericShowdown_IntDevLeader(_, _, _, _, _)
THEN
PROC_COL_KethericShowdown_DetermineIntDevLeader();

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_IntDevLeader(_Var1);

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntellectDevourers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_IntDevLeader(_, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_CantMove(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_IntDevLeader(_Var1);

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_IntellectDevourers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 != _Var1
THEN
PROC_Follow(_Var2, _Var1);

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND
DB_COL_KethericShowdown_IntDevLeader(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_StopFollow(_Var1);

PROC
PROC_COL_KethericShowdown_DetermineIntDevLeader()
AND NOT
DB_COL_KethericShowdown_IntDevLeader(_, _, _, _, _)
AND
DB_COL_KethericShowdown_IntellectDevourers(_Var2, _, _, _, _)
THEN
PROC_StopFollow(_Var2);

IF
DB_CantMove(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_IntDevLeader(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Is_InCombat(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_DetermineIntDevLeader();

PROC
PROC_COL_KethericShowdown_Init()
THEN
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521, 3, "COL_KethericShowdown_AD_IsobelKilled", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18, 1, "COL_KethericShowdown_AD_NightsongApostle", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9, 5, "COL_KethericShowdown_AD_NightsongTransform", 0, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3, 6, "COL_KethericShowdown_AD_Phase3Transition", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_NightsongFreed_ab8246f1-5568-7e63-adb8-4deeb3f8f78b, 4, "COL_KethericShowdown_NightsongFreed", 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_NightsongFreed_Apostle_a53aec87-5053-30ec-d18c-dba146bc089b, 4, "COL_KethericShowdown_NightsongFreed", 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4, 2, "COL_KethericShowdown_AD_KethericInvulnerable", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, COL_KethericShowdown_AD_KethericInvulnerable_Apostle_dc07379c-81c8-14f1-fd40-f5ea309392a1, 2, "COL_KethericShowdown_AD_KethericInvulnerable", 2, NULL_00000000-0000-0000-0000-000000000000);
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8);
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae);
DB_COL_KethericShowdown_ADs_IgnoreCharmed(COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs(_Var1, _Var2, _Var3, _Var4, _Var5, _Var6, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ADs(_Var1, _Var2, _Var3, _Var4, _Var5, _Var6);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Var1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Var1);

PROC
PROC_COL_KethericShowdown_TryAD((DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
DB_COL_KethericShowdown_ADs(_Var2, _Var1, _, _Var4, _, _, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_Var4, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_TryPlayAD(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce("", _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
_Var1 != ""
AND
QRY_OnlyOnce(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_TryPlayAD((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var1, _Var2, _, _Var4, _Var5, NULL_00000000-0000-0000-0000-000000000000, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(_Var2, _Var1, 0, 0, 0, 0, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_ProcessWaitTime(_Var1, _Var5);

QRY
QRY_COL_KethericShowdown_TryPlayAD((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_COL_KethericShowdown_ADs_KethericApostleSpeakers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var1, _Var2, _, _Var4, _Var5, _Var6, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_Var6, _Var2, _Var1, _Var1, _Var1)
AND NOT
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(_Var2, _Var1, _Var6, 0, 0, 0, 0, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_ProcessWaitTime(_Var1, _Var5);
PROC_COL_KethericShowdown_ProcessWaitTime(_Var6, _Var5);

PROC
PROC_COL_KethericShowdown_ProcessWaitTime((GUIDSTRING)_Var1, (REAL)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
_Var2 > 0.00010
THEN
SetEntityEventReal(_Var1, "GLO_CombatWait", _Var2);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable(NULL_00000000-0000-0000-0000-000000000000, _, (DIALOGRESOURCE)_, (DIALOGRESOURCE)_, (DIALOGRESOURCE)_)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Var1, (DIALOGRESOURCE)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
HasActiveStatusWithGroup(_Var1, "SG_Charmed", 1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs_IgnoreCharmed(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
HasActiveStatus(_Var1, "COL_NIGHTSONG_SOULCAGE", 1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_ADs_SpeakerNotAvailable((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ADs_Playing(_Var1, _, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
DB_COL_KethericShowdown_ADs_Playing(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var1, _Var2, _, _Var4, _, _, _Var1, _Var1, _Var1, _Var1)
AND
_Var4 != ""
AND
QRY_OnlyOnce(_Var4, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
AutomatedDialogEnded((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ADs_Playing(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ADs_Playing(_Var3, _Var1);

PROC
PROC_COL_KethericShowdown_AD_SelectAD()
AND
DB_COL_KethericShowdown_ADs_Trying(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var2, _Var1, _, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ADs_Selected(_Var2, _, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ADs_Selected(_Var2, _Var1);

PROC
PROC_COL_KethericShowdown_AD_SelectAD()
AND
DB_COL_KethericShowdown_ADs_Trying(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var2, _Var1, _Var3, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs_Selected(_Var2, _Var7, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_Var2, _Var7, _Var8, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND
_Var3 > _Var8
THEN
NOT DB_COL_KethericShowdown_ADs_Selected(_Var2, _Var7);
DB_COL_KethericShowdown_ADs_Selected(_Var2, _Var1);

PROC
PROC_COL_KethericShowdown_AD_PlaySelectedAD()
AND
DB_COL_KethericShowdown_ADs_Selected(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_TryPlayAD(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ADs_Playing(_Var1, _Var2);
NOT DB_COL_KethericShowdown_ADs_Selected(_Var1, _Var2);

PROC
PROC_COL_KethericShowdown_AD_PlaySelectedAD()
AND
DB_COL_KethericShowdown_ADs_Trying(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ADs_Trying(_Var1);

IF
DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, _, _, _, _)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished", _, _, _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
THEN
RealtimeObjectTimerLaunch(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransform", 2000);

IF
ObjectTimerFinished(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransform", _, _, _)
AND NOT
DB_GlobalFlag(SHA_Nightsong_State_Dead_1ec7913b-d5ff-416c-9d11-06d4ae7b9456, _, _, _, _)
THEN
PROC_COL_KethericShowdown_DoNightsongTransform(0);

IF
CastedSpell(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Target_MOO_Ketheric_CommandTroops", _, _, _)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_KethericCommandTroops_3426bfa3-8900-a6fb-982a-f796562f56e8);

IF
UsingSpell(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Projectile_FingerOfDeath_Apostle", _, _, _)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_KethericFingerOfDeath_f9fdab91-a4c4-5b9e-1cf2-6ce5830149ae);

PROC
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished", _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_PAD_NightsongCaged", _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var2, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var1, 1, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(COL_KethericShowdown_PAD_NightsongCaged_4bfa0c3e-1a0d-1388-f229-37433e185905, _Var1, 0, 0, 0, 0, _Var1, _Var1, _Var1, _Var1)
THEN
DB_OnlyOnce("COL_KethericShowdown_PAD_NightsongCaged");

IF
AttackedBy(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, (CHARACTER)_Var2, _, _, _, _, _, _, _)
AND
DB_PartyMembers(_Var2, _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", 1, _, _)
AND
QRY_COL_KethericShowdown_ADs_SelectKethericDialog(COL_KethericShowdown_AD_KethericInvulnerable_24563361-f5fe-f8a4-c8ea-93888c13d2f4, COL_KethericShowdown_AD_KethericInvulnerable_Apostle_dc07379c-81c8-14f1-fd40-f5ea309392a1, _, _, _)
AND
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var7, _, _, _, _)
THEN
PROC_COL_KethericShowdown_TryAD(_Var7);
NOT DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var7);

IF
KilledBy(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, (GUIDSTRING)_)
THEN
DB_COL_KethericShowdown_KethericKilledIsobel(1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_KethericKilledIsobel(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_KethericKilledIsobel(_Var1);

PROC
PROC_COL_KethericShowdown_AD_Check_IsobelKilled()
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _, _)
AND
DB_Defeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_KethericKilledIsobel(1, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521, _, _, _, _)
AND
DB_COL_KethericShowdown_ADs(_, COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521, _, _Var3, _, _, _, _, _, _)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_Var3, _, _, _, _)
THEN
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_IsobelKilled_3f65db66-f4b4-0b3c-fd9c-f3647cd08521);

PROC
PROC_COL_KethericShowdown_AD_Check_Phase3Transition()
AND
DB_COL_KethericShowdown_CurrentPhase(3, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3, _, _, _, _)
AND
DB_COL_KethericShowdown_ADs(_, COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3, _, _Var3, _, _, _, _, _, _)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_Var3, _, _, _, _)
THEN
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_Phase3Transition_15c196f5-b6f3-4b9e-4237-c9c71d0c42e3);

IF
TurnStarted(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
THEN
PROC_COL_KethericShowdown_AD_Check_IsobelKilled();
PROC_COL_KethericShowdown_AD_Check_Phase3Transition();
PROC_COL_KethericShowdown_AD_SelectAD();
PROC_COL_KethericShowdown_AD_PlaySelectedAD();

PROC
PROC_COL_KethericShowdown_AD_Check_NightsongApostle()
AND
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1, _, _)
AND
DB_COL_KethericShowdown_ADs(_, COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18, _, _Var3, _, _, _, _, _, _)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_Var3, _, _, _, _)
THEN
DB_COL_KethericShowdown_ADs_Trying(COL_KethericShowdown_AD_NightsongApostle_c6aed62f-17f9-dd2f-ea7f-f4247b6d2a18);

PROC
PROC_COL_KethericShowdown_AD_Check_NightsongFreed()
AND
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
AND
QRY_COL_KethericShowdown_ADs_SelectKethericDialog(COL_KethericShowdown_AD_NightsongFreed_ab8246f1-5568-7e63-adb8-4deeb3f8f78b, COL_KethericShowdown_AD_NightsongFreed_Apostle_a53aec87-5053-30ec-d18c-dba146bc089b, _, _, _)
AND
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_ADs(_, _Var1, _, _Var4, _, _, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_ADs_CheckOnlyOnce(_Var4, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ADs_Trying(_Var1);
NOT DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var1);

IF
TurnStarted(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
THEN
PROC_COL_KethericShowdown_AD_Check_NightsongFreed();
PROC_COL_KethericShowdown_AD_Check_NightsongApostle();
PROC_COL_KethericShowdown_AD_SelectAD();
PROC_COL_KethericShowdown_AD_PlaySelectedAD();

QRY
QRY_COL_KethericShowdown_ADs_SelectKethericDialog(_, (GUIDSTRING)_Var2, _, _, _)
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1, _, _)
THEN
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var2);

QRY
QRY_COL_KethericShowdown_ADs_SelectKethericDialog((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _Var1, _Var1)
THEN
DB_QRY_RTN_COL_KethericShowdown_ADs_SelectedKethericDialog(_Var1);

IF
TurnStarted((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn(_Var1);

IF
DialogEnded(COL_KethericShowdown_KethericIntro_f36e8087-cc97-0ddd-3f2f-846f18b93e9d, _, _, _, _)
AND
DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Var2, _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _, _, _, _)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
THEN
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn(_Var2);

IF
TurnStarted((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(COL_KethericShowdown_State_Started_33489af3-23b7-4340-bbf6-19033c9dae03, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var2, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Var1);

IF
TurnEnded((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_PlayerHavingCombatTurn(_Var1);

PROC
PROC_COL_KethericShowdown_TryPlayerNightsongFirstTurn((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_OnlyOnce("COL_KethericShowdown_KethericIntro_Finished", _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var2, _Var1, _Var1, _Var1)
AND
CanShowSpellForCharacter(_Var1, "Target_Help", 1, _Var1, _Var1)
THEN
PROC_ShowUnifiedTutorialForPlayer(_Var1, Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

IF
FlagSet(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, _, _, _, _)
AND
DB_Players(_Var3, _, _, _, _)
THEN
HideTutorial(_Var3, Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
HideTutorial(_Var1, Helping_Downed_Characters__Nightsong__3a552454-f61f-4d02-aac5-6619699882f0);

IF
EnteredCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
THEN
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
PROC_EnterCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(0, _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_Defeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
QRY_OnlyOnce("COL_KethericShowdown_NightsongFreedInitial", _, _, _, _)
THEN
SetForceUpdate(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);
PROC_SetCanFight(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
SetCanJoinCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1);
PROC_SetRelationMutual(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 0);
PROC_SetRelationToPlayers(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, 0);
PROC_SetRelationToPlayers(ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4, 100);
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);

IF
StatusRemoved(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(0, _, _, _, _)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", 1, _, _)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(0, _, _, _, _)
THEN
MusicPlayGeneral("Music_KethericFight_NightsongFree");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE");
SetFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415);
ClearTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

IF
StatusApplied(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(1);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(1, _, _, _, _)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", 0, _, _)
THEN
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", -1, 1);

PROC
PROC_COL_KethericShowdown_SetNightsongCaged(1, _, _, _, _)
THEN
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_INVULNERABLE", -1);
ClearFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415);
SetTag(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, AI_IGNORED_TARGET_ff6d7d1f-094f-432e-a117-fdc3a0ab7ac1);

IF
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_Defeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0, _, _)
AND
GetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SetRelationToPlayers(_Var1, 100);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 6, 0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
TurnStarted(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_State_NightsongFreed_bfe9a480-01bd-0474-f461-d18734170415, _, _, _, _)
THEN
PROC_COL_KethericShowdown_DoNightsongTransform(1);

PROC
PROC_COL_KethericShowdown_DoNightsongTransform(0, _, _, _, _)
THEN
TimerLaunch("COL_KethericShowdown_NightsongTransform_DelayAD", 500);

IF
TimerFinished("COL_KethericShowdown_NightsongTransform_DelayAD", _, _, _, _)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9);
UseSpell(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Shout_MOO_Nightsong_RadiantConsumption", S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_COL_KethericShowdown_DoNightsongTransform(1, _, _, _, _)
THEN
UseSpell(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Shout_MOO_Nightsong_RadiantConsumption", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
UsingSpell(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Shout_MOO_Nightsong_RadiantConsumption", _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
THEN
PROC_COL_KethericShowdown_TryAD(COL_KethericShowdown_AD_NightsongTransform_29ec745e-0dd1-4883-28c4-a79d0aed8be9);

IF
CastSpellFailed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "Shout_MOO_Nightsong_RadiantConsumption", _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
THEN
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "MOO_NIGHTSONG_MOONBEAM", 60, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "MOO_NIGHTSONG_MOONBEAM", _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
THEN
SetEntityEventReal(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_CombatWait", 3);
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");

IF
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
AND
HasAppliedStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", 1, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

IF
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
THEN
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");

IF
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
AND NOT
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
THEN
PROC_Foop(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
Transform(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, Humans_Female_Strong_NightSong_9671ecbb-4030-48ff-b63e-f138e988835f, Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
RealtimeObjectTimerLaunch(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransformed_EquipWeapon", 2520);

IF
ObjectTimerFinished(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_KethericShowdown_NightsongTransformed_EquipWeapon", _, _, _)
THEN
PROC_GLO_Nightsong_GiveNightsongEquipment();

IF
TemplateAddedTo(WPN_HUM_Greatsword_A_1_1a2a58b7-4bd5-44d5-b1fe-8cd7e5b53def, (ITEM)_Var1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, (ITEM)_Var1)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _Var1, _Var1)
THEN
Equip(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1);

IF
TimerFinished("Nightsong_PostResurrection", _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
THEN
PROC_EnterCombat(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
RelationChanged(ACT2_COL_KethericShowdown_2762926d-2d97-4a9c-808f-1690f5f6a4dd, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, _, _)
AND
DB_COL_KethericShowdown_ForcePlayersEnterCombat(1, _, _, _, _)
AND
DB_Players(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_ForcePlayersEnterCombat(1);
RemoveStatus(_Var2, "SNEAKING", S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_EnterCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var2);

IF
DB_GLO_DefeatCounter(_Var1, "COL_KethericShowdown_KillCounter_Minion", _Var1, _Var1, _Var1)
THEN
AddPreferredAiTargetTag(_Var1, ACT2_MOO_KETHERIC_TAUNT_34ccbf00-621b-4cb2-a3e7-daef32df9146);

PROC
PROC_GLO_DefeatCounter_Notify("COL_KethericShowdown_KillCounter_Minion", _, _, 6, (INTEGER)_)
THEN
SetTag(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, ACT2_MOO_KETHERIC_BLOCKCOMMAND_e97caba7-e96d-46d6-a1ac-01bade846aeb);

IF
HitpointsChanged(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
QRY_COL_KethericShowdown_KethericPhase1Defeated()
AND NOT
DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _, _, _, _)
THEN
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut");

QRY
QRY_COL_KethericShowdown_KethericPhase1Defeated()
AND
DB_COL_KethericShowdown_CurrentPhase(1, _, _, _, _)
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Phase2_FadeOut", _, _, _, _)
THEN
MusicPlayGeneral("Music_KethericFight_Dead");

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_AnyPlayersInCombat(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_COL_KethericShowdown_TryApostleDialog(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut", _, _, _, _)
AND
DB_GlobalFlag(COL_KethericShowdown_Event_SkipToApostleForm_165700f3-c5cd-d34c-d335-9f5f736475a0, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_COL_KethericShowdown_TryApostleDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
DialogRequestFailed(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

QRY
QRY_COL_KethericShowdown_TryApostleDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8, S_GLO_Myrkul_9061c1d3-5965-4251-9c07-bcebe53d0660, _Var1, 0, 0, 0, 0, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Var1);
DB_COL_KethericShowdown_StartedApostleTransform(1);

IF
DB_COL_KethericShowdown_CurrentPhase(2, _, _, _, _)
AND NOT
DB_DialogName(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, _, _, _, _)
AND
QRY_OnlyOnce("Music_MyrkulFight_Start", _, _, _, _)
THEN
PROC_MusicPlayGeneral("Music_MyrkulFight_Start");

PROC
PROC_StartDialog_AddExtraSpeakers(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
DialogStarted(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _Var3, _Var1, _Var1)
AND
_Var3 > 1
THEN
DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Var2);

IF
DialogStarted(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, _, _, _, _)
AND
DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_, _, _, _, _)
AND
QRY_GetRandom("DB_COL_KethericShowdown_Apostle_RandomInclusionOptions", 1, "DB_COL_KethericShowdown_Apostle_SelectedInclusion", _, _)
AND
DB_COL_KethericShowdown_Apostle_SelectedInclusion(_Var3, _, _, _, _)
THEN
SetFlag(COL_KethericShowdown_Event_Apostle_Inclusion_Selected_b07324ee-a2d7-f560-26af-1c28e43f44eb, _Var3);

IF
DialogStarted(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, _, _, _, _)
AND
DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_Apostle_RandomInclusionOptions(_Var2);

IF
DialogEnded(COL_KethericShowdown_KethericApostle_2b57ce81-5951-6c63-c94b-3d310e58bff0, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_COL_KethericShowdown_Apostle_SelectedInclusion(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(COL_KethericShowdown_Event_Apostle_Inclusion_Selected_b07324ee-a2d7-f560-26af-1c28e43f44eb, _Var2);
NOT DB_COL_KethericShowdown_Apostle_SelectedInclusion(_Var2);

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut", _, _, _, _)
AND NOT
DB_COL_KethericShowdown_StartedApostleTransform(1, _, _, _, _)
AND NOT
DB_GlobalFlag(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2, _, _, _, _)
THEN
PROC_GlobalSetFlagAndCache(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2);

IF
TimerFinished("COL_KethericShowdown_Phase2_FadeOut", _, _, _, _)
AND
DB_COL_KethericShowdown_StartedApostleTransform(1, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_StartedApostleTransform(1);

IF
FlagSet(COL_KethericShowdown_Event_CueTransformation_18f20c1b-42b5-e406-eb99-ec09098f7ee2, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_COL_KethericShowdown_EnterPhase_2();

PROC
PROC_COL_KethericShowdown_EnterPhase_2()
AND
GetEquippedItem(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Breast", _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_KethericArmor(_Var1);
TeleportTo(_Var1, S_MOO_Ketheric_Transforming_5222b192-2ea3-4ecc-8434-79c9f28169f8, "", 0, 0, 0, 0, 1);
SetOnStage(_Var1, 0);
SetFlag(COL_KethericShowdown_State_IsApostleForm_e5560828-c855-befd-42d5-2413420ba6ce, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);

PROC
PROC_COL_KethericShowdown_EnterPhase_2()
AND
GetEquippedWeapon(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
THEN
Unequip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1);

PROC
PROC_COL_KethericShowdown_EnterPhase_2()
THEN
PROC_SetOnStage(S_COL_ShowdownApostleStandBox_5b08724c-e510-4b87-a7e8-42de9f0a909e, 0);
TimerLaunch("COL_KethericShowdown_Phase2_TransformFrameDelay", 250);

IF
TimerFinished("COL_KethericShowdown_Phase2_TransformFrameDelay", _, _, _, _)
THEN
RemoveHarmfulStatuses(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
SetImmortal(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);
SetHitpointsPercentage(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 100);
PROC_COL_KethericShowdown_SetPhase(2);
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 1);
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "AURA_OF_PROTECTION");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "AURA_OF_HATE");
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", -1, 1);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_ShowdownKethericPhase3_Pos_6ec38505-b588-4ea0-8b33-8deec08c2eff, "COL_ApostleTeleportFinished");

IF
EntityEvent(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "COL_ApostleTeleportFinished", _, _, _)
THEN
PROC_SetOnStage(S_COL_ShowdownApostleStandBox_5b08724c-e510-4b87-a7e8-42de9f0a909e, 1);
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 1);

IF
StatusApplied(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", _, _, (GUIDSTRING)_)
THEN
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32);

IF
StatusApplied(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", _, _, _)
AND
CheckRulesetModifierString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, "HARD", 1, _, _)
THEN
PROC_COL_KethericShowdown_SetHardMode(1);

IF
RulesetModifierChangedString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, _, "HARD", _, _)
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", 1, _, _)
THEN
PROC_COL_KethericShowdown_SetHardMode(1);

IF
RulesetModifierChangedString(SCRIPTED_COMBAT_MECHANICS_cac2d8bd-c197-4a84-9df1-f86f54ad4521, _, (STRING)_Var2, _, _)
AND
_Var2 != "HARD"
AND
HasActiveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", 1, _, _)
THEN
PROC_COL_KethericShowdown_SetHardMode(0);

PROC
PROC_COL_KethericShowdown_SetHardMode(_, _, _, _, _)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_Var2);

PROC
PROC_COL_KethericShowdown_SetHardMode(_, _, _, _, _)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_Var2);

PROC
PROC_COL_KethericShowdown_SetHardMode(0, _, _, _, _)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM_HARDCORE");
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "LEGENDARY_RESISTANCE_CROWD_CONTROL");
NOT DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_Hardcore_01_8d36cc0a-a0a9-46ca-83d0-65c33c74d1de);
NOT DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_Hardcore_02_593a1e49-d315-4eb4-b3b0-16ae45d68ecf);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(2);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(6);

PROC
PROC_COL_KethericShowdown_SetHardMode(1, _, _, _, _)
THEN
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM_HARDCORE", -1, 1);
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "LEGENDARY_RESISTANCE_CROWD_CONTROL", -1, 1);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_Hardcore_01_8d36cc0a-a0a9-46ca-83d0-65c33c74d1de);
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(S_COL_ShowdownDeathBloomSpawnBox_Hardcore_02_593a1e49-d315-4eb4-b3b0-16ae45d68ecf);
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(4);
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(8);

IF
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TriggerRegisterForParty(_Var1);

PROC
PROC_COL_KethericShowdown_DeathBloomSpawnTrigger_Remove((TRIGGER)_Var1, (TRIGGER)_Var1, (TRIGGER)_Var1, (TRIGGER)_Var1, (TRIGGER)_Var1)
THEN
NOT DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var1);
PROC_TriggerUnregisterForParty(_Var1);

IF
CombatRoundStarted((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_CurrentPhase(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
_Var3 > 1
THEN
PROC_COL_KethericShowdown_SpawnDeathBlooms();

PROC
PROC_COL_KethericShowdown_SpawnDeathBlooms()
AND
DB_COL_KethericShowdown_DeathBloom_SpawnLimit(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_DeathBloom_SpawnPerRound(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_DoNTimes(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRY_RTN_DoNTimes(_, _Var1, _Var1, _Var1, _Var1)
AND
SysCount("DB_COL_KethericShowdown_ExistingDeathBloomNecromite", 2, _Var4, _Var1, _Var1)
AND
_Var4 < _Var1
AND
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
TriggerGetRandomPosition(_Var5, _Var6, _Var7, _Var8, _Var1)
AND
FindValidPosition(_Var6, _Var7, _Var8, 10, S_COL_ShowdownDeathBloomSpawnHelper_00f374a9-5284-4dbb-baa7-1a211ae2ac9c, 0, _Var9, _Var10, _Var11, _Var1)
AND
CreateAt(Quest_COL_Ketheric_DeathBloom_47d0ac01-b412-44f6-9fcf-fe6888764c1d, _Var9, _Var10, _Var11, 0, 1, "", _Var12, _Var1, _Var1)
AND
GetFaction(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var13, _Var1, _Var1, _Var1)
AND
GetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var14, _Var1, _Var1, _Var1)
THEN
NOT DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_Var5);
DB_COL_KethericShowdown_DeathBloomSpawned(_Var12, _Var5);
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var12, _Var5);
DB_Combat_DeathBloom(_Var12, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var13, _Var14);

PROC
PROC_COL_KethericShowdown_SpawnDeathBlooms()
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_Var1);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_AnyPlayerInTrigger(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var1);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND NOT
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_, _, _, _, _)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var2, _, _, _, _)
AND
QRY_AnyCharacterInTrigger(_Var2, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_, _Var2, _, _, _)
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var2);
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_Var2);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND NOT
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_, _, _, _, _)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var2, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_, _Var2, _, _, _)
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var2);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND NOT
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_, _, _, _, _)
AND
DB_COL_KethericShowdown_DeathBloomSpawnTrigger(_Var2, _, _, _, _)
THEN
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var2);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
QRY_GetRandom("DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions", 1, "DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger", _, _)
AND
DB_QRY_RTN_COL_KethericShowdown_SelectedDeathBloomSpawnTrigger(_, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_SelectDeathBloomSpawnTrigger()
AND
DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_DeathBloomSpawnTriggerOptions(_Var1);

IF
EnteredLevel((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_Var1, _, _Var1, _Var1, _Var1)
AND
GetCombatGroupID(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var5, _Var1, _Var1, _Var1)
THEN
SetCombatGroupID(_Var1, _Var5);
PROC_EnterCombat(_Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
DB_Combat_DeathBloom_SpawnedNecromite(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_Var2, _Var3, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _Var3);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_COL_KethericShowdown_DeathBloomSpawned(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_DeathBloomSpawned(_Var1, _Var2);

IF
DestroyedBy((GUIDSTRING)_Var1, _, _, _, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _Var5, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _Var5);

IF
KilledBy((GUIDSTRING)_Var1, _, _, _, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _Var5, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _Var5);

IF
CharacterDisarmed(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, _, (STRING)_, (STRING)_)
THEN
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 0);

IF
ShapeshiftedHitpointsChanged(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, (REAL)_Var1, (REAL)_Var1, (REAL)_Var1, (REAL)_Var1)
AND
DB_COL_KethericShowdown_CurrentPhase(2, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 < 70
THEN
PROC_COL_KethericShowdown_EnterPhase_3();

PROC
PROC_COL_KethericShowdown_EnterPhase_3()
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 > 0
THEN
PROC_COL_KethericShowdown_SetPhase(3);
DebugText(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "PHASE 3 ACTIVE");
ApplyStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_PHASE3_NECROMITE_HELPER", -1, 1);

IF
StatusApplied((GUIDSTRING)_Var1, "MOO_NECROMITE_OFFERSELF", _, _, (GUIDSTRING)_Var1)
THEN
RequestSetSwarmGroup(_Var1, "");

PROC
PROC_COL_KethericShowdown_EnterPhase_3()
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _, _, _)
THEN
PROC_COL_KethericShowdown_SetPhase(3);
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut");

IF
StatusApplied((GUIDSTRING)_Var1, "MYRKULS_BOON_HELPER", (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1)
THEN
SetEntityEventReal(_Var1, "GLO_CombatWait", 1.5);
RealtimeObjectTimerLaunch(_Var1, "NecromiteOfferSelf_Killdelay", 2250);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "NecromiteOfferSelf_Killdelay", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 0);
DB_NecromiteOfferSelf_OffstageDelay(_Var1);

IF
Died((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_NecromiteOfferSelf_OffstageDelay(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_NecromiteOfferSelf_OffstageDelay(_Var1);
PROC_SetOnStage(_Var1, 0);

IF
DB_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_CurrentPhase(1, _, _, _, _)
AND
GetHitpoints(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, _, _, _)
THEN
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut");

PROC
PROC_StateSet_PermaDefeated(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "COL_NIGHTSONG_SOULCAGE", 1, _, _)
THEN
PROC_COL_KethericShowdown_SetNightsongCaged(0);

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
AND NOT
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed", _, _, _, _)
THEN
DB_OnlyOnce("COL_KethericShowdown_NightsongTransformed");

PROC
PROC_COL_KethericShowdown_CueCinematic("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
THEN
MusicPlayGeneral("Music_KethericFight_MyrkulDefeated");

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
THEN
DB_DialogDeath(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
PROC_SetOnStage(S_COL_ApostleScythe_1cf197e8-a751-4712-8822-b08257a6bd32, 0);
TeleportTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_Showdown_KethericDeath_Point_21ab3fb3-f5dd-417f-ab4f-d752219ab7d2, "", 0, 0, 0, 0, 1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
AND NOT
DB_Dead(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
THEN
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var2, _Var1, _Var1, _Var1)
AND
QRY_COL_KethericShowdown_AnyPlayerInChamber()
AND NOT
DB_COL_KethericShowdown_Combatants(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_COL_KethericShowdown_Combatants(_Var1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_Combatants(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
RemoveStatusesWithGroup(_Var1, "SG_Charmed", NULL_00000000-0000-0000-0000-000000000000);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_Combatants(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_Combatants(_Var1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GLO_DefeatCounter(_Var1, "COL_KethericShowdown_KillCounter_Minion", _Var1, _Var1, _Var1)
AND NOT
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _, _Var1, _Var1, _Var1)
AND NOT
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_COL_KethericShowdown_ExistingDeathBloomNecromite(_Var1, _, _Var1, _Var1, _Var1)
AND NOT
DB_Destroyed(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_Dead(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Var1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
RemoveHarmfulStatuses(_Var1);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
THEN
RemoveStatus(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "MOO_KETHERIC_APOSTLEFORM", NULL_00000000-0000-0000-0000-000000000000);
SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b, 1);
ToInventory(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1, 0, 1);
SetOnStage(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, 1);
DB_DialogDeath(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

IF
TimerFinished("COL_KethericShowdown_Death_FadeOut", _, _, _, _)
AND
QRY_OnlyOnce("COL_KethericShowdown_DefeatedDialog", _, _, _, _)
AND NOT
QRY_COL_KethericShowdown_StartKethericDefeatedDialog()
THEN
PROC_COL_KethericShowdown_AfterDefeat();

IF
Resurrected(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
DB_OnlyOnce("COL_KethericShowdown_DefeatedDialog", _, _, _, _)
THEN
DB_DialogDeath(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);
Die(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, NULL_00000000-0000-0000-0000-000000000000, 1, 1, 0);

QRY
QRY_COL_KethericShowdown_StartKethericDefeatedDialog()
AND
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b, _Var1, 0, 0, 0, 0, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_COL_KethericShowdown_SetClosestPlayerSpeaker(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
AND NOT
DB_COL_KethericShowdown_PrimarySpeaker(_, _, _, _, _)
AND
QRY_GetClosestAvailableCharacterTo(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, 0, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 1, _, _, _, _)
AND
DB_ClosestAvailableCharacterTo(_Var2, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _)
THEN
DB_COL_KethericShowdown_PrimarySpeaker(_Var2);

PROC
PROC_StartDialog_AddExtraSpeakers(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 1, 0, 0, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
FlagSet(COL_Nightsong_Event_Resurrect_99786514-3577-1f2b-ae66-5d8b779a5017, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
Resurrect(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
DialogEnded(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, _, _, _, _)
AND
DB_COL_KethericShowdown_PrimarySpeaker(_Var2, _, _, _, _)
THEN
NOT DB_COL_KethericShowdown_PrimarySpeaker(_Var2);

IF
DialogEnded(COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_COL_KethericShowdown_AfterDefeat();

PROC
PROC_COL_KethericShowdown_AfterDefeat()
THEN
SetOnStage(S_COL_KethericShowdown_Apostle_Helper_57017856-e080-405b-a849-f5fdc3d3827b, 0);
DB_AD_Dialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, COL_KethericShowdown_AD_NightsongAfterCombat_d2060999-5499-e1a1-1a45-2f917b2a15f7);
TimerLaunch("COL_KethericShowdown_VB_AfterCombatComment", 3000);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "MOO_NIGHTSONG_MOONBEAM", NULL_00000000-0000-0000-0000-000000000000);
NOT DB_PartyDialogSuppressionZone(S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf);

IF
TimerFinished("COL_KethericShowdown_VB_AfterCombatComment", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _Var1, _Var1, _Var1)
AND NOT
DB_DialogPlayers(_, _Var1, _, _Var1, _Var1)
AND
IsControlled(_Var1, 1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("COL_KethericShowdown_VB_AfterCombatComment", _Var1, _Var1, _Var1, _Var1)
THEN
StartVoiceBark(COL_KethericShowdown_VB_AfterCombatComment_bbdeca5b-e15b-c197-e558-2b52078a5381, _Var1);

IF
AutomatedDialogEnded(COL_KethericShowdown_PAD_AfterCombatComment_a4364c67-075a-5e70-d118-2308008770a9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_OnlyOnce("KethericShowdown_CrownController", _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
THEN
PROC_DaisyAD(_Var2, COL_KethericShowdown_DaisyAD_GrabNetherstone_cc5e8113-97b6-64f5-4109-87b6bfaadfc9);

QRY
QRY_CorpseLooting_BlockMakeOwned(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
DB_ORI_Karlach_TriggerGortashAvatarDialogAtCOL(1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
THEN
ClearScreenFade(_Var1, 1, "COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f", 1);

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND NOT
DB_ORI_Karlach_TriggerGortashAvatarDialogAtCOL(1, _, _, _, _)
THEN
ClearScreenFade(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1, "COL_KethericShowdown_KethericDefeated_6596d1d4-725f-6ba2-0c3f-07f3a5733b7f", 1);

PROC
PROC_SCE_StartSetupDebrief()
AND NOT
DB_OnlyOnce("KethericShowdown_ReplaceArmor", _, _, _, _)
AND NOT
DB_COL_KethericShowdown_KethericArmor(_, _, _, _, _)
AND
GetEquippedItem(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, "Breast", _Var2, _, _)
THEN
DB_COL_KethericShowdown_KethericArmor(_Var2);

PROC
PROC_SCE_StartSetupDebrief()
AND NOT
DB_OnlyOnce("KethericShowdown_ReplaceArmor", _, _, _, _)
AND
DB_COL_KethericShowdown_KethericArmor(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetOnStage(_Var1, 1);
Equip(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _Var1, 1, 0, 1);
Transform(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, MOO_Ketheric_NoNetherstone_621e229c-e0b1-4861-9bbe-5f00cdb4d808, DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);

IF
AddedTo((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_COL_KethericShowdown_KethericArmor(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(GLO_Ketheric_State_Dead_668558ed-0052-0777-64f7-a8a197c40cc5, _Var1, _Var1, _Var1, _Var1)
THEN
Transform(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, MOO_Ketheric_Dead_6950c3cc-af39-4cbd-94e6-233bf55ae536, DisguiseKeepName_c7c3381e-b901-416e-a0c4-bc745e1ff54a);
NOT DB_COL_KethericShowdown_KethericArmor(_Var1);

IF
TextEvent("KethericShowdown_RemoveTransform", _, _, _, _)
THEN
RemoveTransforms(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f);

PROC
PROC_BlockLootCorpse((GUIDSTRING)_Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_OnlyOnce("KethericShowdown_CrownController", _Var1, _Var1, _Var1, _Var1)
AND
IsInInventoryOf(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 1, _Var1, _Var1)
THEN
ToInventory(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, _Var1, 1, 1, 1);
DB_CustomLootCorpseResponse(_Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0);
DB_COL_KethericShowdown_DelayLootCorpse(_Var1);

PROC
PROC_SCE_StartSetupDebrief()
AND
DB_COL_KethericShowdown_DelayLootCorpse(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
OpenCharacterLootUI(_Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, _, _Var1, _Var1)
THEN
NOT DB_COL_KethericShowdown_DelayLootCorpse(_Var1);

IF
AddedTo(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("KethericShowdown_CrownController", _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_COL_ColonyArea_NoOubliette_e35841eb-e9ae-4c13-8b46-832184d1ec5b, _Var1, _Var1, _Var1)
AND NOT
QRY_StartDialogCustom(COL_KethericShowdown_CrownController_1bcd7cc6-6b38-3cf7-ca60-686d4eadc2b2, _Var1, S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, 0, 0, 0, 0, _Var1, _Var1, _Var1)
THEN
PROC_SCE_StartSetupDebrief();

IF
DialogEnded(COL_KethericShowdown_CrownController_1bcd7cc6-6b38-3cf7-ca60-686d4eadc2b2, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
PROC_SCE_StartSetupDebrief();

QRY
QRY_SCE_Debrief_BlockCharacter(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_COL_KethericShowdown_ChosenThree_Box_1581a588-b69f-41c9-a591-5959751f3cdf, _, _, _)
THEN
PROC_SCE_SendCharacterToDebrief(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);

PROC
PROC_SCE_StartSetupDebrief()
THEN
PROC_TriggerRegisterForPlayers(S_SCE_NoStoneThrallDialogBox_a93cb754-abab-4901-83f1-65be16c80166);
DB_AddCharactersInTriggerToDialog(GLO_ThrallOfTheAbsolute_LeaveWithoutKethericStone_e89ef423-ba39-2243-4383-dd28eef77c74, S_SCE_NoStoneThrallDialogBox_a93cb754-abab-4901-83f1-65be16c80166, 1, 1, 1, 1);
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "MOO_NIGHTSONG_MOONBEAM", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_BlockUseOfItem((CHARACTER)_Var1, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_GLO_EmperorPrelude_NetherstoneIsInMagicPocketsOrCamp(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(S_COL_CrownController_Ketheric_06b8891b-e71c-423b-8482-2680c3c16a4d, S_COL_Colony_SUB_c72269e5-0719-4379-a8ea-ca2ca199d0a3, 1, _Var1, _Var1)
THEN
DB_CustomUseItemResponse(_Var1, S_SCE_Portal_ce5f1b20-6e3b-4fe9-9137-8c4ea3d025af, 0);
PROC_COL_KethericShowdown_WithoutKethericStoneWarning(_Var1);

PROC
PROC_COL_KethericShowdown_WithoutKethericStoneWarning((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
QRY_StartDialog(GLO_ThrallOfTheAbsolute_LeaveWithoutKethericStone_e89ef423-ba39-2243-4383-dd28eef77c74, NULL_00000000-0000-0000-0000-000000000000, _Var1, _Var1, _Var1)
THEN
PROC_PlayCantUseItemAD(_Var1);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act2"
