Version 1
SubGoalCombiner SGC_AND

INITSECTION
PROC_TriggerRegisterForParty(S_WYR_SentientAmulet_Crypt_Area_Trigger_94be7aaf-ebf9-4517-9553-74453e3d0d38);
PROC_TriggerRegisterForPlayers(S_WYR_SentientAmulet_Crypt_VB_Trigger_a9599746-2bb4-4b77-9298-024263aaad89);
DB_GLO_MonkAmuletBanters(S_WYR_SentientAmulet_OpenHandTemple_Trigger_e913a308-a398-4b64-ab10-8423c0518dff, WYR_SentientAmulet_AD_OpenHandTempleComment_ae7d95ca-0196-b0ce-5237-fd6034a6e092);
DB_GLO_MonkAmuletBanters(S_WYR_SentientAmulet_Banter_Circus_Trigger_6f605103-66d3-4eaa-ad44-37b87b3f2b44, WYR_SentientAmulet_AD_CircusComment_4ee5b284-327e-c259-5129-254b974e8530);
DB_WYR_SentientAmulet_Plaques(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae, WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_Corpse_000");
DB_WYR_SentientAmulet_Plaques(S_WYR_SentientAmulet_Tomb_Plaque_001_1e5e7950-6908-492a-93c4-856c04c83368, WYR_SentientAmulet_AD_Tomb_Plaque_01_b6617136-05cf-4e0c-7d53-03cb31703246, S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a, "WYR_SentientAmulet_Corpse_001");
DB_WYR_SentientAmulet_Plaques(S_WYR_SentientAmulet_Tomb_Plaque_002_80c5321b-de4f-4c8c-853b-e10b2d40de14, WYR_SentientAmulet_AD_Tomb_Plaque_02_7dcd5857-c25a-06b1-882f-21f27cf8f9e9, S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd, "WYR_SentientAmulet_Corpse_002");
DB_WYR_SentientAmulet_Plaques(S_WYR_SentientAmulet_Tomb_Plaque_003_2d7269f8-084a-463e-93dd-f0d5b28c812f, WYR_SentientAmulet_AD_Tomb_Plaque_03_469bb6e6-4ad6-1736-853f-b93099d78499, S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e, "WYR_SentientAmulet_Corpse_003");
DB_HasItemEvent(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62);
DB_FlagReactionAfterDialog(WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca, WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408, "", 0, 0, 0, 1, 1);
SetOnStage(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, 1);
SetImmortal(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, 1);
ApplyStatus(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "INVULNERABLE_NOT_SHOWN", -1, 1, NULL_00000000-0000-0000-0000-000000000000);
PROC_CharacterDisableAllCrimes(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e);
DB_WYR_SentientAmulet_Zombies(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
DB_WYR_SentientAmulet_Zombies_Tombs(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, S_WYR_SentientAmulet_Tomb_Bed_b42a3db9-38dd-4532-b623-7d2bb50a0f63, S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6, S_WYR_SentientAmulet_Tomb_Lid_Open_Point_3700ab31-4cb1-4e5e-ad1b-18fc7bef07bc);
DB_WYR_SentientAmulet_Zombies_Tombs(S_WYR_SentientAmulet_Zombie_001_d985482f-3f1a-4fea-ba83-58fe5862841a, S_WYR_SentientAmulet_Tomb_Bed_001_02d59fb5-a6a6-4586-8f98-b7615a320c65, S_WYR_SentientAmulet_Tomb_Lid_001_d14f3ec7-58f8-40d8-94f5-dd8d829d4669, S_WYR_SentientAmulet_Tomb_Lid_Open_Point_001_f387c4d5-f702-4824-b7ce-4bbc8f90ae67);
DB_WYR_SentientAmulet_Zombies_Tombs(S_WYR_SentientAmulet_Zombie_002_022ee3da-672b-4961-9cdf-89283878d3dd, S_WYR_SentientAmulet_Tomb_Bed_002_b5bc8fa5-3827-4674-886b-90b03635a182, S_WYR_SentientAmulet_Tomb_Lid_002_4192aede-79ae-4f70-ba9b-f708195ff6fa, S_WYR_SentientAmulet_Tomb_Lid_Open_Point_002_27836500-a773-4d49-b24c-84b63ed60ab2);
DB_WYR_SentientAmulet_Zombies_Tombs(S_WYR_SentientAmulet_Zombie_003_372d7242-975d-4eea-b7a5-a7e71cdb6f9e, S_WYR_SentientAmulet_Tomb_Bed_003_b599dcbb-aff0-4948-a3d3-1f5f76643570, S_WYR_SentientAmulet_Tomb_Lid_003_c1607ce8-6952-4220-ac26-2436c1624a47, S_WYR_SentientAmulet_Tomb_Lid_Open_Point_003_50fe605e-3fcb-4351-b4a7-cebd9aea1628);
DB_HostileToPlayerGroupCancelFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055, ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999);

KBSECTION
IF
TextEvent("SAM_Reset", _, _, _, _)
THEN
Resurrect(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
DB_WYR_SentientAmulet_ZombieReposing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, BASE_DEC_Sittable_Immovable_000_b42a3db9-38dd-4532-b623-7d2bb50a0f63);
ClearFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);
ClearFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
ClearFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);
ClearFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);
TeleportTo(S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6, S_WYR_SentientAmulet_DEBUG_Lid_Reset_Point_6212026c-703c-4dae-9099-34bb50eb5d13);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408, "", 0, 0, 0, 1, 1);
PROC_SetRelationToPlayers(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, 50);
NOT DB_OnlyOnce("WYR_SentientAmulet_StartedCombat");

IF
TextEvent("SAM_Reset", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_HostileToPlayerGroup(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_HostileToPlayerGroup(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, _Var1);

IF
FlagSet(WYR_SentientAmulet_Debug_GetAmulet_87df7be7-10b6-393a-45be-a6a86cf64c5e, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(WYR_SentientAmulet_Debug_GetAmulet_87df7be7-10b6-393a-45be-a6a86cf64c5e, _Var1);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);

IF
TextEvent("SAM_Get", _, _, _, _)
AND NOT
GetTextEventParamInteger(1, _, _, _, _)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);

IF
TextEvent("SAM_Get", (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
GetTextEventParamInteger(1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(_Var1);

IF
FlagSet(WYR_SentientAmulet_Debug_Start_a59158ae-5568-39b9-cd80-4dc80d4e7535, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(WYR_SentientAmulet_Debug_Start_a59158ae-5568-39b9-cd80-4dc80d4e7535, _Var1);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_Debug_Teleport_WYR_OpenHand_562fedbf-e567-424b-b474-daf7f27ceb9e, "");
PROC_WYR_Brainquakes_UnregisterAllEventTriggers();

IF
TextEvent("SAM_Start", _, _, _, _)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_Debug_Teleport_WYR_OpenHand_562fedbf-e567-424b-b474-daf7f27ceb9e, "");
PROC_WYR_Brainquakes_UnregisterAllEventTriggers();

IF
FlagSet(WYR_SentientAmulet_Debug_Crypt_5cee1010-2be4-9fef-356f-1633143ed2e8, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(WYR_SentientAmulet_Debug_Crypt_5cee1010-2be4-9fef-356f-1633143ed2e8, _Var1);
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c, "");
TimerLaunch("WYR_SentientAmulet_DEBUG_DelayOnStage", 1000);

IF
TimerFinished("WYR_SentientAmulet_DEBUG_DelayOnStage", _, _, _, _)
THEN
SetOnStage(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 1);

IF
TextEvent("SAM_Crypt", _, _, _, _)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c, "");
TimerLaunch("WYR_SentientAmulet_DEBUG_DelayOnStage", 1000);

PROC
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1, _, _, _, _)
THEN
SetFlag(UND_MonkAmulet_State_FoundAmulet_843c2dc4-0066-47f7-a23b-8eef3965ffd3);
SetFlag(UND_MonkAmulet_State_PlayerSpokeWithAmulet_5614945a-6d08-d67e-2606-99d4f87ea51a);
SetFlag(UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f);

PROC
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(_, _, _, _, _)
AND
GetHostCharacter(_Var2, _, _, _, _)
THEN
Equip(_Var2, S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, 1, 1, 1);

IF
TextEvent("SAM_Banter", (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
GetTextEventParamUUID(1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(_Var1, S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178);

IF
FlagSet(WYR_SentientAmulet_Debug_CryptCombat_67c56326-266c-ed39-c2ad-e04a9fee5298, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(WYR_SentientAmulet_Debug_CryptCombat_67c56326-266c-ed39-c2ad-e04a9fee5298, _Var1);
PROC_WYR_SentientAmulet_DEBUG_StartCombat();

IF
TextEvent("SAM_Combat", _, _, _, _)
THEN
PROC_WYR_SentientAmulet_DEBUG_StartCombat();

PROC
PROC_WYR_SentientAmulet_DEBUG_StartCombat()
AND
GetHostCharacter(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_DEBUG_GetAmulet(1);
PROC_WYR_SentientAmulet_PrepareCombat();
PROC_TeleportPartiesTo(S_WYR_SentientAmulet_DEBUG_Crypt_Point_d7e7114c-eb29-4632-a373-4aa16a0f806c, "");
DB_WYR_SentientAmulet_InteractingPlayer(_Var1);
SetFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);
PROC_SetRelationToPlayers(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, 0);
TimerLaunch("WYR_SentientAmulet_DEBUG_Combat", 2000);

IF
TimerFinished("WYR_SentientAmulet_DEBUG_Combat", _, _, _, _)
AND
IsOnStage(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, 1, _, _, _)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
TemplateAddedTo(UNI_UND_MonkAmulet_086ae8fd-c44e-43a7-b8be-777b551a06d6, (GUIDSTRING)_Var1, (CHARACTER)_Var2, _, (GUIDSTRING)_Var1)
AND
_Var1 != S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("WYR_SentientAmulet_DEBUG_GaveAmuletFallback", _Var1, _Var1, _Var1, _Var1)
THEN
ToInventory(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, _Var2, 1, 1, 1);

IF
FlagSet(WYR_SentientAmulet_Knows_ShirraIsInCrypt_7d8201db-b5d8-9792-a1e3-3c75622b7f58, _, _, _, _)
AND NOT
DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78, _, _, _, _)
AND
DB_GlobalFlag(UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f, _, _, _, _)
AND NOT
DB_InRegion(_, S_WYR_SentientAmulet_Crypt_Area_Trigger_94be7aaf-ebf9-4517-9553-74453e3d0d38, _, _, _)
THEN
DB_OneShot_VoiceBarkTrigger(S_WYR_SentientAmulet_Crypt_VB_Trigger_a9599746-2bb4-4b77-9298-024263aaad89, WYR_SentientAmulet_VB_EnteredCrypt_5843ff68-de37-e484-1b83-ee00d776ea91);

IF
DB_WYR_SentientAmulet_Plaques(_Var1, _Var2, _Var3, _, _Var1)
THEN
DB_Dialogs(_Var1, _Var2);
SetStoryDisplayName(_Var3, "WYR_SentientAmulet_Corpse_Unidentified");

IF
UseFinished(_, (GUIDSTRING)_Var2, 1, _, _)
AND
DB_WYR_SentientAmulet_Plaques(_Var2, _, _Var4, _, _)
AND NOT
DB_WYR_SentientAmulet_IdentifiedCorpse(_Var4, _, _, _, _)
THEN
PROC_WYR_SentientAmulet_IdentifyCorpse(_Var4);

PROC
PROC_WYR_SentientAmulet_IdentifyCorpse((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_Plaques(_, _, _Var1, _Var4, _Var1)
THEN
DB_WYR_SentientAmulet_IdentifiedCorpse(_Var1);
SetStoryDisplayName(_Var1, _Var4);

IF
UseFinished(_, S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae, 1, (CHARACTER)_, (CHARACTER)_)
THEN
DB_WYR_SentientAmulet_IdentifiedCorpse(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

IF
AutomatedDialogEnded(WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_GlobalFlag(UND_MonkAmulet_Event_OfferedQuest_1226f854-c4f6-af9f-6863-e7c3d013647f, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_OpenTomb(S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6, _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession(_Var2);

QRY
QRY_SelectCustomDialog(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Dialogs(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae, WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f, _Var1, _Var1, _Var1)
AND
DB_CantTalk(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(NULL_00000000-0000-0000-0000-000000000000, _Var1);
PROC_TryStartAD(WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f, S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae);

IF
EntityEvent(_, "WYR_SentientAmulet_GhostFadeIn_TombOpened", _, _, _)
AND
QRY_StartDialog(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _)
THEN
SetFlag(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5);

IF
AutomatedDialogStarted(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95, _, _, _, _)
AND
DB_DialogName(WYR_SentientAmulet_PAD_Tomb_Plaque_86ace81b-0eaf-9bd3-9a8d-2ed5ef14e20f, _Var2, _, _, _)
THEN
PROC_ForceStopDialog(S_WYR_SentientAmulet_Tomb_Plaque_641ec497-4208-4f57-a01b-40c9997edfae);

IF
AutomatedDialogEnded(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95, _, _, _, _)
AND NOT
DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _, _, _)
THEN
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
UseFinished((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, 1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_, _, _Var2, _, _Var1)
AND NOT
DB_WYR_SentientAmulet_OpenTomb(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_OpenTomb(_Var2);

PROC
PROC_WYR_SentientAmulet_OpenTomb((ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1)
AND NOT
DB_WYR_SentientAmulet_OpenTomb(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_Var2, _, _Var1, _Var4, _Var1)
THEN
SetOnStage(_Var2, 1);
ItemMoveTo(_Var1, _Var4, 1, 0, 1, "WYR_SentientAmulet_OpenTomb", 0);
SetCanInteract(_Var1, 0);

IF
UseFinished((GUIDSTRING)_Var1, S_WYR_SentientAmulet_Tomb_Lid_97f1280f-f052-4988-b59d-5f972c9651d6, 1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession(_Var1);

PROC
PROC_ProcessLootCorpse((CHARACTER)_Var1, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_IdentifiedCorpse(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_TryStartShirraPossession(_Var1);
DB_CustomLootCorpseResponse(_Var1, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 0);

PROC
PROC_WYR_SentientAmulet_TryStartShirraPossession((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62, _Var1, 0, _Var1, _Var1)
AND NOT
DB_DialogName(WYR_SentientAmulet_PAD_TombNoAmulet_da7da320-7fbf-6a2c-786b-d71c6e40373b, _, _Var1, _Var1, _Var1)
AND NOT
DB_EntityUnreachable(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(WYR_SentientAmulet_PAD_TombNoAmulet_da7da320-7fbf-6a2c-786b-d71c6e40373b, _Var1);

PROC
PROC_WYR_SentientAmulet_TryStartShirraPossession((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_GlobalFlag(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(WYR_SentientAmulet_State_HasAmulet_f4bbc9de-b75a-491a-9e80-52a3c8bbce62, _Var1, 1, _Var1, _Var1)
THEN
DB_WYR_SentientAmulet_InteractingPlayer(_Var1);
PROC_GlobalSetFlagAndCache(WYR_SentientAmulet_State_StartedShirraPossession_3debb5ae-a0a9-41cd-aeee-26695a103a78);
SetFaction(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_WYR_SentientAmulet_Zombie_Point_f09ed71a-f93e-4bfd-bd3e-197aedde8fd9, "WYR_SentientAmulet_GhostTeleport", 0, 0, 0, 1, 1);

IF
EntityEvent(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_GhostTeleport", _, _, _)
THEN
PROC_FadeInEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_GhostFadeIn_TombOpened");
LookAtEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 3);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e, _, _, _, _)
AND NOT
DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _, _, _)
AND
IsOnStage(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, 1, _, _, _)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e, _, _, _, _)
AND NOT
DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _, _, _)
THEN
DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
Resurrect(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, NULL_00000000-0000-0000-0000-000000000000, 1);
SetHitpointsPercentage(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 100);
EndRepose(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
Resurrected(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _, _, _)
AND
DB_GlobalFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616, _, _, _, _)
THEN
PROC_CharacterMoveTo(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, S_WYR_SentientAmulet_Zombie_Point_f09ed71a-f93e-4bfd-bd3e-197aedde8fd9, "Walk", "WYR_SentientAmulet_ZombieWalk");
ClearFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);

IF
EntityEvent(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_ZombieWalk", _, _, _)
THEN
DB_WYR_SentientAmulet_TryZombieDialog(1);
TimerLaunch("WYR_SentientAmulet_ZombieDialogFallback", 15000);

IF
DialogStarted(WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
TimerCancel("WYR_SentientAmulet_ZombieDialogFallback");

IF
TimerFinished("WYR_SentientAmulet_ZombieDialogFallback", (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogName(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95, _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogSpeakers(_Var1, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _, _Var1, _Var1)
AND
IsSpeakerReserved(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 0, _Var1, _Var1, _Var1)
THEN
PROC_ForceStopDialog(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);

IF
DB_WYR_SentientAmulet_TryZombieDialog(1, _, _, _, _)
AND NOT
DB_DialogName(WYR_SentientAmulet_AD_Possession_454401ab-bf99-c21f-d032-995487461b95, _, _, _, _)
THEN
NOT DB_WYR_SentientAmulet_TryZombieDialog(1);
SetEntityEvent(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_TryZombieDialog");

IF
EntityEvent(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_TryZombieDialog", _, _, _)
THEN
DB_Dialogs(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed);

IF
EntityEvent(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_TryZombieDialog", _, _, _)
AND NOT
QRY_WYR_SentientAmulet_TryZombieTalkWithInteractingPlayer()
THEN
DB_SpotPlayers(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_Zombie", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_WYR_SentientAmulet_TryZombieTalkWithInteractingPlayer()
AND
DB_WYR_SentientAmulet_InteractingPlayer(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Sees(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_WYR_SentientAmulet_StartZombieDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_InteractingPlayer(_Var1);

PROC
PROC_SpotPlayers_Spotted(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_SentientAmulet_Zombie", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_WYR_SentientAmulet_StartZombieDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_WYR_SentientAmulet_StartZombieDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed, S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
DialogStarted(WYR_SentientAmulet_Zombie_b30457da-d36e-8822-cb6f-d8b24fe013ed, _, _, _, _)
AND
DB_SpotPlayers(_Var2, "WYR_SentientAmulet_Zombie", _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Var2, "WYR_SentientAmulet_Zombie");

IF
FlagSet(WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
NOT DB_WYR_SentientAmulet_MonkPossessing(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
DB_WYR_SentientAmulet_MonkPossessing(_Var1);
RemoveStatus(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, "WYR_AMULET_POSSESSION", S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
DB_DialogDeath(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c);
Die(S_WYR_SentientAmulet_Zombie_Shirra_cc15a9d4-b600-4e82-b981-3a0038a62c6c, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 0, 0);

PROC
PROC_FlagReactionAfterDialog((GUIDSTRING)_Var1, WYR_SentientAmulet_Event_MonkPossessPlayer_564d44f7-20af-478f-a4a0-7442adafc0ca, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
RemoveStatus(_Var1, "WYR_AMULET_POSSESSION", S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f, _Var1);

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
HasPassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_Passive", 1, _Var1, _Var1)
THEN
RemovePassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_Passive");
AddPassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_2_Passive");

IF
FlagSet(WYR_SentientAmulet_Event_LoseWisdomPoint_6fde50af-67eb-4f4e-8d64-f3e111a8880f, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
HasPassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_2_Passive", 0, _Var1, _Var1)
AND
HasPassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_Passive", 0, _Var1, _Var1)
THEN
AddPassive(_Var1, "MAG_MonkAmulet_WisdomDebuff_Passive");

IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
RemoveStatus(_Var1, "WYR_AMULET_POSSESSION", S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
AddSpell(_Var1, "Target_WYR_SentientAmulet_HideousLaughter", 1, 1);

IF
DB_Is_InCombat(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _, _, _, _)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
AttackedBy((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, _, _, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_HostileToPlayerGroup(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, _Var2);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, (CHARACTER)_Var1, _, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat", _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, 0, 0, 0, 0, _Var1, _Var1, _Var1)
THEN
LookAtEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, 3);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, (GUIDSTRING)_Var1, _, _, _, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat", _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(WYR_SentientAmulet_Event_MonkPossessZombie_5df6e111-8f7d-46a5-b35b-4266230f713e);

IF
AttackedBy(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, (CHARACTER)_Var1, _, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
DB_HostileToPlayerGroup(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, _Var1);
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
DB_Is_InCombat(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GlobalClearFlagAndCache(WYR_SentientAmulet_Event_ZombieLeaveCoffin_b95f8cbd-e23a-4ee9-0f38-32efcc4a9616);

IF
DB_Is_InCombat(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_PrepareCombat();

IF
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_PreventPermaDefeated(_Var1);

IF
DB_WYR_SentientAmulet_Zombies_Tombs(_Var1, _Var2, _, _, _Var1)
THEN
DB_WYR_SentientAmulet_ZombieReposing(_Var1, _Var2);

IF
DB_WYR_SentientAmulet_ZombieReposing(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
Use(_Var1, _Var2, 1, 0, "");

IF
UseFinished((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_ZombieReposing(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0);

IF
Died((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_ZombieReposing(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_ZombieReposing(_Var1, _Var2);
SetOnStage(_Var1, 0);
SetFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f, _Var1);
ApplyStatus(_Var1, "GROUNDED_APPLYTODEAD", -1, 0, NULL_00000000-0000-0000-0000-000000000000);

IF
Resurrected((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f, _Var1, 1, _Var1, _Var1)
THEN
ClearFlag(WYR_SentientAmulet_State_InCoffin_5044f3aa-9901-4266-8bb4-0924d30d917f, _Var1);
RemoveStatus(_Var1, "GROUNDED_APPLYTODEAD", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkCombatStart_566204b2-9506-c16e-4f7b-024a5e7ab54c, _Var1);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_Plaques(_, _, _Var3, _, _)
AND NOT
DB_WYR_SentientAmulet_IdentifiedCorpse(_Var3, _, _, _, _)
THEN
PROC_WYR_SentientAmulet_IdentifyCorpse(_Var3);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_Var1, _, _Var3, _, _Var1)
AND
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_WYR_SentientAmulet_ShouldResurrect(_Var1, _Var3);

IF
DB_WYR_SentientAmulet_ShouldResurrect(_Var1, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_WYR_SentientAmulet_OpenTomb(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_WYR_SentientAmulet_OpenTomb(_Var2);

IF
DB_WYR_SentientAmulet_ShouldResurrect(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_OpenTomb(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_ShouldResurrect(_Var1, _Var2);
Resurrect(_Var1, NULL_00000000-0000-0000-0000-000000000000, 1);
SetHitpointsPercentage(_Var1, 100);
EndRepose(_Var1);

IF
EntityEvent((GUIDSTRING)_Var1, "WYR_SentientAmulet_OpenTomb", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_Zombies_Tombs(_, _, _Var1, _, _Var1)
THEN
DB_WYR_SentientAmulet_OpenTomb(_Var1);

PROC
PROC_WYR_SentientAmulet_PrepareCombat()
THEN
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat");

IF
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ApplyStatus(_Var1, "WYR_AMULET_POSSESSION", -1, 1, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
StatusRemoved((CHARACTER)_Var1, "WYR_AMULET_POSSESSION", _, _, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_MonkPossessing(_Var1);

IF
TurnStarted((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetHitpointsPercentage(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
_Var2 <= 50
AND NOT
QRY_WYR_SentientAmulet_PossessNewZombie()
AND
QRY_OnlyOnce("WYR_SentientAmulet_AD_MonkNoMoreZombies", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkNoMoreZombies_7d61535f-6599-32bd-060a-5efa422398b3, _Var1);

IF
TurnStarted((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_PossessionCandidates(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_PossessionCandidates(_Var2);

QRY
QRY_WYR_SentientAmulet_PossessNewZombie()
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_WYR_SentientAmulet_InitPossessionCandidates()
AND
QRY_GetRandom("DB_WYR_SentientAmulet_PossessionCandidates", 1, "DB_WYR_SentientAmulet_PossessionTarget", _Var1, _Var1)
AND
DB_WYR_SentientAmulet_PossessionTarget(_, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkLeavesZombie_4d87caef-34f2-ada2-e76e-f9824b5c12d5, _Var1);
RealtimeObjectTimerLaunch(_Var1, "WYR_SentientAmulet_Possess", 5000);
RealtimeObjectTimerLaunch(_Var1, "WYR_SentientAmulet_EndTurn", 7000);
SetEntityEventReal(_Var1, "GLO_CombatWait", 7);

QRY
QRY_WYR_SentientAmulet_InitPossessionCandidates()
AND
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Defeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_WYR_SentientAmulet_PossessionCandidates(_Var1);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "WYR_SentientAmulet_Possess", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_PossessionTarget(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
RemoveStatus(_Var1, "WYR_AMULET_POSSESSION", S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
NOT DB_WYR_SentientAmulet_MonkPossessing(_Var1);
DB_WYR_SentientAmulet_MonkPossessing(_Var2);
NOT DB_WYR_SentientAmulet_PossessionTarget(_Var2);
UseSpell(_Var2, "Target_WYR_SentientAmulet_MonkHeal", _Var2, NULL_00000000-0000-0000-0000-000000000000);
PROC_TryStartAD(WYR_SentientAmulet_AD_MonkEntersZombie_b76bda62-0e29-4ba7-fd81-0638b7ea2b5c, _Var2);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "WYR_SentientAmulet_EndTurn", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
EndTurn(_Var1);

IF
Dying((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat", _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_SentientAmulet_Zombies(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Dead(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_PreventPermaDefeated(_Var2);
Die(_Var2, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0);

IF
Dying((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_MonkPossessing(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_OnlyOnce("WYR_SentientAmulet_StartedCombat", _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_PreventPermaDefeated(_Var1);
DB_WYR_SentientAmulet_LastPossessed(_Var1);
NOT DB_WYR_SentientAmulet_MonkPossessing(_Var1);
PROC_GlobalSetFlagAndCache(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);
PROC_SetRelationToPlayers(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, 50);

IF
Resurrected((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_Zombies(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055);

IF
Died((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_WYR_SentientAmulet_LastPossessed(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_LastPossessed(_Var1);
PROC_SetRelationToPlayers(ACT3_WYR_SentientAmulet_MadMonk_416a0f93-c472-48ea-8d06-d17a40ff1999, 50);
TriggerRegisterForCharacter(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
TeleportTo(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, "WYR_SentientAmulet_AfterCombatTeleport", 0, 0, 0, 1, 1);

IF
EntityEvent(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_AfterCombatTeleport", _, _, _)
THEN
PROC_FadeInEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_GhostFadeIn_AfterCombat");

IF
EntityEvent(_, "WYR_SentientAmulet_GhostFadeIn_AfterCombat", (GUIDSTRING)_, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
TimerLaunch("WYR_SentientAmulet_WrapUp_StartSpot", 1000);

IF
TimerFinished("WYR_SentientAmulet_WrapUp_StartSpot", _, _, _, _)
THEN
DB_SpotPlayers(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_WrapUp", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_WYR_SentientAmulet_LastPossessed(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d, _Var1, _Var1, _Var1)
THEN
TriggerUnregisterForCharacter(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);
PROC_TriggerRegisterForPlayers(S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d);
DB_AddCharactersInTriggerToDialog(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, S_WYR_SentientAmulet_AfterCombat_Dialog_Trigger_7f9fc448-0823-4411-b194-b1ffec475a3d, 1, 1, 0);

PROC
PROC_SpotPlayers_Spotted(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, "WYR_SentientAmulet_WrapUp", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialogCustom(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, 0, 0, 0, 0, _Var1, _Var1, _Var1)
THEN
LookAtEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30, _Var1, 3);

IF
DialogStarted(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, _, _, _, _)
AND
DB_SpotPlayers(_Var2, "WYR_SentientAmulet_WrapUp", _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Var2, "WYR_SentientAmulet_WrapUp");

IF
DialogEnded(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_FadeOutEntity(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5, _, _, _, _)
AND
IsEquipped(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, 1, _, _, _)
THEN
DB_WYR_SentientAmulet_Equipped(1);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_GhostLeftAmulet_752d02d4-0a40-405e-946c-58475b3493a5, _Var1, _Var1, _Var1, _Var1)
AND
GetInventoryOwner(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408, "", 0, 0, 0, 0, 1);
SetOnStage(S_UND_MonkAmulet_Amulet_de2ea5a9-943a-4794-9ef7-208be7747178, 0);
ToInventory(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, _Var1, 1, 0, 1);

IF
AddedTo(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_Equipped(1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_Equipped(1);
Equip(_Var1, S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055, _, _, _, _)
AND
IsEquipped(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, 1, _, _, _)
THEN
DB_WYR_SentientAmulet_Equipped(1);

IF
DB_GlobalFlag(WYR_SentientAmulet_State_DefeatedZombies_bfbbb273-5195-428d-931a-5a93a7431055, _Var1, _Var1, _Var1, _Var1)
AND
GetInventoryOwner(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, S_TeleportTrigger_Asylum_c46ad6e3-e21a-41fc-83e5-0c36db324408, "", 0, 0, 0, 0, 1);
SetOnStage(S_WYR_SentientAmulet_Amulet_NoGhost_36cc7257-9d6c-47c1-8c84-210a3ba277b2, 0);
ToInventory(S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371, _Var1, 1, 0, 1);

IF
AddedTo(S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_SentientAmulet_Equipped(1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_Equipped(1);
Equip(_Var1, S_WYR_SentientAmulet_Amulet_AfterCombat_c037dd05-5001-4e44-a6fb-fcd866da4371);

IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_WYR_SentientAmulet_ResolutionPlayer(_Var1);

IF
FlagSet(WYR_SentientAmulet_Event_GetMonkReward_93f52b5c-5f1f-4163-b76f-ab6cec9a6767, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_PeacefulResolve(S_GLO_LathanderMonk_bd1fac9a-f107-4064-85d0-ec392a6f2b30);

IF
DialogEnded(WYR_SentientAmulet_AfterCombat_ee99c776-72b8-3269-8a68-f307eaae4ce7, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
AND NOT
DB_WYR_SentientAmulet_ResolutionPlayer(_, _Var1, _Var1, _Var1, _Var1)
THEN
DB_WYR_SentientAmulet_ResolutionPlayer(_Var2);

IF
DB_WYR_SentientAmulet_ResolutionPlayer(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_DialogPlayers(_, _Var1, _, _Var1, _Var1)
THEN
NOT DB_WYR_SentientAmulet_ResolutionPlayer(_Var1);
ObjectTimerLaunch(_Var1, "WYR_SentientAmulet_DelayResolutionPAD", 2000);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "WYR_SentientAmulet_DelayResolutionPAD", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(WYR_SentientAmulet_PAD_PostResolutionComment_f5451b97-a4bf-9dea-9a20-a22393055ac3, _Var1);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act3"
