Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_Dialogs(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, GOB_Festivities_Goblin004_f623cf7f-49df-d597-779c-076b9e7d9399);
DB_GOB_GoblinToast_MaxPoisonedGoblins(3);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf, 2000);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, 1000);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94, 2500);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776, 2700);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0, 3000);
DB_GOB_GoblinToast_GoblinsToPoison(S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7, 1700);
DB_GOB_GoblinToast_CommentAfterPoison(3, 1000, 4000);
DB_GOB_GoblinToast_CommentAfterPoison_CountDeaths(0);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_001_774c78ed-1227-48f9-812e-aac0021c71bf);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_002_bb9c82a2-7ed9-45ed-99b6-58f84520fb8c);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_003_0296a9f6-b2bc-46a0-8632-ba72679a36d3);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_005_a955aea9-9040-4d4c-9264-e46e385dea94);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_RoastingDwarfOperator_000_1fe911f8-c9c9-4405-83fa-d343d59c7be9);
DB_GOB_GoblinToast_ToastParticipants(S_GOB_RoastingDwarfOperator_001_3837d519-dc92-459c-ab2d-1eac0b208fc7);
DB_GOB_GoblinToast_Lead(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748);
PROC_TriggerRegisterForPlayers(S_GOB_GoblinToast_ToastArea_d501d299-1d54-4795-b991-eddabac2fc5a);
PROC_TriggerRegisterForPlayers(S_GOB_GoblinToast_MainDialogueArea_73795d7a-a919-46a2-8433-c15011b34bf7);
DB_AddCharactersInTriggerToDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, S_GOB_GoblinToast_MainDialogueArea_73795d7a-a919-46a2-8433-c15011b34bf7, 1, 0, 1);
DB_Inclusion_Object(S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776, GOB_GoblinToast_Event_IncludeSecondGoblin_807f09bf-46ae-e8da-0111-4f92746b6ad0, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object(S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0, GOB_GoblinToast_Event_IncludeThirdGoblin_2537a9f2-0c49-5cd4-a7db-fcfaf6d0e8a1, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_Object(S_GOB_RoastingDwarfOperator_000_1fe911f8-c9c9-4405-83fa-d343d59c7be9, GOB_GoblinToast_Event_IncludeFourthGoblin_10d0e286-8cdd-4205-b535-75fc82eb80ab, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776);
DB_Inclusion_NPCDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);
DB_Inclusion_NPCDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, S_GOB_RoastingDwarfOperator_000_1fe911f8-c9c9-4405-83fa-d343d59c7be9);
SetOnStage(S_Debug_GOB_GoblinToast_Poison_220322be-0c04-4bf3-8012-ad43c92d9b38, 0);
SetOnStage(S_Debug_GOB_GoblinToast_Invis_c2605218-07f9-4176-a387-2d74949caa80, 0);
DB_SpotPlayers(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "GOB_GoblinToast", GOB_GoblinToast_Event_StartSpotting_58170b7e-7795-462f-8d53-1a740b04e610, GOB_GoblinToast_Event_StopSpotting_fbfa3f56-a02f-486a-80a4-aaa5d7e4f2f9);
DB_SpotPlayers_SpotTrigger(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "GOB_GoblinToast", S_GOB_GoblinToast_ToastArea_d501d299-1d54-4795-b991-eddabac2fc5a);
PROC_SpotPlayers_StopSpotting(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "GOB_GoblinToast");
PROC_DeclareCounter("GOB_GoblinToast_PoisonedGoblins");
DB_GOB_GoblinToast_StateManager(GOB_GoblinToast_State_CrowdGathered_0b99e023-2c0f-4a9d-8e37-5677f50ccd00);
DB_GOB_GoblinToast_StateManager(GOB_GoblinToast_State_ToastIsOn_99a0dc3a-289e-48b3-9710-60388f0d72ed);
DB_GOB_GoblinToast_StateManager(GOB_GoblinToast_State_ToastEnded_dbfb6871-4498-4050-b5f1-a0741cf30217);
DB_GOB_GoblinToast_StateManager(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c);
DB_GlobalFlagReactionAfterDialog(GOB_GoblinToast_State_ConfrontedAboutPoisoning_2a1bfba9-36ec-49aa-8540-97cd87301592, GOB_GoblinToast_PoisoningInterrogation_c0f43bec-7a24-c7ba-f392-1edc8d9034fc);
SetOnStage(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, 0);
DB_GOB_GoblinToast_Tub(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562);
DB_CustomForbiddenItemCrimes(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, "GOB_Festivities_NoticedPoisoning", "GOB_Festivities_NoticedPoisoning");
DB_CustomForbiddenItemCrimes(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, "GOB_Festivities_NoticedPoisoning", "GOB_Festivities_NoticedPoisoning");
DB_CRIME_AddressOwnerWithCombatFallback("GOB_Festivities_NoticedPoisoning");
DB_CRIME_AddressOwnerWithCombatFallback("GOB_Festivities_Poisoning");

KBSECTION
IF
TextEvent("debug_goblintoast_poison", _, _, _, _)
THEN
SetOnStage(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, 0);
SetOnStage(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, 1);

IF
TextEvent("debug_goblintoast_spawnpoison", _, _, _, _)
THEN
SetOnStage(S_Debug_GOB_GoblinToast_Poison_220322be-0c04-4bf3-8012-ad43c92d9b38, 1);
SetOnStage(S_Debug_GOB_GoblinToast_Invis_c2605218-07f9-4176-a387-2d74949caa80, 1);
ClearOwnership(S_Debug_GOB_GoblinToast_Poison_220322be-0c04-4bf3-8012-ad43c92d9b38);
ClearOwnership(S_Debug_GOB_GoblinToast_Invis_c2605218-07f9-4176-a387-2d74949caa80);

IF
DB_GlobalFlag(Debug_GOB_GoblinToast_SpawnPoison_4b7f5af4-ba1f-40d5-a06b-e46e13a064f1, _, _, _, _)
THEN
SetOnStage(S_Debug_GOB_GoblinToast_Poison_220322be-0c04-4bf3-8012-ad43c92d9b38, 1);
SetOnStage(S_Debug_GOB_GoblinToast_Invis_c2605218-07f9-4176-a387-2d74949caa80, 1);
ClearOwnership(S_Debug_GOB_GoblinToast_Poison_220322be-0c04-4bf3-8012-ad43c92d9b38);
ClearOwnership(S_Debug_GOB_GoblinToast_Invis_c2605218-07f9-4176-a387-2d74949caa80);

IF
TextEvent("debug_poisoning", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_CharacterRegisterCrime(_Var1, "GOB_Festivities_Poisoning", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TextEvent("debug_poisoning_victim", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_Lead(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_CharacterRegisterCrime(_Var1, "GOB_Festivities_Poisoning", _Var2, _Var2, 0);

IF
TextEvent("goblin_beer_poisoned", _, _, _, _)
THEN
DB_GOB_GoblinToast_PoisonType("GOB_SMALLPOISON");

IF
FlagSet(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
SetFlag(GOB_GoblinToast_Event_NoMoreRefills_5929d40e-8867-2fc6-a0d9-6ab1a7a49696, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_Destroyed(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_Tub(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(GOB_GoblinToast_Event_NoMoreRefills_5929d40e-8867-2fc6-a0d9-6ab1a7a49696, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_GoblinToast_PoisonDieInstantly((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_PoisonedGoblins(_Var1);
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

PROC
PROC_GOB_GoblinToast_PoisonDieStatus((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_PoisonedGoblins(_Var1);
Die(_Var1, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 0);

IF
EntityEvent((CHARACTER)_Var1, "GOB_GoblinToast_DrinkPoisonedBeer", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetFlag(GOB_GoblinToast_State_CrowdGathered_0b99e023-2c0f-4a9d-8e37-5677f50ccd00, NULL_00000000-0000-0000-0000-000000000000, 0, _Var1, _Var1)
AND
GetFlag(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, NULL_00000000-0000-0000-0000-000000000000, 0, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonDieStatus(_Var1);

IF
RequestCanCombine((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (ITEM)_Var2, _, _, _, (INTEGER)_Var6, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_CombineCachedFlag(_Var7, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_CombineCachedFlag(_Var7);

IF
RequestCanCombine((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (ITEM)_Var2, _, _, _, (INTEGER)_Var6, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetStatString(_Var2, _Var7, _Var1, _Var1, _Var1)
AND
DB_FOR_GoblinHuntPoison_PoisonFlags(_Var7, _Var8, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_CombineCachedFlag(_Var8);

IF
Combined(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (ITEM)_Var1, _, _, _, (CHARACTER)_Var5, _, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1)
AND
DB_GOB_GoblinToast_CombineCachedFlag(_Var7, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(_Var7, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(GLO_GoblinHuntPoison_Quest_BeerPoisoned_0c261a18-68f7-4a4b-9e91-b0b5ef50f474, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(GOB_GoblinToast_Quest_Poisoner_a6a1cdda-7b11-4d0b-9d1f-38abb688ef7d, _Var5, 0);

IF
RequestCanCombine((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (ITEM)_Var2, _, _, _, (INTEGER)_Var6, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_OwnersCached(_Var7, _Var8, _Var1, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_OwnersCached(_Var7, _Var8);

IF
RequestCanCombine((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (ITEM)_Var2, _, _, _, (INTEGER)_Var6, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetOriginalOwner(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _Var7, _Var1, _Var1, _Var1)
AND
GetOwner(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _Var8, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_OwnersCached(_Var7, _Var8);

IF
Combined(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _, _, _, _, (CHARACTER)_Var5, (ITEM)_Var6, _, _, _)
AND
DB_GOB_GoblinToast_OwnersCached(_Var7, _Var8, _, _, _)
THEN
NOT DB_GOB_GoblinToast_Tub(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562);
DB_GOB_GoblinToast_Tub(_Var6);
SetOriginalOwner(_Var6, _Var7);
SetOwner(_Var6, _Var8);

IF
StatusApplied(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, "POISONED", (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1)
AND
QRY_OnlyOnce("GOB_GoblinToast_TubPoisoned", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonTub(_Var1);

IF
AttackedBy(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, (GUIDSTRING)_Var1, _, "Poison", _, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_OnlyOnce("GOB_GoblinToast_TubPoisoned", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonTub(_Var1);

PROC
PROC_GOB_GoblinToast_PoisonTub((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_GOB_GoblinToast_SetPoisonerFlag(_Var1);
PROC_GOB_GoblinToast_PretendCombinePoison();
SetFlag(GLO_GoblinHuntPoison_Quest_BeerPoisoned_0c261a18-68f7-4a4b-9e91-b0b5ef50f474, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GLO_GoblinHuntPoison_Quest_BeerPoisoned_BasicPoison_33a52748-6b1f-458c-9ae0-7a3aef8848c6, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_GoblinToast_PretendCombinePoison()
THEN
SetOnStage(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, 1);

PROC
PROC_GOB_GoblinToast_PretendCombinePoison()
AND
GetOriginalOwner(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _Var1, _Var1, _Var1, _Var1)
AND
GetOwner(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _Var2, _Var1, _Var1, _Var1)
THEN
SetOriginalOwner(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, _Var1);
SetOwner(S_GOB_GoblinToast_BeerSkullTub_Poisoned_f29614e3-0388-4331-8ca1-2aa2595ea61d, _Var2);

PROC
PROC_GOB_GoblinToast_PretendCombinePoison()
THEN
SetOnStage(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, 0);

PROC
PROC_GOB_GoblinToast_SetPoisonerFlag((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_GOB_GoblinToast_IsPlayer(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(GOB_GoblinToast_Quest_Poisoner_a6a1cdda-7b11-4d0b-9d1f-38abb688ef7d, _Var1);

PROC
PROC_GOB_GoblinToast_SetPoisonerFlag((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
QRY_GOB_GoblinToast_IsPlayer(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetClosestAlivePlayer(S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _Var2, _, _Var1, _Var1)
THEN
SetFlag(GOB_GoblinToast_Quest_Poisoner_a6a1cdda-7b11-4d0b-9d1f-38abb688ef7d, _Var2);

QRY
QRY_GOB_GoblinToast_IsPlayer((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
IsCharacter(_Var1, 1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
FlagSet(GOB_GoblinToast_Quest_Poisoner_a6a1cdda-7b11-4d0b-9d1f-38abb688ef7d, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _Var1, _Var1)
THEN
StartVoiceBark(GOB_GoblinToast_VB_BoozePoisoned_97f7eef4-8300-9251-875a-72aed3eeaf53, _Var1);

IF
FlagSet(GOB_GoblinToast_Quest_Poisoner_a6a1cdda-7b11-4d0b-9d1f-38abb688ef7d, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_SuspiciousPlayers(_Var1);

IF
FlagSet(GLO_GoblinHuntPoison_Quest_BeerPoisoned_0c261a18-68f7-4a4b-9e91-b0b5ef50f474, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
THEN
DB_GOB_GoblinToast_PoisonType("GOB_SMALLPOISON");

IF
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_PoisonedGoblins(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SysClear("DB_GOB_GoblinToast_LookAtPoisonedGoblin", 1);
DB_GOB_GoblinToast_LookAtPoisonedGoblin(_Var1);
ObjectTimerLaunch(_Var1, "GOB_GoblinToast_IncreaseCounter", 500);

IF
ObjectTimerFinished(_, "GOB_GoblinToast_IncreaseCounter", (GUIDSTRING)_, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_IncreaseCounter("GOB_GoblinToast_PoisonedGoblins");

PROC
PROC_CounterIncreased("GOB_GoblinToast_PoisonedGoblins", (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_GOB_GoblinToast_MaxPoisonedGoblins(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 <= _Var1
THEN
SetFlag(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GLO_GoblinHuntPoison_Quest_BeerPoisoned_0c261a18-68f7-4a4b-9e91-b0b5ef50f474, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var3, _, _, _, _)
AND NOT
DB_CantAct(_Var3, _, _, _, _)
AND
GetFlag(GOB_Festivities_Behaviour_Absent_ed2fbbf4-42b3-4845-865d-39827dedb503, _Var3, 0, _, _)
THEN
TimerLaunch("GOB_GoblinToast_StartToastEvent", 1000);

IF
FlagSet(GLO_GoblinHuntPoison_Quest_BeerPoisoned_0c261a18-68f7-4a4b-9e91-b0b5ef50f474, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var3, _, _, _, _)
AND NOT
DB_CantMove(_Var3, _, _, _, _)
AND
GetFlag(GOB_Festivities_Behaviour_Absent_ed2fbbf4-42b3-4845-865d-39827dedb503, _Var3, 1, _, _)
THEN
SetFlag(GOB_Festivities_Behaviour_StoryBusy_0cd6cbb4-303f-4da1-b75d-cc46beeda854, _Var3);
PROC_CharacterMoveTo(_Var3, S_GOB_Festivities_TableTrigger_004_98a91f82-4840-42ed-bdcd-5c43e6dc6dcd, "Walk", "GOB_GoblinToast_ToasterReadyToInit");

IF
EntityEvent(_, "GOB_GoblinToast_ToasterReadyToInit", (GUIDSTRING)_, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
TimerLaunch("GOB_GoblinToast_StartToastEvent", 1000);

IF
TimerFinished("GOB_GoblinToast_StartToastEvent", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_CantAct(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_GOB_GoblinToast_ChickenChasePostpone()
THEN
DB_GOB_GoblinToast_ToastOngoing(1);
PROC_ForceStopDialog(_Var1);
SetHasDialog(_Var1, 0);
PROC_TryStartAD(GOB_GoblinToast_AD_WalkingTowardsToastPoint_6f801083-a823-3739-03a0-8859fac61ba9, _Var1);
PROC_CharacterMoveTo(_Var1, S_GOB_GoblinToast_ToastPoint_e363d352-2a2b-4c01-87e4-1494eb8a46ad, "Walk", "GOB_GoblinToast_MovedToSayToast");
SetFlag(GOB_GoblinToast_State_CrowdGathered_0b99e023-2c0f-4a9d-8e37-5677f50ccd00, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent((CHARACTER)_Var1, "GOB_GoblinToast_MovedToSayToast", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_Lead(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
LookFromTrigger(_Var2, S_GOB_GoblinToast_ToastPoint_e363d352-2a2b-4c01-87e4-1494eb8a46ad, 0);
SetHasDialog(_Var2, 1);
ObjectTimerLaunch(_Var2, "Timer_GOB_GoblinToast_StartWithoutPlayer", 10000);
PROC_GOB_GoblinToast_StartSpotting();

PROC
PROC_GOB_GoblinToast_StartSpotting()
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SpotPlayers_RestartSpotting(_Var1, "GOB_GoblinToast");

IF
FlagCleared(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, _, _, _, _)
AND
DB_GOB_GoblinToast_ToastWithMovementPostponed(1, _, _, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var3, _, _, _, _)
THEN
NOT DB_GOB_GoblinToast_ToastWithMovementPostponed(1);
DB_GOB_GoblinToast_ToastOngoing(1);
PROC_ForceStopDialog(_Var3);
SetHasDialog(_Var3, 0);
PROC_TryStartAD(GOB_GoblinToast_AD_WalkingTowardsToastPoint_6f801083-a823-3739-03a0-8859fac61ba9, _Var3);
PROC_CharacterMoveTo(_Var3, S_GOB_GoblinToast_ToastPoint_e363d352-2a2b-4c01-87e4-1494eb8a46ad, "Walk", "GOB_GoblinToast_MovedToSayToast");

IF
FlagSet(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, _, _, _, _)
AND
DB_GOB_GoblinToast_ToastOngoing(1, _, _, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var3, _, _, _, _)
THEN
PROC_SpotPlayers_StopSpotting(_Var3, "GOB_GoblinToast");
DB_GOB_GoblinToast_ToastWithMovementPostponed(1);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Var1, "GOB_GoblinToast", (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_StartDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _Var1, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SpotPlayers_RestartSpotting(_Var1, "GOB_GoblinToast");

IF
DialogStarted(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(GOB_GoblinToast_State_ToastIsOn_99a0dc3a-289e-48b3-9710-60388f0d72ed, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_SelectCustomDialog((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_ToastOngoing(1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _Var1, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _Var2);

QRY
QRY_GOB_GoblinToast_ChickenChasePostpone()
AND
DB_GlobalFlag(GOB_ChickenChase_State_PlayingChase_34de58e6-ca4a-d171-c1ac-32821bb036ed, _, _, _, _)
THEN
DB_GOB_GoblinToast_ToastWithMovementPostponed(1);

IF
DialogEnded(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _, _, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var2, _, _, _, _)
THEN
PROC_GOB_GoblinToast_EndToast();

PROC
PROC_GOB_GoblinToast_EndToast()
THEN
ClearFlag(GOB_GoblinToast_State_ToastIsOn_99a0dc3a-289e-48b3-9710-60388f0d72ed, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(GOB_GoblinToast_State_CrowdGathered_0b99e023-2c0f-4a9d-8e37-5677f50ccd00, NULL_00000000-0000-0000-0000-000000000000);
PROC_SpotPlayers_StopSpotting(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "GOB_GoblinToast");
NOT DB_GOB_GoblinToast_ToastOngoing(1);

IF
DialogStarted(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _, _, _, _)
AND
DB_GOB_GoblinToast_Lead(_Var2, _, _, _, _)
THEN
ObjectTimerCancel(_Var2, "Timer_GOB_GoblinToast_StartWithoutPlayer");
ObjectTimerCancel(_Var2, "Timer_GOB_GoblinToast_CancelToast");

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "Timer_GOB_GoblinToast_StartWithoutPlayer", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_TryStartAD(GOB_GoblinToast_AD_SceneWithoutPlayer_4365d7df-3208-5640-6aab-7cc189a576b2, _Var1, S_GOB_Festivities_Goblin_006_f3f416d1-b946-4019-95ba-7053f63dd776, S_GOB_Festivities_Goblin_007_10a00987-1dbe-4540-aa34-e96976c7bac0);

IF
AutomatedDialogStarted(GOB_GoblinToast_AD_SceneWithoutPlayer_4365d7df-3208-5640-6aab-7cc189a576b2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(GOB_GoblinToast_State_ToastIsOn_99a0dc3a-289e-48b3-9710-60388f0d72ed, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GOB_GoblinToast_Event_SceneWithoutPlayerEnded_d9b0b56e-0d25-4c5c-a634-aced3c26d6b3, NULL_00000000-0000-0000-0000-000000000000, _, (INTEGER)_, (INTEGER)_)
THEN
SetHasDialog(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, 0);

IF
AutomatedDialogEnded(GOB_GoblinToast_AD_SceneWithoutPlayer_4365d7df-3208-5640-6aab-7cc189a576b2, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_SceneWithoutPlayerEnded_d9b0b56e-0d25-4c5c-a634-aced3c26d6b3, NULL_00000000-0000-0000-0000-000000000000, 1, _, _)
THEN
PROC_GOB_GoblinToast_EndSceneWithoutPlayer();

IF
AutomatedDialogEnded(GOB_GoblinToast_AD_SceneWithoutPlayer_4365d7df-3208-5640-6aab-7cc189a576b2, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_SceneWithoutPlayerEnded_d9b0b56e-0d25-4c5c-a634-aced3c26d6b3, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
THEN
ObjectTimerLaunch(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "Timer_GOB_GoblinToast_CancelToast", 3000);

IF
ObjectTimerFinished(S_GOB_Festivities_Goblin_004_e63401de-04ea-40b6-a988-b2f90a90f748, "Timer_GOB_GoblinToast_CancelToast", _, _, _)
THEN
PROC_GOB_GoblinToast_EndToast();

IF
AutomatedDialogRequestFailed(GOB_GoblinToast_AD_SceneWithoutPlayer_4365d7df-3208-5640-6aab-7cc189a576b2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_GOB_GoblinToast_EndToast();

PROC
PROC_GOB_GoblinToast_EndSceneWithoutPlayer()
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ObjectTimerLaunch(_Var1, "Timer_GOB_GoblinToast_StartWithoutPlayerDelay", 1000);

IF
ObjectTimerFinished((CHARACTER)_Var1, "Timer_GOB_GoblinToast_StartWithoutPlayerDelay", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_GOB_GoblinToast_ToasterInMainDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(GOB_GoblinToast_Event_ToastSuccess_8567a81c-abe6-cbea-0090-7b9af53aee39, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(GOB_GoblinToast_ToastWasWithoutPlayer_d2fe6e01-7fb2-48d9-9e85-3153ee3799b2, NULL_00000000-0000-0000-0000-000000000000);
NOT DB_GOB_GoblinToast_CommentAfterPoison(3, 1000, 4000);
DB_GOB_GoblinToast_CommentAfterPoison(4, 4000, 8000);
PROC_SpotPlayers_StopSpotting(_Var1, "GOB_GoblinToast");
PROC_GOB_GoblinToast_DrinkAndDieWithoutPlayer();

QRY
QRY_GOB_GoblinToast_ToasterInMainDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_DialogNPCs(_Var2, _Var1, _, _Var1, _Var1)
AND
DB_DialogName(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _Var2, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_GOB_GoblinToast_DrinkAndDieWithoutPlayer()
THEN
ObjectTimerLaunch(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "Timer_GOB_GoblinToast_Aftermath", 6000);

PROC
PROC_GOB_GoblinToast_DrinkAndDieWithoutPlayer()
AND
DB_GOB_GoblinToast_ToastParticipants(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var1, S_GOB_GoblinToast_ToastDyingArea_d5f5a1a4-5a3f-411d-8e96-86dea301a508, 1, _Var1, _Var1)
AND NOT
DB_CantAct(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
Random(1000, _Var2, _Var1, _Var1, _Var1)
THEN
SetHasDialog(_Var1, 0);
ObjectTimerLaunch(_Var1, "GOB_GoblinToast_DrinkingAnimationDelay", _Var2);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "GOB_GoblinToast_DrinkingAnimationDelay", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PlayAnimation(_Var1, CUST_Drinking_01_fab141d9-e068-4f2e-ba44-699b6d9b3636, "");

PROC
PROC_GOB_GoblinToast_DrinkAndDieWithoutPlayer()
AND
DB_GOB_GoblinToast_Lead(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var1, S_GOB_GoblinToast_ToastDyingArea_d5f5a1a4-5a3f-411d-8e96-86dea301a508, 1, _Var1, _Var1)
AND NOT
DB_CantAct(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetHasDialog(_Var1, 0);
PlayAnimation(_Var1, CUST_Drinking_01_fab141d9-e068-4f2e-ba44-699b6d9b3636, "");

IF
ObjectTimerFinished(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "Timer_GOB_GoblinToast_Aftermath", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_ToastParticipants(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetHasDialog(_Var1, 1);

IF
ObjectTimerFinished(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "Timer_GOB_GoblinToast_Aftermath", _, _, _)
THEN
ClearFlag(GOB_GoblinToast_State_ToastIsOn_99a0dc3a-289e-48b3-9710-60388f0d72ed, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_GoblinToast_SuccessAftermath();

IF
DialogEnded(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, _, _, _, _)
AND
DB_GlobalFlag(GOB_GoblinToast_Event_ToastSuccess_8567a81c-abe6-cbea-0090-7b9af53aee39, _, _, _, _)
THEN
PROC_GOB_GoblinToast_SuccessAftermath();

PROC
PROC_GOB_GoblinToast_SuccessAftermath()
THEN
DB_GOB_GoblinToast_SuccessAftermath(1);

PROC
PROC_GOB_GoblinToast_SuccessAftermath()
THEN
SetFlag(GOB_GoblinToast_State_ToastEnded_dbfb6871-4498-4050-b5f1-a0741cf30217, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_GoblinToast_SuccessAftermath()
AND
DB_GOB_GoblinToast_GoblinsToPoison(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var1, S_GOB_GoblinToast_ToastDyingArea_d5f5a1a4-5a3f-411d-8e96-86dea301a508, 1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ObjectTimerLaunch(_Var1, "GOB_GoblinToast_DieAfterToast", _Var2);

PROC
PROC_GOB_GoblinToast_SuccessAftermath()
AND
DB_GLO_DefeatCounter(_Var1, "GOB_FestivitiesArea", _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var1, S_GOB_GoblinToast_ToastDyingArea_d5f5a1a4-5a3f-411d-8e96-86dea301a508, 1, _Var1, _Var1)
AND NOT
DB_GOB_GoblinToast_GoblinsToPoison(_Var1, _, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
Random(2000, _Var3, _Var1, _Var1, _Var1)
AND
IntegerSum(_Var3, 1000, _Var4, _Var1, _Var1)
THEN
ObjectTimerLaunch(_Var1, "GOB_GoblinToast_DamageAfterToast", _Var4);

IF
ObjectTimerFinished((CHARACTER)_Var1, "GOB_GoblinToast_DieAfterToast", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
PROC_GOB_GoblinToast_PoisonDieInstantly(_Var1);

IF
ObjectTimerFinished((CHARACTER)_Var1, "GOB_GoblinToast_DamageAfterToast", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetHitpoints(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
_Var2 > 1
AND
IntegerDivide(_Var2, 2, _Var3, _Var1, _Var1)
THEN
PROC_SetHitpoints_BlockSelfHealing(_Var1, _Var3);

IF
ObjectTimerFinished((CHARACTER)_Var1, "GOB_GoblinToast_DieAfterToast", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_CommentAfterPoison_CountDeaths(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
IntegerSum(_Var2, 1, _Var3, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_CommentAfterPoison_CountDeaths(_Var2);
DB_GOB_GoblinToast_CommentAfterPoison_CountDeaths(_Var3);

IF
DB_GOB_GoblinToast_CommentAfterPoison_CountDeaths(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_CommentAfterPoison(_Var1, _Var2, _, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_CommentOnStrangersWithDelay(_Var2);

PROC
PROC_GOB_GoblinToast_SuccessAftermath()
AND
DB_GOB_GoblinToast_CommentAfterPoison(_, _, _Var3, _, _)
THEN
PROC_GOB_GoblinToast_CommentOnStrangersWithDelay(_Var3);

PROC
PROC_GOB_GoblinToast_CommentOnStrangersWithDelay((INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_OnlyOnce("GOB_GoblinToast_CommentOnStrangersWithDelay", _Var1, _Var1, _Var1, _Var1)
THEN
TimerLaunch("GOB_GoblinToast_CommentOnStrangers", _Var1);

IF
TimerFinished("GOB_GoblinToast_CommentOnStrangers", _, _, _, _)
AND
QRY_OnlyOnce("GOB_GoblinToast_CommentOnStrangersTimerFinished", _, _, _, _)
THEN
PROC_GOB_GoblinToast_CommentOnStrangers();

IF
DialogEnded(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetFlag(GOB_GoblinToast_Event_DrinkPoisonedBeer_e7c4305b-e83a-dff0-c086-06ddf1038627, _Var2, 1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonPlayer(_Var2);

IF
DialogEnded(GOB_GoblinToast_c8b8655b-8e8d-ddad-0b5b-e2794fa11003, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_GlobalFlag(GOB_GoblinToast_Event_FailedPersuasion_d5328849-e369-1981-115f-d4b35b3b45f5, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_MakeFestivitiesAreaHostile();

PROC
PROC_CounterIncreased("GOB_GoblinToast_PoisonedGoblins", 1, _, _, _)
AND NOT
DB_GOB_GoblinToast_SuccessAftermath(1, _, _, _, _)
THEN
PROC_GOB_GoblinToast_CommentOnPoison(GOB_GoblinToast_AD_TooMuchBeer_001_dee9c3a4-263f-cd41-ec02-6c83d1440ca0);

PROC
PROC_CounterIncreased("GOB_GoblinToast_PoisonedGoblins", 2, _, _, _)
AND NOT
DB_GOB_GoblinToast_SuccessAftermath(1, _, _, _, _)
THEN
PROC_GOB_GoblinToast_CommentOnPoison(GOB_GoblinToast_AD_TooMuchBeer_002_15d56243-7102-42dd-434d-60b7f0dad6bb);

PROC
PROC_CounterIncreased("GOB_GoblinToast_PoisonedGoblins", 3, _, _, _)
AND NOT
DB_GOB_GoblinToast_SuccessAftermath(1, _, _, _, _)
THEN
PROC_GOB_GoblinToast_CommentOnStrangers();

PROC
PROC_GOB_GoblinToast_CommentOnPoison((DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
QRY_GOB_GoblinToast_GetRandomGoblinToCommentOnPoison()
AND
DB_GOB_GoblinToast_GoblinToCommentOnPoison(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_LookAtPoisonedGoblin(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ForceStopDialog(_Var2);
LookAtEntity(_Var2, _Var3);
NOT DB_GOB_GoblinToast_LookAtPoisonedGoblin(_Var3);
PROC_TryStartAD(_Var1, _Var2);

PROC
PROC_GOB_GoblinToast_RegisterPoisoning()
AND
GetHostCharacter(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "HIDDEN_WLD_Boosters", "GOB_GoblinToast_Poisoned");

PROC
PROC_GOB_GoblinToast_RegisterPoisoning()
THEN
NOT DB_GOB_GoblinToast_SuccessAftermath(1);
SetFlag(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, NULL_00000000-0000-0000-0000-000000000000);
SetFaction(S_GOB_Festivities_Bugbear_Wanderer_c45936ea-2e38-4cf5-b5e1-1ff382888737, ACT1_GOB_FestivitiesAreaGoblins_0e01ffb1-ecd5-834b-edc4-f19a61dcd405);

PROC
PROC_GOB_GoblinToast_RegisterPoisoning()
AND
DB_GOB_GoblinToast_SuspiciousPlayers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GOB_GoblinToast_RegisteredCriminals(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_RegisteredCriminals(_Var1);
PROC_CharacterRegisterCrime(_Var1, "GOB_Festivities_Poisoning", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(GOB_GoblinToast_State_ConfrontedAboutPoisoning_2a1bfba9-36ec-49aa-8540-97cd87301592, _, _, _, _)
AND
DB_Players(_Var3, _, _, _, _)
THEN
CharacterStopCrime(_Var3, "GOB_Festivities_Poisoning", NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Var1, "GOB_Festivities_Poisoning", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, _)
AND
GetFlag(GOB_GoblinToast_State_ConfrontedAboutPoisoning_2a1bfba9-36ec-49aa-8540-97cd87301592, NULL_00000000-0000-0000-0000-000000000000, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_GOB_GoblinToast_RegisterPoisoning()
THEN
ObjectTimerLaunch(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "GOB_GoblinToast_CheckIfSpotted", 5000);

IF
ObjectTimerFinished(_, "GOB_GoblinToast_CheckIfSpotted", _, _, _)
AND NOT
DB_DialogName(GOB_GoblinToast_PoisoningInterrogation_c0f43bec-7a24-c7ba-f392-1edc8d9034fc, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
THEN
PROC_GOB_GoblinToast_SendGoblinToDestroyTub();
ObjectTimerLaunch(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "GOB_GoblinToast_ToStations", 1000);

PROC
PROC_GlobalFlagReactionAfterDialog(GOB_GoblinToast_State_ConfrontedAboutPoisoning_2a1bfba9-36ec-49aa-8540-97cd87301592, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
THEN
PROC_GOB_GoblinToast_SendGoblinToDestroyTub();
ObjectTimerLaunch(S_GOB_Festivities_Coordinator_f2cd133a-8339-4043-9277-e5dd8fe93e5f, "GOB_GoblinToast_ToStations", 1000);

IF
ObjectTimerFinished(_, "GOB_GoblinToast_ToStations", _, _, _)
AND NOT
DB_DialogName(GOB_GoblinToast_AD_ToStations_9369ece0-ff61-bbee-78f0-d394bd4e08f5, _, _, _, _)
THEN
SetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000);

IF
ObjectTimerFinished(_, "GOB_GoblinToast_ToStations", _, _, _)
AND
DB_DialogName(GOB_GoblinToast_AD_ToStations_9369ece0-ff61-bbee-78f0-d394bd4e08f5, _, _, _, _)
THEN
DB_GOB_GoblinToast_SendToStationsAfterDialog(1);

IF
AutomatedDialogEnded(GOB_GoblinToast_AD_ToStations_9369ece0-ff61-bbee-78f0-d394bd4e08f5, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_GOB_GoblinToast_SendToStationsAfterDialog(1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_SendToStationsAfterDialog(1);
SetFlag(GOB_GoblinToast_Event_ToStations_0b555ee8-2b8e-3881-b35e-9811f6baf77a, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GOB_GoblinToast_SendGoblinToDestroyTub()
AND
QRY_IsEmptyDB("DB_GOB_GoblinToast_DestroyingTubGoblin", 1, _, _, _)
AND
QRY_GOB_GoblinToast_NotAllParticipantsDead()
AND
QRY_GOB_GoblinToast_GetRandomGoblinToCommentOnPoison()
AND
DB_GOB_GoblinToast_GoblinToCommentOnPoison(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_DestroyingTubGoblin(_Var1);
SetFlag(GOB_GoblinToast_State_DestroyingTub_5f3d9ca8-b7bb-e0d3-f3a8-c6cab3f775ac, _Var1);
PROC_TryStartAD(GOB_GoblinToast_AD_ToStations_9369ece0-ff61-bbee-78f0-d394bd4e08f5, _Var1);

IF
FlagSet(GOB_GoblinToast_Event_DestroyTub_b7337301-f6e7-40d3-be8a-df00d82a838c, (ITEM)_Var1, _, (ITEM)_Var1, (ITEM)_Var1)
THEN
Die(_Var1);

IF
FlagSet(GOB_GoblinToast_Event_DestroyTub_b7337301-f6e7-40d3-be8a-df00d82a838c, (ITEM)_Var1, _, (ITEM)_Var1, (ITEM)_Var1)
AND
DB_GOB_GoblinToast_DestroyingTubGoblin(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_DestroyingTubGoblin(_Var3);
ClearFlag(GOB_GoblinToast_State_DestroyingTub_5f3d9ca8-b7bb-e0d3-f3a8-c6cab3f775ac, _Var3);

PROC
PROC_GOB_GoblinToast_CommentOnStrangers()
AND NOT
QRY_GOB_GoblinToast_NotAllParticipantsDead()
THEN
PROC_GOB_GoblinToast_RegisterPoisoning();

PROC
PROC_GOB_GoblinToast_CommentOnStrangers()
AND
QRY_GOB_GoblinToast_NotAllParticipantsDead()
THEN
TimerLaunch("GOB_GoblinToast_CheckAttackAD", 2000);
PROC_GOB_GoblinToast_MakeRandomGoblinCommentOnStrangers();

PROC
PROC_GOB_GoblinToast_MakeRandomGoblinCommentOnStrangers()
AND
QRY_GOB_GoblinToast_GetRandomGoblinToCommentOnPoison()
AND
DB_GOB_GoblinToast_GoblinToCommentOnPoison(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("GOB_GoblinToast_CommentOnStrangers", _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_LookAtPoisonedGoblin(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
LookAtEntity(_Var1, _Var2, 2);
PROC_TryStartAD(GOB_GoblinToast_AD_Attack_4fc811cb-6a63-476a-7aae-1eb269b8230e, _Var1);
PROC_GOB_GoblinToast_LookAtSpeaker(_Var1);

PROC
PROC_GOB_GoblinToast_LookAtSpeaker((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GOB_GoblinToast_SuccessAftermath(1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_ToastParticipants(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_CantAct(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 != _Var1
THEN
LookAtEntity(_Var2, _Var1);

QRY
QRY_GOB_GoblinToast_GetRandomGoblinToCommentOnPoison()
AND
SysCount("DB_GOB_GoblinToast_ToastParticipants", 1, _Var1, _Var1, _Var1)
AND
Random(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
IntegerSum(_Var2, 1, _Var3, _Var1, _Var1)
AND
SysFactAtIndex("DB_GOB_GoblinToast_ToastParticipants", 1, _Var3, "DB_GOB_GoblinToast_GoblinToCommentOnPoison", _Var1)
THEN
DB_NOOP(1);

QRY
QRY_GOB_GoblinToast_NotAllParticipantsDead()
AND
DB_GOB_GoblinToast_ToastParticipants(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
AutomatedDialogStarted(GOB_GoblinToast_AD_Attack_4fc811cb-6a63-476a-7aae-1eb269b8230e, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_GOB_GoblinToast_AttackADStarted(1);

IF
TimerFinished("GOB_GoblinToast_CheckAttackAD", _, _, _, _)
AND NOT
DB_GOB_GoblinToast_AttackADStarted(1, _, _, _, _)
THEN
PROC_GOB_GoblinToast_RegisterPoisoning();

IF
AutomatedDialogEnded(GOB_GoblinToast_AD_Attack_4fc811cb-6a63-476a-7aae-1eb269b8230e, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_GOB_GoblinToast_RegisterPoisoning();

IF
AutomatedDialogRequestFailed(GOB_GoblinToast_AD_Attack_4fc811cb-6a63-476a-7aae-1eb269b8230e, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_GOB_GoblinToast_RegisterPoisoning();

IF
FlagSet((GUIDSTRING)_Var1, NULL_00000000-0000-0000-0000-000000000000, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_GOB_GoblinToast_StateManager(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_StateManager_ChangeCurrentState(_Var1);

PROC
PROC_GOB_GoblinToast_StateManager_ChangeCurrentState((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_GOB_GoblinToast_StateManager(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 != _Var1
THEN
ClearFlag(_Var2, NULL_00000000-0000-0000-0000-000000000000);

IF
TemplateUseFinished((CHARACTER)_Var1, DEC_Goblins_Camp_CookingPot_A_Poisoned_Dynamic_015ac04c-2568-4668-a672-339448c58154, (ITEM)_Var2, 1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_PoisonType(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonPlayer(_Var1);

IF
RequestCanCombine((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var7, _Var1, _Var1, _Var1, _Var1)
AND
IsInTrigger(_Var7, S_GOB_Festivities_BingeArea_f4a4031d-7e0c-45b8-970b-47c62d4908d8, 1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_SuspiciousPlayers(_Var7);

IF
StoppedCombining((CHARACTER)_Var1, S_GOB_GoblinToast_BeerSkullTub_43d2f409-e9cb-4bbe-974c-b1e2cce87562, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
CharacterStopCrime(_Var1, "GOB_Festivities_NoticedPoisoning", NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded(GOB_GoblinToast_NoticedPoisoning_71d701f1-6ed7-d416-49be-39f727bf91ab, _, _, _, _)
AND
GetFlag(GOB_GoblinToast_PoisoningRedHanded_f79b4e0d-7b96-4aae-9560-0687cc2287b6, NULL_00000000-0000-0000-0000-000000000000, 1, _, _)
THEN
SetFlag(GOB_GoblinToast_Event_NoMoreRefills_5929d40e-8867-2fc6-a0d9-6ab1a7a49696, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_MakeFestivitiesAreaHostile();

IF
DialogActorLeft(GOB_GoblinToast_NoticedPoisoning_71d701f1-6ed7-d416-49be-39f727bf91ab, _, (CHARACTER)_Var2, _, _)
AND
GetFlag(GOB_GoblinToast_GoblinBulliedAway_26f42c2a-f07c-407c-bb42-d25a1c56a769, _Var2, 1, _, _)
THEN
PROC_DisappearOutOfSightTo(_Var2, S_GOB_GoblinToast_RunAway_8cebe5cb-1960-4f45-90ee-cb075a1e81aa, "Sprint", 0, "");

PROC
PROC_LongRest()
AND
DB_GOB_GoblinToast_PoisonType(_, _, _, _, _)
THEN
SetFlag(GOB_GoblinToast_State_RealizedPoison_0e867c08-b2b9-4f43-8260-168026663e2c, NULL_00000000-0000-0000-0000-000000000000);
PROC_GOB_GoblinToast_ApplyPoisonedStatusBehindScenes();

IF
LeftTrigger((CHARACTER)_Var1, S_GOB_CampFirstHalfArea_d98ba3fa-743e-4d0e-98d8-2b3f79c17647, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_CheckOtherPlayersInTrigger(_Var1, S_GOB_CampFirstHalfArea_d98ba3fa-743e-4d0e-98d8-2b3f79c17647, _Var1, _Var1, _Var1)
AND
DB_GOB_GoblinToast_PoisonType(_, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_ApplyPoisonedStatusBehindScenes();

PROC
PROC_GOB_GoblinToast_ApplyPoisonedStatusBehindScenes()
AND
DB_GOB_GoblinToast_GoblinsToPoison(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_GOB_GoblinToast_PoisonDieInstantly(_Var1);

PROC
PROC_StateSet_PermaDefeated((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GOB_GoblinToast_ToastParticipants(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_GOB_GoblinToast_ToastParticipants(_Var1);

IF
EnteredLevel((ITEM)_Var1, INTERACT_DEC_Goblins_Camp_CookingPot_A_Poisoned_015ac04c-2568-4668-a672-339448c58154, "WLD_Main_A", (ITEM)_Var1, (ITEM)_Var1)
AND
IsInTrigger(_Var1, S_GOB_GoblinHuntPoison_BarrelTrigger_07accba9-1adf-4bb6-9d15-17c6b9c44eee, 1, _Var1, _Var1)
THEN
DB_GOB_GoblinToast_NewTub(_Var1);

IF
FlagSet(GOB_GoblinToast_State_DestroyingTub_5f3d9ca8-b7bb-e0d3-f3a8-c6cab3f775ac, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_GOB_GoblinToast_NewTub(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
SetDualEntityEvent(_Var1, _Var3, "GOB_GoblinToast_NewTub");

PROC
PROC_GOB_GoblinToast_PoisonPlayer((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
IsTagged(_Var1, POISONED_ADV_494276cb-a499-4843-a985-a11926bf2785, _Var2, _Var1, _Var1)
THEN
RequestPassiveRoll(_Var1, _Var1, "SavingThrow", "Constitution", Act1_Hard_831e1fbe-428d-4f4d-bd17-4206d6efea35, _Var2, "GOB_GoblinToast_PoisonSavingThrow");

IF
RollResult("GOB_GoblinToast_PoisonSavingThrow", (CHARACTER)_Var1, _, (INTEGER)_Var3, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
_Var3 != 1
THEN
ApplyStatus(_Var1, "GOB_SMALLPOISON", 60);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act1"
