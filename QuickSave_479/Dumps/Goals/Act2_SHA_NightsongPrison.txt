Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_GLO_CompoundFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3);
DB_PartyDialogSuppressionZone(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);
DB_ItemDialog_NarratorAD(S_SHA_NightsongPrison_EntrancePlaque_308f465c-2294-4663-b989-074a258614b8, SHA_NightsongPrison_AD_EntrancePlaque_e84e77bc-68e2-2241-013f-c8b64a6119db);
DB_DropMutingStatussesDialog(SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87);
DB_FlagReactionAfterDialog(SHA_NightsongPrison_Event_StartReadyCheck_9344260b-727a-6a3f-34da-fb28a1ba1116, SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87);
DB_DropMutingStatussesDialog(SHA_NightsongPrison_CINE_EnterWater_0517fe06-0777-8773-9784-dc9e2e9d7107);
DB_AddCharactersInTriggerToDialog(SHA_NightsongPrison_CINE_EnterWater_0517fe06-0777-8773-9784-dc9e2e9d7107, S_SHA_NightsongPrison_Entrance_e28c4917-5918-4b41-92f2-26951dcb1344, 1, 0, 1);
DB_DropMutingStatussesDialog(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72);
DB_AddCharactersInTriggerToDialog(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, 1, 0, 1);
DB_DialogBlockAttackButton(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72);
DB_DialogBlockTradeButton(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72);
PROC_TriggerRegisterForPlayers(S_SHA_NightsongPrison_GatherPartyArea_8f3c363b-b497-4318-ae1d-f5dd20d034bb);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_Entrance_e28c4917-5918-4b41-92f2-26951dcb1344);
PROC_TriggerRegisterForPlayers(S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_Entrance_e28c4917-5918-4b41-92f2-26951dcb1344, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_EntranceADTrigger_eadfb071-e08f-451d-bbd3-aa907d695596, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_EntryTrigger_000_234ce37b-9610-4748-b35e-c0f96c9647d3);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_EntryTrigger_001_ec7d34d8-c00c-4df9-8bfd-ed7a3d8f2f9d);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb);
PROC_TriggerRegisterForParty(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_000_234ce37b-9610-4748-b35e-c0f96c9647d3, S_SHA_Light_000_297a8774-45df-4b52-997f-186b22bd1a8b, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_000_234ce37b-9610-4748-b35e-c0f96c9647d3, S_SHA_Light_001_4656a59d-2747-4f97-965f-4d7cabd6f396, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_001_ec7d34d8-c00c-4df9-8bfd-ed7a3d8f2f9d, S_SHA_Light_002_1c8b2a4b-9acc-47c0-92cb-7441524b0eba, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_001_ec7d34d8-c00c-4df9-8bfd-ed7a3d8f2f9d, S_SHA_Light_003_7a5d419f-8f68-41ab-8609-6e9c4592e866, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_004_0daf8377-cd86-47b5-aadc-24d2ebc69305, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_005_a8246a66-44a4-4aff-b2e4-bf8890caf157, 200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_006_c5eadee0-b01b-42a6-8d85-c19fb412339c, 100);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_007_fec0e312-0c5c-4b45-95df-77dc53dc8685, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_008_025a8fcb-1ae3-4bd1-99cf-5dec70b28305, 300);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_009_71716d8d-3057-49b8-a08f-be3ac46e585f, 400);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_010_8b5d32c5-4973-478b-ba9e-6f6446308eab, 500);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_011_0c31c38e-45d0-4b01-8eba-aff87b5136cd, 500);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_012_aa932bb5-ec02-4ad0-a5bd-6da981dde9eb, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_013_39dcf2d8-e347-4fa7-bc0d-56bd9b8aa4a7, 100);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_014_56700af1-fb2e-453e-8c5b-652a17d02d3a, 100);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_015_65722b3c-ad19-4533-96a8-f70c0a3de888, 300);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_016_67f2fefd-37d9-4779-86b0-01290da09f2f, 1200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_017_3cf9ac6e-b79b-4336-82f4-f8bb07aad627, 500);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_018_15d5654b-ce02-45ce-acd0-f3f50699941f, 1200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_002_74680fe4-4a59-4581-b653-bdb5a5f42adb, S_SHA_Light_019_ed7daa46-ba76-41ee-ab0e-ae273d79ff47, 300);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_020_464563fe-9bfe-42c6-9d03-a1297f1370b7, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_021_61fb3b17-ef2c-4ab4-8b3d-bb801fbd7150, 200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_022_868bc886-2f10-4a8c-9c28-8018b2e673ae, 500);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_023_6046754a-97c1-47f6-b939-3ba9a95c4943, 300);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_024_a822b564-1f92-4441-bf79-41c24e1be886, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_025_4a61e46a-bcc1-4537-8558-3acef039cfa9, 300);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_026_38c000f9-ebe3-4c6e-8d35-71f54add4167, 500);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_027_2c8b13de-6d2f-4aad-91db-0c45dae9d5a8, 900);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_028_a654b8ff-4666-4c1a-b3a6-24de2fba77f3, 900);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_029_9cc1ca9e-f25b-4e26-b2db-ee4000286bd0, 0);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_030_ac921939-2292-47d6-b8e7-0324fb1eacd1, 200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_031_e450b24d-9b41-43dc-ad4d-6e4780e78541, 200);
DB_SHA_NightsongPrison_Lights(S_SHA_NightsongPrison_EntryTrigger_003_4f2cb8cd-7031-4fc9-ab8a-f8bbeaa9fedc, S_SHA_Light_032_e8979cc9-adfa-44dd-96c3-e6c165e8974d, 200);
DB_ItemDialog_NarratorAD(S_SHA_StealthPlaque_28e77594-4469-4d9d-bdec-e0ce1681f177, SHA_NightsongPrison_AD_StealthPlaque_db88ba34-c1d3-00df-ec0c-0ac6e7bdea1a);
DB_ItemDialog_NarratorAD(S_SHA_MartialPlaque_8e28fe32-e46f-4e8c-9e86-d60d2488f261, SHA_NightsongPrison_AD_MartialPlaque_58e34526-74c5-9ed9-73f6-b099cf338df0);
DB_ItemDialog_NarratorAD(S_SHA_DarknessPlaque_7707ef50-3366-4bb6-a9f9-9a2e15938eb8, SHA_NightsongPrison_AD_DarknessPlaque_b19b8686-0db3-4320-6674-38c3279ef073);
DB_OneShot_VoiceBarkTrigger(S_SHA_PreparationRoom_02fd1bb2-5309-4831-8bb0-b22cdfcf1892, SHA_NightsongPrison_VB_ShadowfellEntrance_6817a4ca-8806-d609-1c47-d565221e45f1, "Global");
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_000_2646b41b-387f-4bf9-94ff-296618a7509a, S_SHA_NightsongPrison_VanishTrigger_000_5f2a7831-f0dd-4d88-b522-113c2f100642);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_001_b8b71d98-65b3-4196-acb4-264556620319, S_SHA_NightsongPrison_VanishTrigger_002_8273c3c1-e69e-48f4-8c02-b1921839f838);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_002_f77b6b24-670d-4970-bfde-a1ecb3546d23, S_SHA_NightsongPrison_VanishTrigger_003_fc38202f-70f5-4c95-b808-ad95ba1a3fe4);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_003_9f3f7a89-7a17-479b-ad50-9f6f4a6d9d45, S_SHA_NightsongPrison_VanishTrigger_004_418c57a4-e92c-4f3a-81b8-d035858f9ee9);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_004_f80d8816-99d2-4166-adc1-36671a3a3fca, S_SHA_NightsongPrison_VanishTrigger_005_5786948b-e948-4bb2-b482-56860524fcce);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_005_1e7bfcdd-0120-485e-b536-9ea955434e7c, S_SHA_NightsongPrison_VanishTrigger_009_4d08ca2c-2999-4318-a549-058106b497c4);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_006_6803a3db-ef72-42bf-9285-67bf8ab4f8e2, S_SHA_NightsongPrison_VanishTrigger_010_8d8d6fd9-ddf9-4742-b12c-7bbe0ba23903);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_007_8d3a8ab0-f874-4a99-9fb6-a7398e5a6695, S_SHA_NightsongPrison_VanishTrigger_006_c83351c0-404c-4d32-a051-5037eaf4f0ad);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_008_e10227ef-ac4e-4f57-b867-4daa83589639, S_SHA_NightsongPrison_VanishTrigger_007_83dbd3a3-e1bd-4ad9-88b5-9c967304da74);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_009_970dcd1f-b12e-4e52-981b-a5fdc88bb0b9, S_SHA_NightsongPrison_VanishTrigger_008_5739d4af-fb63-4145-b8f6-b1e968119f8b);
DB_SHA_NightsongPrison_VanishingJusticiars(S_SHA_NightsongPrison_VanishingJusticiar_010_9ef69ab2-d46d-45cb-8f5d-bf65d189b06d, S_SHA_NightsongPrison_VanishTrigger_001_a9964896-1d09-48f8-8aa6-0edf5cac79e9);
DB_KeepDialogsOnDeath(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
DB_IgnoreMutingStatussesDialog(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_AddCharactersInTriggerToDialog(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, 1, 0, 1);
DB_DialogBlockAttackButton(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_IgnoreMutingStatussesDialog(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_AddCharactersInTriggerToDialog(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, 1, 0, 1);
DB_DialogBlockAttackButton(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_DialogBlockAttackButton(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_IgnoreMutingStatussesDialog(SHA_NightsongPrison_NightsongFreed_ba59f509-df8b-9bd9-431d-524f367cc14b);
DB_AddCharactersInTriggerToDialog(SHA_NightsongPrison_NightsongFreed_ba59f509-df8b-9bd9-431d-524f367cc14b, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, 1, 0, 1);
DB_DialogBlockAttackButton(SHA_NightsongPrison_NightsongFreed_ba59f509-df8b-9bd9-431d-524f367cc14b);
DB_IgnoreMutingStatussesDialog(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09);
DB_DialogBlockAttackButton(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09);
DB_HostileToPlayerGroupCancelFlag(SHA_Nightsong_Event_Resurrected_43ea94b5-f929-4eb4-baea-b9cdc459b53f, ACT1_SHA_Nightsong_89d54194-f9fd-4a99-879a-e11971bfe3e4);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, SHA_NightsongPrison_NightsongFreed_ba59f509-df8b-9bd9-431d-524f367cc14b);
DB_FlagReactionAfterDialog(SHA_NightsongPrison_Event_StartNightsongFreedDialog_737d8c1e-7970-2c6c-06ec-8ccb3a9bf25e, SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_FlagReactionAfterDialog(SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);
DB_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_Event_NecroSummonsSkellies_8649c31d-15bf-dd68-5cc0-828e6f44af0f, SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);
DB_GLO_DieFlag(SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0, NULL_00000000-0000-0000-0000-000000000000);
DB_PlayerHasTemplateItem(SHA_SharSpear_d590884d-55a2-4136-9777-531ee7d53f7e, SHA_NightsongPrison_State_HasSpear_08b1de4b-9f5c-41aa-93ec-9bf4376754b6);
DB_SHA_NightsongPrison_NecroAndNightsongSpeakers(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, NULL_00000000-0000-0000-0000-000000000000);
DB_SHA_NightsongPrison_NecroAndNightsongSpeakers(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, NULL_00000000-0000-0000-0000-000000000000, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
TriggerRegisterForCharacter(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
SetOnStage(S_SHA_NightsongPrison_Waypoint_3e872c6c-95d1-47ef-85b5-bfa835ebb525, 0);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_000_cc668fa4-557e-41c1-bd5b-78a1fe478eb4, S_SHA_NightsongPrison_Skeleton_Caster_001_b273e9ee-12b0-4b7a-904c-249c2d96cbcd);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_006_5dbc8a80-2d82-4f73-a000-cc8ff0538be2, S_SHA_NightsongPrison_Skeleton_Caster_002_568fe93a-bfb9-442d-ad0c-072b3647312c);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_015_6cf85f22-841f-4fbe-8948-c071666f1008, S_SHA_NightsongPrison_Skeleton_Caster_003_8cf15356-011f-43a0-b4e6-9bdbaa9ec00a);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_022_4d3501ba-e7c1-4109-83bd-50105364ef05, S_SHA_NightsongPrison_Skeleton_Melee_001_c7dc19c7-d335-4c92-b7ec-eb83e55af583);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_002_3e9e5c02-f58e-44b7-9a82-a48a59a75783, S_SHA_NightsongPrison_Skeleton_Melee_002_f9f5e14b-15f2-4cc2-8c11-89511fb6e048);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_019_3e0a68b4-a9e0-47fe-b8fd-6865dbdb651c, S_SHA_NightsongPrison_Skeleton_Melee_003_4a89535a-7bba-4389-bfea-e06f0e428c52);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_023_3e8dc625-e551-4cb8-a83a-e63cbd9f3328, S_SHA_NightsongPrison_Skeleton_Melee_004_ee76571d-62ca-41cd-b09a-b20c933d527c);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_001_7e8038fa-8173-4262-99d7-e5626b3e04ae, S_SHA_NightsongPrison_Skeleton_Melee_005_3289b74b-c010-4406-b380-2a5d521cf707);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_016_9ed5cfcd-1e23-491c-a3d9-f2983afd3e7e, S_SHA_NightsongPrison_Skeleton_Melee_006_c5fcc305-5505-4e17-9143-7397159952c7);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_017_0743ffc9-6aa4-4055-9426-f67478baaabf, S_SHA_NightsongPrison_Skeleton_Melee_007_1f2ce750-bd4a-4ffc-b42b-3427e6253477);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_018_6a58f358-52a6-4b65-a098-588e29a90ac8, S_SHA_NightsongPrison_Skeleton_Melee_008_ebc74f77-af62-4952-9677-44bc33dc40a1);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_011_440fd08d-c27f-4f9d-9048-50b896a88cb5, S_SHA_NightsongPrison_Skeleton_Ranger_001_99b3bfee-594a-4e90-8bb7-41b77514b462);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_007_c035cd1d-743d-4434-b662-13537e73ff51, S_SHA_NightsongPrison_Skeleton_Ranger_002_8d9dde65-c868-4f88-a23d-8f62da9db6e9);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_008_10b26022-ea85-44d6-93ec-f32f0e04c1ae, S_SHA_NightsongPrison_Skeleton_Ranger_003_396f039e-7b50-4d13-abca-b0537986ea9d);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_009_6d9a8ad5-952b-4f19-bf29-4cc993fc5e3e, S_SHA_NightsongPrison_Skeleton_Ranger_004_658542ef-f47e-40a2-a6a4-07e15ceb55de);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_010_2a22c249-a4d3-44d7-a2d2-3e77d0d3b928, S_SHA_NightsongPrison_Skeleton_Ranger_005_091d9b80-ed6b-49fc-a56f-4676324c684f);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_012_92e43fdb-1e25-46f1-a9db-298f4515ee77, S_SHA_NightsongPrison_Skeleton_Ranger_006_75798310-e2c3-4f4c-9ba1-2e48ab594819);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_003_66241024-0a39-4931-ba4d-2a72fce8fe4c, S_SHA_NightsongPrison_Skeleton_Giant_001_53f672fa-0724-44cf-b536-19e1df33d4eb);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_020_be305a26-0b47-4bf8-bbac-748a3805718f, S_SHA_NightsongPrison_Skeleton_Giant_002_2a747f03-f547-4043-ada5-7cd7311487a4);
DB_SHA_NightsongPrison_BalthazarSkeletons(S_SHA_NightsongPrison_BonePile_021_3ac701c7-00c3-487b-b908-ff35175efa29, S_SHA_NightsongPrison_Skeleton_Giant_003_405c8ca9-02fb-46a9-b394-86adb963a6c0);

KBSECTION
IF
DB_InRegion(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, _, _, _)
THEN
PROC_SceneDialogOnly("SHA_NightsongPrison_MeetingNightsong", S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562);
DB_SpotPlayers(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong", NULL_00000000-0000-0000-0000-000000000000, SHA_NightsongPrison_Event_MeetingNightsong_StopSpotting_f5d00e70-c888-471e-9257-2266844aa828);
DB_SpotPlayers_Continuous(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong");
DB_SpotPlayers_SpotTrigger(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong", S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562);
DB_Dialogs(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c);

IF
DB_InRegion(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, _, _, _)
THEN
PROC_RemoveAllDialogEntriesForSpeaker(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);
PROC_SceneDialogOnly("SHA_NightsongPrison_MeetingNightsong", S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562);
DB_SpotPlayers(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", NULL_00000000-0000-0000-0000-000000000000, SHA_NightsongPrison_Event_MeetingNightsong_StopSpotting_f5d00e70-c888-471e-9257-2266844aa828);
DB_SpotPlayers_Continuous(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong");
DB_SpotPlayers_SpotTrigger(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562);
DB_Dialogs(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385);

PROC
PROC_SceneInterrupted((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, "SHA_NightsongPrison_MeetingNightsong", "Spotted", (GUIDSTRING)_Var1)
AND
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(_Var3, _, _, _Var1, _Var1)
AND
QRY_StartDialog(_Var3, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var2, _Var1, _Var1)
THEN
SetFlag(SHA_NightsongPrison_Event_MeetingNightsong_StopSpotting_f5d00e70-c888-471e-9257-2266844aa828);
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");

PROC
PROC_SceneInterrupted(_, (CHARACTER)_Var2, "SHA_NightsongPrison_MeetingNightsong", (STRING)_Var3, _)
AND
_Var3 != "StartedDialog"
AND
_Var3 != "Spotted"
AND
_Var3 != "Unspotted"
AND
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _, _, _)
THEN
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
PROC_SetRelationToPlayers(ACT2_SHA_Necromancer_6a8d2366-831d-48ad-8d58-1f99a5cc7ca1, 0);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_SpeakerIsAvailable(S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_SHA_VoiceOfShar_OverrideSpeaker_9293e853-5c10-45a1-a158-ebcde08c02ee);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_SpeakerIsAvailable(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND NOT
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(SHA_NightsongPrison_AD_NightsongUnavailable_61f5c7d5-28ea-07ca-5e2a-876a40839c09, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(_Var2, _Var3, _Var4, _Var1, _Var1)
THEN
DB_SelectedDialog(_Var2, _Var3, _Var1, _Var4);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SceneManager(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_SpeakerIsAvailable(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(SHA_NightsongPrison_AD_NecroUnavailable_afc2832f-e21d-e346-868e-cfe58e4f5025, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(_Var2, _Var3, _Var4, _Var1, _Var1)
THEN
DB_SelectedDialog(_Var2, _Var3, _Var1, _Var4);

QRY
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(_Var2, _Var3, _Var4, _Var1, _Var1)
THEN
NOT DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(_Var2, _Var3, _Var4);

QRY
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SceneManager(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_NightsongPrison_NecroAndNightsongSpeakers(_Var1, _Var2, _Var3, _Var1, _Var1)
THEN
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, _Var2, _Var3);

QRY
QRY_SHA_NightsongPrison_SelectMeetingNightsongDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SceneManager(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND NOT
DB_SceneManager(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_NightsongPrison_MeetingNightsong", _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
DB_QRYRTN_SHA_NightsongPrison_SelectedMeetingNightsongDialog(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", 1, _, _)
THEN
RemoveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GlobalFlag(SHA_NightsongPrison_Event_GiveWeapon_7fa89ca7-3b1c-40ed-83ca-a03bec65e755, _, _, _, _)
THEN
QuestUpdate("HIDDEN_SCL_Boosters", "SCL_NightsongPrison_Weapon");

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, _Var2);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QRY_SpeakerIsAvailable(S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_Player_Jaheira_91b6b200-7d00-4d62-8dc9-99e8339dfa1a);

IF
DialogEnded(SHA_NightsongsFate_OM_Shadowheart_AOM_OOM_COM_7c1dc5a3-0410-ebf4-3b3b-b2ee753562db, _, _, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
THEN
PROC_NightsongPrison_FreeNightsong();

IF
DialogEnded(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, _, _, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
THEN
PROC_NightsongPrison_FreeNightsong();

PROC
PROC_NightsongPrison_FreeNightsong()
THEN
NOT DB_NoLowAttitudeDialog(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_Freed");
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_NightsongFreed");
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
PROC_SelfHealing_Enable(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

PROC
PROC_NightsongPrison_FreeNightsong()
AND NOT
DB_OnlyOnce("SHA_NightsongPrison_StartedNightsongFlightCinematic", _, _, _, _)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailable(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1)
THEN
DB_OnlyOnce("SHA_NightsongPrison_StartedNightsongFlightCinematic");

PROC
PROC_NightsongPrison_FreeNightsong()
THEN
MusicPlayGeneral("NightsongFree");

IF
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
THEN
DB_SHA_NightsongPrison_OngoingCombats(_Var2);

IF
CombatEnded((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_NightsongPrison_OngoingCombats(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_OngoingCombats(_Var1);

IF
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_SHA_NightsongPrison_OngoingCombats(_, _, _, _, _)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
THEN
DB_SHA_NightsongPrison_NightsongAwaitsResurrection(1);

IF
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND NOT
DB_SHA_NightsongPrison_OngoingCombats(_, _, _, _, _)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
THEN
PROC_SHA_NightsongPrison_ResurrectNightsong();

IF
CombatRoundStarted((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_NightsongPrison_OngoingCombats(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_NightsongPrison_NightsongAwaitsResurrection(1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SHA_NightsongPrison_NightsongCanResurrect()
THEN
PROC_SHA_NightsongPrison_ResurrectNightsong();

PROC
PROC_SHA_NightsongPrison_ResurrectNightsong()
AND
DB_Dead(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
GetFaction(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_NightsongAwaitsResurrection(1);
PROC_SetRelationToPlayers(_Var1, 50);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_GROUNDED", -1, 1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION_DOWNED", 0, 1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "GLO_NIGHTSONGRESURRECTION", 0, 1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

QRY
QRY_SHA_NightsongPrison_NightsongCanResurrect()
AND NOT
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtCol", _, _)
AND NOT
DB_GlobalFlag(MOO_Assault_State_InProgress_0f3a8f5d-7402-4220-bebb-d4b21d3db08d, _, _, _, _)
AND NOT
DB_LOW_SorcerousSundries_NightsongImpededByLorroakan(1, _, _, _, _)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0, _, _)
THEN
DB_NOOP(1);

IF
TimerFinished("Nightsong_PostResurrection", _, _, _, _)
AND NOT
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
AND
DB_State_Current(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtTemple", _, _)
THEN
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_NIGHTSONG_SOULCAGE", -1, 1, S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);

IF
KilledBy(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (CHARACTER)_Var1, _, _, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
HasActiveStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", 0, _Var1, _Var1)
THEN
SetFlag(GLO_NightsongPrison_State_KilledNightsong_e50857c8-aaa1-1f12-93bb-6818342a3725, _Var1, 0);

IF
KilledBy(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, (CHARACTER)_Var1, _, _, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetTag(_Var1, DARK_JUSTICIAR_4e4e26e8-9bbf-4913-93c7-c55972a6d051);

IF
FlagSet(SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
NOT DB_KeepDialogsOnDeath(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
NOT DB_PreventPermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b);
ApplyStatus(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_SHARSPEAR_MORTALWOUND", -1, 1, _Var1);

PROC
PROC_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _, _, _)
THEN
PROC_SHA_NightsongPrison_NightsongToMoonrise();

PROC
PROC_SHA_NightsongPrison_NightsongToMoonrise()
THEN
PROC_State_Progress(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_AtMoo");
PROC_State_Progress(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtMoonrise");
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");

PROC
PROC_SHA_NightsongPrison_NightsongToMoonrise()
THEN
TimerLaunch("SHA_NightsongPrison_NightsongsFate_VBTimer", 800);

IF
DialogEnded(SHA_Nightsong_CINE_NightsongsDeath_7c9548d5-b719-60f0-43af-1b963a5e4c6e, _, _, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, _, _, _, _)
THEN
TimerLaunch("SHA_NightsongPrison_NightsongsFate_VBTimer", 800);

IF
DialogEnded(SHA_Nightsong_CINE_NightsongsFlight_71bd5b3a-b21a-4764-2306-7ad8987ebc09, _, _, _, _)
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, _, _, _, _)
THEN
TimerLaunch("SHA_NightsongPrison_NightsongsFate_VBTimer", 800);

IF
TimerFinished("SHA_NightsongPrison_NightsongsFate_VBTimer", _, _, _, _)
THEN
PROC_SHA_NightsongPrison_NightSongFateReaction();

PROC
PROC_SHA_NightsongPrison_NightSongFateReaction()
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_ReactToNightsongsFateVB", _Var1, _Var1, _Var1, _Var1)
THEN
StartVoiceBark(SHA_NightsongPrison_VB_NightsongFateReaction_6c928ed1-2f0a-125b-05a0-3f8060f55d5f, _Var1);

IF
EnteredTrigger((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_NightsongPrison_Lights(_Var2, _Var3, _Var4, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_Lights(_Var2, _Var3, _Var4);
ObjectTimerLaunch(_Var3, "SHA_NightsongPrison_LightDelay", _Var4, 0);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "SHA_NightsongPrison_LightDelay", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
SetEntityEvent(_Var1, "turnOn", 1);

IF
AddedTo(S_SHA_FalseSpearOfNight_846c9caf-1099-4e50-bb9d-d628d02a70ad, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_FalseSpear", _Var1, _Var1, _Var1, _Var1)
THEN
StartVoiceBark(SHA_NightsongPrison_VB_FalseNightSpear_40156197-6ca6-b9c0-6a14-2f6bd9933af8, _Var1);

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_GatherPartyArea_8f3c363b-b497-4318-ae1d-f5dd20d034bb, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_AnyPlayerNotInTrigger(S_SHA_NightsongPrison_GatherPartyArea_8f3c363b-b497-4318-ae1d-f5dd20d034bb, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SHA_NightsongPrison_State_AllPlayersAtEntrance_bcb4d489-aa30-236c-5a85-77d2ec1f939d);

IF
LeftTrigger((GUIDSTRING)_Var1, S_SHA_NightsongPrison_GatherPartyArea_8f3c363b-b497-4318-ae1d-f5dd20d034bb, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_AnyPlayerNotInTrigger(S_SHA_NightsongPrison_GatherPartyArea_8f3c363b-b497-4318-ae1d-f5dd20d034bb, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(SHA_NightsongPrison_State_AllPlayersAtEntrance_bcb4d489-aa30-236c-5a85-77d2ec1f939d);

IF
UseStarted((GUIDSTRING)_Var1, S_SHA_NightsongPrison_ShadowfellEntranceHelper_1fc893ad-277f-4bb3-914c-9bdef4ff0385, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
QRY_SHA_SkipShadowfellDialog()
AND
QRY_StartDialog(SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87, S_SHA_NightsongPrison_ShadowfellEntranceHelper_1fc893ad-277f-4bb3-914c-9bdef4ff0385, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
UseStarted((CHARACTER)_Var1, S_SHA_NightsongPrison_ShadowfellEntranceHelper_1fc893ad-277f-4bb3-914c-9bdef4ff0385, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_SHA_SkipShadowfellDialog()
THEN
PROC_SHA_NightsongPrison_TeleportEffect(_Var1);
PROC_SHA_NightsongPrison_Entrance(_Var1);

QRY
QRY_SHA_SkipShadowfellDialog()
AND
DB_GlobalFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_SHA_SkipShadowfellDialog()
AND
DB_GlobalFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, _, _, _, _)
THEN
DB_NOOP(1);

IF
ReadyCheckPassed("ReadyCheck_EnterNightsongPrison", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_NightsongPrison_StartedReadyCheck(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_SHA_NightsongPrison_AttemptEntranceCinematic(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_NightsongPrison_TeleportEffect(_Var1);
PROC_SHA_NightsongPrison_Entrance(_Var1);

IF
ReadyCheckPassed("ReadyCheck_EnterNightsongPrison", _, _, _, _)
THEN
PROC_State_Progress(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtPrison");

IF
ReadyCheckFailed("ReadyCheck_EnterNightsongPrison", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_NightsongPrison_StartedReadyCheck(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_StartedReadyCheck(_Var1);

IF
SavegameLoaded()
AND
DB_SHA_NightsongPrison_StartedReadyCheck(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_StartedReadyCheck(_Var1);

IF
DialogEnded(SHA_NightsongPrison_CINE_EnterWater_0517fe06-0777-8773-9784-dc9e2e9d7107, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
PROC_SHA_NightsongPrison_TryTeleport(_Var1);

IF
DialogRequestFailed(SHA_NightsongPrison_CINE_EnterWater_0517fe06-0777-8773-9784-dc9e2e9d7107, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
PROC_SHA_NightsongPrison_TryTeleport(_Var1);

PROC
PROC_SHA_NightsongPrison_TryTeleport((INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_NightsongPrison_TeleportEffect(_Var2);
PROC_SHA_NightsongPrison_Entrance(_Var2);

IF
ScreenFadeDone((INTEGER)_Var1, (STRING)_Var2, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_SHA_NightsongPrison_FadeEvents(_Var3, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_FadeEvents(_Var3, _Var2);
ClearScreenFade(_Var3, 2, _Var2);

QRY
QRY_SHA_NightsongPrison_AttemptEntranceCinematic((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_EntranceCinematic", _Var1, _Var1, _Var1, _Var1)
THEN
StartVoiceBark(SHA_NightsongPrison_VB_EnterWater_65a44496-e3e1-62af-13e9-8d39ab007232, _Var1);

PROC
PROC_FlagReactionAfterDialog((GUIDSTRING)_Var1, SHA_NightsongPrison_Event_StartReadyCheck_9344260b-727a-6a3f-34da-fb28a1ba1116, SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_SHA_NightsongPrison_StartedReadyCheck(_, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SHA_NightsongPrison_StartedReadyCheck(_Var1);
ReadyCheckGlobal("ReadyCheck_EnterNightsongPrison", "Message_ProgressingWorldState", 1, _Var1);

PROC
PROC_FlagReactionAfterDialog((GUIDSTRING)_Var1, SHA_NightsongPrison_Event_StartReadyCheck_9344260b-727a-6a3f-34da-fb28a1ba1116, SHA_NightsongPrison_GatherYourParty_29530c19-2d81-2a03-53ac-8f96304f4a87, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(SHA_NightsongPrison_Event_StartReadyCheck_9344260b-727a-6a3f-34da-fb28a1ba1116, _Var1);

PROC
PROC_SHA_NightsongPrison_Entrance((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_NightsongPrison_TeleportPlayerWithFade(_Var1, S_SHA_NightsongPrison_EntranceTeleportTrigger_49b61a34-31ba-47cb-b075-f4baf6e6f122);

PROC
PROC_SHA_NightsongPrison_Entrance((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, S_SHA_NightsongPrison_EntranceTeleportTrigger_49b61a34-31ba-47cb-b075-f4baf6e6f122, "", 0, 0, 1);

PROC
PROC_SHA_NightsongPrison_TeleportEffect((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetPosition(_Var1, _Var2, _Var3, _Var4, _Var1)
THEN
PlayEffectAtPosition(VFX_Script_Stub_Poof_01_f0cf792a-0f74-d17e-ad0d-6052a6131416, _Var2, _Var3, _Var4, 1);

PROC
PROC_SHA_NightsongPrison_TeleportPlayerWithFade((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetUUID(_Var1, _Var3, _Var1, _Var1, _Var1)
AND
GUIDToString(_Var2, _Var4, _Var1, _Var1, _Var1)
AND
Concatenate(_Var4, _Var3, _Var5, _Var1, _Var1)
THEN
DB_SHA_NightsongPrison_FadeEvents(_Var1, _Var5);
ScreenFadeTo(_Var1, 2, 0, _Var5);

PROC
PROC_SHA_NightsongPrison_TeleportPlayerWithFade((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_Is_InCombat(_Var1, _, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, _Var2, "", 0, 1, 1);

PROC
PROC_SHA_NightsongPrison_TeleportPlayerWithFade((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Is_InCombat(_Var1, _, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, _Var2, "", 0, 0, 1);

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _Var1);

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
THEN
ApplyStatus(_Var1, "FEATHER_FALL", -1, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
Resurrected((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ApplyStatus(_Var1, "FEATHER_FALL", -1, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_InRegion(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _, _, _)
THEN
SetTag(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_ArrivedAtPrison", _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_StartDialog(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72, S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_AllyPrisonPos_9a2ce54e-e117-43fa-a19d-38f6a015b0bc, "SHA_NightsongPrison_NecromancerAtNightsong");

IF
DB_InRegion(_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_ArrivedAtPrison", _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_StartDialog(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72, NULL_00000000-0000-0000-0000-000000000000, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
DialogEnded(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72, _, _, _, _)
AND NOT
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _, _, _, _)
THEN
TeleportTo(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_AllyPrisonPos_9a2ce54e-e117-43fa-a19d-38f6a015b0bc, "SHA_NightsongPrison_NecromancerAtNightsong");

IF
DialogEnded(SHA_NightsongPrison_ArriveAtShadowfell_5d63c3ff-6ef6-2e6a-0722-f752b72a8b72, _, _, _, _)
AND
DB_Players(_Var2, _, _, _, _)
AND
QRY_OnlyOnce("SHA_NightsongPrison_PlayersHaveShadowfellArrivalScene", _, _, _, _)
THEN
ShowMapMarker(_Var2, "SHA_NightsongPrison_Point", 1);
TimerLaunch("SHA_NightsongPrison_EntryVBTimer", 3000);

IF
TimerFinished("SHA_NightsongPrison_EntryVBTimer", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
StartVoiceBark(SHA_NightsongPrison_VB_EnteredShadowfell_de76d4f1-a12c-b503-8118-98c2005ac5d0, _Var1);

IF
EnteredTrigger((GUIDSTRING)_Var1, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_NightsongPrison_Player_Reached_Prison", _Var1, _Var1, _Var1, _Var1)
THEN
ShowMapMarker(_Var1, "SHA_NightsongPrison_Point", 0);

IF
LeftTrigger((GUIDSTRING)_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
RemoveStatus(_Var1, "FEATHER_FALL", NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_State_Changed(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, "SHA_Nightsong", "SHA_State_Nightsong_PermanentlyDead", _, _)
THEN
NOT DB_PartyDialogSuppressionZone(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);

IF
FlagSet(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
NOT DB_PartyDialogSuppressionZone(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);

IF
FlagSet(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
NOT DB_PartyDialogSuppressionZone(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);

IF
LeftTrigger((GUIDSTRING)_Var1, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_PartyDialogSuppressionZone(S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0);
ClearFlag(GLO_Companion_LeaveBlocked_4386e3a1-b16e-4331-92ec-29edbc359d51, _Var1);

IF
LeftTrigger(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, S_SHA_NightsongPrison_SUB_0a302268-dd92-4462-99e5-ca7491815ec0, _, _, _)
THEN
ClearTag(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);

PROC
PROC_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, _, _, _, _)
THEN
PROC_Foop(S_SHA_NightsongPrison_ExitPortal_3e872c6c-95d1-47ef-85b5-bfa835ebb525);

IF
UseFinished(_, S_SHA_NightsongPrison_ExitPortal_3e872c6c-95d1-47ef-85b5-bfa835ebb525, 1, (CHARACTER)_, (CHARACTER)_)
THEN
PROC_GlobalClearFlagAndCache(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282);

IF
DB_SHA_NightsongPrison_VanishingJusticiars(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
PROC_TriggerRegisterForParty(_Var2);
DB_SpotPlayers(_Var1, "SHA_NightsongPrison_VanishingJusticiarSpotting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_InRegion(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_NightsongPrison_VanishingJusticiars(_Var3, _Var2, _Var1, _Var1, _Var1)
THEN
PROC_FadeOutEntity(_Var3);

IF
StatusApplied((CHARACTER)_Var1, (STRING)_Var2, (CHARACTER)_Var3, _, (CHARACTER)_Var1)
AND
DB_SHA_NightsongPrison_VanishingJusticiars(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_FadeOutEntity(_Var1);

QRY
QRY_CRIME_BlockRegisterCrime((CHARACTER)_Var1, (STRING)_Var2, (ITEM)_Var3, (CHARACTER)_Var4, (INTEGER)_Var5)
AND
DB_SHA_NightsongPrison_VanishingJusticiars(_Var4, _, _Var1, _Var1, _Var1)
AND
QRY_SHA_NightsongPrison_JusticiarAssaulted(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_FadeOutEntity(_Var4);

QRY
QRY_SHA_NightsongPrison_JusticiarAssaulted((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
QRY_CRIME_IsCrimeFamilyMember(_Var1, "AssaultRelated", _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_SHA_NightsongPrison_JusticiarAssaulted((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
QRY_CRIME_IsCrimeFamilyMember(_Var1, "Assault", _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted((GUIDSTRING)_Var1, "SHA_NightsongPrison_VanishingJusticiarSpotting", (GUIDSTRING)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_TryStartAD(SHA_NightsongPrison_AD_VanishingJusticiarChanting_2834f273-1441-bb9d-0656-54fc31550acb, _Var1);

IF
DB_SHA_NightsongPrison_BalthazarSkeletons(_, _Var2, _, _, _)
THEN
SetOnStage(_Var2, 0);

PROC
PROC_GlobalFlagReactionAfterDialog(SHA_NightsongPrison_Event_NecroSummonsSkellies_8649c31d-15bf-dd68-5cc0-828e6f44af0f, SHA_NightsongPrison_NecroAndNightsong_500474d5-3855-9b12-29d1-b6e7645d7385, _, _, _)
THEN
ClearTag(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
PROC_SHA_NightsongPrison_BalthazarSummonSkellies();

IF
CastedSpell((GUIDSTRING)_Var1, "Target_SHA_Necromancer_ReclaimControl", _, _, _)
THEN
PROC_SHA_NightsongPrison_BalthazarSummonSkellies();

PROC
PROC_SHA_NightsongPrison_BalthazarSummonSkellies()
AND
DB_SHA_NightsongPrison_BalthazarSkeletons(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_NightsongPrison_BalthazarSkeletons(_Var1, _Var2);
AppearAt(_Var2, _Var1, 1, NULL_00000000-0000-0000-0000-000000000000, "SHA_NightsongPrison_SkellySummoned");
PROC_Poof(_Var1);

PROC
PROC_SHA_NightsongPrison_BalthazarSummonSkellies()
THEN
PROC_SetRelationToPlayers(ACT2_SHA_Necromancer_NightsongSkeletons_d0b1cca2-25d3-4e06-b8d2-56406bffb60b, 0);

IF
DB_SHA_NightsongPrison_BalthazarSkeletons(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
DB_GLO_DefeatCounter(_Var2, "SHA_NightsongPrison_SkeletonsDefeated");

IF
TextEvent("SHA_NightsongPrison_GiveResearch", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ToInventory(S_SHA_Necromancer_Research_822d964d-1c62-4465-b493-1aa1c34baef3, _Var1, 1, 1, 1);

IF
TextEvent("SHA_NightsongPrison_GiveNightSpear", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetHostCharacter(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ToInventory(S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8, _Var1, 1, 1, 1);

IF
TextEvent("SHA_NightsongPrison_FreeNightsong", _, _, _, _)
THEN
PROC_Debug_FreeNightsong();

IF
TextEvent("SHA_NightsongPrison_ShadowheartKillsNightsong", _, _, _, _)
THEN
SetFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3);
SetFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169);
SetOnStage(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0);

IF
TextEvent("SHA_NightsongPrison_PermanentlyKillNightsong", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SHA_NightsongPrison_Event_PermanentlyKillNightsong_097792de-6bd1-e7c9-77d3-fe6419e3170a, _Var1);

IF
TextEvent("SHA_NightsongPrison_NightsongToMoonrise", _, _, _, _)
THEN
PROC_Debug_NightsongToMoonrise();

IF
FlagSet(SHA_NightsongPrison_Debug_GiveNightSpear_cc17c054-497d-467a-af98-56d6e20f3556, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ToInventory(S_SHA_NightSpear_b2454f89-dc53-48a6-a8cd-92c7a380a6a8, _Var1, 1, 1, 1);

PROC
PROC_Debug_NightsongToMoonrise()
THEN
SetFlag(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, NULL_00000000-0000-0000-0000-000000000000, 0);
SetFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3, NULL_00000000-0000-0000-0000-000000000000, 0);
PROC_SHA_NightsongPrison_NightsongToMoonrise();

PROC
PROC_Debug_FreeNightsong()
THEN
SetFlag(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa);
SetFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3);
PROC_NightsongPrison_FreeNightsong();


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act2"
