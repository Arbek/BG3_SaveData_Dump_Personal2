Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_SHA_OrthonLair_Party(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_SHA_OrthonLair_Party(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_000_fbbf364f-5da0-4d60-86e4-ecf68da8fb25);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_001_5577f1b0-bb18-4ddb-a0ff-1524b743537f);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_002_316417ee-9493-46c5-b05b-859130d480b3);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_003_ee9eb6d6-0f76-40ba-b6e2-fc85f4bbccab);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_004_b2efcdbd-501f-4666-86ed-5c402837cbcd);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_005_f5d352d6-2147-41df-812f-91f3d1ef3029);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_006_167cd600-1543-4b76-b0da-f6ff587d7b9d);
DB_SHA_OrthonLair_Party(S_SHA_Merregon_007_03762803-f443-4754-a78a-f476d2a21849);
DB_SHA_OrthonLair_PartyDialogues(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, SHA_Displacer_618b26dd-25a2-f1f1-be8f-79b6dcdcfab6);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_000_fbbf364f-5da0-4d60-86e4-ecf68da8fb25, SHA_Merregon_000_f9081776-3d93-bdd0-a3dc-b9a887235c41);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_001_5577f1b0-bb18-4ddb-a0ff-1524b743537f, SHA_Merregon_001_3e971f14-fb08-8d7f-fe29-0d6f8ebb000a);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_002_316417ee-9493-46c5-b05b-859130d480b3, SHA_Merregon_002_e99a9e97-c605-8790-4c4e-ba58474f1640);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_003_ee9eb6d6-0f76-40ba-b6e2-fc85f4bbccab, SHA_Merregon_003_4bea8007-8896-a389-a748-c24138f4dc89);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_004_b2efcdbd-501f-4666-86ed-5c402837cbcd, SHA_Merregon_004_d8e1f50c-4e82-f7f8-88ac-68f0bffb80e8);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_005_f5d352d6-2147-41df-812f-91f3d1ef3029, SHA_Merregon_005_0db6d1c4-9bcd-0b53-6083-c15e5b39d617);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_006_167cd600-1543-4b76-b0da-f6ff587d7b9d, SHA_Merregon_006_fb33d3ba-f4aa-3beb-26d3-b4fd1be6e5ec);
DB_SHA_OrthonLair_PartyDialogues(S_SHA_Merregon_007_03762803-f443-4754-a78a-f476d2a21849, SHA_Merregon_007_f38511ed-6159-13a2-163b-0f35d2bfa9a2);
DB_DropMutingStatussesDialog(SHA_Displacer_618b26dd-25a2-f1f1-be8f-79b6dcdcfab6);
DB_Inclusion_Object(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, SHA_Displacer_StartInclusion_51a64a47-c1f2-4cc8-bf37-32b2b215d0cb, NULL_00000000-0000-0000-0000-000000000000);
DB_Inclusion_NPCDialog(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2);
DB_GLO_DieFlag(SHA_OrthonLair_Event_OrthonKillsDisplacer_933902ed-45fb-405e-9ea0-4b499298e947, S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, 0, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_GlobalFlagReactionAfterDialog(SHA_OrthonLair_Event_MakeOrthonPartyHostile_4aef7ac9-3fe2-412a-ab1b-e0b43ec61e65, SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de);
DB_GlobalFlagReactionAfterDialog(SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7, SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de);
DB_GlobalFlagReactionAfterDialog(SHA_OrthonLair_Event_MakeOrthonPartyHostile_4aef7ac9-3fe2-412a-ab1b-e0b43ec61e65, SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430);
DB_DefeatedEvent(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, SHA_Orthon_State_Defeated_f9b8bab6-c2ce-4051-9a3f-5b6c7846ff34);
DB_PreventPermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_SpotPlayers(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, "SHA_DisplacerBeast_FirstStop", NULL_00000000-0000-0000-0000-000000000000, SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91);
SetFlag(SHA_Displacer_State_WaitAtFirstLurePoint_b20f15a7-f50b-4a46-a2e6-78426e90b78d, NULL_00000000-0000-0000-0000-000000000000);
DB_SHA_OrthonLair_DisplacerBait("SHA_DisplacerBeast_FirstStop", S_SHA_Displacer_WaitPos_001_ccbf4599-abd8-4b9a-821d-4c9e74aa789b, "SHA_DisplacerBeast_SecondStop");
DB_SHA_OrthonLair_DisplacerBait("SHA_DisplacerBeast_SecondStop", S_SHA_Displacer_WaitPos_002_9d2c2baa-3c7d-4d05-b093-63a4efdc9b1c, "");
DB_SHA_OrthonLair_DisplacerBaitFlags("SHA_DisplacerBeast_FirstStop", SHA_Displacer_State_WaitAtFirstLurePoint_b20f15a7-f50b-4a46-a2e6-78426e90b78d);
DB_SHA_OrthonLair_DisplacerBaitFlags("SHA_DisplacerBeast_SecondStop", SHA_Displacer_State_WaitAtSecondLurePoint_9a1ba959-74ee-48ea-bb9b-6b8d2eb3252b);
DB_SHA_OrthonLair_DisplacerBaitFlags("", SHA_Displacer_State_WaitAtThirdLurePoint_9af221f9-b726-4dda-a188-612036ae9e36);
PROC_SHA_OrthonLair_UpdateDisplacerBaitFlags(SHA_Displacer_State_WaitAtFirstLurePoint_b20f15a7-f50b-4a46-a2e6-78426e90b78d);
DB_AmbushTrigger(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, S_SHA_OrthonsLair_LowerPerceptionTrigger_5aa78649-2605-41b4-b569-a7fe2ab96935, DC_Hard_831e1fbe-428d-4f4d-bd17-4206d6efea35);
DB_AmbushTrigger(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, S_SHA_OrthonsLair_UpperPerceptionTrigger_16980f29-a78d-44e2-9105-c5f184cd4541, DC_Medium_fa621d38-6f83-4e42-a55c-6aa651a75d46);
DB_AmbushTrigger_AmbushRevealAD(S_SHA_OrthonsLair_LowerPerceptionTrigger_5aa78649-2605-41b4-b569-a7fe2ab96935, SHA_OrthonLair_PAD_AmbushPerceptionCheck_5bafdbfe-6ecd-7224-bc02-117dc291b551);
DB_AmbushTrigger_AmbushRevealAD(S_SHA_OrthonsLair_UpperPerceptionTrigger_16980f29-a78d-44e2-9105-c5f184cd4541, SHA_OrthonLair_PAD_AmbushPerceptionCheck_5bafdbfe-6ecd-7224-bc02-117dc291b551);
DB_AmbushTrigger_AdditionalAmbushTrigger(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, S_SHA_OrthonsLair_Ambush_UpperFloor_63f9d457-6988-4f64-84e7-b5298cb4d621);
PROC_TriggerRegisterForPlayers(S_SHA_OrthonLair_AmbushDialog_43ecfeb2-5709-40f5-986e-54ba0639c980);
DB_AddCharactersInTriggerToDialog(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, S_SHA_OrthonLair_AmbushDialog_43ecfeb2-5709-40f5-986e-54ba0639c980, 0);
SetFlag(SHA_OrthonLair_State_AmbushInProgress_3fb4d528-b422-43e4-816b-54261450b401, NULL_00000000-0000-0000-0000-000000000000);
TriggerRegisterForCharacter(S_SHA_OrthonLair_SecondJump_0e3341b2-5d32-4006-8a2f-9a493c759e86, S_SHA_Merregon_003_ee9eb6d6-0f76-40ba-b6e2-fc85f4bbccab);
PROC_TriggerRegisterForParty(S_SHA_OrthonsLair_Ambush_PlayerAtUpperFloor_edc0c8a1-8b75-44e3-83d4-6bf9b659e24c);
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(0);
DB_OneShot_VoiceBarkTrigger(S_SHA_OrthonLair_LairVB_eef4cc7a-78ca-4a2e-b201-98e760d4aa91, SHA_OrthonLair_VB_EnteredLair_346062d4-71c6-7cbf-e6de-e46ddc9a68a6);
DB_GLO_CompoundFlag(SHA_Orthon_Event_RaphaelAppears_71780298-ea4b-4c90-9083-87d394e3b9a4, SHA_Orthon_Event_ClearGemOwnership_97c1bb82-2c37-1c13-b4ae-dcc7e25aa7f3);
SetOwner(S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
SetOwner(S_SHA_OrthonChest_d439365a-ec12-473e-8893-f0426f772bca, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
DB_SHA_Orthon_MerregonsPartySize(8);
DB_SHA_Orthon_DefeatedMerregonsForPhaseTwo(4);
PROC_TriggerRegisterForParty(S_SHA_OrthonLairArea_feb22b75-8807-4733-b9da-fd24773c3866);
DB_FlagReactionAfterDialog(SHA_OrthonLair_Event_SpeakWithPlayer_b71f8487-f4b7-0863-8d1c-82f68488d001, SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de);
DB_GLO_CustomEntityCorpseDialog(S_SHA_OrthonBed_3ef1754c-0b81-48b1-956e-b8f4ae7da3d6, S_SHA_OrthonBed_CorpseHelper_c252c016-937e-4b8e-85fd-2c675c324f9b, SHA_OrthonBed_Dead_37d0b4cf-6964-d938-1249-c9076115cec4);
DB_ItemDialog_PlayerVB(S_SHA_OrthonBed_3ef1754c-0b81-48b1-956e-b8f4ae7da3d6, SHA_OrthonBed_VB_523b5230-3e0f-bcc1-ee27-03be3ad2573b);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
DB_HasItemEvent(S_SHA_InfernalPlate_03f5f86a-1560-4121-9543-c3d1c87e5495, SHA_Misc_State_HasInfernalMetal_1e9fcebf-20bf-431a-b805-ecf2a220075e);
DB_HasItemEvent(S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb, SHA_Misc_State_HasOrthonGem_81dd03ea-b817-4dca-8be1-6019f012b462);
DB_GiveItemToEvent(S_SHA_InfernalPlate_03f5f86a-1560-4121-9543-c3d1c87e5495, SHA_Misc_Event_GiveInfernalMetal_52383bd7-6ff6-4286-ba3e-e1f9a7adab5d);
DB_HasItemTemplateScriptFlag(1, SHA_Merregon_000_f9081776-3d93-bdd0-a3dc-b9a887235c41, UNI_Throwable_Grenade_MerregonPotion_11600b5b-999b-4444-b9a1-f3aa110c7604, 1, 5);
DB_GiveNewItemFromTemplateEvent(UNI_Throwable_Grenade_MerregonPotion_11600b5b-999b-4444-b9a1-f3aa110c7604, SHA_Merregon_Event_GavePotions_3c2c33c4-e163-4403-c7e3-ec992b6e2caf, 5);
DB_RemoveItemFromTemplateEvent(UNI_Throwable_Grenade_MerregonPotion_11600b5b-999b-4444-b9a1-f3aa110c7604, SHA_Merregon_Event_GavePotions_3c2c33c4-e163-4403-c7e3-ec992b6e2caf, NULL_00000000-0000-0000-0000-000000000000, 5);
DB_DialogBlockAttackButton(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de);
SetCombatGroupID(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "3a1d0215-4c49-e95c-73a8-8e514653a251");

KBSECTION
IF
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_GLO_DefeatCounter(_Var1, "SHA_OrthonGroup");
DB_State_Priority(_Var1, "SHA_OrthonLair", "Ambushing", 0);
DB_State_Priority(_Var1, "SHA_OrthonLair", "AfterAmbush", 100);
DB_State_Current(_Var1, "SHA_OrthonLair", "Ambushing");
DB_SceneManager(_Var1, "SHA_OrthonLair_Ambush");

IF
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2
THEN
DB_AmbushTrigger_Ambusher(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, _Var1, 1);

IF
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c
AND
_Var1 != S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2
THEN
DB_GLO_DefeatCounter(_Var1, "SHA_Merregons");
DB_GLO_DieFlag(SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8, _Var1, 0, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);

IF
FlagSet(SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8, _, _, _, _)
AND
DB_GLO_DieFlag(SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8, _Var3, _, _, _)
AND NOT
DB_PermaDefeated(_Var3, _, _, _, _)
THEN
ApplyStatus(_Var3, "PEACEFUL_RESOLUTION_XP", -1, 1);

IF
FlagSet(SHA_OrthonLair_Event_OrthonKillsDisplacer_933902ed-45fb-405e-9ea0-4b499298e947, _, _, _, _)
AND NOT
DB_PermaDefeated(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _, _, _, _)
THEN
ApplyStatus(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, "PEACEFUL_RESOLUTION_XP", -1, 1);

IF
FlagSet(SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7, _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
THEN
ApplyStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "PEACEFUL_RESOLUTION_XP", -1, 1);

IF
DB_SpotPlayers(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var1, _, _, _Var1)
AND
DB_SHA_OrthonLair_DisplacerBait(_Var1, _, _, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SpotPlayers_IncludeFollowers(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var1);
DB_SpotPlayers_IncludeSummons(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var1);

PROC
PROC_SpotPlayers_Spotted(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, (STRING)_Var1, _, (STRING)_Var1, (STRING)_Var1)
AND
DB_SHA_OrthonLair_DisplacerBait(_Var1, _Var3, _Var4, _Var1, _Var1)
AND
DB_SHA_OrthonLair_DisplacerBaitFlags(_Var4, _Var5, _Var1, _Var1, _Var1)
THEN
PROC_SHA_OrthonLair_UpdateDisplacerBaitFlags(_Var5);
PROC_ClearStoryMove(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2);
PROC_CharacterMoveTo(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var3, "Sprint", _Var1);

PROC
PROC_SHA_OrthonLair_UpdateDisplacerBaitFlags((FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_SHA_OrthonLair_DisplacerBaitFlags(_, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(_Var1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SHA_OrthonLair_UpdateDisplacerBaitFlags((FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_SHA_OrthonLair_DisplacerBaitFlags(_, _Var3, _Var1, _Var1, _Var1)
AND
_Var3 != _Var1
AND
DB_GlobalFlag(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(_Var1, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_SHA_OrthonLair_UpdateDisplacerBaitFlags((FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_GlobalFlag(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(_Var1, NULL_00000000-0000-0000-0000-000000000000);

IF
EntityEvent(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
DB_SHA_OrthonLair_DisplacerBait(_Var1, _Var2, _Var3, _Var1, _Var1)
AND
DB_SHA_OrthonLair_DisplacerBait(_Var3, _, _, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SpotPlayers(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var3, NULL_00000000-0000-0000-0000-000000000000, SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91);

IF
EnteredTrigger((GUIDSTRING)_Var1, S_SHA_OrthonsLair_Ambush_PlayerAtUpperFloor_edc0c8a1-8b75-44e3-83d4-6bf9b659e24c, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
SetFlag(SHA_OrthonLair_State_BlockAmbushDialogAndStartCombat_5fb5f550-83a7-48fe-ae4e-1fd8711e06d4, _Var1);

IF
LeftTrigger((GUIDSTRING)_Var1, S_SHA_OrthonsLair_Ambush_PlayerAtUpperFloor_edc0c8a1-8b75-44e3-83d4-6bf9b659e24c, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(SHA_OrthonLair_State_BlockAmbushDialogAndStartCombat_5fb5f550-83a7-48fe-ae4e-1fd8711e06d4, _Var1);

PROC
PROC_GLO_KnowledgeCheckSuccess((GUIDSTRING)_Var1, _, S_SHA_OrthonsLair_LowerPerceptionTrigger_5aa78649-2605-41b4-b569-a7fe2ab96935, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
SetFlag(SHA_OrthonLair_Knows_Ambush_fc0dd64d-8025-450f-ac36-42efecd44efb, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_KnowledgeCheckSuccess((CHARACTER)_Var1, _, S_SHA_OrthonsLair_UpperPerceptionTrigger_16980f29-a78d-44e2-9105-c5f184cd4541, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
SetFlag(SHA_OrthonLair_Knows_Ambush_fc0dd64d-8025-450f-ac36-42efecd44efb, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_RevealAmbush(S_SHA_OrthonsLair_LowerPerceptionTrigger_5aa78649-2605-41b4-b569-a7fe2ab96935, _, _, _, _)
THEN
PROC_KnowledgeCheck_Clear(S_SHA_OrthonsLair_UpperPerceptionTrigger_16980f29-a78d-44e2-9105-c5f184cd4541);
SetFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_RevealAmbush(S_SHA_OrthonsLair_UpperPerceptionTrigger_16980f29-a78d-44e2-9105-c5f184cd4541, _, _, _, _)
THEN
PROC_KnowledgeCheck_Clear(S_SHA_OrthonsLair_LowerPerceptionTrigger_5aa78649-2605-41b4-b569-a7fe2ab96935);
SetFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_LaunchAmbush(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
SetFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_OrthonLair_SendDisplacerToAmbush();

PROC
PROC_LaunchAmbush(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_CustomDialogRange(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, 999);

PROC
PROC_LaunchAmbush(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
QRY_SHA_OrthonLair_TryAmbushDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SHA_OrthonLair_EndAmbushHostile(1);

QRY
QRY_SHA_OrthonLair_TryAmbushDialog((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetFlag(SHA_OrthonLair_State_BlockAmbushDialogAndStartCombat_5fb5f550-83a7-48fe-ae4e-1fd8711e06d4, _Var1, 0, _Var1, _Var1)
AND
QRY_StartDialogCustom(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, 0, 0, 1, 1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_SHA_OrthonLair_Party(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 != S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c
AND
_Var2 != S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2
THEN
PROC_DialogAddSpeakingActor(_Var1, _Var2);

IF
DB_SHA_OrthonLair_EndAmbushHostile(1, _, _, _, _)
AND NOT
DB_DialogName(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_OrthonLair_EndAmbush", _, _, _, _)
THEN
PROC_SHA_OrthonLair_EndAmbushHostile();

IF
DB_SHA_OrthonLair_EndAmbushNeutral(1, _, _, _, _)
AND NOT
DB_DialogName(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_OrthonLair_EndAmbush", _, _, _, _)
THEN
PROC_SHA_OrthonLair_EndAmbushNeutral();

PROC
PROC_SHA_OrthonLair_EndAmbushHostile()
AND
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ForceStopDialog(_Var1);

PROC
PROC_SHA_OrthonLair_EndAmbushHostile()
THEN
PROC_SHA_OrthonLair_MakeOrthonPartyHostile();
PROC_TryStartAD(SHA_Orthon_AD_AmbushStartsAtUpperFloor_c988219b-a05b-9c77-cf62-607c19a0aa91, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c);
PROC_SHA_OrthonLair_EndAmbushNeutral();

PROC
PROC_SHA_OrthonLair_EndAmbushNeutral()
AND
DB_SceneManager(_, "SHA_OrthonLair_Ambush", _, _, _)
THEN
DB_OnlyOnce("SHA_OrthonLair_EndAmbush");
PROC_SceneOver("SHA_OrthonLair_Ambush");

PROC
PROC_SceneOver("SHA_OrthonLair_Ambush", _, _, _, _)
AND
DB_AmbushTrigger(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011, _, _, _, _)
THEN
PROC_CancelAmbush(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011);

PROC
PROC_SceneOver("SHA_OrthonLair_Ambush", _, _, _, _)
THEN
ClearFlag(SHA_OrthonLair_State_AmbushInProgress_3fb4d528-b422-43e4-816b-54261450b401, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, NULL_00000000-0000-0000-0000-000000000000);
PROC_TriggerUnregisterForPlayers(S_SHA_OrthonLair_AmbushDialog_43ecfeb2-5709-40f5-986e-54ba0639c980);

PROC
PROC_SceneOver("SHA_OrthonLair_Ambush", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_State_Progress(_Var1, "SHA_OrthonLair", "AfterAmbush");

PROC
PROC_State_Changed((CHARACTER)_Var1, "SHA_OrthonLair", "AfterAmbush", (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_OrthonLair_PartyDialogues(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
SetHasDialog(_Var1, 1);
PROC_RemoveDialog(_Var1);
DB_Dialogs(_Var1, _Var2);

PROC
PROC_State_Changed(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, "SHA_OrthonLair", "AfterAmbush", _, _)
THEN
PROC_ClearStoryMove(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2);
PROC_CharacterMoveTo(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, S_SHA_OrthonLair_Displacer_Pos_666632ba-abdd-4974-98aa-0a928d7d48cb, "Walk", "SHA_Displacer_ArrivedToLair");

IF
FlagSet(SHA_OrthonLair_Event_KillOrthonsParty_7f658366-ee8e-459f-ba68-c423bc259fc8, _, _, _, _)
AND
DB_SceneManager(_Var3, "SHA_OrthonLair_Ambush", _, _, _)
AND
_Var3 != S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c
AND
_Var3 != S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2
THEN
PROC_SceneManager_RemoveFromScene(_Var3, "SHA_OrthonLair_Ambush");

IF
FlagSet(SHA_OrthonLair_Event_OrthonKillsDisplacer_933902ed-45fb-405e-9ea0-4b499298e947, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_SceneManager_RemoveFromScene(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, "SHA_OrthonLair_Ambush");

PROC
PROC_GlobalFlagReactionAfterDialog(SHA_OrthonLair_Event_OrthonKillsSelf_5779d2a2-1676-463d-905b-699e9c7b1bc7, _, _, _, _)
THEN
PROC_SceneManager_RemoveFromScene(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "SHA_OrthonLair_Ambush");
Die(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 0, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, 1, 0);

PROC
PROC_SHA_OrthonLair_MakeOrthonPartyHostile()
THEN
PROC_SetRelationToPlayers(ACT2_SHA_Orthon_eda9b693-579a-43de-90fc-f4684f06c3dd, 0);
PROC_SetRelationToPlayers(ACT2_SHA_OrthonParty_eda9b693-579a-43de-90fc-f4684f06c3dd, 0);

IF
DialogStarted(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(SHA_Displacer_State_StopSpotting_830e8a6a-f55f-40b2-9b28-0ec90b94ec91, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_SHA_OrthonLair_SendDisplacerToAmbush();

PROC
PROC_SHA_OrthonLair_SendDisplacerToAmbush()
AND NOT
DB_GlobalFlag(SHA_Displacer_State_WaitAtThirdLurePoint_9af221f9-b726-4dda-a188-612036ae9e36, _, _, _, _)
THEN
NOT DB_SHA_OrthonLair_DisplacerBaitFlags("", SHA_Displacer_State_WaitAtThirdLurePoint_9af221f9-b726-4dda-a188-612036ae9e36);
PROC_GlobalSetFlagAndCache(SHA_Displacer_State_WaitAtThirdLurePoint_9af221f9-b726-4dda-a188-612036ae9e36);
PROC_ClearStoryMove(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2);
PROC_CharacterMoveTo(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, S_SHA_Displacer_WaitPos_002_9d2c2baa-3c7d-4d05-b093-63a4efdc9b1c, "Run", "");

PROC
PROC_DialogStarted(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_GlobalSetFlagAndCache(SHA_OrthonLair_Event_HostileAfterAmbushDialog_0a02a860-7888-4822-9b5a-9cfb085f985e);

IF
DialogRequestFailed(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_SHA_OrthonLair_EndAmbushHostile(1);

IF
DialogEnded(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, _, _, _)
AND NOT
DB_GlobalFlag(SHA_OrthonLair_Event_HostileAfterAmbushDialog_0a02a860-7888-4822-9b5a-9cfb085f985e, _, _, _, _)
THEN
DB_SHA_OrthonLair_EndAmbushNeutral(1);

IF
DialogEnded(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, _, _, _)
AND
DB_GlobalFlag(SHA_OrthonLair_Event_HostileAfterAmbushDialog_0a02a860-7888-4822-9b5a-9cfb085f985e, _, _, _, _)
THEN
DB_SHA_OrthonLair_EndAmbushHostile(1);

PROC
PROC_GlobalFlagReactionAfterDialog(SHA_OrthonLair_Event_MakeOrthonPartyHostile_4aef7ac9-3fe2-412a-ab1b-e0b43ec61e65, _, _, _, _)
THEN
PROC_SetRelationToPlayers(ACT2_SHA_Orthon_eda9b693-579a-43de-90fc-f4684f06c3dd, 0);
PROC_SetRelationToPlayers(ACT2_SHA_OrthonParty_216e6942-98f2-405b-93b0-425197b56606, 0);

IF
FlagSet(SHA_Orthon_Event_ClearGemOwnership_97c1bb82-2c37-1c13-b4ae-dcc7e25aa7f3, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearOwnership(S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb);

PROC
PROC_SceneInterrupted(_, _, "SHA_OrthonLair_Ambush", (STRING)_Var3, _)
AND
_Var3 != "StartedDialog"
THEN
PROC_SHA_OrthonLair_EndAmbushHostile();
SetFlag(SHA_OrthonLair_State_AmbushInProgress_3fb4d528-b422-43e4-816b-54261450b401, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_DialogAttackRequested_CustomResponse(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_DialogPlayers(_Var2, _Var1, _, _Var1, _Var1)
AND
DB_DialogName(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _Var2, _Var1, _Var1, _Var1)
THEN
DB_SHA_OrthonLair_EndAmbushHostile(1);

PROC
PROC_SceneOver("SHA_OrthonLair_Ambush", _, _, _, _)
AND
DB_SceneManager(_, "SHA_OrthonLair_Ambush", _, _, _)
THEN
DB_ItemOwnerShipTriggers("SCL_Main_A", S_SHA_MerregonTrader_Junk_c8d1c5c0-528e-4ab9-b743-3df593b0fa44, S_SHA_Merregon_000_fbbf364f-5da0-4d60-86e4-ecf68da8fb25);

IF
FlagSet(SHA_LastJusticiar_State_KilledJusticiar_95b1ac4a-c978-3288-a192-d294b70229c4, _, _, _, _)
AND NOT
DB_DialogName(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, _, _, _)
THEN
PROC_SHA_OrthonLair_EndAmbushNeutral();

IF
StatusRemoved(S_SHA_OrthonLair_Campfire_f1b07f19-aa90-467f-b298-15af4e52586e, "BURNING", _, _, (GUIDSTRING)_)
THEN
SetEntityEvent(S_SHA_Merregon_000_fbbf364f-5da0-4d60-86e4-ecf68da8fb25, "SHA_MerregonLitCampfire");
SetEntityEvent(S_SHA_Merregon_004_b2efcdbd-501f-4666-86ed-5c402837cbcd, "SHA_MerregonLitCampfire");

PROC
PROC_GLO_DefeatCounter_Notify("SHA_Merregons", (INTEGER)_Var1, _, _, (INTEGER)_Var1)
AND
DB_SHA_Orthon_MerregonsPartySize(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_OrthonLair_StartCountingActiveMerregons(1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SHA_OrthonLair_StartCountingActiveMerregons(1);

IF
TurnStarted(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (REAL)_Var1, (REAL)_Var1, (REAL)_Var1, (REAL)_Var1)
AND
GetHitpointsPercentage(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 < 50
THEN
SetFlag(SHA_OrthonLair_Event_ReachedHPThreshold_9500270b-3d82-4050-b1dc-f35584dab6d4, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_Orthon_Phase2_Start();

IF
TurnStarted(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
AND
DB_SHA_Orthon_AdvanceToSecondPhase(1, _, _, _, _)
THEN
NOT DB_SHA_Orthon_AdvanceToSecondPhase(1);
SetFlag(SHA_OrthonLair_Event_ReachedSpecifiedRound_f60ea098-149d-4fac-bd1f-61c3b25c370c, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_Orthon_Phase2_Start();

IF
TurnStarted(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Is_InCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_CurrentCombatRoundIsGreaterThan(_Var1, 3, _Var1, _Var1, _Var1)
THEN
SetFlag(SHA_OrthonLair_Event_ReachedSpecifiedRound_f60ea098-149d-4fac-bd1f-61c3b25c370c, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_Orthon_Phase2_Start();

PROC
PROC_GLO_DefeatCounter_Notify("SHA_Merregons", _, _, _, _)
AND
DB_SHA_OrthonLair_StartCountingActiveMerregons(1, _, _, _, _)
AND
QRY_GLO_DefeatCounter_Count("SHA_Merregons", "Active", _, _, _)
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Var4, _, _, _, _)
AND
DB_SHA_Orthon_MerregonsPartySize(_Var5, _, _, _, _)
AND
DB_SHA_Orthon_DefeatedMerregonsForPhaseTwo(_Var6, _, _, _, _)
AND
IntegerSubtract(_Var5, _Var6, _Var7, _, _)
AND
_Var4 == _Var7
THEN
DB_SHA_Orthon_AdvanceToSecondPhase(1);

PROC
PROC_SHA_Orthon_Phase2_Start()
AND NOT
DB_SHA_Orthon_Phase2Archetype(_, _, _, _, _)
AND
GetBaseArchetype(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var2, _, _, _)
THEN
RemoveStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "INVISIBILITY");
DebugText(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "ENTERING PHASE 2");
SetEntityEventReal(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "GLO_CombatWait", 2);
ClearTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
RequestSetBaseArchetype(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "orthon_melee");
SetEntityEvent(SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430, "GLO_AiExecuteRecalc");
DB_SHA_Orthon_Phase2Archetype(_Var2);

PROC
PROC_SHA_Orthon_Phase2_Start()
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _, _, _, _)
AND
QRY_SHA_OrthonLair_CanSayCombatAD()
AND
QRY_OnlyOnce("SHA_Orthon_PhaseAD", _, _, _, _)
THEN
PROC_SHA_OrthonLair_CombatAD(SHA_Orthon_AD_TransitionsToSecondPhase_ddc48774-35f9-7f62-9683-c12e2b2f7255, 3);

IF
LeftCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
AND
DB_SHA_Orthon_Phase2Archetype(_Var2, _, _, _, _)
THEN
SetTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, AI_USESPELL_A_33aa698c-aea0-43e2-bd16-582aa718fd3e);
ClearTag(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, AI_USESPELL_B_3297ed55-ccc1-473e-8475-ac4162a63fdd);
RequestSetBaseArchetype(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var2);
NOT DB_SHA_Orthon_Phase2Archetype(_Var2);
NOT DB_OnlyOnce("SHA_Orthon_PhaseAD");
ClearFlag(SHA_OrthonLair_Event_ReachedSpecifiedRound_f60ea098-149d-4fac-bd1f-61c3b25c370c, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(SHA_OrthonLair_Event_ReachedSpecifiedRound_f60ea098-149d-4fac-bd1f-61c3b25c370c, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(SHA_OrthonLair_Event_ReachedHPThreshold_9500270b-3d82-4050-b1dc-f35584dab6d4, NULL_00000000-0000-0000-0000-000000000000);

IF
TurnStarted(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _, _, _, _)
AND
DB_Is_InCombat(S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _Var2, _, _, _)
AND
DB_Is_InCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var2, _, _, _)
AND
QRY_IsEnemy(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, S_SHA_Displacer_0d5e3e88-972b-4577-b6b2-b0946f38fce2, _, _, _)
AND
QRY_SHA_OrthonLair_CanSayCombatAD()
THEN
PROC_SHA_OrthonLair_CombatAD(SHA_Orthon_AD_BetrayedByDisplacer_c69bac28-283e-faaf-761c-410cf742b8fc, 3);

PROC
PROC_GLO_DefeatCounter_Notify("SHA_Merregons", _, _, _, _)
AND
DB_SHA_OrthonLair_StartCountingActiveMerregons(1, _, _, _, _)
AND
QRY_GLO_DefeatCounter_Count("SHA_Merregons", "Active", _, _, _)
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Var4, _, _, _, _)
AND
_Var4 < 2
THEN
SetFlag(SHA_OrthonLair_State_AlmostAllMerregonsDefeated_34a4e39b-4d10-4569-a531-7dd1eec47190, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_DefeatCounter_Notify("SHA_Merregons", _, _, _, _)
AND
DB_SHA_OrthonLair_StartCountingActiveMerregons(1, _, _, _, _)
AND
DB_GlobalFlag(SHA_OrthonLair_State_AlmostAllMerregonsDefeated_34a4e39b-4d10-4569-a531-7dd1eec47190, _, _, _, _)
AND
QRY_GLO_DefeatCounter_Count("SHA_Merregons", "Active", _, _, _)
AND
DB_QRYRTN_GLO_DefeatCounter_Count(_Var4, _, _, _, _)
AND
_Var4 > 1
THEN
ClearFlag(SHA_OrthonLair_State_AlmostAllMerregonsDefeated_34a4e39b-4d10-4569-a531-7dd1eec47190, NULL_00000000-0000-0000-0000-000000000000);

IF
TurnStarted(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _, _, _, _)
AND
DB_Is_InCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var2, _, _, _)
AND NOT
DB_GlobalFlag(SHA_OrthonLair_State_AlmostAllMerregonsDefeated_34a4e39b-4d10-4569-a531-7dd1eec47190, _, _, _, _)
AND
QRY_CurrentCombatRoundIs(_Var2, 1, _, _, _)
AND
QRY_SHA_OrthonLair_CountMerregonsInCombat(_Var2, _, _, _, _)
AND
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var3, _, _, _, _)
AND
_Var3 > 1
AND
QRY_SHA_OrthonLair_CanSayCombatAD()
AND
QRY_OnlyOnce("SHA_Orthon_RegroupOrder", _, _, _, _)
THEN
PROC_SHA_OrthonLair_CombatAD(SHA_Orthon_AD_FormLines_3ec00ef2-4101-45e3-1725-4456771d81c7, 3);

QRY
QRY_SHA_OrthonLair_CountMerregonsInCombat((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var2);
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(0);

QRY
QRY_SHA_OrthonLair_CountMerregonsInCombat((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_OrthonLair_Party(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
GetTemplate(_Var2, Merregon_9bbee0e3-4141-4561-9543-15d3a21000f4, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
IntegerSum(_Var3, 1, _Var4, _Var1, _Var1)
THEN
NOT DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var3);
DB_QRYRTN_SHA_OrthonLair_MerregonsInCombat(_Var4);

IF
CastedSpell(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "Projectile_MineCluster_Orthon", _, _, _)
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _, _, _, _)
AND
QRY_SHA_OrthonLair_CanSayCombatAD()
AND
QRY_OnlyOnce("SHA_OthonCastsMineCluster", _, _, _, _)
THEN
PROC_SHA_OrthonLair_CombatAD(SHA_Orthon_AD_MineClusterAbility_6163de78-e922-0b82-0814-8a44f850c44b, 3);

IF
AttackedBy((CHARACTER)_Var1, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, (INTEGER)_Var4, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
_Var4 > 0
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _Var1, _Var1, _Var1, _Var1)
AND
IsSummon(_Var1, 0, _Var1, _Var1, _Var1)
AND
QRY_IsEnemy(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, _Var1, _Var1, _Var1)
AND
GetHitpoints(_Var1, _Var8, _Var1, _Var1, _Var1)
AND
_Var8 <= 0
AND
QRY_SHA_OrthonLair_CanSayCombatAD()
THEN
PROC_SHA_OrthonLair_CombatAD(SHA_Orthon_AD_KilledEnemy_b2a3f90c-b94b-4d2d-d3f6-8e61dc09f860, 2);

PROC
PROC_SHA_OrthonLair_CombatAD((DIALOGRESOURCE)_Var1, (REAL)_Var2, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND NOT
DB_SHA_OrthonLair_CombatADInProgress(_, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(_Var1, S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, _Var1, _Var1)
THEN
SetEntityEventReal(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "GLO_CombatWait", _Var2);
DB_SHA_OrthonLair_CombatADInProgress(_Var1);

IF
AutomatedDialogRequestFailed((DIALOGRESOURCE)_Var1, _, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
DB_SHA_OrthonLair_CombatADInProgress(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_OrthonLair_CombatADInProgress(_Var1);

IF
AutomatedDialogEnded((DIALOGRESOURCE)_Var1, _, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
DB_SHA_OrthonLair_CombatADInProgress(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_OrthonLair_CombatADInProgress(_Var1);

QRY
QRY_SHA_OrthonLair_CanSayCombatAD()
AND NOT
DB_CantTalk_IgnoreCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
AND
HasActiveStatusWithGroup(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "SG_Invisible", 0, _, _)
THEN
DB_NOOP(1);

IF
EnteredTrigger(_, S_SHA_OrthonLairArea_feb22b75-8807-4733-b9da-fd24773c3866, (CHARACTER)_, (CHARACTER)_, (CHARACTER)_)
THEN
PROC_State_Progress(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_OrthonsLair");

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_OrthonsLair", _, _)
THEN
PROC_SceneOver("SHA_RaphaelAtGraveyard");

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_OrthonsLair", _, _)
AND
DB_Dead(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _, _, _, _)
THEN
Resurrect(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

PROC
PROC_StartDialog_AddExtraSpeakers(SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_OrthonsLair", _Var1, _Var1)
AND NOT
DB_OnlyOnce("SHA_RaphaelAndOrthonSceneFinished", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8);

IF
FlagSet(SHA_Orthon_Event_RaphaelAppears_71780298-ea4b-4c90-9083-87d394e3b9a4, _, _, _, _)
AND
DB_State_Current(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_OrthonsLair", _, _)
THEN
ClearFlag(SHA_Orthon_Event_RaphaelAppears_71780298-ea4b-4c90-9083-87d394e3b9a4, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_OrthonLair_TeleportRaphaelToOrthon();

PROC
PROC_SHA_OrthonLair_TeleportRaphaelToOrthon()
AND
GetPosition(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _Var1, _Var2, _Var3, _Var1)
AND
FindValidPosition(_Var1, _Var2, _Var3, 15, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, 1, _Var4, _Var5, _Var6, _Var1)
THEN
TeleportToPosition(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _Var4, _Var5, _Var6, "SHA_RaphaelTeleportedToOrthon", 0, 0, 0, 1, 1);

IF
EntityEvent((CHARACTER)_Var1, "SHA_RaphaelTeleportedToOrthon", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
PROC_GLO_Monitor_Foop();
DB_SceneManager(_Var1, "SHA_RaphaelAndOrthon");
DB_SceneManager(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "SHA_RaphaelAndOrthon");
DB_SceneAllowAllDisturbances("SHA_RaphaelAndOrthon");

IF
DialogActorLeft(SHA_Orthon_e06c8c4b-4931-391e-1c51-5b8f9b820430, _, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _, _)
AND
DB_SceneManager(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "SHA_RaphaelAndOrthon", _, _, _)
THEN
PROC_SceneOver("SHA_RaphaelAndOrthon");

PROC
PROC_SceneInterrupted(_, _, "SHA_RaphaelAndOrthon", (STRING)_Var3, _)
AND
DB_GLO_GenericSceneManager_ViolenceReason(_Var3, _, _, _, _)
AND NOT
QRY_StartDialog(SHA_Orthon_AD_MonitorLeaves_e4559c78-0768-8f1a-0b42-35304d3b7cc7, S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, _, _, _)
THEN
PROC_GlobalSetFlagAndCache(GLO_Monitor_State_AttackedMonitor_355730d6-4035-4918-888e-dbbefea1b6c3);
PROC_SceneOver("SHA_RaphaelAndOrthon");
PROC_State_Progress(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftAct2");

PROC
PROC_State_Changed(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", _, "GLO_Monitor_LeftAct2", (STRING)_)
THEN
PROC_GLO_Monitor_Poof();

IF
AutomatedDialogEnded(SHA_Orthon_AD_MonitorLeaves_e4559c78-0768-8f1a-0b42-35304d3b7cc7, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_HAV_MolsDeal_MonitorPoof();
PROC_State_Progress(S_GLO_Monitor_f65becd6-5cd7-4c88-b85e-6dd06b60f7b8, "GLO_Monitor", "GLO_Monitor_LeftAct2");

PROC
PROC_SceneOver("SHA_RaphaelAndOrthon", _, _, _, _)
AND
QRY_OnlyOnce("SHA_RaphaelAndOrthonSceneFinished", _, _, _, _)
THEN
PROC_SHA_OrthonLair_OrthonAndHisPartyDisappear();

PROC
PROC_SHA_OrthonLair_OrthonAndHisPartyDisappear()
THEN
PROC_GLO_Monitor_Poof();

PROC
PROC_SHA_OrthonLair_OrthonAndHisPartyDisappear()
AND
DB_SHA_OrthonLair_Party(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetCombatGroupID(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "83c104ad-4960-4208-a7e6-5bb70d65a310");
PROC_Poof(_Var1, VFX_Script_FieryPoof_01_90e5c093-038c-34c7-3eb4-255c968f0932);

IF
FlagSet(SHA_Orthon_State_ContractEnded_26c35edd-3617-82b3-b4d7-1b7bb6410485, _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, _, _, _, _)
THEN
ApplyStatus(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "PEACEFUL_RESOLUTION_XP", -1, 1);

IF
DialogEnded(SHA_Orthon_TrespassLair_68842a58-e440-fb14-4f64-21c1783469de, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(SHA_OrthonLair_Knows_Orthon_84ce6c40-0906-afae-0b6a-1df4625fa9d3, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EnteredCombat(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SHA_OrthonLair_Knows_Orthon_84ce6c40-0906-afae-0b6a-1df4625fa9d3, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(SHA_Orthon_State_Defeated_f9b8bab6-c2ce-4051-9a3f-5b6c7846ff34, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
SetFlag(SHA_Orthon_State_DefeatedOnce_8dd589d6-90fc-4a3b-b369-10440bd56520);

PROC
PROC_GLO_DefeatCounter_AllDefeated("SHA_OrthonGroup", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_InRegion(_Var1, S_SHA_OrthonLairArea_feb22b75-8807-4733-b9da-fd24773c3866, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_Orthon_DefeatedOrthon", _Var1, _Var1, _Var1, _Var1)
THEN
SetCombatGroupID(S_GLO_Orthon_1dc8091d-2af6-4d33-9268-998ef266d19c, "83c104ad-4960-4208-a7e6-5bb70d65a310");
PROC_TriggerUnregisterForParty(S_SHA_OrthonLairArea_feb22b75-8807-4733-b9da-fd24773c3866);
RealtimeObjectTimerLaunch(_Var1, "SHA_Orthon_DefeatedOrthonDelay", 1000);

IF
ObjectTimerFinished((GUIDSTRING)_Var1, "SHA_Orthon_DefeatedOrthonDelay", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
StartVoiceBark(SHA_OrthonLair_VB_DefeatedOrthon_55a685dd-4bd6-cf78-4e9a-30f90ba42be0, _Var1);

IF
FlagSet(VISITEDREGION_INT_Main_A_a2e1a618-d211-484e-9389-6b37308b8da1, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
GoalCompleted;

PROC
PROC_SHA_OrthonLair_OrthonAndHisPartyDisappear()
THEN
GoalCompleted;

IF
TextEvent("SHA_KilledLastJusticiar", _, _, _, _)
THEN
SetFlag(SHA_LastJusticiar_State_KilledJusticiar_95b1ac4a-c978-3288-a192-d294b70229c4, NULL_00000000-0000-0000-0000-000000000000);
DB_SHA_OrthonLair_EndAmbushNeutral(1);


EXITSECTION
PROC_SceneOver("SHA_OrthonLair_Ambush");
PROC_CancelAmbush(S_SHA_OrthonsLair_Ambush_56b326c2-bbf7-4693-b0e0-63c7f7f23011);
ENDEXITSECTION

ParentTargetEdge "Act2"
