Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_OriginMayLeaveDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d);
DB_DefeatedEvent(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_Karlach_State_Defeated_3f1f91aa-95d3-4d7f-a845-9fc962c8d1b9);
DB_DeadEvent(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_PlayerHasTemplateItem(LOOT_SoulCoin_8c68e68d-96d4-45d6-804c-5f31ac948ff3, ORI_Karlach_State_HasSoulCoin_9e5fb882-7511-401d-befa-f40261dc56de);
DB_ORI_CoolingDownForYou_ValidStatuses("WET", 0);
DB_ORI_CoolingDownForYou_ValidStatuses("POTION_OF_RESISTANCE_FIRE", 1);
DB_ORI_CoolingDownForYou_ValidStatuses("SLEET_STORM", 1);
DB_ORI_CoolingDownForYou_ValidStatuses("FIRE_SHIELD_CHILL", 1);
DB_ORI_CoolingDownForYou_ValidStatuses("CRYSTALSKIN", 1);
PROC_DeclareCounter("ORI_Karlach_SoulCoinsConsumed");
DB_TaggedItemTracker("INFERNAL_METAL_596255e4-37a3-4d06-b09d-2905874f892f", GLO_ForgingOfTheHeart_State_HasInfernalMetalTemplate_4a98c0fa-dd56-49db-8dae-f2b41f18deb5);
DB_PlayerHasTemplateItem(LOOT_Ketheric_Infernal_Plate_A_6242490e-42c9-49f0-bc3b-4e7ec11c0fe7, GLO_ForgingOfTheHeart_State_HasInfernalMetal_A_0fb4e5c9-f164-4804-88fe-69fc4e88fec1);
DB_PlayerHasTemplateItem(LOOT_Ketheric_Infernal_Plate_B_4a1dec56-1b6d-4faa-8bfb-719a0efd3f9e, GLO_ForgingOfTheHeart_State_HasInfernalMetal_B_ea10a017-b82f-4203-8df5-2e9c3d6c287c);
DB_PlayerHasTemplateItem(LOOT_Ketheric_Infernal_Plate_C_0f47473f-aa2e-46da-9529-f0f3868b77af, GLO_ForgingOfTheHeart_State_HasInfernalMetal_C_159a9933-f9f8-471e-aa6e-f1bad8082480);
DB_GiveTemplateFromPlayerDialogEvent(LOOT_Ketheric_Infernal_Plate_A_6242490e-42c9-49f0-bc3b-4e7ec11c0fe7, GLO_ForgingOfTheHeart_Event_GiveInfernalMetal_A_5f4630ee-9864-4eef-b4a4-e20a24572e50, GLO_ForgingOfTheHeart_State_ReceivedInfernalMetal_b2d05896-e0b7-4f46-8a54-2db04eae6d4b, 1);
DB_GiveTemplateFromPlayerDialogEvent(LOOT_Ketheric_Infernal_Plate_B_4a1dec56-1b6d-4faa-8bfb-719a0efd3f9e, GLO_ForgingOfTheHeart_Event_GiveInfernalMetal_B_7b13c4f6-4cb2-4de6-ab91-8291c70f9745, GLO_ForgingOfTheHeart_State_ReceivedInfernalMetal_b2d05896-e0b7-4f46-8a54-2db04eae6d4b, 1);
DB_GiveTemplateFromPlayerDialogEvent(LOOT_Ketheric_Infernal_Plate_C_0f47473f-aa2e-46da-9529-f0f3868b77af, GLO_ForgingOfTheHeart_Event_GiveInfernalMetal_C_83146ad9-948b-4520-a155-5e016fc8712b, GLO_ForgingOfTheHeart_State_ReceivedInfernalMetal_b2d05896-e0b7-4f46-8a54-2db04eae6d4b, 1);
DB_ORI_Karlach_InfernalMetalTemplates(LOOT_Ketheric_Infernal_Plate_A_6242490e-42c9-49f0-bc3b-4e7ec11c0fe7);
DB_ORI_Karlach_InfernalMetalTemplates(LOOT_Ketheric_Infernal_Plate_B_4a1dec56-1b6d-4faa-8bfb-719a0efd3f9e);
DB_ORI_Karlach_InfernalMetalTemplates(LOOT_Ketheric_Infernal_Plate_C_0f47473f-aa2e-46da-9529-f0f3868b77af);
DB_GlobalFlagReactionAfterDialog(GLO_ForgingOfTheHeart_Event_ToldToGetMoreMetal_b2c0ae25-b3d7-eea3-7468-4283334e9b6c, GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1);
DB_GiveTemplateFromPlayerDialogEvent(LOOT_Ketheric_Infernal_Plate_A_6242490e-42c9-49f0-bc3b-4e7ec11c0fe7, GLO_Dammon_Event_GiveInfernalMetal_4747dcf1-79a5-40cd-95f1-300741b7908c, GLO_Dammon_Event_ReceivedInfernalMetal_be516c21-6263-4904-95ac-163db3470654, 1);
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_Weaponsmith_PostEA_f2e19bab-4804-9a49-c7ee-0a190f1fcafd, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_DruidAttack_Weaponsmith_PostEA_23532629-93cf-a224-d39d-f29825c49025, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_AttackOnDen_Weaponsmith_f74a35e9-5895-dd0f-5c83-52009f6b0379, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(DEN_Weaponsmith_PostEA_f2e19bab-4804-9a49-c7ee-0a190f1fcafd, DEN_Weaponsmith_PostEA_f2e19bab-4804-9a49-c7ee-0a190f1fcafd);
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(DEN_DruidAttack_Weaponsmith_PostEA_23532629-93cf-a224-d39d-f29825c49025, DEN_DruidAttack_Weaponsmith_PostEA_23532629-93cf-a224-d39d-f29825c49025);
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(DEN_AttackOnDen_Weaponsmith_f74a35e9-5895-dd0f-5c83-52009f6b0379, DEN_AttackOnDen_Weaponsmith_f74a35e9-5895-dd0f-5c83-52009f6b0379);
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(HAV_TieflingSurvivors_Weaponsmith_c2312421-411c-757e-551b-3e7ddbb9d7e7, HAV_TieflingSurvivors_Weaponsmith_c2312421-411c-757e-551b-3e7ddbb9d7e7);
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(LOW_Dammon_028c720e-ece2-d8e4-de6c-cd4fa8faad26, LOW_Dammon_028c720e-ece2-d8e4-de6c-cd4fa8faad26);
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(HAV_TieflingSurvivors_Weaponsmith_c2312421-411c-757e-551b-3e7ddbb9d7e7, GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1, "SCL_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act2_53a40041-14dc-4b33-af88-fd15d6e1680a);
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(LOW_Dammon_028c720e-ece2-d8e4-de6c-cd4fa8faad26, GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1, "CTY_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act3b_52c8933c-0083-4c42-a67c-5dff706d03e9);
DB_TopicalGreeting(TG_ORI_Karlach_GotSecondUpgrade_617c5dc9-0c92-49f6-8994-63e9d06edb6a);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(GLO_ForgingOfTheHeart_State_KarlachUpgraded_a818e2f5-9e0c-4ab3-8c1e-00765d3b892f, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(HAV_ForgingOfTheHeart_State_ReadyForSecondUpgrade_edce0ffd-21d1-7a6c-2b55-a3e749d06fca, 1);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(GLO_ForgingOfTheHeart_Quest_WaitForNextAct_29c86e0b-100f-5a32-31d6-6bd4e287af71, 0);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, 0);
DB_DeadEvent(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, GLO_Gortash_State_Dead_97868c33-ffff-4b24-b647-6477f774fd09);
DB_RelationshipDialog_WRD_TriggerInCamp(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_GortashPermadefeated_1045fee7-ff39-dc6a-8619-a9bcf1b1adfe);
DB_ExclamationDialog_NeverStop(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_GortashPermadefeated_1045fee7-ff39-dc6a-8619-a9bcf1b1adfe);
DB_TopicalGreeting(TG_ORI_Karlach_AfterGortashDeathAvatar_802e3436-0184-463c-8580-e8c8c9a15bef);
DB_TopicalGreeting(TG_ORI_Karlach_AfterGortashDeathCompanion_cc1791d7-69a0-44aa-8bc0-40f15a129172);
DB_ORI_Karlach_InPartyOMFlags(ORI_Karlach_IPRD_Enrage_68790c64-811d-4e4e-9ff8-02c3b69dd6e6, ORI_Karlach_State_UnlockedEnrageBranch_2408f429-546f-4c85-8fb1-cbdc184b1150);
DB_ORI_Karlach_InPartyOMFlags(ORI_Karlach_IPRD_SoulCoin_c5905063-6ab2-4491-b8df-360d0e7db346, ORI_Karlach_State_UnlockedSoulCoinBranch_8613daab-56b5-49a8-be4b-2765171b0a7b);
DB_ORI_Karlach_InPartyOMFlags(ORI_Karlach_IPRD_FirstUpgrade_4b10a176-899f-f5ab-a292-3ad35324f47d, ORI_Karlach_State_UnlockedFirstUpgradeBranch_c885c76f-c2e5-4ee2-90e1-41914af7314d);
DB_ORI_Karlach_InPartyOMFlags(ORI_Karlach_IPRD_ReachedOverdrive_b64bb016-8c5a-433c-9726-967996799ea9, ORI_Karlach_State_UnlockedReachedOverrideBranch_73bf76a8-f1eb-4205-ab4c-a9abc1020bc3);
DB_ORI_Karlach_InPartyOMFlags(ORI_Karlach_IPRD_GortashInColony_80314a56-b334-48fe-9055-54bcd2efc5b6, ORI_Karlach_State_UnlockGortashInPartyBranch_fb912442-9b36-40fb-8599-169e12465511);
DB_ORI_Karlach_JaheiraHasMetFlags(HAV_Jaheira_HasMet_0f4791bf-fdf7-c7a3-4703-a0577a846434, ORI_Karlach_Event_HasMetJaheiraInHAV_348184aa-ba1e-478b-9b50-a74aa0bdd71c);
DB_ORI_Karlach_JaheiraHasMetFlags(HAV_Jaheira_HasMet_Unprotected_d03e70c2-621f-f6c4-a55b-1fb58297a1da, NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_Karlach_JaheiraHasMetFlags(SCE_Jaheira_HasMet_c3f7240e-7455-1bfd-0c6e-e9c94d1b4f05, ORI_Karlach_Event_HasMetJaheiraAfterHAV_60c6c051-5c19-404d-8c43-a709677f298d);
DB_ORI_Karlach_JaheiraHasMetFlags(ORI_Jaheira_HasMet_814ec660-b54f-4c5f-abe5-3acdaca21df7, ORI_Karlach_Event_HasMetJaheiraAfterHAV_60c6c051-5c19-404d-8c43-a709677f298d);
DB_QuestDef_State(WYR_KillDirectorGortash_Knows_CeremonyLocationAndGortashName_5eb9384c-4108-4a68-85eb-ba72931a7bc9, "ORI_Avatar_Karlach", "KillGortash");
DB_QuestDef_State(WYR_KillDirectorGortash_Knows_CeremonyLocationAndGortashName_5eb9384c-4108-4a68-85eb-ba72931a7bc9, "ORI_COM_Karlach", "ConfrontGortash");
DB_QuestDef_State(ORI_Karlach_Quest_RescuedFromPrison_0cd7a57a-77c3-4087-fc0c-25301150464e, "ORI_COM_Karlach", "KarlachRescued");
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd);
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1);
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b);
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("WLD_Main_A", "");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("CRE_Main_A", "_Act2");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("SCL_Main_A", "_Act2");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("INT_Main_A", "_Act3");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("BGO_Main_A", "_Act3");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("CTY_Main_A", "_Act3");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("IRN_Main_A", "_Act3");
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes("END_Main", "_Act3");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("FindInfernalMetal_FirstUpgrade");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("GetFirstUpgrade");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("DammonFound");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("WaitForNextDay");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("TalkToDammon");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("FindInfernalMetal_SecondUpgrade");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("GetSecondUpgrade");
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates("KarlachFullyUpgraded");
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons("WLD_Main_A", S_ORI_InfernalMetal_002_e9ad4534-e879-4a61-971e-ef6466889672);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons("SCL_Main_A", S_ORI_InfernalMetal_aecd08cb-1350-4358-b458-d46d4c7be792);
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons("SCL_Main_A", S_SHA_InfernalIron_2aac999a-faed-4ad0-9f24-c90d166c3197);

KBSECTION
IF
FlagSet((GUIDSTRING)_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_InPartyOMFlags(_Var1, _Var3, _Var1, _Var1, _Var1)
THEN
SetFlag(_Var3, NULL_00000000-0000-0000-0000-000000000000);

IF
TagSet(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, _, _, _)
THEN
DB_DeadEvent(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
DB_GLO_CharacterCorpseDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, PLA_KarlachRecruitment_Dead_Karlach_fad65f7a-c6bd-d258-b53d-2da039e7e4c9);

IF
TagCleared(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, BLOCK_RESURRECTION_22a75dbb-1588-407e-b559-5aa4e6d4e6a6, _, _, _)
THEN
NOT DB_DeadEvent(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
NOT DB_GLO_CharacterCorpseDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, PLA_KarlachRecruitment_Dead_Karlach_fad65f7a-c6bd-d258-b53d-2da039e7e4c9);

IF
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
NOT DB_DeadEvent(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_Karlach_State_Dead_26f3c3b0-a9c8-40d6-8950-67c9b8e134e2);
NOT DB_GLO_CharacterCorpseDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, PLA_KarlachRecruitment_Dead_Karlach_fad65f7a-c6bd-d258-b53d-2da039e7e4c9);

IF
StatusApplied(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (STRING)_Var1, _, _, (STRING)_Var1)
AND
IsStatusFromGroup(_Var1, "SG_Rage", 1, _Var1, _Var1)
AND
HasAppliedStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_RAGE_FLAMES", 0, _Var1, _Var1)
THEN
ApplyStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_RAGE_FLAMES", -1, 1);

IF
StatusRemoved(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (STRING)_Var1, _, _, (STRING)_Var1)
AND
IsStatusFromGroup(_Var1, "SG_Rage", 1, _Var1, _Var1)
AND
HasAppliedStatusWithGroup(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "SG_Rage", 0, _Var1, _Var1)
THEN
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_RAGE_FLAMES");

IF
DialogEnded(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
THEN
ClearFlag(ORI_Karlach_State_ReturnToDefaultBranch_938d12db-730b-52f2-2b51-6c276f848057, _Var2);

PROC
PROC_DialogFlagSetup(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
DB_ORI_Karlach_ReopenedTadpoleBranchForPlayer(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(ORI_Karlach_State_BlockTadpoleBranch_e1b99918-f6c4-347a-a2f8-de85a9a44f0f, _Var1, 1, _Var1, _Var1)
AND
GetFlag(GLO_Tadpole_Event_FirstConsumed_fab5ae97-23b5-4bf2-88ae-0b1bd57523d8, _Var1, 1, _Var1, _Var1)
THEN
DB_ORI_Karlach_ReopenedTadpoleBranchForPlayer(_Var1);
ClearFlag(ORI_Karlach_State_BlockTadpoleBranch_e1b99918-f6c4-347a-a2f8-de85a9a44f0f, _Var1);

IF
LevelGameplayStarted("SCL_Main_A", _, _, _, _)
AND
DB_GlobalFlag(ORI_Karlach_State_PromisedToDealWithPaladins_41e9f88c-0f3e-427a-911f-5df379642fe4, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
LevelGameplayStarted("CRE_Main_A", _, _, _, _)
AND
DB_GlobalFlag(ORI_Karlach_State_PromisedToDealWithPaladins_41e9f88c-0f3e-427a-911f-5df379642fe4, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

PROC
PROC_DEN_AttackOnDen_BetrayTieflings()
THEN
PROC_Origins_ForceLowApprovalLeavingDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
TemplateAddedTo(LOOT_SoulCoin_8c68e68d-96d4-45d6-804c-5f31ac948ff3, (GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1)
AND NOT
DB_OnlyOnce("ORI_Karlach_FoundSoulCoin", _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(ORI_Karlach_Knows_InfernalEngineExists_9b6d609a-2081-b5de-7dd6-12c425a8bc17, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Karlach_Event_ReachedOverdrive_8c308560-7a87-49f5-ae52-143b48dd963b, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
IsInMagicPockets(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1, _Var1, _Var1)
AND
QRY_OnlyOnce("ORI_Karlach_FoundSoulCoin", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_SoulCoin_c5905063-6ab2-4491-b8df-360d0e7db346, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_GLO_PartyMembers_AddHook(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_OnlyOnce("ORI_Karlach_FoundSoulCoin", _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(ORI_Karlach_Knows_InfernalEngineExists_9b6d609a-2081-b5de-7dd6-12c425a8bc17, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Karlach_Event_ReachedOverdrive_8c308560-7a87-49f5-ae52-143b48dd963b, _Var1, _Var1, _Var1, _Var1)
AND
TemplateGetCountInMagicPockets(LOOT_SoulCoin_8c68e68d-96d4-45d6-804c-5f31ac948ff3, _Var1, _Var2, _Var1, _Var1)
AND
_Var2 > 0
AND
QRY_OnlyOnce("ORI_Karlach_FoundSoulCoin", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_SoulCoin_c5905063-6ab2-4491-b8df-360d0e7db346, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet(ORI_Karlach_State_HasSoulCoin_9e5fb882-7511-401d-befa-f40261dc56de, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_OnlyOnce("ORI_Karlach_FoundSoulCoin", _, _, _, _)
THEN
DB_ORI_SoulCoinDiscovery_StartSoulCoinDialog(1);

IF
DB_ORI_SoulCoinDiscovery_StartSoulCoinDialog(1, _, _, _, _)
AND NOT
DB_CantTalk(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_StartDialog_Fixed(ORI_Karlach_FoundSoulCoin_b413b479-39e8-d999-ebda-ebd106af9641, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _)
THEN
NOT DB_ORI_SoulCoinDiscovery_StartSoulCoinDialog(1);

IF
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _, _, _, _)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_ORI_CoolingDownForYou_Dialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Partnered(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_CoolingDownForYou_Dialog(_Var1);

IF
StatusApplied(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (STRING)_Var1, _, _, (STRING)_Var1)
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_CoolingDownForYou_Dialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
StatusApplied((CHARACTER)_Var1, (STRING)_Var2, _, _, (CHARACTER)_Var1)
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_GetPartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_ORI_PartnerOrDatingAvatar(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_CoolingDownForYou_Dialog(_Var1);

IF
AttackedBy(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, "Cold", _, _, _, _, _, _)
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _, _, _, _)
THEN
PROC_ORI_CoolingDownForYou_Dialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

QRY
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_ORI_CoolingDownForYou_ValidStatuses(_Var2, 0, _Var1, _Var1, _Var1)
AND
HasAppliedStatus(_Var1, _Var2, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
_Var1 != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
DB_ORI_CoolingDownForYou_ValidStatuses(_Var2, 1, _Var1, _Var1, _Var1)
AND
HasAppliedStatus(_Var1, _Var2, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_ORI_CoolingDownForYou_Dialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1);
PROC_GlobalClearFlagAndCache(ORI_Karlach_State_WaitingForSolution_e1bf36eb-9538-d684-442e-162807e37456);
DB_ORI_CoolingDownForYou_StartDialog(_Var1);

IF
DB_ORI_CoolingDownForYou_StartDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_CantTalk(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_ORI_CoolingDownForYou_StartDialog(_Var1);
PROC_ORI_CoolingDownForYou_Dialog_Internal(_Var1);

PROC
PROC_ORI_CoolingDownForYou_Dialog_Internal((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
_Var1 != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
QRY_ORI_GetPartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_ORI_PartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND
QRY_StartDialog_Fixed(CAMP_Karlach_ROM_CoolingDownForYou_6df8c8ce-b7e7-33ea-8f52-9fedb1a79f3f, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_ORI_CoolingDownForYou_Dialog_Internal(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_ORI_GetPartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_QRYRTN_ORI_PartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND
QRY_StartDialog_Fixed(CAMP_Karlach_ROM_CoolingDownForYou_6df8c8ce-b7e7-33ea-8f52-9fedb1a79f3f, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_GetPartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
DB_QRYRTN_ORI_PartnerOrDatingAvatar(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(CAMP_Karlach_ROM_CoolingDownForYou_6df8c8ce-b7e7-33ea-8f52-9fedb1a79f3f, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1);

PROC
PROC_DialogStarted(CAMP_Karlach_ROM_CoolingDownForYou_6df8c8ce-b7e7-33ea-8f52-9fedb1a79f3f, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(ORI_Karlach_State_BlockCoolingDownForYou_9347aa1b-94f9-92b0-a9ea-8916b9af7d52, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved((CHARACTER)_Var1, (STRING)_Var2, _, _, (CHARACTER)_Var1)
AND
DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_ORI_CoolingDownForYou_HasValidResistanceStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_CoolingDownForYou_RemoveResistance(_Var1);

PROC
PROC_ORI_CoolingDownForYou_RemoveResistance((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
NOT DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1);

PROC
PROC_ORI_CoolingDownForYou_RemoveResistance((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_ORI_CoolingDownForYou_StartDialog(_Var1);

PROC
PROC_ORI_CoolingDownForYou_RemoveResistance((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_ORI_CoolingDownForYou_PlayerWithResistance(_, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GlobalSetFlagAndCache(ORI_Karlach_State_WaitingForSolution_e1bf36eb-9538-d684-442e-162807e37456);

PROC
PROC_Camp_EveryoneWakeupEndHook()
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _, _, _, _)
THEN
PROC_ORI_CoolingDownForYou_Clear();

PROC
PROC_Camp_Leave(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_GlobalFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, _, _, _, _)
THEN
PROC_ORI_CoolingDownForYou_Clear();

PROC
PROC_ORI_CoolingDownForYou_Clear()
AND
DB_ORI_CoolingDownForYou_PlayerWithResistance(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_CoolingDownForYou_RemoveResistance(_Var1);

PROC
PROC_ORI_CoolingDownForYou_Clear()
THEN
ClearFlag(ORI_Karlach_State_HelpingAboutBurningOthers_96189a7e-1c8d-c908-adb9-bc8e8ce4b1a7, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_Karlach_Event_SetHighLevelBurningState_a4f81325-2eb2-4606-8066-773cc782b9dc, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearFlag(ORI_Karlach_Event_SetHighLevelBurningState_a4f81325-2eb2-4606-8066-773cc782b9dc, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
ApplyStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", 60, 1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
FlagSet(ORI_Karlach_Event_SetLowLevelBurningState_e693ee79-85af-4940-8ab4-8a9a10a8635f, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearFlag(ORI_Karlach_Event_SetLowLevelBurningState_e693ee79-85af-4940-8ab4-8a9a10a8635f, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
ApplyStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", 60, 1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
StatusApplied(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", _, _, _)
AND
HasAppliedStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", 0, _, _)
THEN
SetFlag(ORI_Karlach_State_Burning_e3ebe6f8-d24a-4b47-acf2-8e47a96a1464, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", _, _, _)
AND
HasAppliedStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", 0, _, _)
THEN
ClearFlag(ORI_Karlach_State_Burning_e3ebe6f8-d24a-4b47-acf2-8e47a96a1464, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusApplied(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", _, _, _)
AND
HasAppliedStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", 0, _, _)
THEN
SetFlag(ORI_Karlach_State_Burning_e3ebe6f8-d24a-4b47-acf2-8e47a96a1464, NULL_00000000-0000-0000-0000-000000000000);

IF
StatusRemoved(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", _, _, _)
AND
HasAppliedStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", 0, _, _)
THEN
ClearFlag(ORI_Karlach_State_Burning_e3ebe6f8-d24a-4b47-acf2-8e47a96a1464, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_Karlach_Event_StopBurning_eb256a3f-aaa4-46e3-bbc6-28a71d3268ac, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearFlag(ORI_Karlach_Event_StopBurning_eb256a3f-aaa4-46e3-bbc6-28a71d3268ac, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_HIGHLEVEL_VFX", S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_BURNING_LOWLEVEL_VFX", S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
TemplateUseFinished(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, LOOT_SoulCoin_8c68e68d-96d4-45d6-804c-5f31ac948ff3, _, 1, (ITEM)_)
THEN
PROC_IncreaseCounter("ORI_Karlach_SoulCoinsConsumed");

PROC
PROC_CounterIncreased("ORI_Karlach_SoulCoinsConsumed", 10, _, _, _)
THEN
SetFlag(ORI_Karlach_State_OverdriveSkillUnlocked_8247bd54-e88c-4712-b9c9-25eb9fc890af, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(ORI_Karlach_Event_ReachedOverdrive_8c308560-7a87-49f5-ae52-143b48dd963b, NULL_00000000-0000-0000-0000-000000000000);
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_ReachedOverdrive_b64bb016-8c5a-433c-9726-967996799ea9, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
DB_GlobalFlag(ORI_Karlach_Event_ReachedOverdrive_8c308560-7a87-49f5-ae52-143b48dd963b, _, _, _, _)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_CantTalk(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_ORI_Karlach_AvatarOverdriveDialog();

PROC
PROC_ORI_Karlach_AvatarOverdriveDialog()
THEN
PROC_GlobalClearFlagAndCache(ORI_Karlach_Event_ReachedOverdrive_8c308560-7a87-49f5-ae52-143b48dd963b);

PROC
PROC_ORI_Karlach_AvatarOverdriveDialog()
AND
QRY_StartDialog_Fixed(ORI_Karlach_AvatarOverdrive_c1899f27-c130-2c09-c7b2-6085f8514e8e, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _)
THEN
DB_NOOP(1);

IF
DialogEnded((GUIDSTRING)_Var1, (INTEGER)_Var2, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(_, _Var1, _Var4, _Var5, _Var1)
AND NOT
DB_DialogRequestFailed(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_CurrentLevel(_Var4, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(_Var5, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(_Var5, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_OM_BlockDisablingTrade((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
TemplateAddedTo((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var3, _, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_PreventMPDialogue(_Var3, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("ORI_Karlach_PlayFoundInfernalMetalPAD", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(GLO_ForgingOfTheHeart_PAD_FoundInfernalMetal_2b7ced89-ad85-7490-33af-d5c5050b8333, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);

IF
FlagSet(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
AND
QRY_OnlyOnce_Reset("ORI_Karlach_PlayFoundInfernalMetalPAD", _, _, _, _)
THEN
SetFlag(ORI_Karlach_State_FoundMetalBranchUnlocked_e262fc84-d7ea-4e21-98de-102fcdc57ed0, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachUpgraded_a818e2f5-9e0c-4ab3-8c1e-00765d3b892f, _, _, _, _)
AND
QRY_OnlyOnce_Reset("ORI_Karlach_PlayFoundInfernalMetalPAD", _, _, _, _)
THEN
SetFlag(ORI_Karlach_State_FoundMetalBranchUnlocked_e262fc84-d7ea-4e21-98de-102fcdc57ed0, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ClearFlag(ORI_Karlach_State_FoundMetalBranchUnlocked_e262fc84-d7ea-4e21-98de-102fcdc57ed0, NULL_00000000-0000-0000-0000-000000000000);

IF
TemplateAddedTo((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, "Regular", (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(GLO_ForgingOfTheHeart_State_ReceivedInfernalMetal_b2d05896-e0b7-4f46-8a54-2db04eae6d4b, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, 1, _Var1, _Var1)
THEN
ClearFlag(GLO_ForgingOfTheHeart_State_ReceivedInfernalMetal_b2d05896-e0b7-4f46-8a54-2db04eae6d4b, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79);
RequestDelete(_Var2);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachUpgraded_a818e2f5-9e0c-4ab3-8c1e-00765d3b892f, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
ApplyStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE", -1, 1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_FirstUpgrade_4b10a176-899f-f5ab-a292-3ad35324f47d, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
SetFlag(GLO_Karlach_State_CanHaveSex_1ea8dd6c-0562-473d-8310-6fdfdbffadca, NULL_00000000-0000-0000-0000-000000000000);
RemoveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE");
ApplyStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_SECONDUPGRADE", -1, 1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c);
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_SecondUpgrade_54aef59f-3758-4254-a315-3723e9f9edc9, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_Camp_EveryoneWakeupEndHook()
AND
DB_GlobalFlag(HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, _, _, _, _)
THEN
SetFlag(HAV_ForgingOfTheHeart_State_ReadyForSecondUpgrade_edce0ffd-21d1-7a6c-2b55-a3e749d06fca, NULL_00000000-0000-0000-0000-000000000000);
ClearFlag(HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, NULL_00000000-0000-0000-0000-000000000000);
PROC_DefineSingleOriginMoment(HAV_TieflingSurvivors_Weaponsmith_c2312421-411c-757e-551b-3e7ddbb9d7e7, REALLY_KARLACH_1a2f70d6-8ead-4eb5-a824-79ee1971764a, GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1);
PROC_DefineSingleOriginMoment(LOW_Dammon_028c720e-ece2-d8e4-de6c-cd4fa8faad26, REALLY_KARLACH_1a2f70d6-8ead-4eb5-a824-79ee1971764a, GLO_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_e31f3936-c198-cf82-bd8f-e26efba691f1);

QRY
QRY_SelectCustomDialog_AfterGenerics(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_CurrentLevel(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(_Var3, _, _Var2, _Var5, _Var1)
AND
DB_GlobalFlag(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_DoubleOriginMoment(_Var3, _, _, GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b, _, _, _, _, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND
DB_Dialogs(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _Var3, _Var1, _Var1, _Var1)
AND
QRY_GLO_Karlach_TryDefineForgingOfTheHeartFollowUp(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
0 == 1
THEN
DB_NOOP(1);

QRY
QRY_GLO_Karlach_TryDefineForgingOfTheHeartFollowUp((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
QRY_GLO_Karlach_BlockForgingOfTheHeartFollowUp()
AND
DB_ORI_Karlach_ForgingOfTheHeart_DevDialogues(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
PROC_DefineSingleOriginMoment(_Var2, KARLACH_9aab4bcd-e1f7-4008-8f7b-f1203789ae9b, GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b);

QRY
QRY_GLO_Karlach_BlockForgingOfTheHeartFollowUp()
AND
DB_GlobalFlag(HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_ForgingOfTheHeart_State_ReadyForSecondUpgrade_edce0ffd-21d1-7a6c-2b55-a3e749d06fca, _, _, _, _)
THEN
DB_NOOP(1);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachUpgraded_a818e2f5-9e0c-4ab3-8c1e-00765d3b892f, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
NOT DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_Weaponsmith_PostEA_f2e19bab-4804-9a49-c7ee-0a190f1fcafd, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
NOT DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_DruidAttack_Weaponsmith_PostEA_23532629-93cf-a224-d39d-f29825c49025, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
NOT DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(DEN_AttackOnDen_Weaponsmith_f74a35e9-5895-dd0f-5c83-52009f6b0379, DEN_ForgingOfTheHeart_OM_Karlach_AOM_OOM_COM_61ffefa2-22fd-2f44-cfd1-29abbba4a2fd, "WLD_Main_A", ORI_Karlach_State_HadForgingOfTheHeartOM_Act1_7fe068a3-9d1f-438f-ba2a-3e4379d32f20);
PROC_ClearOriginMoment(GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
AND
DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(_Var3, _Var4, _Var5, _Var6, _)
THEN
NOT DB_ORI_Karlach_ForgingOfTheHeart_OMFlags(_Var3, _Var4, _Var5, _Var6);

IF
FlagSet(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ClearOriginMoment(GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b);
PROC_TopicalGreeting_UnlockTopic(TG_ORI_Karlach_GotSecondUpgrade_617c5dc9-0c92-49f6-8994-63e9d06edb6a);

QRY
QRY_OriginMoment_PreventRelaunchDialog(GLO_ForgingOfTheHeart_FollowUp_OM_Karlach_AOM_OOM_COM_b141c825-0beb-5216-a106-e5cec367f70b, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_NOOP(1);

PROC
PROC_GlobalFlagReactionAfterDialog(GLO_ForgingOfTheHeart_Event_ToldToGetMoreMetal_b2c0ae25-b3d7-eea3-7468-4283334e9b6c, _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_FindMoreMetal_b821a524-63b8-0f73-a49f-51e05fa3a048, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(_Var1, 1, _Var1, _Var1, _Var1)
THEN
ClearFlag(GLO_ForgingOfTheHeart_State_BlockInfernalMetalQuestion_8095c7e4-d365-d4f2-2f95-69da62ddb0a4, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_InfernalMetalBranch(_Var1, 0, _Var1, _Var1, _Var1)
THEN
SetFlag(GLO_ForgingOfTheHeart_State_BlockInfernalMetalQuestion_8095c7e4-d365-d4f2-2f95-69da62ddb0a4, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_GLO_SteelWatchers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Dialogs(_Var1, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_Karlach_SteelWatcher_ProcessedDialogues(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Karlach_State_EncounteredSteelWatcher_a60d0317-5188-464d-b8c4-1f5307a7a65b, _Var1, _Var1, _Var1, _Var1)
THEN
DB_ORI_Karlach_SteelWatcher_ProcessedDialogues(_Var2);
PROC_DefineSingleOriginMoment(_Var2, KARLACH_9aab4bcd-e1f7-4008-8f7b-f1203789ae9b, GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6, GLO_SteelWatchers_OM_Karlach_COM_bab2d2bc-7f56-3408-a2ad-1e9699f291c6, GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6);

IF
DB_GLO_SteelWatchers_CustomDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Dialogs(_Var1, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_Karlach_SteelWatcher_ProcessedDialogues(_Var2, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Karlach_State_EncounteredSteelWatcher_a60d0317-5188-464d-b8c4-1f5307a7a65b, _Var1, _Var1, _Var1, _Var1)
THEN
DB_ORI_Karlach_SteelWatcher_ProcessedDialogues(_Var2);
PROC_DefineSingleOriginMoment(_Var2, KARLACH_9aab4bcd-e1f7-4008-8f7b-f1203789ae9b, GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6, GLO_SteelWatchers_OM_Karlach_COM_bab2d2bc-7f56-3408-a2ad-1e9699f291c6, GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6);

IF
DialogStarted(GLO_SteelWatchers_OM_Karlach_COM_bab2d2bc-7f56-3408-a2ad-1e9699f291c6, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(ORI_Karlach_State_EncounteredSteelWatcher_a60d0317-5188-464d-b8c4-1f5307a7a65b, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogStarted(GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetFlag(ORI_Karlach_State_EncounteredSteelWatcher_a60d0317-5188-464d-b8c4-1f5307a7a65b, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_OriginMoment_OutsideCOMTrigger(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6, _, _, _)
AND
IsInTrigger(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, 1, _, _)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_OutsideCOMTrigger(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, GLO_SteelWatchers_OM_Karlach_COM_bab2d2bc-7f56-3408-a2ad-1e9699f291c6, _, _, _)
AND
IsInTrigger(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_WYR_WyrmRock_AudienceHallArea_a078f420-9f5e-452b-9391-e96e754b61c8, 1, _, _)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(GLO_SteelWatchers_OM_Karlach_COM_bab2d2bc-7f56-3408-a2ad-1e9699f291c6, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
DB_NOOP(1);

QRY
QRY_OriginMoment_PreventRelaunchDialog(GLO_SteelWatchers_OM_Karlach_AOM_OOM_fadbf09f-e900-e797-0606-db5c8f3e54b6, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
DB_NOOP(1);

IF
FlagSet(COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_GortashConfrontation_AnyPlayerHasFlag(LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(ORI_GortashConfrontation_State_PartyHasBothStones_c42f5ebb-d471-47aa-9a19-40aebe9e7b2a, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_GortashConfrontation_AnyPlayerHasFlag(COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(ORI_GortashConfrontation_State_PartyHasBothStones_c42f5ebb-d471-47aa-9a19-40aebe9e7b2a, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagCleared(LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_ORI_GortashConfrontation_AnyPlayerHasFlag(LOW_BhaalTemple_State_HasNetherstone_818fd00e-6780-4712-980e-5c7c25ba9987, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(ORI_GortashConfrontation_State_PartyHasBothStones_c42f5ebb-d471-47aa-9a19-40aebe9e7b2a, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagCleared(COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_ORI_GortashConfrontation_AnyPlayerHasFlag(COL_KethericShowdown_State_HasNetherstone_0243527e-408f-4711-97a0-7759847bb00a, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(ORI_GortashConfrontation_State_PartyHasBothStones_c42f5ebb-d471-47aa-9a19-40aebe9e7b2a, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_ORI_GortashConfrontation_AnyPlayerHasFlag((FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(_Var1, _Var2, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
FlagSet((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_JaheiraHasMetFlags(_Var1, _Var4, _Var1, _Var1, _Var1)
AND
_Var4 != NULL_00000000-0000-0000-0000-000000000000
THEN
SetFlag(_Var4, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_JaheiraHasMetFlags(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UnlockHasMetJaheiraBranch();

PROC
PROC_ORI_Karlach_UnlockHasMetJaheiraBranch()
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_OnlyOnce("ORI_Karlach_HasMetJaheira", _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_MetJaheira_ab0c8400-202d-49a3-aa0a-81b201f4f066, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
TagSet(S_Player_Wyll_c774d764-4a17-48dc-b470-32ace9ce447d, WYLL_DEVIL_5e844f0e-d822-4210-a28e-6af149a7bd4b, _, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_GlobalFlag(DBG_Act3_Setup_Good_eecb2a28-fbbb-4e51-856b-8f6a0b1edfbe, _, _, _, _)
AND
QRY_OnlyOnce("ORI_Karlach_ReactsToWyllTransformation", _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_WyllTransformation_26799c64-03fb-5581-059c-fe04d2987050, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_DialogStarted(CAMP_MizorasJudgement_CRD_Karlach_66ec5e1a-22ce-1538-d84f-1048c92df582, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_OnlyOnce("ORI_Karlach_ReactsToWyllTransformation");
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_WyllTransformation_26799c64-03fb-5581-059c-fe04d2987050);

IF
FlagSet(GLO_Monitor_State_MadeDeal_86f40f63-0bfa-4ab6-b3b0-d01475c3cbdc, _, (INTEGER)_Var2, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_DialogPlayers(_Var2, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1, _, _)
AND NOT
DB_GlobalFlag(END_General_State_Started_a0fd5f91-e4b3-4d01-84d3-9ff484139e99, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_SignedContractWithRaphael_b0bca668-7f2d-4ce7-acb6-b5ff96880388, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet(ORI_Karlach_State_SleptWithMizora_e0c36221-366c-d689-58b9-de92dc651cbe, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
DB_ORI_Karlach_ConfrontAvatarAboutMizora(_Var1);

PROC
PROC_GLO_PartyMembers_AddHook(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_OnlyOnce("ORI_Karlach_ConfrontPlayerAboutMizoraRomance", _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ConfrontAvatarAboutMizora(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_TryConfrontPlayerAboutMizoraRomance(_Var1);

PROC
PROC_Camp_Leave(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_OnlyOnce("ORI_Karlach_ConfrontPlayerAboutMizoraRomance", _, _, _, _)
AND
DB_ORI_Karlach_ConfrontAvatarAboutMizora(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_TryConfrontPlayerAboutMizoraRomance(_Var1);

PROC
PROC_ORI_Karlach_TryConfrontPlayerAboutMizoraRomance((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_ORI_Partnered(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("ORI_Karlach_ConfrontPlayerAboutMizoraRomance", _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_ORI_Karlach_ConfrontAvatarAboutMizora(_Var1);
DB_RelationshipDialog_AutostartTryOnce(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_MizoraPartnerFollowup_de1c1b7e-3eb4-11dc-6217-bf8e236d1166);
DB_ExclamationDialog_NeverStop(Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_MizoraPartnerFollowup_de1c1b7e-3eb4-11dc-6217-bf8e236d1166);
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_MizoraPartnerFollowup_de1c1b7e-3eb4-11dc-6217-bf8e236d1166, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 1);

IF
DB_CurrentLevel("END_Main", _, _, _, _)
THEN
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_GortashPermadefeated_1045fee7-ff39-dc6a-8619-a9bcf1b1adfe);
TimerCancel("ORI_Karlach_TryTriggerGortashPermadefeatedIPRD");

IF
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_CantTalk(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_ORI_Karlach_TriggeredGortashPermadefeatedIPRD(1, _, _, _, _)
AND NOT
DB_ORI_Karlach_BlockedGortashPermadefeatedIPRD(1, _, _, _, _)
AND NOT
DB_CurrentLevel("END_Main", _, _, _, _)
THEN
TimerLaunch("ORI_Karlach_TryTriggerGortashPermadefeatedIPRD", 1500);

IF
FlagSet(GLO_Gortash_State_PermaDefeated_74dd56ff-7e00-42a6-a0f3-0d122f364769, _, _, _, _)
AND NOT
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
SetFlag(ORI_Karlach_Event_GortashPermadefeated_WasNotInParty_a2901fa7-f325-6d7b-19d1-82bd86eee69c, NULL_00000000-0000-0000-0000-000000000000);

IF
TimerFinished("ORI_Karlach_TryTriggerGortashPermadefeatedIPRD", _, _, _, _)
AND NOT
DB_CantTalk(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
DB_ORI_Karlach_TriggeredGortashPermadefeatedIPRD(1);
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_GortashPermadefeated_1045fee7-ff39-dc6a-8619-a9bcf1b1adfe, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_DialogStarted(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_ORI_Karlach_BlockedGortashPermadefeatedIPRD(1);
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_GortashPermadefeated_1045fee7-ff39-dc6a-8619-a9bcf1b1adfe);

PROC
PROC_BlockLootCorpse((CHARACTER)_Var1, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_CurrentLevel("END_Main", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_TryStartGortashCorpseDialog(_Var1);

PROC
PROC_ORI_Karlach_TryStartGortashCorpseDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_OnlyOnce("ORI_Karlach_BlockGortashCorpseDialog", _Var1, _Var1, _Var1, _Var1)
THEN
DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var1);

PROC
PROC_ORI_Karlach_TryStartGortashCorpseDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_OnlyOnce("ORI_Karlach_BlockGortashCorpseDialog", _, _, _, _)
AND
QRY_ORI_GortashConfrontation_SelectKarlachInteractingDialog()
THEN
DB_NOOP(1);

PROC
PROC_ORI_Karlach_TryStartGortashCorpseDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_OnlyOnce("ORI_Karlach_BlockGortashCorpseDialog", _Var1, _Var1, _Var1, _Var1)
AND
QRY_ORI_GortashConfrontation_SelectNotKarlachInteractingDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_ORI_Karlach_TryStartGortashCorpseDialog(_, _, _, _, _)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var2, _, _, _, _)
THEN
NOT DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var2);

IF
DialogStarted(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
DB_OnlyOnce("ORI_Karlach_BlockGortashCorpseDialog");
SetFlag(ORI_Karlach_Knows_GortashGrudge_65838018-f5f0-4ecf-acd7-0b6ca245a9a2, NULL_00000000-0000-0000-0000-000000000000);

QRY
QRY_ORI_GortashConfrontation_SelectKarlachInteractingDialog()
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_GetBestAvatarForCompanion(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_QRYRTN_GetBestAvatarForCompanion(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsInDialogRange(_Var1, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1)
AND
QRY_StartDialog_Fixed(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1)
AND
QRY_WYR_GortashConfrontation_DialogSpeakerIsLooter(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_CustomLootCorpseResponse(_Var2, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, 0);

QRY
QRY_WYR_GortashConfrontation_DialogSpeakerIsLooter((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_WYR_GortashConfrontation_DialogSpeakerIsLooter(_, _, _, _, _)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_ORI_GortashConfrontation_SelectKarlachInteractingDialog()
AND
QRY_StartDialog_Fixed(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
DB_CustomLootCorpseResponse(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, 0);

QRY
QRY_ORI_GortashConfrontation_SelectNotKarlachInteractingDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Var1, _Var1, _Var1)
AND
QRY_StartDialog_Fixed(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1)
AND
QRY_WYR_GortashConfrontation_DialogSpeakerIsLooter(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_WYR_GortashConfrontation_LootingGortashCorpse(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
DB_CustomLootCorpseResponse(_Var2, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, 0);

PROC
PROC_StateSet_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND
DB_InCamp(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
SetFlag(ORI_Karlach_State_GortashDefeatedWhileInCamp_a911b164-a03d-fe58-4ef5-e47b0951c102, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_InCamp(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_GlobalFlag(WYR_GortashConfrontation_Event_SendKarlachToCamp_7a52ef44-835d-4af9-0388-cdd1036a09ed, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet(ORI_Karlach_Event_ClearAfterGortashDefeatCRDAndIPRD_bbc8076f-bdd6-f53a-d9c3-3cfd87df1baf, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);

PROC
PROC_CAMP_LeftCamp(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_CampNight_ClearCampNight(NIGHT_Karlach_AfterDefeatingGortash_b8e239e4-e73e-433e-9550-e4a56bdbffd1);
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_AfterDefeatingGortash_585a4ee6-b04f-2559-2bc5-ae99a1f57ff2);

IF
DialogEnded(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, _, _, _)
AND NOT
DB_DialogRequestFailed(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, _, _, _)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_TopicalGreeting_UnlockTopic(TG_ORI_Karlach_AfterGortashDeathAvatar_802e3436-0184-463c-8580-e8c8c9a15bef);

IF
DialogEnded(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, _, _, _)
AND NOT
DB_DialogRequestFailed(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_TopicalGreeting_UnlockTopic(TG_ORI_Karlach_AfterGortashDeathCompanion_cc1791d7-69a0-44aa-8bc0-40f15a129172);

PROC
PROC_LevelUnloading("BGO_Main_A", _, _, _, _)
AND
DB_TopicalGreeting_Current(TG_ORI_Karlach_AfterGortashDeathAvatar_802e3436-0184-463c-8580-e8c8c9a15bef, _, _, _, _)
THEN
PROC_TopicalGreeting_ClearOldTopic();

PROC
PROC_LevelUnloading("BGO_Main_A", _, _, _, _)
AND
DB_TopicalGreeting_Current(TG_ORI_Karlach_AfterGortashDeathCompanion_cc1791d7-69a0-44aa-8bc0-40f15a129172, _, _, _, _)
THEN
PROC_TopicalGreeting_ClearOldTopic();

IF
FlagSet(GLO_Jaheira_State_LeftInAnger_16778577-593d-4bdf-b0bb-aaa7fb927a87, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_JaheiraLeftAngry_eb11a6b1-2388-4f9a-8812-0205bd485875, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

PROC
PROC_GlobalFlagReactionAfterDialog(INT_EmperorRevealed_Event_SceneComplete_2fa4811a-8757-40e7-a0bb-dc7e210dd6e6, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_EmperorRevealed_06420aa1-cfa8-6f06-7bee-53cc6f1ab958, S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, 0);

IF
FlagSet(VISITEDREGION_BGO_Main_A_40f06537-814f-4796-b012-5ffaa648a8d9, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_CancelRelationshipDialog(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, Karlach_InParty_12459660-b66e-9b0b-9963-670e0993543d, ORI_Karlach_IPRD_EmperorRevealed_06420aa1-cfa8-6f06-7bee-53cc6f1ab958);

PROC
PROC_ORI_Karlach_UpdateJournal((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_Avatar_Karlach", _Var1);

PROC
PROC_ORI_Karlach_UpdateJournal((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("ORI_COM_Karlach", _Var1);

PROC
PROC_ORI_Karlach_UpdateJournal((CHARACTER)_Var1, (STRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "ORI_COM_Karlach", _Var2);

PROC
PROC_LevelLoadedOnce(_, _, _, _, _)
AND
DB_Avatars(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_QuestIsAccepted("ORI_Avatar_Karlach", _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("EscapeAvernus");

PROC
PROC_LevelLoadedOnce("WLD_Main_A", _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("AvernusEscaped");

IF
FlagSet(ORI_Karlach_Quest_AgreedToHelpNotRecruited_f08dc12e-cb2e-e373-e2eb-b0d2c7b0d7dc, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("NotRecruited_PaladinsNotDefeated");

PROC
PROC_CheckFirstTimeRecruited(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("Recruited_PaladinsNotDefeated");
SetFlag(ORI_Karlach_State_Recruited_ed56dd05-9a92-4729-88bc-f4e6c6fb5be8);

IF
FlagSet(ORI_Karlach_State_PromisedToDealWithPaladins_41e9f88c-0f3e-427a-911f-5df379642fe4, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateJournal("PaladinsReminder");

IF
FlagSet(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
AND
DB_PartOfTheTeam(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
QRY_ORI_Karlach_HadAnyPaladinsEntries()
THEN
PROC_ORI_Karlach_UpdateJournal("ExploreSwordCoast");

QRY
QRY_ORI_Karlach_HadAnyPaladinsEntries()
AND
DB_QuestIsAccepted("PLA_PaladinsOfTyr", _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Karlach_HadAnyPaladinsEntries()
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_Avatar_Karlach", "DealWithPaladins", _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_CheckFirstTimeRecruited(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
AND
DB_GlobalFlag(PLA_KarlachRecruitmentTollhouse_State_PaladinsPermaDefeated_d78dbc95-8d8e-4b3a-b618-ccfb48c31375, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("Recruited_PaladinsDefeated");
SetFlag(ORI_Karlach_State_Recruited_ed56dd05-9a92-4729-88bc-f4e6c6fb5be8);

IF
DialogEnded(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_DialogRequestFailed(COL_KethericShowdown_ChosenThree_94ef9fa6-729b-d34a-623a-74a8c3ba187f, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateJournal("MetGortashInCOL_KarlachPresent");

PROC
PROC_COL_KethericShowdown_AfterDefeat()
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Karlach", "MetGortashInCOL_KarlachPresent", _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KethericDefeated");

IF
FlagSet(ORI_Karlach_Quest_HuntGortash_8092d608-7969-3862-5f9a-d8a9853307b5, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateJournal("LearntGortashStory");

IF
DB_Sees(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _)
AND NOT
DB_ORI_Karlach_FoundGortash(1, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("ConfrontGortash");

IF
DB_Sees(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _)
AND NOT
DB_ORI_Karlach_FoundGortash(1, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KillGortash");

IF
QuestUpdateUnlocked(_, "ORI_Avatar_Karlach", "KillGortash", (CHARACTER)_, (CHARACTER)_)
THEN
DB_ORI_Karlach_FoundGortash(1);

IF
QuestUpdateUnlocked(_, "ORI_COM_Karlach", "ConfrontGortash", (CHARACTER)_, (CHARACTER)_)
THEN
DB_ORI_Karlach_FoundGortash(1);

IF
FlagSet(ORI_GortashConfrontation_Event_KarlachSentToPrison_f6764bce-1df3-4f81-91d0-bf986329798e, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateJournal("RescueKarlach");

IF
DB_Is_InCombat(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateJournal("KillGortash_AtWYR");

IF
EnteredChasm(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, (GUIDSTRING)_Var1, _, _, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND NOT
QRY_GLO_Chasms_HasChasmImmunity(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _Var1, _Var1, _Var1, _Var1)
THEN
DB_ORI_Karlach_GortashFellInChasm(1);

IF
Died(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
THEN
TimerLaunch("ORI_Karlach_CheckGortashInChasm", 500);

IF
TimerFinished("ORI_Karlach_CheckGortashInChasm", _, _, _, _)
AND
QRY_ORI_Karlach_GortashCorpseAvailable()
THEN
PROC_ORI_Karlach_UpdateJournal("GoToGortashCorpse");

IF
TimerFinished("ORI_Karlach_CheckGortashInChasm", _, _, _, _)
AND NOT
QRY_ORI_Karlach_GortashCorpseAvailable()
THEN
PROC_ORI_Karlach_SaveTheCityJournalUpdate();

IF
DB_OffStage(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
THEN
PROC_ORI_Karlach_SaveTheCityJournalUpdate();

QRY
QRY_ORI_Karlach_GortashCorpseAvailable()
AND NOT
DB_ORI_Karlach_GortashFellInChasm(1, _, _, _, _)
AND
DB_Dead(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_DialogStarted(WYR_GortashConfrontation_SoulConsumption_d1543a3d-c943-003c-3e9e-c3b93e0758f2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_ORI_Karlach_SaveTheCityJournalUpdate();

PROC
PROC_ORI_Karlach_SaveTheCityJournalUpdate()
AND
QRY_ORI_Karlach_CanCompleteForgingOfTheHeart()
THEN
PROC_ORI_Karlach_UpdateJournal("SaveTheCity");

PROC
PROC_ORI_Karlach_SaveTheCityJournalUpdate()
AND
QRY_ORI_Karlach_CanCompleteForgingOfTheHeart()
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("GetUpgrades_DoesKnowDammon");

PROC
PROC_ORI_Karlach_SaveTheCityJournalUpdate()
AND
QRY_ORI_Karlach_CanCompleteForgingOfTheHeart()
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("GetUpgrades_DoesKnowDammon");

IF
QuestClosed("ORI_Avatar_Karlach_SUB_ForgingOfTheHeart", _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
THEN
PROC_ORI_Karlach_CloseMainQuest();

IF
QuestClosed("ORI_COM_Karlach_SUB_ForgingOfTheHeart", _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
THEN
PROC_ORI_Karlach_CloseMainQuest();

PROC
PROC_ORI_Karlach_SaveTheCityJournalUpdate()
AND NOT
QRY_ORI_Karlach_CanCompleteForgingOfTheHeart()
THEN
PROC_ORI_Karlach_CloseMainQuest();

QRY
QRY_ORI_Karlach_CanCompleteForgingOfTheHeart()
AND NOT
DB_PermaDefeated(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _, _, _, _)
AND NOT
QRY_ORI_Karlach_ForgingOfTheHeartClosed()
THEN
DB_NOOP(1);

QRY
QRY_ORI_Karlach_ForgingOfTheHeartClosed()
AND NOT
DB_QuestIsClosed("ORI_Avatar_Karlach_SUB_ForgingOfTheHeart", _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Karlach_ForgingOfTheHeartClosed()
AND NOT
DB_QuestIsClosed("ORI_COM_Karlach_SUB_ForgingOfTheHeart", _, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_LevelLoadedOnce("END_Main", _, _, _, _)
THEN
PROC_ORI_Karlach_CloseMainQuest();

PROC
PROC_ORI_GortashConfrontation_DecideKarlachsFate()
THEN
PROC_ORI_Karlach_CloseMainQuest();

PROC
PROC_ORI_Karlach_CloseMainQuest()
THEN
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest();

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND
DB_GlobalFlag(ORI_GortashConfrontation_State_KarlachLeft_1fed69d1-c245-4c5f-9ed0-5cfed57d8ae9, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KarlachNotRescued");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND
DB_GlobalFlag(ORI_GortashConfrontation_State_KarlachWillLeave_cb4ac6a2-b553-5f2d-2bfe-680d5aa0ff94, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KarlachNotRescued");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND
DB_SceneManager(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KarlachInPrison", _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KarlachNotRescued");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("ReachEND_FullyUpgraded_GortashDefeated");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND NOT
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("ReachEND_FullyUpgraded_GortashNotDefeated");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("ReachEND_NotFullyUpgraded_GortashDefeated");

PROC
PROC_ORI_Karlach_CloseMainQuest()
AND NOT
DB_PermaDefeated(S_GLO_Gortash_b878a854-f790-4999-95c4-3f20f00f65ac, _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_State_KarlachSecondUpgrade_f6dc0de4-1089-43c0-b392-306a9a44387c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("ReachEND_NotFullyUpgraded_GortashNotDefeated");

IF
DB_PermaDefeated(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateJournal("KarlachPermanentlyDies");

PROC
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND NOT
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateJournal(_Var1);

PROC
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal((STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_MultiActUpdates(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_Suffixes(_Var2, _Var3, _Var1, _Var1, _Var1)
AND
Concatenate(_Var1, _Var3, _Var4, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateJournal(_Var4);

PROC
PROC_DialogFlagSetup((DIALOGRESOURCE)_Var1, _, _, (DIALOGRESOURCE)_Var1, (DIALOGRESOURCE)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_PrepareInfernalMetalMarkers();

PROC
PROC_DialogFlagSetup((GUIDSTRING)_Var1, _, _, _, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_Dialogues(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_PrepareInfernalMetalMarkers();

PROC
PROC_ORI_Karlach_PrepareInfernalMetalMarkers()
THEN
ClearFlag(GLO_ForgingOfTheHeart_State_InfernalMetalAvailable_a1e06b76-42d9-4fe8-8b5a-cbc7135f3124, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_ORI_Karlach_PrepareInfernalMetalMarkers()
AND
DB_ActiveLevel(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_InfernalIrons(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
IsDestroyed(_Var2, 0, _Var1, _Var1, _Var1)
AND NOT
DB_OffStage(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(GLO_ForgingOfTheHeart_State_InfernalMetalAvailable_a1e06b76-42d9-4fe8-8b5a-cbc7135f3124, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_Karlach_State_ToldKarlachAboutDammon_f2afec2f-95fb-a1c9-2976-9fb798144226, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("RecruitedKarlach_KnowsCanBeUpgraded");

IF
FlagSet(ORI_Karlach_State_InSearchOfMechanic_9943b467-dff2-4a15-abbc-e380e0b8f794, _, _, _, _)
AND NOT
DB_GlobalFlag(PLA_KarlachRecruitment_State_DammonUnavailable_96af4ae3-496d-497f-afb5-fec042fe6f27, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("RecruitedKarlach_KnowsCanBeUpgraded");

IF
FlagSet(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindInfernalMetal_FirstUpgrade");
DB_QuestDef_SawPermaDefeatedState("ORI_Avatar_Karlach", "DammonPermadefeated", S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79);
DB_QuestDef_SawPermaDefeatedState("ORI_COM_Karlach", "DammonPermadefeated", S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79);

IF
FlagSet(GLO_ForgingOfTheHeart_Event_RememberAboutFirstUpgrade_3b130e78-b545-9251-476b-b338a0568948, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(GLO_ForgingOfTheHeart_Event_RememberAboutFirstUpgrade_3b130e78-b545-9251-476b-b338a0568948, _Var1);
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindInfernalMetal_FirstUpgrade");

IF
FlagSet(GLO_ForgingOfTheHeart_Event_RememberAboutSecondUpgrade_1547eb4c-0cde-8984-e691-a0f14a864b42, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(GLO_ForgingOfTheHeart_Event_RememberAboutSecondUpgrade_1547eb4c-0cde-8984-e691-a0f14a864b42, _Var1);
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindInfernalMetal_SecondUpgrade");

IF
FlagSet(GLO_ForgingOfTheHeart_Quest_WaitForNextAct_29c86e0b-100f-5a32-31d6-6bd4e287af71, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("WaitForNextAct");

PROC
PROC_LevelLoadedOnce("CRE_Main_A", _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act2");

PROC
PROC_LevelLoadedOnce("SCL_Main_A", _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act2");

IF
FlagSet(Act2_PointOfNoReturnReached_a3155f30-b8f3-4db5-ac21-d3036f4426e3, _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act3");

PROC
PROC_LevelLoadedOnce("INT_Main_A", _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act3");

PROC
PROC_LevelLoadedOnce("BGO_Main_A", _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act3");

PROC
PROC_LevelLoadedOnce("CTY_Main_A", _, _, _, _)
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("FindDammon_Act3");

IF
Saw((GUIDSTRING)_Var1, S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("DammonFound");
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var3);

IF
FlagSet(HAV_ForgingOfTheHeart_State_UnlockUpgradeNextDay_40dd7a6c-89a8-b301-a935-915059472061, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("WaitForNextDay");

IF
FlagSet(HAV_ForgingOfTheHeart_State_ReadyForSecondUpgrade_edce0ffd-21d1-7a6c-2b55-a3e749d06fca, _, _, _, _)
AND
DB_ActiveLevel(_Var3, _, _, _, _)
AND
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var3, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("TalkToDammon");

IF
TemplateAddedTo((GUIDSTRING)_Var1, _, (GUIDSTRING)_Var3, _, (GUIDSTRING)_Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE", 0, _Var1, _Var1)
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_SECONDUPGRADE", 0, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("GetFirstUpgrade");

IF
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
TemplateIsInInventory(_Var3, _Var2, _Var4, _Var1, _Var1)
AND
_Var4 > 0
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE", 0, _Var1, _Var1)
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_SECONDUPGRADE", 0, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("GetFirstUpgrade");

IF
TemplateAddedTo((ITEMROOT)_Var1, _, (CHARACTER)_Var3, _, (ITEMROOT)_Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var5, _Var1, _Var1, _Var1, _Var1)
AND
TemplateIsInInventory(LOOT_Ketheric_Infernal_Plate_A_5f4022b2-848a-4e91-8697-85863f5136c8, _Var3, _Var6, _Var1, _Var1)
AND
_Var6 > 0
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE", 1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("GetSecondUpgrade");

IF
DB_ORI_Karlach_ForgingOfTheHeart_HasSeenDammonInLevel(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_ActiveLevel(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Karlach_InfernalMetalTemplates(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
TemplateIsInInventory(_Var3, _Var2, _Var4, _Var1, _Var1)
AND
_Var4 > 0
AND
HasActiveStatus(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_FIRSTUPGRADE", 1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("GetSecondUpgrade");

IF
StatusApplied(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, "ORI_KARLACH_SECONDUPGRADE", _, _, (GUIDSTRING)_)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("KarlachFullyUpgraded");

PROC
PROC_Origins_CompanionLeavePermanently(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND NOT
DB_Origin_TemporaryLeaveReason(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("ForgingOfTheHeart_KarlachPermanentlyLeaves");

IF
DB_PermaDefeated(S_Player_Karlach_2c76687d-93a2-477b-8b18-8a14b549304c, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("ForgingOfTheHeart_KarlachPermanentlyDies");

PROC
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest()
AND
DB_PermaDefeated(S_DEN_Weaponsmith_e2ad06ec-8034-479a-9f69-b86faea6dc79, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("DammonPermadefeated");

PROC
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest()
AND
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("ForgingOfTheHeart_ReachEND");

PROC
PROC_ORI_Karlach_CloseForgingOfTheHeartQuest()
AND NOT
DB_GlobalFlag(GLO_ForgingOfTheHeart_Knows_DammonCanUpgradeKarlach_226d82fb-711b-64ac-e59a-b4361ce2204e, _, _, _, _)
THEN
PROC_ORI_Karlach_UpdateForgingOfTheHeartJournal("DammonNeverMet");


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "ModWrapper_Gustav"
