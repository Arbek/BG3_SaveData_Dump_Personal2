Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_QuestDef_State(SCL_Harpers_Event_ShowHavenLocation_5565fa4f-ec30-472a-a9ea-7bb7b09390b3, "GLO_Moonrise", "KnowHaven_KnowHarpers");
DB_QuestDef_State(SCL_HarperScouts_Event_InvitedToHaven_9ade36a5-8ea6-ab0e-929c-ac323741435a, "GLO_Moonrise", "KnowHaven_HarperScouts");
DB_QuestDef_State_ConditionalFlag(GLO_Haven_HeardAbout_e2fba874-5443-415d-8c50-26c51d6993b3, "GLO_Moonrise", "KnowHaven", 0, GLO_Haven_KnowsLocation_16cb0598-a205-47dc-8de9-5229b6897012);
DB_QuestDef_State(SCL_Drider_Quest_BetrayedCaravan_3b4381c1-9483-c6ae-3174-d80a2636a6c9, "GLO_Moonrise", "Drider_BetrayedCaravan_Parent");
DB_QuestDef_State(SCL_Drider_State_HasMoonlantern_18a0f150-6f13-429b-9c2b-dbc7dc3ba927, "GLO_Moonrise", "TookMoonlantern_Parent");
DB_QuestDef_State(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412, "GLO_Moonrise", "VisitedHaven_Reach");
DB_QuestDef_State(SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a, "GLO_Moonrise", "HarperAmbushStart");
DB_QuestDef_State(MOO_EntranceCheckpoint_AllowedIn_eaac9acc-ec76-fb91-edc4-a694fc9c8156, "GLO_Moonrise", "PassedMTCheckpoint");
DB_QuestDef_State(MOO_EntranceCheckpoint_GainedAccess_e1925000-34f0-9f85-fd1f-32b49478defe, "GLO_Moonrise", "PassedMTCheckpoint");
DB_QuestDef_State(MOO_Execution_Event_KethericRegenerated_d71b5d18-1a38-2bbd-50ce-6e06fa5f6704, "GLO_Moonrise", "ExecutionWitness");
DB_QuestDef_State(MOO_Executioner_Knows_BalthazarIsMissing_84e5cbc6-d9ad-935b-b54c-fc227a365ad6, "GLO_Moonrise", "AskedCaptureNightsong");
DB_QuestDef_State(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, "GLO_Moonrise", "AskedKidnapIsobel");
DB_QuestDef_State(GLO_Ketheric_State_AskedBringIsobel_6c4d6bf6-c5f6-4fac-fac0-a6a323ce52a7, "GLO_Moonrise", "AskedKidnapIsobel_Ketheric");
DB_QuestDef_State(ORI_Minthara_State_ToldBalthazar_3ccb6b27-8e83-3cca-81b0-f6acdfd31f13, "GLO_Moonrise", "Relic_MintharaToldNecro");
DB_QuestDef_State(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, "GLO_Moonrise", "FreedNS_Parent");
DB_QuestDef_State(MOO_Assault_HasMet_Jaheira_437d97ee-ae53-283f-52be-e81336d56da7, "GLO_Moonrise", "AssaultSawHarpers");
DB_QuestDef_State_ConditionalFlag(MOO_Assault_State_AllyReadyPositions_f0316e51-b885-472a-a8db-b5cf64aca732, "GLO_Moonrise", "AssaultedMT", 1, GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f);
DB_GLO_Moonrise_Journal_LearnedSourceFlags(SHA_Necromancer_Knows_InvulnerabilitySource_0e33cbbe-18b6-ac57-8ec3-35f296bc6734);
DB_GLO_Moonrise_Journal_LearnedSourceFlags(MOO_BalthazarsSecrets_Knows_NightsongSecret_3599ecf9-382d-46b7-8c72-c7d99303d7c4);
DB_QuestDef_State(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412, "GLO_Moonrise", "Protection_VisitedHaven");
DB_QuestDef_State(SCL_ShadowCurse_Knows_DeepCurse_1f996b1d-833b-4a0f-9aca-a3ebf55c0039, "GLO_Moonrise", "ExperiencedShadowcurse_DeepCurse");
DB_QuestDef_State(HAV_Jaheira_SentToIsobel_66fe5023-3708-9bba-5dce-70b4ded2665b, "GLO_Moonrise", "IsobelProtection");
DB_QuestDef_State(HAV_TakingIsobel_Event_GiveOintment_efb6aed5-fd07-433b-b0c5-b980bf77bb2c, "GLO_Moonrise", "GotSeluneProtection");
DB_QuestDef_State_ConditionalFlag(SCL_Drider_HasMet_2af6450a-480a-32bd-65cb-505587c2b0f3, "GLO_Moonrise", "MetDrider", 0, HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958);
DB_QuestDef_ChainedState("GLO_Moonrise", "Drider_BetrayedCaravan_Parent", "Drider_BetrayedCaravan");
DB_QuestDef_State(SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a, "GLO_Moonrise", "MoveToAmbush");
DB_QuestDef_State_ConditionalFlag(SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d, "GLO_Moonrise", "HarpersDefeated_NotReachedAmbush", 1, SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a);
DB_QuestDef_State(SCL_Drider_Event_AcquiredMoonlanternWithoutFight_cb3bc317-8358-47f4-831e-44ff812ec2b0, "GLO_Moonrise", "PeacefulResolution");
DB_QuestDef_State_ConditionalFlag(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, "GLO_Moonrise", "CaravanBetrayedHarpers", 1, SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a);
DB_QuestDef_ChainedState("GLO_Moonrise", "KnowHaven_HarperScouts", "Protection_HelpedHarperScouts");
DB_QuestDef_State(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, "GLO_Moonrise", "ReachedMoonriseNoLantern");
DB_QuestDef_ChainedState("GLO_Moonrise", "Relic_ToldHelpNecromancer", "ZrellToldLantern");
DB_QuestDef_ConditionalState("GLO_Moonrise", "FollowDrider", "JoinedCaravan", "CaravanBetrayedHarpers", 1);
DB_QuestDef_ConditionalState("GLO_Moonrise", "FollowDrider", "JoinedCaravan", "MetDrider_HavenFell", 1);
DB_QuestDef_State(GLO_Pixie_Event_Released_8b8a6c7b-fc40-94a5-0139-1c6c43762651, "GLO_Moonrise", "ReleasedPixie");
DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_DriderHarperGroup_BeforeAmbush", SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d);
DB_SCL_Journal_HavenQuestUpdates("Protection_VisitedHaven");
DB_SCL_Journal_HavenQuestUpdates("Protection_HelpedHarperScouts");
DB_SCL_Journal_HavenQuestUpdates("LearnAboutHaven_NoMoonlantern");
DB_SCL_Journal_HavenQuestUpdates("LearnAboutHaven_Moonlantern");
DB_SCL_Journal_HavenQuestUpdates("IsobelProtection");
DB_SCL_Journal_HavenQuestUpdates("AgreedToHelp_NotLeft");
DB_SCL_Journal_IsobelDialogues(HAV_TakingIsobel_BriefInRoom_22c23201-13a8-916c-932c-a7976bb1f5a5);
DB_SCL_Journal_IsobelDialogues(HAV_TakingIsobel_FollowUpSaved_5de4ab22-4449-3f6c-3909-f13d66a0e9bd);
DB_GLO_Moonrise_Journal_KnowsAboutNereLanternFlags(GLO_Player_Knows_NereToldAboutMoonlantern_8c20dcde-b0b8-bc5e-3305-5de123d71036);
DB_GLO_Moonrise_Journal_KnowsAboutNereLanternFlags(UND_TheDrowNere_Event_MoonlanternBroken_8165207b-e0ad-1a9f-701f-ca7f63ead477);
DB_GLO_Moonrise_Journal_KnowsAboutNereLanternFlags(GLO_Shadowcurse_Knows_FromGnome_f81ae4ea-a095-11f2-fc60-1b7b61a4ba03);
DB_GLO_Moonrise_Journal_KnowsAboutNereLanternFlags(GLO_Shadowcurse_Knows_FromDuergar_493ad2e1-44cd-2f9d-7d24-4697233a0a3b);
DB_QuestDef_ChainedState("GLO_Moonrise", "DriderCaravanUpdate", "MeetDrider_Summoned");
DB_QuestDef_ChainedState("GLO_Moonrise", "DriderCaravanStart", "MeetDrider_Summoned");
DB_QuestDef_State(SCL_Drider_State_AfterAmbushSituationDefused_320cbaed-d830-bcbd-8c19-d1fdab1d2268, "GLO_Moonrise", "FollowDrider");
DB_QuestDef_State(SCL_EntryPoint_State_GoblinInvited_bfb98886-3a98-9afa-2336-f45d045c9ce1, "GLO_Moonrise", "CaravanMetGoblin");
DB_QuestDef_State(HAV_TakingIsobel_State_SpyConfrontationStarted_44c18469-4650-4941-bf5f-9fe1f01df6e0, "GLO_Moonrise", "MarcusBrief");
DB_QuestDef_State(HAV_TakingIsobel_Event_AttackedMarcusDuringBrief_65767f32-1d6c-46e2-8592-2c94c9efcc2d, "GLO_Moonrise", "AssaultMarcus");
DB_QuestDef_State(HAV_TakingIsobel_Event_HarperGuardIsobel_7316cac0-c33c-4bb7-94b4-62c7eb10de86, "GLO_Moonrise", "WarnedJaheira");
DB_QuestDef_State(HAV_TakingIsobel_State_SidedWithIsobel_52395bbc-a58d-44cd-bd40-8069c776875b, "GLO_Moonrise", "BetrayMarcus");
DB_QuestDef_ChainedState("GLO_Moonrise", "IsobelDead", "Infiltrator_RewardedZrell");
DB_QuestDef_ChainedState("GLO_Moonrise", "IsobelKidnapped", "Infiltrator_RewardedZrell");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_MarcusCapture", "Altar_IsobelDead", "Infiltrator_RewardedKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_MarcusCapture", "Altar_IsobelKidnapped", "Infiltrator_RewardedKetheric");
DB_GLO_Moonrise_Journal_OnMoonriseMission("CaptureNotMet");
DB_GLO_Moonrise_Journal_OnMoonriseMission("CaptureMet");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "IsobelDead", "CapturedIsobelForZrell");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "IsobelKidnapped", "CapturedIsobelForZrell");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "Altar_IsobelDead", "CapturedIsobelForKetheric");
DB_GLO_Moonrise_Journal_ChainedStateIfOpen("GLO_Moonrise_SUB_ZrellCapture", "Altar_IsobelKidnapped", "CapturedIsobelForKetheric");
DB_QuestDef_State(MOO_Executioner_Knows_BalthazarIsMissing_84e5cbc6-d9ad-935b-b54c-fc227a365ad6, "GLO_Moonrise", "Relic_ToldHelpNecromancer");
DB_QuestDef_BookReadState("GLO_Moonrise", "Relic_LearnSourceBook", S_MOO_BalthazarSecretBook_8f90de22-6a7c-4579-a966-73c0d80d7a54);
DB_QuestDef_State(SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898, "GLO_Moonrise", "ActivatedElevator");
DB_QuestDef_State_ConditionalFlag(SHA_Trials_Event_AllGemsFound_2d47ee89-2a15-4b33-b933-59f0b0aa6f3b, "GLO_Moonrise", "AcquiredAllGems_LowerAltar", 1, SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898);
DB_QuestDef_State_ConditionalFlag(SHA_Trials_Event_AllGemsFound_2d47ee89-2a15-4b33-b933-59f0b0aa6f3b, "GLO_Moonrise", "AcquiredAllGems_UpperAltar", 0, SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898);
DB_QuestDef_State_ConditionalFlag(SHA_Upper_State_DiscUnlocked_4b056ce5-e145-4d90-8451-0ff502e11898, "GLO_Moonrise", "ActivatedElevator_HasGems", 1, SHA_Trials_Event_AllGemsFound_2d47ee89-2a15-4b33-b933-59f0b0aa6f3b);
DB_QuestDef_State(SHA_NightsongPrison_State_PlayerBetrayedNecro_ed6e37a5-ea65-cf0b-f70b-8e9e2a7e4ed2, "GLO_Moonrise", "Relic_NecromancerFight");
DB_QuestDef_State(ORI_Shadowheart_State_SharPath_bf9ae334-ff6a-458d-b898-3074bca0bdfb, "GLO_Moonrise", "Relic_KilledNS");
DB_QuestDef_State(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, "GLO_Moonrise", "Relic_FreedNS");
DB_SHA_RelicJournal("Relic_LearnSourceBook");
DB_SHA_RelicJournal("Relic_BrewerConfession");
DB_SHA_RelicJournal("Relic_MetNecromancer_Alt");
DB_SHA_RelicJournal("Relic_MetNecromancer");

KBSECTION
IF
FlagSet(GLO_Daisy_Event_ToldToGoToMoonrise_f51feeff-096d-44b3-8453-0c486e88f8a4, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND
DB_ActiveLevel("SCL_Main_A", _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ToldMoonriseInSCL_Daisy_KnowsMT");

IF
FlagSet(GLO_Daisy_Event_ToldToGoToMoonrise_f51feeff-096d-44b3-8453-0c486e88f8a4, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND
DB_ActiveLevel("SCL_Main_A", _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ToldMoonriseInSCL_Daisy_DontKnow");

PROC
PROC_LevelLoadedOnce("SCL_Main_A", _, _, _, _)
AND
DB_QuestIsAccepted("GLO_PathToMoonrise", _, _, _, _)
AND NOT
DB_GlobalFlag(GLO_Daisy_Event_ToldToGoToMoonrise_f51feeff-096d-44b3-8453-0c486e88f8a4, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "EnteredSCL_KnowsMT");

PROC
PROC_LevelLoadedOnce("SCL_Main_A", _, _, _, _)
AND
DB_QuestIsAccepted("GLO_PathToMoonrise", _, _, _, _)
AND
DB_GlobalFlag(GLO_Daisy_Event_ToldToGoToMoonrise_f51feeff-096d-44b3-8453-0c486e88f8a4, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "EnteredSCL_KnowsMT_HadDream");

IF
FlagSet(HAV_Jaheira_State_MissionGiven_7516666c-4c71-86d7-9d2b-9f3a4269970b, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "JaheiraKillKetheric_Reach");

IF
FlagSet(GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelKillKetheric_Reach");

IF
QuestAccepted(_, "GLO_Moonrise_SUB_MarcusCapture", _, _, _)
AND NOT
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "InfiltratorStart_Reach");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", "SavedIsobel", _, _)
AND NOT
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ProtectedIsobel_Reach");

PROC
PROC_State_Changed(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege", _, _)
AND NOT
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "HavenFell_Parent");

PROC
PROC_SCL_Drider_StartCaravanEscort()
AND
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND
DB_OnlyOnce("SCL_Drider_DriderAppears", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "DriderCaravanUpdate");

PROC
PROC_SCL_Drider_StartCaravanEscort()
AND NOT
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND
DB_OnlyOnce("SCL_Drider_DriderAppears", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "DriderCaravanStart");

IF
FlagSet(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "PassedMTCheckpoint", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FoundMOO");

IF
DialogEnded(MOO_Execution_2b2f9929-86da-50b1-c796-7d3e485ed901, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ZrellRequest");

IF
FlagSet(MOO_Execution_Event_IsobelDebrief_b76693b3-aa07-d119-8f4e-f2c7c3185a01, _, _, _, _)
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelKidnappedBeforeNightsong");

IF
FlagSet(MOO_Executioner_State_IsDefeated_2b857607-9c26-4d56-a1a9-a63f8ff5bebf, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "KilledZrellBeforeBalthazar");

IF
FlagSet(HAV_Jaheira_State_MissionGiven_7516666c-4c71-86d7-9d2b-9f3a4269970b, _, _, _, _)
AND
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "JaheiraKillKetheric");

IF
FlagSet(GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7, _, _, _, _)
AND
DB_GlobalFlag(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelKillKetheric");

IF
FlagSet(MOO_BalthazarsSecrets_Knows_NightsongSecret_3599ecf9-382d-46b7-8c72-c7d99303d7c4, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ZrellDead_LearnSourceBook", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "TowersHostile_LearnedSource", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "LearnedSource", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ZrellDead_LearnSourceBook");

IF
FlagSet((GUIDSTRING)_Var1, _, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_GLO_Moonrise_Journal_LearnedSourceFlags(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _Var1, _Var1, _Var1, _Var1)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ZrellDead_LearnSourceBook", _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "TurnedHostile_LearnSourceBook", _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "LearnedSource", _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "LearnedSource");

IF
FlagSet(SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FoundBalthazar");

IF
DialogStarted(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND
DB_GlobalFlag(GLO_MoonriseTower_EverEnteredBefore_26aeabb0-7644-4897-9bbd-7a95e3e8930f, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "MetNS_Infiltrate");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", "ZrellRequest", _, _)
AND
DB_Players(_Var2, _, _, _, _)
AND NOT
DB_GLO_Moonrise_Journal_ZrellMarkerShown(_Var2, _, _, _, _)
THEN
DB_GLO_Moonrise_Journal_ZrellMarkerShown(_Var2);
PROC_ShowMarker(_Var2, "MOO_Executioner");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", (STRING)_Var2, _, _)
AND
_Var2 != "ZrellRequest"
AND
DB_Players(_Var3, _, _, _, _)
AND
DB_GLO_Moonrise_Journal_ZrellMarkerShown(_Var3, _, _, _, _)
THEN
NOT DB_GLO_Moonrise_Journal_ZrellMarkerShown(_Var3);
PROC_HideMarker(_Var3, "MOO_Executioner");

IF
FlagSet(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
AND NOT
DB_PermaDefeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ExecutionWitness", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReturnToZrell");

IF
FlagSet(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
AND
DB_PermaDefeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ExecutionWitness", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReturnToKetheric");

PROC
PROC_MOO_Journal_KethericToldPlayerToKneelAtAltar()
AND
DB_GlobalFlag(MOO_Audience_State_KethericToldToKneelAtAltar_d36fc964-2170-4731-a6aa-29749c33b774, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Audience_State_GrantedPermission_ef5c0ad1-8aae-48b8-a438-5989b1778f9a, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "EarlyKethericRoof");

IF
FlagSet(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
QRY_GLO_Moonrise_Journal_IsOnKidnapIsobelQuest()
AND NOT
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
PROC_MOO_Journal_UpdateIsobelReportQuest("Zrell");

IF
FlagSet(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
QRY_GLO_Moonrise_Journal_IsOnKidnapIsobelQuest()
AND
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
PROC_MOO_Journal_UpdateIsobelReportQuest("Ketheric");

PROC
PROC_MOO_Journal_UpdateIsobelReportQuest("Zrell", _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapZrell_Alive");

PROC
PROC_MOO_Journal_UpdateIsobelReportQuest("Zrell", _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapZrell_Dead");

PROC
PROC_MOO_Journal_UpdateIsobelReportQuest("Ketheric", _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapKetheric_Alive");

PROC
PROC_MOO_Journal_UpdateIsobelReportQuest("Ketheric", _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapKetheric_Dead");

QRY
QRY_GLO_Moonrise_Journal_IsOnKidnapIsobelQuest()
AND
DB_GlobalFlag(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_GLO_Moonrise_Journal_IsOnKidnapIsobelQuest()
AND
DB_GlobalFlag(GLO_Ketheric_State_AskedBringIsobel_6c4d6bf6-c5f6-4fac-fac0-a6a323ce52a7, _, _, _, _)
THEN
DB_NOOP(1);

IF
DialogEnded(MOO_Executioner_1e888683-64d6-47f1-3cde-f1d9f430e3e6, _, _, _, _)
AND
DB_GlobalFlag(MOO_Audience_State_GrantedPermission_ef5c0ad1-8aae-48b8-a438-5989b1778f9a, _, _, _, _)
AND
QRY_OnlyOnce("PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof", _, _, _, _)
THEN
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof();

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
AND
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelDead");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelKidnapped");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND NOT
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FailedKidnapping");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "IsobelKidnappedBeforeNightsong", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelCaptureAlreadyReported");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "IsobelKidnappedBeforeNightsong", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FirstMeeting_IsobelKidnapped");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "IsobelKidnappedBeforeNightsong", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FirstMeeting_IsobelDead");

PROC
PROC_GLO_Moonrise_Journal_ZrellGaveAccessToRoof()
AND NOT
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "IsobelKidnappedBeforeNightsong", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AskedKidnapIsobel", _, _, _)
AND
QRY_OnlyOnce("GLO_Moonrise_Journal_ZrellSentToKetheric_OnlyOnce", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FirstMeeting_IsobelFailed");

IF
DialogEnded(MOO_Audience_Ketheric_26cf4f1f-7f17-e59c-245c-6ed6e767d28f, _, _, _, _)
AND
DB_GlobalFlag(MOO_Audience_State_KethericToldToKneelAtAltar_d36fc964-2170-4731-a6aa-29749c33b774, _, _, _, _)
THEN
PROC_MOO_Journal_KethericToldPlayerToKneelAtAltar();

PROC
PROC_MOO_Journal_KethericToldPlayerToKneelAtAltar()
AND
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
DB_GlobalFlag(MOO_Audience_State_GrantedPermission_ef5c0ad1-8aae-48b8-a438-5989b1778f9a, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Altar_IsobelKidnapped");

PROC
PROC_MOO_Journal_KethericToldPlayerToKneelAtAltar()
AND
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
DB_GlobalFlag(MOO_Audience_State_GrantedPermission_ef5c0ad1-8aae-48b8-a438-5989b1778f9a, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Altar_IsobelDead");

PROC
PROC_MOO_Journal_KethericToldPlayerToKneelAtAltar()
AND NOT
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
DB_GlobalFlag(MOO_Audience_State_GrantedPermission_ef5c0ad1-8aae-48b8-a438-5989b1778f9a, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Altar_IsobelFailed");

PROC
PROC_COL_TeleportPartiesToColony(1, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "HadAudience");

IF
FlagSet(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TurnedHostile_BeforeNecro");

IF
FlagSet(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TurnedHostile_AfterNecro");

IF
FlagSet(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TurnedHostile_SentNS");

IF
FlagSet(HAV_Jaheira_State_MissionGiven_7516666c-4c71-86d7-9d2b-9f3a4269970b, _, _, _, _)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("MOO_EndKetheric", "TowersHostile_JaheiraKillKetheric");

IF
FlagSet(MOO_BalthazarsSecrets_Knows_NightsongSecret_3599ecf9-382d-46b7-8c72-c7d99303d7c4, _, _, _, _)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ZrellDead_LearnSourceBook", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "TowersHostile_LearnedSource", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "LearnedSource", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TurnedHostile_LearnSourceBook");

IF
FlagSet((FLAG)_Var1, _, _, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_GLO_Moonrise_Journal_LearnedSourceFlags(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _Var1, _Var1, _Var1, _Var1)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "ZrellDead_LearnSourceBook", _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "TurnedHostile_LearnSourceBook", _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "LearnedSource", _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TowersHostile_LearnedSource");

IF
FlagSet(SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431, _, _, _, _)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TurnedHostile_FoundBalthazar");

IF
FlagSet(SHA_Necromancer_State_Dead_f83edb0d-f11f-4a3e-a866-58af8fc6c96d, _, _, _, _)
AND
DB_State_Current(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtTemple", _, _)
THEN
QuestUpdate("GLO_Moonrise", "BalthazarDied_Parent");

PROC
PROC_MOO_Assault_StartBossFight()
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "AttackedKetheric_Close");

PROC
PROC_MOO_Assault_StartBossFight()
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
AND
DB_GlobalFlag(SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "AttackedKetheric_Close");

IF
AttackedBy(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, (CHARACTER)_Var1, _, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _Var1, _Var1, _Var1, _Var1)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "AttackedKetheric_NoNS_BeforeNecro", _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "AttackedKetheric_NoNS");

IF
AttackedBy(S_MOO_Ketheric_e9918f3e-5b87-40a3-a9bd-61545151573f, (CHARACTER)_Var1, _, _, _, _, _, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "AttackedKetheric_NoNS_BeforeNecro");

IF
FlagSet(SHA_Necromancer_State_PermaDefeated_c8fc43c5-f6bb-4c15-9869-8ceefc288ef2, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
QuestUpdate("GLO_Moonrise", "BalthazarDied_Parent");

IF
DialogStarted(SHA_NightsongPrison_NightsongsFate_309684a3-b0e7-9a5b-68fb-63c802c2240c, _, _, _, _)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "MetNS_Defeat");

PROC
PROC_State_Changed(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath", _, _)
THEN
QuestUpdate("GLO_Moonrise", "KilledNS_Parent");

IF
FlagSet(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault", _, _)
THEN
QuestUpdate("GLO_Moonrise", "FoundMOO_Assault");

IF
FlagSet(MOO_PartyProgress_EnteredMoonrise_278dff38-c7e5-4699-9cb9-6d66ef3c9030, _, _, _, _)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath", _, _)
THEN
QuestUpdate("GLO_Moonrise", "FoundMOO_NightsongDead");

IF
FlagSet(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6, _, _, _, _)
AND NOT
DB_GlobalFlag(SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
PROC_GLO_Moonrise_Journal_OnEndingMainQuest();
QuestUpdate("GLO_Moonrise", "FacedKethericMT");

IF
FlagSet(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6, _, _, _, _)
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
PROC_GLO_Moonrise_Journal_OnEndingMainQuest();
QuestUpdate("GLO_Moonrise", "FacedKethericMT_NoNS");

IF
FlagSet(MOO_Assault_Event_KethericTeleportedAway_ba71e8cd-8922-61a4-a2ff-8c5f5ff8aac6, _, _, _, _)
AND
DB_GlobalFlag(SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba, _, _, _, _)
THEN
PROC_GLO_Moonrise_Journal_OnEndingMainQuest();
QuestUpdate("GLO_Moonrise", "FacedKethericMT_NoNS");

IF
FlagSet(SCL_ShadowCurse_Knows_Curse_6981aa13-9654-4284-99af-8bdbfccc1d3f, _, (INTEGER)_Var2, _, _)
AND NOT
DB_DialogName(_, _Var2, _, _, _)
AND NOT
QRY_GLO_Moonrise_KnowsAboutNereLantern()
THEN
QuestUpdate("GLO_Moonrise", "ExperiencedShadowcurse");

IF
FlagSet(SCL_ShadowCurse_Knows_Curse_6981aa13-9654-4284-99af-8bdbfccc1d3f, _, (INTEGER)_Var2, _, _)
AND
DB_DialogName(_, _Var2, _, _, _)
AND NOT
QRY_GLO_Moonrise_KnowsAboutNereLantern()
THEN
QuestUpdate("GLO_Moonrise", "ExperiencedShadowcurse_KnowsLight");

IF
FlagSet(SCL_ShadowCurse_Knows_Curse_6981aa13-9654-4284-99af-8bdbfccc1d3f, _, _, _, _)
AND
QRY_GLO_Moonrise_KnowsAboutNereLantern()
THEN
QuestUpdate("GLO_Moonrise", "ExperiencedShadowcurse_KnowsNereLantern");

QRY
QRY_GLO_Moonrise_KnowsAboutNereLantern()
AND
DB_GLO_Moonrise_Journal_KnowsAboutNereLanternFlags(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
AddedTo(S_UND_Nere_Moonlantern_Broken_5a76ae0a-d013-42e9-98b5-fa427a1cddbe, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("GLO_Moonrise_FoundNeresMoonlantern", _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(VISITEDREGION_SCL_Main_A_f6e72539-9bc6-42e1-a20f-390f3a17ad8d, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "GLO_Moonrise", "TookBrokenLantern");

IF
GameBookInterfaceClosed(S_SCL_OrdersFromJaheira_7493444e-aa24-48ea-b54e-d68502f1956d, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(GLO_Haven_EverEnteredBefore_f1176fa0-ec29-410e-bffa-24623b19c8e4, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "GLO_Moonrise", "ReadJaheiraOrders");

IF
FlagSet(SCL_Harpers_Event_ShowHavenLocation_5565fa4f-ec30-472a-a9ea-7bb7b09390b3, _, _, _, _)
AND
QRY_SCL_Drider_HarpersHaveMoonlantern()
THEN
QuestUpdate("GLO_Moonrise", "LearnAboutHaven_Moonlantern");

IF
FlagSet(SCL_Harpers_Event_ShowHavenLocation_5565fa4f-ec30-472a-a9ea-7bb7b09390b3, _, _, _, _)
AND NOT
QRY_SCL_Drider_HarpersHaveMoonlantern()
THEN
QuestUpdate("GLO_Moonrise", "LearnAboutHaven_NoMoonlantern");

IF
FlagSet(GLO_HAV_IsobelGaveMission_4f0dd500-6de8-08ce-7db9-083c891e67e7, _, _, _, _)
AND
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TowersHostile_IsobelKillKetheric");

IF
StatusApplied((GUIDSTRING)_Var1, "SCL_SHADOW_CURSE", _, _, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SCL_ShadowCurse_Knows_Curse_6981aa13-9654-4284-99af-8bdbfccc1d3f, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_SCL_ShadowCurse_InBlightedArea(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(SCL_ShadowCurse_Knows_DeepCurse_1f996b1d-833b-4a0f-9aca-a3ebf55c0039, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_OnlyOnce_PerUser(_, "SCL_EntryPoint_RemovedCurseByLight", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ProtectedByLight");

IF
FlagSet(SCL_Drider_State_IsobelToldAboutHarpers_f56abcc8-566f-feaa-1115-d10317db14a8, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d, _, _, _, _)
AND NOT
QRY_SCL_Drider_AnyHarpersDuringOrAfterAmbush()
THEN
QuestUpdate("GLO_Moonrise", "AgreedToHelp_NotLeft");
QuestUpdate("GLO_Moonrise", "HarperAmbushStart");

IF
StatusApplied((CHARACTER)_Var1, (STRING)_Var2, _, _, (CHARACTER)_Var1)
AND
DB_SCL_ShadowCurse_UndeadStatuses(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TransformedToShadowCreature");

PROC
PROC_SCL_Drider_HarpersWin_SidedWithHarpers()
AND
QRY_State_IsBeforeState(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege", _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "Drider_BetrayedCaravan", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TalkToHarpers");

PROC
PROC_SCL_Drider_HarpersWin_SidedWithHarpers()
AND NOT
QRY_State_IsBeforeState(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege", _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "Drider_BetrayedCaravan", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TakeMoonlantern");

PROC
PROC_StateSet_Defeated((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SCL_Pixie_MoonlanternHolder(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SCL_Drider_HarpersGroup(_Var1, _, _, _Var1, _Var1)
AND NOT
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "HarpersLostLantern");

IF
DB_InRegion(_Var1, S_SCL_Drider_PlayerAndHarpersAmbushPosition_98361852-5286-4fae-8edb-9b5632876740, _Var1, _Var1, _Var1)
AND
DB_State_Current(_Var2, "SCL_DriderHarpers", "WaitingAtAmbush", _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "GLO_Moonrise", "StartAmbush");

PROC
PROC_State_Changed(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege", _, _)
AND
QRY_SCL_Journal_HasHavenRelatedUpdates()
THEN
QuestUpdate("GLO_Moonrise", "HavenFell");

QRY
QRY_SCL_Journal_HasHavenRelatedUpdates()
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SCL_Journal_HavenQuestUpdates(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(_Var1, "GLO_Moonrise", _Var2, 1, _Var1)
THEN
DB_NOOP(1);

IF
AddedTo(S_GLO_DriderMoonlantern_4591d212-8f1b-4b85-880c-dc94f76702f4, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SCL_Drider_CaravanBetrayedAndInCombat()
THEN
QuestUpdate("GLO_Moonrise", "TookMonlantern_BetrayedCaravan");

IF
AddedTo(S_GLO_DriderMoonlantern_4591d212-8f1b-4b85-880c-dc94f76702f4, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_SCL_Drider_CaravanBetrayedAndInCombat()
THEN
QuestUpdate(_Var1, "GLO_Moonrise", "TookMoonlantern");

IF
DB_GlobalFlag(SCL_Drider_State_HarpersPermaDefeated_be4a239e-0127-4916-a350-8704a86daea9, _, _, _, _)
AND NOT
DB_SCL_Drider_AmbushCombatID(_, _, _, _, _)
AND
DB_SCL_Pixie_MoonlanternHolder(_Var2, _, _, _, _)
AND
DB_Players(_Var2, _, _, _, _)
THEN
QuestUpdate(_Var2, "GLO_Moonrise", "TookMoonlantern");

IF
EntityEvent(_, "SCL_Drider_HarperReturnsToInn", _, _, _)
AND
DB_SCL_Pixie_MoonlanternHolder(_Var2, _, _, _, _)
AND
DB_Players(_Var2, _, _, _, _)
THEN
QuestUpdate(_Var2, "GLO_Moonrise", "TookMoonlantern");

IF
AddedTo(S_MOO_Moonlantern_2dcc6a54-f07b-4b4c-98d4-ca7ec92a59fd, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TookMoonlantern_BalthazarsRoom");

IF
FlagSet(SCL_Drider_Event_GiveMoonlantern_69ac556a-7c78-43f5-9bea-f8efeda31b42, (CHARACTER)_Var1, (INTEGER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogName(_Var3, _Var2, _Var1, _Var1, _Var1)
AND
DB_SCL_Journal_IsobelDialogues(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TookMoonlantern_VisitedHaven");

PROC
PROC_SCL_Drider_TeleportCaravanToAmbush()
THEN
NOT DB_GLO_DefeatCounter_AllPermaDefeatedGlobalFlag("SCL_DriderHarperGroup_BeforeAmbush", SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d);
QuestUpdate("GLO_Moonrise", "CaravanAppears");

PROC
PROC_GLO_Moonrise_Journal_OnEndingMainQuest()
THEN
QuestUpdate("GLO_Moonrise", "NoProtection");

IF
DB_SCL_Drider_HarpersGroup(_Var1, _, _, _Var1, _Var1)
THEN
DB_GLO_DefeatCounter(_Var1, "SCL_DriderHarperGroup_BeforeAmbush");

IF
FlagSet(SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
NOT DB_QuestDef_State(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, "GLO_Moonrise", "CaravanBetrayedHarpers");

PROC
PROC_SCL_Drider_TeleportCaravanToAmbush()
AND
DB_GLO_DefeatCounter(_Var1, "SCL_DriderHarperGroup_BeforeAmbush", _Var1, _Var1, _Var1)
THEN
NOT DB_GLO_DefeatCounter(_Var1, "SCL_DriderHarperGroup_BeforeAmbush");

IF
DB_Is_InCombat(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithHarpers_a130dde9-c086-4486-9cd8-298a67fb6aee, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_Drider_Event_StartCaravanEscort_26062990-9018-4845-a520-d737837fa207, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SCL_Drider_CombatJournalUpdated(1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_IsEnemy(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _Var2, _Var1, _Var1, _Var1)
THEN
DB_SCL_Drider_CombatJournalUpdated(1);
QuestUpdate("GLO_Moonrise", "AttackedCaravan");

IF
GameBookInterfaceClosed(S_SCL_OrdersFromJaheira_7493444e-aa24-48ea-b54e-d68502f1956d, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_SCL_Drider_Journal_ReadOrders(1);

IF
DB_SCL_Drider_Journal_ReadOrders(1, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_HarpersPermaDefeatedBeforeAmbush_cb451e32-061a-422c-ab4c-18a0c174696d, _, _, _, _)
AND
QRY_State_IsBeforeState(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "EscortingCaravan", _, _)
THEN
QuestUpdate("GLO_Moonrise", "OrdersFromJaheira");

IF
DB_Is_InCombat(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_SCL_Drider_HarpersGroup(_Var2, _, _, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithHarpers_a130dde9-c086-4486-9cd8-298a67fb6aee, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_Drider_Event_StartCaravanEscort_26062990-9018-4845-a520-d737837fa207, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SCL_Drider_CombatJournalUpdated(1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_IsEnemy(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _Var2, _Var1, _Var1, _Var1)
THEN
DB_SCL_Drider_CombatJournalUpdated(1);
QuestUpdate("GLO_Moonrise", "AttackedCaravan");

IF
DB_PermaDefeated(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithHarpers_a130dde9-c086-4486-9cd8-298a67fb6aee, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TakeMoonlantern");

IF
DB_PermaDefeated(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_HarpersPermaDefeated_be4a239e-0127-4916-a350-8704a86daea9, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_StartedAmbushQuestWithHarpers_85b1171d-f21f-4cc4-8718-5f37a3f42f0a, _, _, _, _)
AND
QRY_SCL_Drider_AnyHarpersDuringOrAfterAmbush()
AND
DB_SCL_Drider_HarpersGroup(_Var1, _, _, _Var1, _Var1)
AND NOT
QRY_State_IsBeforeState(_Var1, "SCL_DriderHarpers", "BackAtInn", _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TakeMoonlantern");

QRY
QRY_SCL_Drider_AnyHarpersDuringOrAfterAmbush()
AND
DB_SCL_Drider_HarpersGroup(_Var1, _, _, _Var1, _Var1)
AND NOT
QRY_State_IsBeforeState(_Var1, "SCL_DriderHarpers", "MovingToAmbush", _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_StateSet_PermaDefeated(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _, _, _, _)
AND NOT
DB_SCL_Drider_AmbushCombatID(_, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TakeMoonlantern");

IF
DB_PermaDefeated(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "TakeMoonlantern_Betrayed");

IF
FlagSet(SCL_Drider_HasMet_2af6450a-480a-32bd-65cb-505587c2b0f3, _, _, _, _)
AND
DB_GlobalFlag(HAV_Siege_State_NoProtection_2da0dbf1-88ca-4cab-9c8f-ee8921822958, _, _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "CaravanAppears", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "MetDrider_HavenFell");

IF
DialogEnded(SCL_Drider_Caravan_HalfOrcCaster_865adfae-1b72-1ed2-f961-d55abd4fb7b1, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_ToldMintharaHasLyre_c0600f2e-12e8-ae1e-3e6e-dc542e97bb71, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "CaravanNoLyre");

IF
DialogEnded(SCL_Drider_Caravan_HalfOrcCaster_865adfae-1b72-1ed2-f961-d55abd4fb7b1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_GlobalFlag(SCL_Drider_State_ToldMintharaHasLyre_c0600f2e-12e8-ae1e-3e6e-dc542e97bb71, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _Var1, _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetFlag(GOB_DrowCommnader_Knows_HasSpiderLyre_40a04a2d-cc84-4f45-ad92-a32e8e5796f7, _Var2, 1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "TalkedCaravanDidntSummon");

IF
FlagSet(GOB_DrowCommnader_Knows_HasSpiderLyre_40a04a2d-cc84-4f45-ad92-a32e8e5796f7, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_Drider_State_ToldMintharaHasLyre_c0600f2e-12e8-ae1e-3e6e-dc542e97bb71, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "CaravanGotLyre");

IF
FlagSet(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("GLO_Moonrise", "HarpersDefeated_NotReachedAmbush", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FollowDrider");

PROC
PROC_StateCleared_Defeated(S_SCL_DriderCaravan_HalfOrcCaster_f9522205-623f-4a82-904a-128b26182707, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_ToldMintharaHasLyre_c0600f2e-12e8-ae1e-3e6e-dc542e97bb71, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _, _, _, _)
AND
DB_GlobalFlag(SCL_EntryPoint_State_GoblinInvited_bfb98886-3a98-9afa-2336-f45d045c9ce1, _, _, _, _)
AND
DB_GlobalFlag(CAMP_GoblinHuntCelebration_Knows_CreaturePath_758098e2-ab9c-e667-9210-d3765c021541, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "CaravanCampDefeated");

IF
DB_QuestIsAccepted("GLO_Moonrise", _, _, _, _)
AND
DB_GlobalFlag(CAMP_GoblinHuntCelebration_Knows_CreaturePath_758098e2-ab9c-e667-9210-d3765c021541, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "MeetDrider_SentByMinthara");

IF
DialogEnded(SCL_Drider_CaravanStart_e436d37f-a2a4-92f7-a429-b0dcb2937690, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_Event_StartCaravanEscort_26062990-9018-4845-a520-d737837fa207, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FollowDrider");

IF
DialogEnded(SCL_Drider_Caravan_HalfOrcCaster_865adfae-1b72-1ed2-f961-d55abd4fb7b1, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_Event_StartCaravanEscort_26062990-9018-4845-a520-d737837fa207, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_State_WaitAtCaravanStart_c2414538-2e56-428e-935e-35d0b11a1ff8, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FollowDrider");

IF
FlagCleared(SCL_Drider_State_WaitingAtAmbushAfterCombat_84d5065a-2648-d39d-d331-78ab4b68621d, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_Event_StartCaravanEscort_26062990-9018-4845-a520-d737837fa207, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_Drider_Event_FailedConvincingAfterAmbush_1ea7879e-51d4-8a26-7a39-6db25f93403f, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "FollowDrider");

IF
DB_SCL_Drider_AmbushCombatID(_, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Caravan", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "DefendCaravan");

IF
DB_SCL_Drider_AmbushCombatID(_, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithHarpers_a130dde9-c086-4486-9cd8-298a67fb6aee, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Caravan", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "BetrayedDrider");

IF
DB_GlobalFlag(SCL_Drider_State_HarpersDefeated_2373a9db-2754-49f8-8523-fc1b32680db9, _, _, _, _)
AND
DB_GlobalFlag(SCL_Drider_State_SidedWithCaravan_57a698da-0149-48d1-91fa-9a84a5dcc293, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Caravan", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "DefeatedHarpers");

PROC
PROC_SCL_Drider_ScatterCaravan()
AND
DB_State_Current(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "EscortingCaravan", _, _)
THEN
QuestUpdate("GLO_Moonrise", "DriderUnavailable");

PROC
PROC_State_Changed(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "ReachedMoonriseTower", _, _)
THEN
QuestUpdate("GLO_Moonrise", "Drider_ReachMOO");

IF
FlagSet(TG_MOO_EnteredMoonrise_03de939d-8906-4d16-a3ae-945a34e471fb, _, _, _, _)
AND NOT
DB_State_Current(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "ReachedMoonriseTower", _, _)
AND NOT
DB_State_Current(S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab, "SCL_TheDrider", "EscortingCaravan", _, _)
THEN
QuestUpdate("GLO_Moonrise", "ReachedNoDrider");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", "AskedKidnapIsobel_Ketheric", _, _)
AND NOT
DB_QuestIsOpened("GLO_Moonrise_SUB_MarcusCapture", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "KethericIsobelBrief");

IF
FlagSet(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
AND
DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "ZrellBrief");

IF
FlagSet(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
AND
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Executioner_State_IsDefeated_2b857607-9c26-4d56-a1a9-a63f8ff5bebf, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ZrellBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "IsobelKilled");

IF
FlagSet(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ZrellBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "RewardZrell");

IF
FlagSet(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
AND
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
DB_GlobalFlag(MOO_Executioner_State_IsDefeated_2b857607-9c26-4d56-a1a9-a63f8ff5bebf, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ZrellBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapKetheric_Dead_Sub");

IF
FlagSet(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_Isobel_State_IsDead_af8b23d8-d04d-4e42-8a56-be909226e706, _, _, _, _)
AND
DB_GlobalFlag(MOO_Executioner_State_IsDefeated_2b857607-9c26-4d56-a1a9-a63f8ff5bebf, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ZrellBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "ReportKidnapKetheric_Alive_Sub");

IF
RelationChanged(ACT2_MOO_Absolute_6b0751e2-fbd4-45e1-92ac-d5edb31649d8, Hero_a1542c81-6895-929e-4522-10ce218bb360, 0, 1, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ZrellBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "EnemyOfAbsolute");

IF
DialogEnded(MOO_Audience_Ketheric_26cf4f1f-7f17-e59c-245c-6ed6e767d28f, _, _, _, _)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_SpyIsDead_5377ad88-9ba1-461c-919f-a4ccfc75c8a7, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "NoCaptureAudience");

IF
FlagSet(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
AND NOT
DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_MarcusCapture", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "CaptureNotMet");

IF
FlagSet(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
AND NOT
DB_PermaDefeated(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_MarcusCapture", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "CaptureMet");

IF
FlagSet(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "MarcusBrief", 0, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "CaptureNotMet", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "SurpriseAbduct");

PROC
PROC_State_Changed(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_TakingIsobel_Capture", "SpyCombat_SideWithIsobel", _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "MarcusBrief", 0, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "CaptureNotMet", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "SurpriseProtect");

IF
FlagSet(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
AND
DB_GLO_Moonrise_Journal_OnMoonriseMission(_Var3, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", _Var3, 1, _)
THEN
QuestUpdate("GLO_Moonrise", "EnemyOfMT");

IF
FlagSet(ORI_Shadowheart_State_SharPath_bf9ae334-ff6a-458d-b898-3074bca0bdfb, _, _, _, _)
AND
DB_GLO_Moonrise_Journal_OnMoonriseMission(_Var3, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", _Var3, 1, _)
THEN
QuestUpdate("GLO_Moonrise", "EnemyOfMT");

IF
FlagSet(SHA_NightsongPrison_State_NightsongFreed_24f27b06-6665-79ed-d7bf-e4bf356ca2fa, _, _, _, _)
AND
DB_GLO_Moonrise_Journal_OnMoonriseMission(_Var3, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", _Var3, 1, _)
THEN
QuestUpdate("GLO_Moonrise", "FreedNS");

IF
FlagSet(HAV_TakingIsobel_State_DefendedIsobel_0d0255e4-dd08-47d7-9b40-cce21ec4a5bd, _, _, _, _)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_SpyIsDefeated_863bc783-83ad-4102-b0ee-b5b70b136047, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "MarcusBrief", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "SavedIsobel");

IF
FlagSet(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_SidedWithSpy_5eb745b2-5043-2f36-4d3a-ee3f09ed7a82, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "SavedIsobel", 0, _)
THEN
PROC_GLO_Moonrise_Journal_HelpedMarcusCaptureIsobel();

PROC
PROC_GLO_Moonrise_Journal_HelpedMarcusCaptureIsobel()
AND NOT
DB_GlobalFlag(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "HelpedMarcusCaptureIsobel");

PROC
PROC_GLO_Moonrise_Journal_HelpedMarcusCaptureIsobel()
AND
DB_GlobalFlag(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
AND NOT
DB_Defeated(MOO_Executioner_1e888683-64d6-47f1-3cde-f1d9f430e3e6, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "HelpedMarcusCaptureIsobel_Zrell");

PROC
PROC_GLO_Moonrise_Journal_HelpedMarcusCaptureIsobel()
AND
DB_GlobalFlag(MOO_Executioner_Event_AskedToKidnapIsobel_59a781cf-4a28-fbc7-b032-05c051c0c9f4, _, _, _, _)
AND NOT
DB_Defeated(MOO_Executioner_1e888683-64d6-47f1-3cde-f1d9f430e3e6, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "HelpedMarcusCaptureIsobel_Ketheric");

IF
FlagSet(MOO_Isobel_State_AtMoonrise_a95b7f8f-1454-433f-a496-71c9306683ce, _, _, _, _)
AND
DB_GlobalFlag(HAV_TakingIsobel_State_SidedWithIsobel_52395bbc-a58d-44cd-bd40-8069c776875b, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "MarcusCapturedIsobel");

IF
DB_PermaDefeated(S_GLO_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, _, _, _, _)
AND
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "NoCaptureNSDead");

PROC
PROC_GLO_Moonrise_Journal_OnEndingMainQuest()
AND
DB_QuestIsOpened("GLO_Moonrise_SUB_MarcusCapture", _, _, _, _)
AND NOT
DB_PermaDefeated(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, _, _, _, _)
AND NOT
DB_GlobalFlag(HAV_TakingIsobel_State_IsobelTakenAway_b1c15a65-8060-4b9e-a73f-bde4cc143f7d, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "SavedIsobel");

IF
FlagSet(TWN_Distillery_State_PeacefulResolution_ef40ccf6-a7d7-4fde-8fcf-82b947c29a44, _, _, _, _)
AND
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_BrewerConfession");

IF
FlagSet(TWN_Distillery_State_PeacefulResolution_ef40ccf6-a7d7-4fde-8fcf-82b947c29a44, _, _, _, _)
AND NOT
DB_QuestIsAccepted("GLO_Moonrise_SUB_Relic", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_BrewerConfession_Start");

IF
AutomatedDialogEnded(SHA_Crypt_AD_MagicSkull_49a95b57-79dc-1816-916c-5b2cdbc64aec, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_FoundNecroSkull", 0, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 1, _)
AND NOT
DB_GlobalFlag(SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundNecroSkull");

PROC
PROC_SHA_Mausoleum_OpenSecretDoors()
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundEntrance");

PROC
PROC_SHA_Mausoleum_OpenSecretDoors()
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundEntrance_Necro");

IF
DialogEnded(SHA_TadpoledSkeletons_Scouts_8c88348b-6302-76dc-54ec-fd3eb430f27b, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundSkeletons");

IF
DialogEnded(SHA_Necromancer_Barricade_734cc4ae-3f54-6948-dde2-7227fc04ff4a, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
AND
IsEnemy(S_SHA_Necromancer_Skeleton_002_3eff903e-b99b-4099-b912-f71a9d02b4a2, _Var2, 0, _Var1, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundBarricade");

IF
FlagSet(SHA_Necromancer_State_JusticiarsDefeated_30313b78-abb9-450d-942b-7f6bc7837e08, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_ToldHelpNecromancer", 1, _)
AND
DB_Players(_Var3, _, _, _, _)
AND
IsEnemy(S_SHA_Necromancer_Skeleton_002_3eff903e-b99b-4099-b912-f71a9d02b4a2, _Var3, 0, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundNecromancer");

IF
FlagSet(SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431, _, _, _, _)
AND
DB_QuestIsOpened("GLO_Moonrise", _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_MetNecromancer_Alt", 0, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_EnterShadowfell", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_MetNecromancer");

IF
FlagSet(SHA_Necromancer_State_AskedHelp_1e06992f-24ad-254e-42aa-a0092f6f8431, _, _, _, _)
AND NOT
DB_QuestIsOpened("GLO_Moonrise", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_MetNecromancer_Alt");

IF
DB_GlobalFlag(SHA_Necromancer_State_Dead_f83edb0d-f11f-4a3e-a866-58af8fc6c96d, _, _, _, _)
AND
DB_State_Current(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtTemple", _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_StartedTrials", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_NecromancerDefeated");

IF
CustomBookUIClosed(_, "SHA_TempleLore", _, _, _)
AND NOT
DB_GlobalFlag(SHA_Trials_Knows_LearnedAboutTrials_a9d9efe0-9031-4b82-8c72-8518c178e485, _, _, _, _)
THEN
PROC_GlobalSetFlagAndCache(SHA_Trials_Knows_LearnedAboutTrials_a9d9efe0-9031-4b82-8c72-8518c178e485);

IF
FlagSet(SHA_Trials_Knows_LearnedAboutTrials_a9d9efe0-9031-4b82-8c72-8518c178e485, _, _, _, _)
AND
DB_SHA_RelicJournal(_Var3, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", _Var3, 1, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_OpenedPath", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_StartedTrials");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", (STRING)_Var2, _, _)
AND
DB_SHA_RelicJournal(_Var2, _, _, _, _)
AND
DB_GlobalFlag(SHA_Trials_Knows_LearnedAboutTrials_a9d9efe0-9031-4b82-8c72-8518c178e485, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_StartedTrials");

IF
FlagSet(SHA_Trials_Knows_SeenAltarInscription_24f46431-f67a-4b04-b027-fa4300322c00, _, _, _, _)
AND
DB_SHA_RelicJournal(_Var3, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", _Var3, 1, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_OpenedPath", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_StartedTrials");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", (STRING)_Var2, _, _)
AND
DB_SHA_RelicJournal(_Var2, _, _, _, _)
AND
DB_GlobalFlag(SHA_Trials_Knows_SeenAltarInscription_24f46431-f67a-4b04-b027-fa4300322c00, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_StartedTrials");

IF
AddedTo((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_GemsNotTaken(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_RelicJournal_GemsTaken(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SHA_RelicJournal_GemsTaken(_Var1);

IF
AddedTo((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_RelicJournal_GemsTaken(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_RelicJournal_GemsJournaled(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_StartedTrials", 1, _Var1)
THEN
DB_SHA_RelicJournal_GemsJournaled(_Var1);
PROC_SHA_RelicJournal_GemUpdateCheck(_Var1);

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", "Relic_StartedTrials", _, _)
AND
DB_SHA_RelicJournal_GemsTaken(_Var2, _, _, _, _)
AND NOT
DB_SHA_RelicJournal_GemsJournaled(_Var2, _, _, _, _)
THEN
DB_SHA_RelicJournal_GemsJournaled(_Var2);
PROC_SHA_RelicJournal_GemUpdateCheck(_Var2);

PROC
PROC_SHA_RelicJournal_GemUpdateCheck((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb
THEN
PROC_SHA_RelicJournal_GemUpdate();

PROC
PROC_SHA_RelicJournal_GemUpdate()
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_FoundGemTrials", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundGemTrials2");

PROC
PROC_SHA_RelicJournal_GemUpdate()
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_FoundGem", 1, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_FoundGemTrials", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundGemTrials");

PROC
PROC_SHA_RelicJournal_GemUpdate()
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_FoundGem", 0, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundGem");

PROC
PROC_SHA_RelicJournal_GemUpdateCheck(S_SHA_TrialGem_006_7fbf6a88-bce1-49e0-a216-0cb2ce23b0eb, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_RelicJournal_FoundOrthonGem", _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate("SHA_TempleTrials", "AcquiredOrthonGem");

IF
DB_GlobalFlag(SHA_Necromancer_State_Dead_f83edb0d-f11f-4a3e-a866-58af8fc6c96d, _, _, _, _)
AND
DB_State_Current(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtTemple", _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_StartedTrials", 1, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_NecromancerDefeated");

IF
PlatformMovementFinished(S_PLT_SHA_Disc_963cbac6-de2b-4ee5-ba5b-c13a0c4fcda9, "SHA_Disc_Moved", _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_SeenSecondAltar");

IF
Opened(S_SHA_NightsongChamberDoor_4689976f-7fe3-4d5f-933a-e872ce947d93, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_OpenedPath");

IF
FlagSet(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, _, _, _, _)
AND
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _, _, _, _)
THEN
QuestUpdate(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GLO_Moonrise", "Relic_EnterShadowfell_NecroDead");

IF
FlagSet(SHA_NightsongPrison_State_PlayerEnteredPrison_f2cbe7cf-5223-4522-a649-879d08638282, _, _, _, _)
AND NOT
DB_PermaDefeated(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, _, _, _, _)
THEN
QuestUpdate(S_Player_ShadowHeart_3ed74f06-3c60-42dc-83f6-f034cb47c679, "GLO_Moonrise", "Relic_EnterShadowfell");

IF
DB_GlobalFlag(SHA_Necromancer_State_Dead_f83edb0d-f11f-4a3e-a866-58af8fc6c96d, _, _, _, _)
AND
DB_State_Current(S_SHA_Necromancer_53651a9f-7ea8-444f-ba2d-224390b72f7d, "SHA_Necromancer", "SHA_Necromancer_State_AtPrison", _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_NecromancerDefeated_Shadowfell");

IF
EnteredTrigger((CHARACTER)_Var1, S_SHA_NightsongPrison_PrisonArea_3673ff64-5760-40fb-8b43-ce4f7731c562, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "Relic_EnterShadowfell", 0, _Var1)
THEN
QuestUpdate("GLO_Moonrise", "Relic_FoundNightsongAlone");

IF
FlagSet(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ExecutionWitness", 0, _)
AND NOT
DB_PermaDefeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_ReturnToMoonrise");

IF
FlagSet(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ExecutionWitness", 1, _)
AND NOT
DB_PermaDefeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_ReturnToZrell");

IF
FlagSet(SHA_NightsongPrison_Event_NightsongSentToMoonrise_685b9761-43b6-9004-8655-073096c62731, _, _, _, _)
AND
QuestUpdateIsUnlocked(NULL_00000000-0000-0000-0000-000000000000, "GLO_Moonrise", "ExecutionWitness", 1, _)
AND
DB_PermaDefeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_ReturnToKetheric");

IF
DialogEnded(MOO_Executioner_1e888683-64d6-47f1-3cde-f1d9f430e3e6, _, _, _, _)
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_RewardedZrell");

IF
DialogEnded(MOO_Audience_Ketheric_26cf4f1f-7f17-e59c-245c-6ed6e767d28f, _, _, _, _)
AND
DB_GlobalFlag(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, _, _)
AND
DB_QuestIsOpened("GLO_Moonrise_SUB_Relic", _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", "Relic_RewardedKetheric");

IF
QuestUpdateUnlocked(_, "GLO_Moonrise", (STRING)_Var2, _, _)
AND
DB_GLO_Moonrise_Journal_ChainedStateIfOpen(_Var3, _Var2, _Var4, _, _)
AND
DB_QuestIsOpened(_Var3, _, _, _, _)
THEN
QuestUpdate("GLO_Moonrise", _Var4);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Start"
