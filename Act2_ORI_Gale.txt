Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_OneShotPartyTrigger(S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f);
SetOnStage(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 0);
PROC_LoopEffect(VFX_Script_Gameplay_Gale_DeathVoice_01_7e9d37d9-a03e-fe8c-d997-d3fe9b26302c, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "ORI_Gale_DoubleOverlay", "SCL_Main_A", "");
DB_Dialogs(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_GaleDouble3_f6fb700a-5086-404c-ba15-7cf16642fc22, 0);
SetOnStage(S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, 0);
SetOnStage(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, 0);
DB_OriginCampFlags(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_ORI_OriginCampData(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "SCLMAIN", S_CAMP_Gale_cd090f6d-20b7-8d2e-1bc5-7cc7fbf04c0d);
DB_ORI_OriginCampData(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "SHARTEMPLE", S_CMP_Gale_A_4413321d-33af-8e54-0ae2-523abab343cf);
DB_ORI_OriginCampData(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "MOONRISE", S_CMP_Gale_A_78fdad04-c5bb-8ef2-3904-ded057036f00);
DB_ORI_OriginCampData(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, "HAVEN", S_CAMP_GALE_44bf9701-c872-8b5c-3c44-be9d626d46a2);
SetTag(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, BLOCK_PICKPOCKET_fe2e65d3-a8de-45bf-a372-c339adec669e);
PROC_ORI_Gale_Act2Setup();
DB_ORI_GaleDouble2Trigger("SCLMAIN", S_ORI_GaleDouble2_Box_bbdd28aa-8fbf-802a-1eda-146fa2b25f29);
DB_ORI_GaleDouble2Trigger("SHARTEMPLE", S_ORI_GaleDouble2_Box_32e75b5a-92a7-8150-0df7-fad2617556eb);
DB_ORI_GaleDouble2Trigger("MOONRISE", S_ORI_GaleDouble2_Box_00409ba1-873a-4eef-87fa-9ca501370067);
DB_ORI_GaleDouble2Trigger("HAVEN", S_ORI_GaleDouble2_Box_3283b04e-277a-8e58-3f59-5635192f59ce);
DB_TopicalGreeting(TG_ORI_Gale_ConsumedTWNBoss_e65c5df2-9ff6-4e46-b0c0-f421e9fce6c9);
DB_TopicalGreeting(TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525);
DB_TopicalGreeting(TG_ORI_Gale_CraftedDarkLantern_e59b3e35-10f1-4d16-9d03-d495a6049c3e);
DB_ORI_Gale_LanternIngredients("Pixie", DEC_Necromancer_Dead_Pixie_A_001_49cc3b4a-171a-42e1-a9e3-edaca53c8e5c);
DB_ORI_Gale_LanternIngredients("Pixie", DEC_Necromancer_Dead_Pixie_Bowl_A_001_25389689-3ea3-4e33-b05c-f49a15241522);
DB_ORI_Gale_LanternIngredients("Lantern", UNI_UND_Moonlantern_Broken_0b42df9e-2ded-41bd-84a6-503573936d95);
DB_ORI_Gale_LanternIngredients("Lantern", UNI_UND_Moonlantern_Broken_12a0f78a-8029-4c67-9965-f863fd20fda5);
DB_RelationshipDialog_WRD_TriggerInCamp(Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df);
DB_RelationshipDialog_WRD_TriggerInCamp(Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

KBSECTION
PROC
PROC_CampNight_StartSelected()
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
THEN
NOT DB_OnlyOnce("ORI_Gale_RejoinDuringLastNightAlive");
PROC_ORI_Gale_SetupForLastNightAlive();
SetOnStage(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 1);
PROC_ORI_SetupCamp(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 1);
Transform(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
CopyCharacterEquipment(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
DB_ORI_Gale_InLastNightAlive(1);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND NOT
DB_PartyMembers(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_Poof(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_ORI_Gale_LastNightAliveAvatar(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_ORI_Gale_LastNightAliveAvatar(_Var1);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_PartyMembers(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
THEN
DB_ORI_Gale_LastNightAliveAvatar(_Var1);

PROC
PROC_ORI_Gale_SetupForLastNightAlive()
AND
DB_PartyMembers(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_GLO_PartyMembers_Remove(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

IF
CharacterLeftParty(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_ORI_Gale_InLastNightAlive(1, _, _, _, _)
THEN
PROC_Poof(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

IF
RemovedFrom((ITEM)_Var1, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1)
AND
IsItem(_Var1, 1, _Var1, _Var1, _Var1)
THEN
RequestDelete(_Var1);

IF
DB_ORI_Gale_InLastNightAlive(1, _, _, _, _)
AND NOT
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
THEN
NOT DB_ORI_Gale_InLastNightAlive(1);
PROC_ORI_Gale_Rejoin();
PROC_Poof(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

IF
AttackedBy(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _, _, _, _, _, _, (GUIDSTRING)_, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_Poof(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, VFX_Script_Gale_Double_Poof_01_5aec34ad-c864-c27d-1c4e-bb941014b75d);

QRY
QRY_Camp_StartRomanceNight_CustomDialogStart(CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_StartDialog_Fixed(CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, S_ORI_Gale_LastNightAlive_GaleDouble3_f6fb700a-5086-404c-ba15-7cf16642fc22, S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ORI_Gale_Rejoin();
Transform(S_ORI_Gale_LastNightAlive_GaleDouble_244735bd-a5e6-4e70-b6e6-becbf70a54b8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
Transform(S_ORI_Gale_LastNightAlive_GaleDouble2_1b5e6e47-03bc-41b6-91e9-dbe6ba86ffe8, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
Transform(S_ORI_Gale_LastNightAlive_AvatarDouble_1cedd0c1-6bfe-4f32-a1e7-78b0acf209a9, _Var1, DISGUISE_KEEPICON_KEEPNAME_b40d9ab4-57a7-4632-b8d7-188904b00606);
MakePlayerActive(_Var1);

PROC
PROC_ORI_Gale_Rejoin()
AND NOT
DB_GlobalFlag(GEN_MaxPlayerCountReached_823b5064-8aa4-c0b7-1b8c-657b46987ccd, _, _, _, _)
AND
DB_ORI_Gale_LastNightAliveAvatar(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("ORI_Gale_RejoinDuringLastNightAlive", _Var1, _Var1, _Var1, _Var1)
THEN
PROC_GLO_PartyMembers_Add(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1);
PROC_ORI_Gale_Rejoin_TryTeleport(_Var1);

PROC
PROC_ORI_Gale_Rejoin_TryTeleport((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_InCamp(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, "", 0, 0, 0, 0, 0);
AttachToPartyGroup(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1);

PROC
PROC_ORI_Gale_Rejoin()
THEN
SetOnStage(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

QRY
QRY_SpeakerIsAvailable(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
AND
DB_OffStage(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
DB_NOOP(1);

IF
DB_InCamp(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _, _, _, _)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
THEN
PROC_CampRelationshipDialog(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b, 0);
PROC_Try_CampRelationshipDialog(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, 1);
DB_CampNight_Completed(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd);

QRY
QRY_CampNight_AtLeastOneCompanionAvailableForCRD(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_InCamp(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND NOT
DB_CantTalk(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
QRY_SpeakerIsAvailable(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
DB_NOOP(1);

IF
DialogEnded(CAMP_GaleDouble2_5aa5ccd5-6624-3660-d814-e5f8d569708b, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetFlag(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _Var2, 1, _Var1, _Var1)
THEN
DB_Camp_QueuedRomanceNight(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, _Var2);
PROC_Camp_TryLeaveNightMode(_Var2);

IF
FlagSet(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_ORI_Gale_QueuedForLastNightAliveScene(_Var1);

IF
FlagCleared(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, (CHARACTER)_Var1, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
NOT DB_Camp_QueuedRomanceNight(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, CAMP_GalesLastNightAlive_SD_ROM_e6067557-2187-7493-c9b6-363ef6dd8334, _Var1);
NOT DB_ORI_Gale_QueuedForLastNightAliveScene(_Var1);

IF
FlagSet(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ORI_Gale_QueuedForLastNightAliveScene(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
_Var3 != _Var1
THEN
ClearFlag(ORI_Gale_Event_LastNightAliveRomanceScene_d99c6ee6-3b6c-3710-ff0c-47ecca820ad9, _Var3, 0);

IF
DB_ActiveCamp(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_GaleDouble2Trigger(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
_Var3 != _Var2
THEN
TriggerUnregisterForCharacter(_Var3, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
NOT DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var3);

IF
DB_ActiveCamp(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_GaleDouble2Trigger(_Var1, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
TriggerRegisterForCharacter(_Var2, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var2);

IF
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_InRegion(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349, _Var1);

IF
DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _Var1, _Var1, _Var1, _Var1)
THEN
TriggerUnregisterForCharacter(_Var1, S_ORI_GaleDouble2_30edc515-b6f2-42c0-8459-41ae4c36b349);
NOT DB_ORI_Gale_CurrentGaleDouble2Trigger(_Var1);

PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_LastNightAliveTrigger_943e6455-3aaa-4804-9fcf-24059ffa603f, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
SetFlag(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
EnteredTrigger((CHARACTER)_Var1, S_SHA_Temple_SUB_348b76ee-33d8-471b-a95d-7ded0d6cdfd5, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
THEN
SetFlag(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_ORI_Dating(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1)
THEN
SetFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_GlobalFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc, _, _, _, _)
AND NOT
DB_ORI_Dating(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
THEN
ClearFlag(ORI_Gale_State_LastNightAlive_RomanceCandidateExists_7c5bc0f6-3488-4cf8-b1f0-f76055bda2fc, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_CAMPDEBUG_QueueNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
AND
GetHostCharacter(_Var2, _, _, _, _)
AND NOT
DB_ORI_Dating(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND
DB_Avatars(_Var2, _, _, _, _)
THEN
DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");
SetFlag(ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, _Var2, 0);

PROC
PROC_CAMPDEBUG_QueueNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
AND NOT
DB_ORI_Dating(_, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND
DB_Avatars(_Var3, _, _, _, _)
THEN
DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");
SetFlag(ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, _Var3, 0);

PROC
PROC_CAMPDEBUG_QueueNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
NOT DB_OnlyOnce("ORI_Gale_LastNightAlive_DebugSetup");

PROC
PROC_Camp_SetModeToDay()
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_3defd8a0-cd64-7e71-2ca8-2fdedd1148cd, _, _, _, _)
AND
QRY_OnlyOnce("ORI_Gale_IPRD_LastNightAlive", _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_WillingToDie_3f22f471-60e6-11df-1c95-19f756f81994, _, _, _, _)
AND
QRY_ORI_Gale_AnyAvatarInLastNightAlive()
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

PROC
PROC_COL_TeleportPartiesToColony(_, (INTEGER)_, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1);

QRY
QRY_ORI_Gale_AnyAvatarInLastNightAlive()
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(ORI_Gale_State_WasInLastNightAlive_8259b8c8-c5aa-35b3-f7c5-820492069c03, _Var1, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_SelectCustomDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_HandlingRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_LastNightAlive_3efef386-5077-3ecf-9e71-a0482695fbc1, _, 0, -100, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(ORI_Gale_State_WasInLastNightAlive_8259b8c8-c5aa-35b3-f7c5-820492069c03, _Var1, 0, _Var1, _Var1)
THEN
DB_SelectedDialog(GLO_AD_NonBondedCompanionDialog_62ba7c46-8d22-c591-f04c-2e99441cd02a, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

QRY
QRY_SelectCustomDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
THEN
DB_SelectedDialog(CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Var1);

PROC
PROC_COL_TeleportPartiesToColony(_, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _, _, _)
THEN
NOT DB_COL_ChosenThreeOverrides(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_ORI_Gale_Act2Setup()
AND NOT
DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem1_a1faa546-4525-437e-a528-a4ccfd541a93, _, _, _, _)
THEN
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

PROC
PROC_ORI_Gale_Act2Setup()
AND NOT
DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

PROC
PROC_ORI_Gale_Act2Setup()
AND NOT
DB_GlobalFlag(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, _, _, _, _)
THEN
DB_OneShotPartyTrigger(S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1);

PROC
PROC_OneShotTriggerEntered(_, S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1, (CHARACTER)_, (CHARACTER)_, (CHARACTER)_)
THEN
PROC_ORI_Gale_IncreaseRegionsVisited();
PROC_ORI_Gale_IncreaseRegionsVisited();

IF
FlagSet(ORI_Gale_State_EnoughRegionsToAskMagicItem3_40cd9192-878b-480f-9a41-9f69c61f2bd9, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_RemoveOneShotTrigger(S_ORI_Gale_SCLBombTrigger_392d9539-883c-41a7-8ac0-b0c0748f47a1);

PROC
PROC_SCE_DebriefStarts()
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_SawElderBrain_05706143-82c3-616d-6850-9281f08c9b9f, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

PROC
PROC_SCE_DebriefStarts()
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_AskMagicItemApproval_f05f6be6-967f-6612-988f-636150f94b5a);
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_ElminsterVisit_2b8afc02-f8ae-d386-a910-989767a06250);
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_NeedMagicItem1_c1899c40-e4c4-72d6-4360-444cea41e72f);
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_NeedMagicItem2_170a6564-a01e-f145-6958-bf84312d0e03);
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_NeedMagicItem3_b2db2afd-74a2-b432-df34-6073d7c78b62);

QRY
QRY_TWN_Finale_CompanionHasUnfinishedBusiness()
AND
DB_PartOfTheTeam(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _, _, _)
AND NOT
DB_OnlyOnce("ORI_Gale_EndOfActReminder", _, _, _, _)
THEN
DB_NOOP(1);

IF
ReadyCheckPassed("TWN_Finale_CompanionReadyCheck", _, _, _, _)
THEN
DB_OnlyOnce("ORI_Gale_EndOfActReminder");

IF
DB_ORI_Dating(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Gale_State_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70, _Var1, _Var1, _Var1, _Var1)
AND
DB_CurrentLevel("SCL_Main_A", _Var1, _Var1, _Var1, _Var1)
AND
DB_Is_InCombat(_Var3, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_PartyMembers(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
IsTagged(_Var3, UNDEAD_33c625aa-6982-4c27-904f-e47029a9b140, 1, _Var1, _Var1)
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1);

IF
CharacterReservedUserIDChanged(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_ORI_Dating(_Var3, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND NOT
QRY_SameUser(_Var3, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
DB_ORI_Partnered(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
FlagCleared(ORI_State_PartneredWithGale_e008e20d-d642-42ed-9008-297b6273aa21, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
FlagCleared(ORI_State_DatingGale_75d0e041-c16c-d089-6d89-64354fa4c9d9, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_DatingIPRD_bc2b11ae-774b-b1ec-c29f-55db48af070f, ORI_Gale_IPRD_DatingAvatarFoughtUndeadInSCL_c85140e7-94db-4411-9162-5b9b1ae6fe70);

IF
DB_GlobalFlag(HAV_EnteringHaven_State_GainedAccess_07c776da-353a-9050-e9be-c42d51a99412, _, _, _, _)
AND
DB_GlobalFlag(ORI_Gale_Knows_NeedsMagicItems_d3827f86-fc4f-411d-9623-9ae5d35d6735, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _, _, _)
THEN
TriggerRegisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
FlagSet(ORI_Gale_Knows_DidHavReminder_0a902530-51c5-fdcf-aa51-4c2417096c98, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
TriggerUnregisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
FlagSet(ORI_Gale_State_GotOneMagicItem_6fec5439-a66e-4aff-b62b-69f88648c34d, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
TriggerUnregisterForCharacter(S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

IF
EnteredTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_State_HAVReminder_7f04f5c1-2585-ff41-a61a-674ab5e31627, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
LeftTrigger(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_HavenReminder_7596e6ad-05fa-4d6b-98f3-d2781bf9ddb1, _, _, _)
THEN
PROC_CancelRelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_State_HAVReminder_7f04f5c1-2585-ff41-a61a-674ab5e31627);

PROC
PROC_CAMPDEBUG_QueueNight((FLAG)_Var1, _, (FLAG)_Var1, (FLAG)_Var1, (FLAG)_Var1)
AND
DB_CampNight_SoloDream(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464, _Var1, _Var1)
THEN
PROC_CampNight_GaleTressym_ToCamp(1);

PROC
PROC_CampNight_StartSleepMoments_PreHook()
AND
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_Avatar_FollowedMystra_f45005bf-c598-4331-8cb8-fe246093f1db, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_Knows_ElminsterLetterRead_0f4d6900-49b2-4c5d-b72e-6b119011b8ab, _, _, _, _)
THEN
NOT DB_Camp_QueuedSoloDream(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464);

IF
DialogStarted(CAMP_Gale_SD_LastNightAlive_fdabf765-0c88-414c-60c2-2221fde2b464, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
SetFlag(ORI_Gale_State_HadLastNightAliveSD_29164397-366b-4b1a-a3c3-c3e91baed4e7, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogStarted(CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
SetOnStage(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, 1);
ToInventory(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);
ApplyStatus(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, "GEN_INVENTORYBOUND", -1, 1, NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded(CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, (INTEGER)_, (INTEGER)_, (INTEGER)_)
THEN
RemoveStatus(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, "GEN_INVENTORYBOUND", NULL_00000000-0000-0000-0000-000000000000);

IF
DialogEnded(CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _)
AND
DB_GlobalFlag(ORI_Gale_Event_ReadElminsterLetter_678c9c84-1003-5c3a-fbe3-600fc12a3288, _, _, _, _)
THEN
Use(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, 1, 0, "");

IF
GameBookInterfaceClosed(S_ORI_Gale_ElminsterLetter_ff4378ac-08d7-4249-88bf-8ef99b35b532, _, (CHARACTER)_, (CHARACTER)_, (CHARACTER)_)
THEN
SetFlag(ORI_Gale_Knows_ElminsterLetterRead_0f4d6900-49b2-4c5d-b72e-6b119011b8ab, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DB_HandlingRelationshipDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _, _, _, _, _)
AND NOT
GetRegion(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, "SCL_Main_A", _, _, _)
THEN
TeleportTo(S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, S_ORI_Gale_ElminsterPoint_SCL_975ef355-b68e-4061-bda8-b774e8ff552f, "", 0, 0, 0, 1, 1);

PROC
PROC_StartDialog_AddExtraSpeakers(CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
THEN
PROC_DialogAddSpeakingActor(_Var1, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b);

QRY
QRY_SelectCustomDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_HandlingRelationshipDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
QRY_SpeakerIsAvailable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SelectedDialog(CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _Var1);

QRY
QRY_SelectCustomDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND
DB_HandlingRelationshipDialog(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, _, _, _, _, _, _, _, _)
AND
QRY_SpeakerIsAvailable(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, _, _, _, _)
THEN
DB_SelectedDialog(CAMP_Gale_Tressym_CRD_LastNightAlive_FollowedMystra_dd050c99-ed81-9115-7a16-207b8744f2f2, S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, S_GLO_Elminster_75bb6396-1132-4064-bafe-205a3f156b9b, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604);

PROC
PROC_BlockLootCorpse((CHARACTER)_Var1, (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_TWN_Bosses(_Var2, _, _, _, _, _, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, _Var2, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1)
THEN
PROC_GlobalSetFlagAndCache(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9);
DB_CustomLootCorpseResponse(_Var1, _Var2, 0);

IF
DialogEnded(TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogSpeakers(_Var1, _Var2, 1, _Var1, _Var1)
AND
GetDistanceTo(_Var2, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var3, _Var1, _Var1)
AND
_Var3 <= 5
AND NOT
DB_Defeated(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
OpenCharacterLootUI(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var2, _, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
FlagSet(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
AddPassive(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Gale_ShadowSpellSlots");
SetFlag(TG_ORI_Gale_ConsumedTWNBoss_e65c5df2-9ff6-4e46-b0c0-f421e9fce6c9, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);
RemoveStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_1", NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_Gale_State_RefusedTWNBossPower_e047de12-2c0b-7bdb-3553-47b03f69ca6a, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b, _, _, _, _)
THEN
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_2", -1, 0, NULL_00000000-0000-0000-0000-000000000000);
SetFlag(TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle", _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
THEN
QuestUpdate(_Var2, "ORI_COM_Gale", "FoundCircle");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle", _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
THEN
QuestUpdate(_Var2, "ORI_COM_Gale", "AccidentallyDestroyed");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle", _Var1, _Var1, _Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
THEN
QuestUpdate(_Var2, "ORI_COM_Gale", "Destroyed");

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, (CHARACTER)_Var5, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle", _, _, _)
THEN
QuestUpdate(_Var5, "ORI_COM_Gale", "Crafted");

IF
LevelLoaded("INT_MAIN_A", _, _, _, _)
AND
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "FoundCircle", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "Crafted", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "Destroyed", _, _, _)
AND NOT
QRY_QuestUpdateIsUnlockedForAny("ORI_COM_Gale", "AccidentallyDestroyed", _, _, _)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
QuestUpdate(_Var1, "ORI_COM_Gale", "MagicCircle_Act3");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 0, _Var1)
THEN
QuestUpdate(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
AND
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1, _Var1)
THEN
QuestUpdate(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Destroyed");

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1, _)
THEN
QuestUpdate(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Crafted");

IF
LevelLoaded("INT_MAIN_A", _, _, _, _)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1, _)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Crafted", 0, _)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "Destroyed", 0, _)
AND
QuestUpdateIsUnlocked(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "FoundCircle", 1, _)
THEN
QuestUpdate(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_Avatar_Gale", "MagicCircle_Act3");

QRY
QRY_MOO_BalthazarLab_Circle_Using((INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
AND
GetFlag(SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Var2, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
InteractionFallback(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _)
AND NOT
QRY_StartDialog(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
THEN
PROC_TryStartAD(GEB_AD_CantTalkNow_ae991ba1-8a2e-9cc7-b4c2-379af7f058c5, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND
DB_Avatars(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SpeakerIsAvailableAndInDialogRange(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1, _Var1)
AND
QRY_SameUser(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_DialogFlagSetup(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
THEN
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog");

IF
InteractionFallback((CHARACTER)_Var1, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
_Var1 != S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604
AND NOT
QRY_ORI_Gale_BalthazarLab_Circle_GaleDialog(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TryStartAD(MOO_BalthazarLab_Circle_PAD_1f95c6fa-8fb7-5d53-a2c0-5eac2013f733, _Var1);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
AND
GetFlag(SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Var2, 1, _Var1, _Var1)
THEN
MakePlayerActive(_Var2);
SetTag(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, ITEMINTERACTION_UNLOCKED_6ca541e1-b5d9-4cfa-b745-61a5483052d7);
ClearFlag(SCL_BalthazarLab_Circle_Event_Use_277fddb0-4519-c267-52c3-3831ad1955c9, _Var2, 0);
Use(_Var2, S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 1, 0, "");

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, 1, _Var1, _Var1)
AND
QuestUpdateIsUnlocked(_Var2, "ORI_COM_Gale", "Crafted_Companion", 1, _Var1)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Var3, _Var4, _Var5, _Var1)
THEN
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_CombineSuccess_01_3fd32122-a4e0-a6eb-291b-60e42e7ad710, _Var3, _Var4, _Var5, 1);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_GlobalFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8, _Var1, _Var1, _Var1, _Var1)
THEN
ClearFlag(MOO_BalthazarLab_Circle_Event_Explode_50cf8893-61a1-9b22-869f-6809bc454ea8);
CreateExplosion(S_SCL_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, "Projectile_MOO_BalthazarCircle_Explode", 10, NULL_00000000-0000-0000-0000-000000000000);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
SetFlag(TG_ORI_Gale_CraftedDarkLantern_e59b3e35-10f1-4d16-9d03-d495a6049c3e, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_CraftedShadowLantern_645a4eb9-5417-951b-f282-9bdcdd9f89f1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, (CHARACTER)_Var5, (ITEM)_Var6, _, _, _)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Var7, _Var8, _Var9, _)
THEN
SetFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b, NULL_00000000-0000-0000-0000-000000000000, 0);
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_CombineSuccess_01_3fd32122-a4e0-a6eb-291b-60e42e7ad710, _Var7, _Var8, _Var9, 1);
SetFlag(ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Var5, 0);
ToInventory(_Var6, _Var5, -1, 1, 1);

IF
UseStarted(_, S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _)
AND
GetFlag(ORI_Gale_State_CraftedDarkLantern_3ddebb12-8c9f-47b4-8b6a-bb8eeac51a9b, NULL_00000000-0000-0000-0000-000000000000, 0, _, _)
THEN
ClearTag(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, ITEMINTERACTION_UNLOCKED_6ca541e1-b5d9-4cfa-b745-61a5483052d7);

IF
Combined(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _, _, _, _, _, _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
QRY_StartDialog(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _)
THEN
DB_NOOP(1);

IF
FlagSet(ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, _, _)
THEN
ApplyStatus(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, "ORI_GALE_MYSTRABLESSING_1", -1, 0, NULL_00000000-0000-0000-0000-000000000000);

IF
FlagSet(ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
SetFlag(TG_ORI_GaleBlessedByMystra_f3f75c10-e497-4819-8fd5-a2a3b3800525, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
FlagSet(ORI_Gale_Event_DestroyBalthazarCircle_773ed9d2-5879-0e2b-f18f-2e6768b958f5, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, _, _)
AND NOT
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
THEN
PROC_RelationshipDialog(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, ORI_Gale_IPRD_BlessedByMystra_66c00d4b-a810-b142-7e3e-7387c1918dd7, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _, _, _, _)
AND
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _, _, _, _)
AND
GetPosition(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, _Var2, _Var3, _Var4, _)
THEN
SetVisible(S_MOO_BalthazarLab_Circle_fa45ff4b-27d6-45dc-85eb-488e5d3c6a77, 0);
PlayEffectAtPosition(VFX_Script_SCL_MagicCircle_DestroyAction_01_4647a831-0117-c958-f9c7-2f2e2829471a, _Var2, _Var3, _Var4, 1);

IF
LeftTrigger((CHARACTER)_Var1, S_MOO_UpperFloorInterior_SUB_93c522d3-04c4-4f71-a1dc-043478c51301, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Var1, 1, _Var1, _Var1)
THEN
ClearFlag(ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Var1, 0);

IF
DialogEnded(Gale_InParty2_6beb1b10-845f-49fa-6d6d-f425eaa42574, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, _Var2, _, _Var1, _Var1)
AND
GetFlag(ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Var2, 1, _Var1, _Var1)
THEN
ClearFlag(ORI_Gale_State_BalthazarCircleUserWaitingForReaction_d81fe123-b593-422c-a4b0-00d6624d885b, _Var2, 0);

IF
Moved((ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1)
AND
DB_ORI_Gale_LanternIngredients(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_ORI_Gale_LanternIngredients(_Var2, _Var1);
PROC_ORI_Gale_BalthazarLab_CheckIngredients();

PROC
PROC_ORI_Gale_BalthazarLab_CheckIngredients()
AND NOT
DB_ORI_Gale_LanternIngredients("Pixie", _, _, _, _)
THEN
SetFlag(ORI_Gale_BalthazarLab_State_IngredientsGone_8e632516-2a31-4ace-8327-392e152f3924, NULL_00000000-0000-0000-0000-000000000000, 0);

PROC
PROC_ORI_Gale_BalthazarLab_CheckIngredients()
AND NOT
DB_ORI_Gale_LanternIngredients("Lantern", _, _, _, _)
THEN
SetFlag(ORI_Gale_BalthazarLab_State_IngredientsGone_8e632516-2a31-4ace-8327-392e152f3924, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
QRY_OnlyOnce_Reset("ORI_Gale_BalthazarLab_Event_TakeIngredients", _Var1, _Var1, _Var1, _Var1)
AND
DB_ORI_Gale_LanternIngredients("Pixie", _Var3, _Var1, _Var1, _Var1)
AND
DB_ORI_Gale_LanternIngredients("Lantern", _Var4, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("ORI_Gale_BalthazarLab_Event_TakeIngredients", _Var1, _Var1, _Var1, _Var1)
THEN
ToInventory(_Var3, _Var1, -1, 1, 1);
ToInventory(_Var4, _Var1, -1, 1, 1);

IF
FlagSet(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
ClearFlag(ORI_Gale_BalthazarLab_Event_TakeIngredients_e60fe6a9-2216-4c63-85cf-b1479451c285, _Var1, 0);

IF
FlagSet(ORI_Gale_State_ReadyForLastNightAlive_088c7213-0615-41a0-a4ac-1ab4d1341666, NULL_00000000-0000-0000-0000-000000000000, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
TadpolePowerAssigned(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
DB_GlobalFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, _, _, _, _)
AND NOT
QRY_ORI_Gale_FollowedMystra()
THEN
ClearFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

QRY
QRY_ORI_Gale_FollowedMystra()
AND NOT
DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9, _, _, _, _)
AND NOT
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog", _, _, _, _)
AND
DB_Avatars(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, _, _, _, _)
AND
GetTadpolePowersCount(S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 0, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_FollowedMystra()
AND
DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9, _, _, _, _)
AND NOT
DB_GlobalFlag(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, _, _)
AND NOT
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog", _, _, _, _)
THEN
DB_NOOP(1);

QRY
QRY_ORI_Gale_FollowedMystra()
AND NOT
DB_GlobalFlag(ORI_Gale_State_LootedTWNBoss_f148dc5b-f7ee-46b7-8d84-c2dd12ba59b9, _, _, _, _)
AND
DB_OnlyOnce("ORI_Gale_BalthazarLab_Circle_GaleDialog", _, _, _, _)
AND
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _, _, _, _)
THEN
DB_NOOP(1);

IF
FlagSet(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _, _, _, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _, _, _, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded(TWN_Gale_LootBoss_bf0f715a-405c-41c1-a736-80fd7c8ecd9e, _, _, _, _)
AND
QRY_ORI_Gale_FollowedMystra()
THEN
SetFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
FlagSet(ORI_Gale_State_AbsorbedTWNBossPower_7d08986a-5410-ccdf-fe70-aaec379a1962, _, _, _, _)
AND
DB_GlobalFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, _, _, _, _)
THEN
ClearFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogEnded(MOO_BalthazarLab_Circle_e759d2dd-b299-de5c-6611-ad7d64da22e9, _, _, _, _)
AND NOT
DB_GlobalFlag(SCL_BalthazarLab_Circle_State_Ruined_12ad3f4a-d592-bb4e-fc31-bf93094a0b75, _, _, _, _)
AND
DB_GlobalFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, _, _, _, _)
THEN
ClearFlag(ORI_Gale_State_FollowedMystra_1493b646-6b41-403b-ad1e-253712206f46, NULL_00000000-0000-0000-0000-000000000000, 0);

IF
DialogStarted(CAMP_Gale_Tressym_00706ce9-cbf7-95ee-912d-b42909b483a7, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_DialogPlayers(_Var1, S_Player_Gale_ad9af97d-75da-406a-ae13-7071c563f604, 1, _Var1, _Var1)
THEN
PROC_StopLoopEffect(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "RelationshipMarker");

IF
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_Avatar_46377049-b609-44ba-ae82-e931d2ff9953, _, _, _, _)
THEN
PROC_StopLoopEffect(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "RelationshipMarker");

IF
DB_Camp_QueuedNight(NIGHT_Gale_LastNightAlive_Avatar_FollowedMystra_f45005bf-c598-4331-8cb8-fe246093f1db, _, _, _, _)
THEN
PROC_StopLoopEffect(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "RelationshipMarker");

IF
FlagSet(MOO_Audience_Event_PassTeleporter_3115b554-2e0e-cbdc-6166-5fa7586cae45, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_StopLoopEffect(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "RelationshipMarker");

IF
FlagSet(SCE_Epilogue_State_HasStarted_9b4bae0b-6464-4b0e-a0e3-41201c0c3c9e, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
PROC_StopLoopEffect(S_GLO_Gale_Tressym_ada7ee81-829d-48c7-ba73-9c9ec191d236, "RelationshipMarker");

IF
FlagSet(ORI_Gale_Event_BombDisarmed_3d014e79-5595-9365-87bb-5cbb1f87fe5c, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
DB_ORI_Gale_Companion_AteMagicItemIPRDs_CancelFlag(ORI_Gale_IPRD_Act2End_05706143-82c3-616d-6850-9281f08c9b9f, ORI_Gale_State_SentToFindBook_223470bc-af59-c833-500a-ace86e5cc1df);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act2"
