Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_MOO_NightsongDeath_Positions(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, S_MOO_NSDeathZrellPoint_ff75df90-edac-49f6-9f0f-915f2b2ba135);
DB_MOO_NightsongDeath_Positions(S_MOO_EntranceGuard_001_b302d246-59ff-48ee-8247-0e3bcfd4b38e, S_MOO_NSDeathPositionPoint_001_704e464f-5095-41fe-96af-ada650f47e36);
DB_MOO_NightsongDeath_Positions(S_MOO_EntranceGuard_002_2ab30cea-d3f1-4aa4-8c83-b8b700ef0048, S_MOO_NSDeathPositionPoint_002_fb97e463-a5c4-41d5-9a50-4081740daec4);
DB_MOO_NightsongDeath_Positions(S_MOO_EntranceGhoul_001_c9b6a714-491a-40aa-b5b6-3fe608a4efb5, S_MOO_NSDeathPositionPoint_003_ce918830-0812-4f08-b398-951c5325a72d);
DB_MOO_NightsongDeath_Positions(S_MOO_EntranceGhoul_002_2e7447e5-35dd-4cdd-8426-43a6afe0edc7, S_MOO_NSDeathPositionPoint_004_b2472290-39bb-4db0-a086-03edeb8d3bbc);
DB_MOO_NightsongDeath_Positions(S_MOO_EntranceGhoul_003_019af169-5366-4a1f-8392-35df658b2e8e, S_MOO_NSDeathPositionPoint_005_4854821b-6959-471a-a8c0-ceb20428ed7a);
DB_MOO_NightsongDeath_Positions(S_MOO_BazEntranceGuard_002_1a7719bc-9f42-4405-a07d-5d54af11ef0b, S_MOO_NSDeathPositionPoint_006_336460ac-86b2-4ce4-8b0c-245beada2d39);
DB_MOO_NightsongDeath_Positions(S_MOO_BazEntranceGuard_001_8fdd2eba-9e1e-48b6-a201-787616541dd9, S_MOO_NSDeathPositionPoint_007_4f1780d4-1061-495d-9c50-8fe8aeb67cf1);
DB_MOO_NightsongDeath_Positions(S_MOO_BazaarGuard_000_1d5cdba7-f2e4-4568-9bb8-94abcf9081d6, S_MOO_NSDeathPositionPoint_008_e71ee06b-a02f-4c72-8831-2c8712d087ad);
DB_MOO_NightsongDeath_Positions(S_MOO_BazaarGuard_001_8843e9dc-b0dc-4c64-991f-7f512dd12dc0, S_MOO_NSDeathPositionPoint_009_3c504581-d109-452e-b232-8b02e6c99df2);
DB_MOO_NightsongDeath_Positions(S_MOO_AccessCultist_7f0f8d11-9d1e-4210-bbcb-41aa05666d58, S_MOO_NSDeathPositionPoint_010_7bdc914b-aa27-4066-be9a-e118a9f1e1dc);
DB_MOO_NightsongDeath_Positions(S_MOO_AudienceGuard_002_50eed113-2a6a-469d-ba8e-a9fd44be681b, S_MOO_NSDeathPositionPoint_011_b4972c23-7b1a-4533-9c87-6fbccdfad468);
DB_MOO_NightsongDeath_Positions(S_MOO_AudienceGuard_001_f986110c-7451-417a-89e2-b2628e200c4d, S_MOO_NSDeathPositionPoint_012_670a672c-092a-461a-bc2c-10533d046900);
DB_MOO_NightsongDeath_Positions(S_MOO_AudienceGuard_003_c9c185bb-ca0d-46b7-b0da-bf6364a96e15, S_MOO_NSDeathPositionPoint_013_37f09999-02b2-492b-8347-63e6ea285bc3);
DB_NightsongDeath_OffStage(S_GOB_Quartermaster_646936f3-8d8d-484e-9361-cd1ed484c615);
DB_NightsongDeath_OffStage(S_GOB_ZhentarimGuard_Ranger_01_4b9818fa-cca6-4bad-b382-4c01334ef22a);
DB_NightsongDeath_OffStage(S_GOB_ZhentarimGuard_Ranger_02_afc5350d-dc9f-4808-b6ce-d7b1bb7c8229);
DB_NightsongDeath_OffStage(S_MOO_InfernalVendor_511c9413-25fe-449c-a81d-4b09bc20745a);
DB_NightsongDeath_OffStage(S_MOO_BazaarStander_007_f152d3c1-fe32-403f-9d7f-2f1049912e0f);
DB_NightsongDeath_OffStage(S_MOO_BazaarStander_006_5e4c22f4-1122-4822-bc16-ba49d3cb701e);
DB_NightsongDeath_OffStage(S_MOO_BazaarStander_005_c31c6739-c991-490e-9857-2a3367042727);
DB_NightsongDeath_OffStage(S_MOO_BazaarStander_004_a6211285-d412-42c5-8c1c-ffe7feca2e09);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_EntranceGuard_001_b302d246-59ff-48ee-8247-0e3bcfd4b38e);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_EntranceGuard_002_2ab30cea-d3f1-4aa4-8c83-b8b700ef0048);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_EntranceGhoul_001_c9b6a714-491a-40aa-b5b6-3fe608a4efb5);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_EntranceGhoul_002_2e7447e5-35dd-4cdd-8426-43a6afe0edc7);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_EntranceGhoul_003_019af169-5366-4a1f-8392-35df658b2e8e);
DB_MOO_NightsongDeath_ZrellEntranceGroup(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84);
DB_MOO_NightsongDeath_NeutralCharacters(NULL_00000000-0000-0000-0000-000000000000);
NOT DB_MOO_NightsongDeath_NeutralCharacters(NULL_00000000-0000-0000-0000-000000000000);
DB_MOO_NightsongDeath_DaisyADTriggers(S_MOO_DaisyADWarningBox_001_1f452dfa-b490-45eb-9baf-2d4f3523090a);
DB_MOO_NightsongDeath_DaisyADTriggers(S_MOO_DaisyADWarningBox_002_cc3f6f71-d929-4af6-affb-d194c5c8c046);

KBSECTION
IF
TextEvent("moonightsongdeath_alive", _, _, _, _)
THEN
PROC_MOO_NightsongDeath_DEBUG_Setup();

IF
TextEvent("moonightsongdeath_dead", _, _, _, _)
THEN
PROC_MOO_NightsongDeath_DEBUG_Setup();
Die(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0);
PROC_State_Progress(S_HAV_Haven_SUB_6ac001f4-9c56-4a1b-963d-a509e158ffab, "HAV_Mood", "HAV_Mood_State_Siege");
PROC_MOO_NightsongDeath_DEBUG_Setup();

IF
TextEvent("moonightsongdeath_tadpole", _, _, _, _)
THEN
PROC_State_Progress(S_GLO_Isobel_263bfbfc-6160-46f4-a9e1-1089cdb5c211, "HAV_Isobel", "HAV_Isobel_State_AtMoonrise");
PROC_MOO_ZrellBriefing_SetupFlamingSpy();
SysCompleteGoal("Act2_HAV_TakingIsobel_FlamingSpy");
PROC_MOO_NightsongDeath_DEBUG_Setup();

PROC
PROC_MOO_NightsongDeath_DEBUG_Setup()
AND
GetHostCharacter(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, S_MOO_TowerExterior_Waypoint_Pos_8fd66a2b-7b29-44f9-b6dd-cd957c91d19c);
PROC_MOO_Execution_ForceResolve();
PROC_SceneOver("SHA_NightsongPrison_MeetingNightsong");
PROC_SHA_Nightsong_PermaKill(_Var1);
Die(S_SHA_Nightsong_6c55edb0-901b-4ba4-b9e8-3475a8392d9b, 0, NULL_00000000-0000-0000-0000-000000000000, 0, 1, 0);
SetFlag(SHA_Nightsong_State_PermaDefeated_d02e8ea4-dec7-4824-8117-efc075dee4ba);
SetFlag(SHA_NightsongPrison_State_NightsongFateDecided_4a61bbda-83ef-2738-e366-d3d3a4fa75e3);
SetFlag(SHA_NightsongPrison_State_ShadowheartKilledNightsong_3cac3cd6-4c16-44a6-8246-a91922821169);

PROC
PROC_State_Changed(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_Assault", _, _)
THEN
GoalCompleted;

IF
FlagSet(MOO_Necromancer_State_AtMoonrise_f64507bf-aa53-6de9-0b59-c19d649bb0a5, _, _, (GUIDSTRING)_, (GUIDSTRING)_)
THEN
GoalCompleted;

PROC
PROC_State_Changed(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath", _, _)
THEN
PROC_SpotPlayers_StopSpotting(S_MOO_RoofCultist_ebfd7bc7-0fd5-4dee-8fd5-308ded4d0a65, "MOO_Audience_GreetingAD");
PROC_MOO_NightsongDeath_AddDriderCaravan();
PROC_MOO_Assault_ForceResolveFlamingSpy();
PROC_MOO_Execution_ForceResolve();
PROC_TWN_MarchingArmy_RemoveArmyArrest();
DB_DangerZone(S_MOO_DangerZoneTrigger_31e89040-1673-46df-b12c-227f1714475a, "MOO_Assault_DangerZone");
DB_DangerZone(S_MOO_Prison_SUB_b262cbea-f40c-47da-9f34-ba8ce5bf782b, "MOO_Assault_DangerZone");
PROC_SetRelationToPlayers(ACT2_MOO_Absolute_6b0751e2-fbd4-45e1-92ac-d5edb31649d8, 0);
Close(S_MOO_MainTowerEntrance_c9007d4d-8dfe-4b1a-a8cd-7b489710d29e);
PROC_MOO_NightsongDeath_CheckSetupZrell();
PROC_MOO_NightsongDeath_SetTower();
PROC_MOO_NightsongDeath_SetRoofTop();

PROC
PROC_MOO_NightsongDeath_AddDriderCaravan()
AND
DB_SCL_Drider_CaravanMemberInTower(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 != S_SCL_Drider_aa59ce01-3d2e-42e8-a539-c07e0ea292ab
AND NOT
DB_MOO_NightsongDeath_Positions(_Var1, _, _Var1, _Var1, _Var1)
THEN
DB_NightsongDeath_OffStage(_Var1);

PROC
PROC_MOO_NightsongDeath_CheckSetupZrell()
AND NOT
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
AND
QRY_MOO_NightsongDeath_ZrellWillTalk()
THEN
DB_SpotPlayers(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MOO_NightsongDeath_ZrellGreeting", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_SpotTrigger(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MOO_NightsongDeath_ZrellGreeting", S_MOO_NSDeathZrellGreetingBox_01bb6c46-f8d3-428c-a03c-eea0d2fbb26a);

PROC
PROC_MOO_NightsongDeath_CheckSetupZrell()
AND NOT
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
THEN
ApplyStatus(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MIRROR_IMAGE_3", -1, 1, S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84);
ApplyStatus(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MIRROR_IMAGE_2", -1, 1, S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84);
ApplyStatus(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MIRROR_IMAGE_1", -1, 1, S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84);

PROC
PROC_MOO_NightsongDeath_CheckSetupZrell()
AND
DB_Defeated(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _, _, _, _)
AND
DB_MOO_NightsongDeath_Positions(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_MOO_NightsongDeath_Positions(_Var1, _Var2);
NOT DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var1);

PROC
PROC_MOO_NightsongDeath_SetTower()
AND
DB_MOO_NightsongDeath_Positions(_Var1, _Var2, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_MOO_NightsongDeath_SetPositions(_Var1, _Var2);

PROC
PROC_MOO_NightsongDeath_SetTower()
AND
DB_NightsongDeath_OffStage(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetOnStage(_Var1, 0);
NOT DB_NightsongDeath_OffStage(_Var1);

PROC
PROC_MOO_NightsongDeath_SetTower()
AND
DB_MOO_NightsongDeath_NeutralCharacters(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFaction(_Var1, ACT2_MOO_Assault_Neutral_495e3f88-4e4d-47b0-b275-5daf3442430b);

PROC
PROC_MOO_NightsongDeath_SetTower()
AND
DB_MOO_NightsongDeath_DaisyADTriggers(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_TriggerRegisterForPlayers(_Var1);

PROC
PROC_MOO_NightsongDeath_SetRoofTop()
AND
DB_MOO_AssaultPositions(_Var1, _Var2, "MOO_Assault_RooftopEnemies", _Var1, _Var1)
AND NOT
DB_PermaDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetOnStage(_Var1, 1);
PROC_MOO_NightsongDeath_SetPositions(_Var1, _Var2);
SetFaction(_Var1, ACT2_MOO_Assault_Neutral_495e3f88-4e4d-47b0-b275-5daf3442430b);
SetCombatGroupID(_Var1, "MOO_Assault_RooftopEnemies");

PROC
PROC_MOO_NightsongDeath_SetPositions((CHARACTER)_Var1, (TRIGGER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
SetOnStage(_Var1, 1);
PurgeOsirisQueue(_Var1);
TeleportTo(_Var1, _Var2);
LookFromTrigger(_Var1, _Var2, 0);
PROC_MOO_NightsongDeath_UpdateIdlePoint(_Var1, _Var2);
PROC_MOO_NightsongDeath_SetZrellGroup(_Var1);

PROC
PROC_MOO_NightsongDeath_SetPositions(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, _, (TRIGGER)_, (TRIGGER)_, (TRIGGER)_)
THEN
ApplyStatus(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "HAV_FLAMINGSPYDISGUISE", -1, 0, NULL_00000000-0000-0000-0000-000000000000);
AddSpell(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "Target_HAV_TakingIsobel_SearingSmite_Marcus", 0, 0);
AddSpell(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "Shout_HAV_FlamingSpy_VampiricShout", 0, 0);
AddSpell(S_HAV_FlamingSpy_acb1dd9e-952b-4281-8e30-ec6f671493a6, "Projectile_HAV_TakingIsobel_Fly_Marcus", 0, 0);

PROC
PROC_MOO_NightsongDeath_UpdateIdlePoint((CHARACTER)_Var1, (TRIGGER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
SetDualEntityEvent(_Var1, _Var2, "MOO_Assault_IdlePointChange", 1);

PROC
PROC_MOO_NightsongDeath_SetZrellGroup((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_MOO_NightsongDeath_ZrellWillTalk()
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Defeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFaction(_Var1, ACT2_MOO_Assault_Neutral_495e3f88-4e4d-47b0-b275-5daf3442430b);
SetCombatGroupID(_Var1, "MOO_NightsongDeath_ZrellEntrance");

PROC
PROC_MOO_NightsongDeath_SetZrellGroup((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
QRY_MOO_NightsongDeath_ZrellWillTalk()
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_Defeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
SetFaction(_Var1, ACT2_MOO_Assault_Hostile_68597716-e217-4777-a391-026263f291b4);
SetCombatGroupID(_Var1, "MOO_NightsongDeath_ZrellEntrance");

QRY
QRY_MOO_NightsongDeath_ZrellWillTalk()
AND
DB_GlobalFlag(MOO_Execution_Knows_Executioner_53052e40-df9b-90a0-ad65-f2c06f996666, _, _, _, _)
AND NOT
DB_GlobalFlag(MOO_MoonriseTower_State_Outcast_93565546-9052-4776-8563-2a1aca8d899e, _, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_SpotPlayers_Spotted(S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, "MOO_NightsongDeath_ZrellGreeting", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
QRY_StartDialog(MOO_Assault_Executioner_d85920d4-073a-ccf2-68dd-c50697b2d1ad, S_MOO_Executioner_8e75eb3b-7551-485e-8f98-2bf2e51d3e84, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
DialogEnded(MOO_Assault_Executioner_d85920d4-073a-ccf2-68dd-c50697b2d1ad, _, _, _, _)
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var2, _, _, _, _)
THEN
SetFaction(_Var2, ACT2_MOO_Assault_Hostile_68597716-e217-4777-a391-026263f291b4);

IF
EnteredCombat((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
GetFaction(_Var1, ACT2_MOO_Assault_Neutral_495e3f88-4e4d-47b0-b275-5daf3442430b, _Var1, _Var1, _Var1)
THEN
SetFaction(_Var1, ACT2_MOO_Assault_Hostile_68597716-e217-4777-a391-026263f291b4);

IF
EnteredTrigger((CHARACTER)_Var1, (TRIGGER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_State_Current(S_MOO_MoonriseTower_SUB_14187ad9-cf83-44f9-81bf-bb46cb4cd8e6, "MOO", "MOO_State_NightsongDeath", _Var1, _Var1)
AND
DB_PartyMembers(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_MOO_InsideMoonriseTowerTriggers(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_MOO_NightsongDeath_ZrellEntranceGroup(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
GetFaction(_Var3, ACT2_MOO_Assault_Neutral_495e3f88-4e4d-47b0-b275-5daf3442430b, _Var1, _Var1, _Var1)
THEN
SetFaction(_Var3, ACT2_MOO_Assault_Hostile_68597716-e217-4777-a391-026263f291b4);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act2"
