Version 1
SubGoalCombiner SGC_AND

INITSECTION
DB_SHA_Trials_LightTrialDoors(S_SHA_LightTial_InteriorDoor_000_3905aa99-03c9-423a-b998-eb4252eec300);
DB_SHA_Trials_LightTrialDoors(S_SHA_LightTial_InteriorDoor_001_32b1b747-cfbb-495d-8f50-2adc2cd3f851);
DB_SHA_Trials_LightTrialDoors(S_SHA_LightTial_InteriorDoor_002_5073dc5d-7037-4913-a8ac-17c934be0b84);
DB_SHA_Trials_LightTrialDoors(S_SHA_LightTial_InteriorDoor_003_c52299f5-e91e-42f8-896c-5be6f5c774f4);
DB_SHA_Trials_LightTrialShadow(S_SHA_LightTrial_Shadow_000_fb9095d7-e399-4cdb-b90a-e4dba3451882);
DB_SHA_Trials_LightTrialShadow(S_SHA_LightTrial_Shadow_001_f4ef2c8e-02fd-4382-a395-4bebc674881d);
PROC_TriggerRegisterForParty(S_SHA_LightTrial_MazeArea_44bbe72b-6eb4-41db-a093-04bcc9194f7b);
PROC_Poof(S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, VFX_Script_SCL_Trial_Shar_Teleport_Disappear_BodyFX_01_0f13f03e-107a-22af-ef1f-5a7a8967d5b9);
DB_SHA_Trials_LightTrialSecretDoors_Open(-1);
DB_SHA_Trials_LightTrialSecretDoors(S_SHA_LightTrial_SecretDoor_000_80e08f57-9619-4c30-9c52-e75020262ad4, S_SHA_LightTrial_SecretDoor_000_Start_19ecc426-cf83-4eec-bf81-930eaef1b430, S_SHA_LightTrial_SecretDoor_000_End_3df8ffc2-914d-4aa5-8da2-b919d4dedbf6, 0);
DB_SHA_Trials_LightTrialSecretDoors(S_SHA_LightTrial_SecretDoor_001_df4c4827-5127-43cb-9f15-87631279441b, S_SHA_LightTrial_SecretDoor_001_Start_6e07ac4c-64ef-4b7a-927e-4c50471a00b1, S_SHA_LightTrial_SecretDoor_001_End_f5ae0740-b060-4f39-8d25-568961b22967, 0);
SetOnStage(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, 0);
DB_SHA_Trials_MirrorCharacters(S_SHA_PlayerMirrorCharacter_000_9b6e66e8-3832-4bbf-b714-ffc2b0d7a911, S_SHA_PlayerMirrorCharacter_000_StartPos_2de7aa25-cfec-4a63-b7d6-62bdb52f5c40);
DB_SHA_Trials_MirrorCharacters(S_SHA_PlayerMirrorCharacter_001_6b8c8710-2e62-4cb2-b4cb-93710d1b65eb, S_SHA_PlayerMirrorCharacter_001_StartPos_e42fa9ab-b3c8-4ecb-9e85-915c33a9f48b);
DB_SHA_Trials_MirrorCharacters(S_SHA_PlayerMirrorCharacter_002_c2165721-f927-4a5c-a0a5-71c12b8b640f, S_SHA_PlayerMirrorCharacter_002_StartPos_f752361e-ba42-481e-8ead-08655d0787a7);
DB_SHA_Trials_MirrorCharacters(S_SHA_PlayerMirrorCharacter_003_31c2dc34-ec63-4ecc-97f7-fdc0cf86a18a, S_SHA_PlayerMirrorCharacter_003_StartPos_ad8c9fc3-dad6-4150-b7ef-d38bcb858566);
PROC_SHA_Trials_InitMirrorCharacters();
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform0_ThreeTriesLeft_a9941c61-327d-4c5e-8cab-c80f500fcab2, 3);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform1_ThreeTriesLeft_089e2736-3487-4474-9660-ea2b2981d5bf, 3);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform2_ThreeTriesLeft_957ea83c-f968-499f-8811-ab5413b8156c, 3);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform3_ThreeTriesLeft_e5d81128-c241-4af5-9cb1-889645e5fcf0, 3);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform0_TwoTriesLeft_42a3aa6c-a4b3-40f5-8b5b-9153991691bb, 2);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform1_TwoTriesLeft_a48255cf-1300-4c2f-9c28-d028bd940b93, 2);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform2_TwoTriesLeft_9a1d077e-9341-4fce-b828-ae961ff7d6d9, 2);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform3_TwoTriesLeft_5e9f8768-e422-4050-adac-8cabce0a3c8b, 2);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform0_LastTryLeft_19411e95-2005-433b-ad0e-8986f1735a69, 1);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform1_LastTryLeft_805564f9-87d7-4419-b818-6b54417de8a4, 1);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform2_LastTryLeft_610cd35c-5ee2-4ee4-b648-0d4fbfbcd672, 1);
DB_SHA_Trials_InvisiblePlatformsCandles(S_SHA_WarningLight_Platform3_LastTryLeft_eb68ad2a-505e-4be4-8923-40956cebc0e4, 1);
PROC_TriggerRegisterForParty(S_SHA_InvisiblePlatformsTrigger_30c88142-8cc0-4e71-842d-6f64f00a9f5e);
PROC_Poof(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, VFX_Script_SCL_Trial_Shar_Teleport_Disappear_BodyFX_01_0f13f03e-107a-22af-ef1f-5a7a8967d5b9);
DB_SHA_Trials_AltDeathTriggerTeleport(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);
DB_SHA_Trials_PlatformStatue(S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a, S_SHA_VoiceOfShar_Platform0_9bc7ee51-334e-48d5-8581-f0a67bbce472);
DB_SHA_Trials_PlatformStatue(S_SHA_PathOfDarknessTrial_DeathTriggerTP_001_9c2f8c45-a159-4932-ba8e-183d0f3b6ef7, S_SHA_VoiceOfShar_Platform1_8b0c9e96-9a60-49dc-8ba7-c7cf6ac9d9c6);
DB_SHA_Trials_PlatformStatue(S_SHA_PathOfDarknessTrial_DeathTriggerTP_002_791bd805-8200-488d-a97b-ed8de55eb524, S_SHA_VoiceOfShar_Platform3_006a50af-14d6-4d05-b28c-8756993cd846);
DB_SHA_Trials_TriesLeftWarning(3, SHA_Trials_PAD_PathOfDarknessFirstWarning_2d731f84-0806-8bbb-c95b-43b91e854741);
DB_SHA_Trials_TriesLeftWarning(2, SHA_Trials_PAD_PathOfDarknessSecondWarning_52afc0ef-f2f5-09a9-2b4d-38dd295d31d4);

KBSECTION
IF
TextEvent("SHA_Teleport_Trials", (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, S_SHA_Trials_OETeleportTo_eb5197fb-423b-4dea-80a8-69cc2433ce19);

IF
DualEntityEvent(_, _, "SHA_StopDoublesEncounterTrial", _, _)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, 1, _, _)
THEN
SetFlag(SHA_Trials_Event_TrialFailed_e80850ea-ab84-4043-9809-960d4db885f6, S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe);

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, (INTEGER)_, (INTEGER)_)
THEN
DB_AmbushTrigger(S_SHA_CloneAmbushTrigger_76fe7265-7cc8-4022-b990-397f86713cb7, S_SHA_CloneAmbushPerceptionTrigger_8e358cd2-34e5-4620-9cfe-33e3f4746d78, HiddenPerception_Medium_cd1800ab-1b11-4c7a-9f50-fdeb8d35481f);

IF
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
DB_DoNotRemoveKnockedOutCharacterOnLongRest(_Var1);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, _Var2);
PROC_SHA_Trials_ResetCharacter(_Var1);

PROC
PROC_SHA_Trials_ResetCharacter((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Dead(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
Resurrect(_Var1);

PROC
PROC_SHA_Trials_ResetCharacter((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
RemoveStatusesWithGroup(_Var1, "SG_Unconscious");
SetHitpointsPercentage(_Var1, 100);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_Pairs(_Var1, _, _Var1, _Var1, _Var1)
THEN
RemoveStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER");

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_Pairs(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_MirrorEncounter_Pairs(_Var1, _Var2);

PROC
PROC_SHA_Trials_InitMirrorCharacters()
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
TeleportTo(_Var1, _Var2);
PROC_CharacterDisableAllCrimes(_Var1);
SetOnStage(_Var1, 0);

PROC
PROC_SHA_Trials_MirrorCharactersAppear()
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_PartyMembersInTrialRooms(_Var3, S_SHA_MentalTortureTrigger_e272b659-024a-457d-a5f5-a9317d60e1eb, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_MirrorEncounter_Pairs(_Var1, _, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_MirrorEncounter_Pairs(_, _Var3, _Var1, _Var1, _Var1)
THEN
DB_SHA_MirrorEncounter_Pairs(_Var1, _Var3);
PROC_SHA_Trials_ClearClassTags(_Var1);
PROC_SHA_Trials_ApplyClassTags(_Var1, _Var3);
Transform(_Var1, _Var3, Disguise_ceccc4eb-d774-4cd5-9147-12322b81b763);
CopyCharacterEquipment(_Var1, _Var3);
DB_GLO_DefeatCounter(_Var1, "SHA_TrialDoubles");
DB_GLO_DefeatCounter(_Var3, "SHA_TrialPlayers");
DB_AmbushTrigger_Ambusher(S_SHA_CloneAmbushTrigger_76fe7265-7cc8-4022-b990-397f86713cb7, _Var1, 1);
PROC_Foop(_Var1);

QRY
QRY_BlockPickpocket(_, (CHARACTER)_Var2, _, _, _)
AND
DB_SHA_Trials_MirrorCharacters(_Var2, _, _, _, _)
THEN
DB_NOOP(1);

PROC
PROC_SHA_Trials_ApplyClassTags((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_ClassTags(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
IsTagged(_Var2, _Var3, 1, _Var1, _Var1)
THEN
SetTag(_Var1, _Var3);
DB_SHA_Trials_DoublesAppliedTags(_Var1, _Var3);

PROC
PROC_SHA_Trials_ApplyClassTags((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_SHA_Trials_HasGodTags(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_GodClassAlignTags(_Var3, _Var4, _Var5, _Var6, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var3, _Var1, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var4, _Var1, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var5, _Var1, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var6, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_SHA_Trials_ApplyClassTags((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
QRY_SHA_Trials_HasGodTags(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
DB_AlignClassTags(_Var3, _Var4, _Var5, _Var1, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var4, _Var1, _Var1)
AND
QRY_SHA_Trials_TryApplyTag(_Var1, _Var2, _Var5, _Var1, _Var1)
THEN
DB_NOOP(1);

QRY
QRY_SHA_Trials_TryApplyTag((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var3, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_NOOP(1);

QRY
QRY_SHA_Trials_TryApplyTag((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, (GUIDSTRING)_Var3, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
IsTagged(_Var2, _Var3, 1, _Var1, _Var1)
THEN
SetTag(_Var1, _Var3);
DB_SHA_Trials_DoublesAppliedTags(_Var1, _Var3);

QRY
QRY_SHA_Trials_HasGodTags((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_ClassHasGodTags(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
IsTagged(_Var1, _Var2, 1, _Var1, _Var1)
THEN
DB_NOOP(1);

IF
AddedTo((GUIDSTRING)_Var1, (GUIDSTRING)_Var2, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var2, _, _Var1, _Var1, _Var1)
AND
IsItem(_Var1, 1, _Var1, _Var1, _Var1)
THEN
DB_SHA_Trials_ItemsToRemove(_Var2, _Var1);

PROC
PROC_SHA_Trials_ClearClassTags((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_ItemsToRemove(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
IsDestroyed(_Var2, 0, _Var1, _Var1, _Var1)
AND
Exists(_Var2, 1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_ItemsToRemove(_Var1, _Var2);
RequestDelete(_Var2);

PROC
PROC_SHA_Trials_ClearClassTags((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_DoublesAppliedTags(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_DoublesAppliedTags(_Var1, _Var2);
ClearTag(_Var1, _Var2);

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, (INTEGER)_, (INTEGER)_)
THEN
PROC_ItemUnlockAndOpen(S_SHA_MentalTortureCellDoor_f6d12215-6e1f-49de-9fa9-be50a549e6e7);
PROC_SHA_Trials_ClearDefeatCounter("SHA_TrialDoubles", SHA_Trials_Event_ClonesWinCombat_150017e2-0ee4-43d5-88a7-fef1baab8366);
PROC_SHA_Trials_ClearDefeatCounter("SHA_TrialPlayers", SHA_Trials_Event_PlayersWinCombat_dea864a4-3c94-4315-8b02-c2f813cd57d2);
PROC_SHA_Trials_MirrorCharactersAppear();

PROC
PROC_SHA_Trials_ClearDefeatCounter((STRING)_Var1, (FLAG)_Var2, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
AND
DB_GLO_DefeatCounter(_Var3, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_GLO_DefeatCounter(_Var3, _Var1);

PROC
PROC_SHA_Trials_ClearDefeatCounter((STRING)_Var1, (FLAG)_Var2, (STRING)_Var1, (STRING)_Var1, (STRING)_Var1)
THEN
ClearFlag(_Var2, NULL_00000000-0000-0000-0000-000000000000);

PROC
PROC_GLO_DefeatCounter_AllDefeated("SHA_TrialDoubles", _, _, _, _)
THEN
SetFlag(SHA_Trials_Event_PlayersWinCombat_dea864a4-3c94-4315-8b02-c2f813cd57d2, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe);

PROC
PROC_GLO_DefeatCounter_AllDefeated("SHA_TrialPlayers", _, _, _, _)
THEN
SetFlag(SHA_Trials_Event_ClonesWinCombat_150017e2-0ee4-43d5-88a7-fef1baab8366, NULL_00000000-0000-0000-0000-000000000000);
PROC_SHA_Trials_TrialFailed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe);

IF
CharacterDisarmed((CHARACTER)_Var1, (ITEM)_Var2, _, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_Poof(_Var2);

IF
DroppedBy((CHARACTER)_Var1, (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
AND
_Var2 != MAG_Critical_CriticalExecution_Ring_c8e43fcf-b374-7e55-2ef4-a5397d0e7e4b
THEN
PROC_Poof(_Var2);

PROC
PROC_StateSet_Defeated((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_Poof(_Var1);

PROC
PROC_SHA_Trials_CustomTrialOutcome(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_Pairs(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
PROC_Poof(_Var1);

IF
ShapeshiftChanged((CHARACTER)_Var1, _, _, _, (CHARACTER)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
DB_NOOP(1);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
THEN
PROC_SHA_Trials_ActivateTeleportStone(S_SHA_MentalTortureTrial_Goal_d2476415-7639-480e-b7da-7afa8c71e4b6);

IF
UseStarted((GUIDSTRING)_Var1, S_SHA_MentalTortureTrial_Goal_d2476415-7639-480e-b7da-7afa8c71e4b6, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_SHA_Trials_MagicTeleport(_Var1, S_SHA_MentalTortureTrial_Start_e7437490-85e3-42fb-b5db-30c1e1b18532, S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe);

PROC
PROC_SHA_Trials_InitMirrorCharacters()
THEN
DB_SHA_MirrorEncounter_ClassData(BARBARIAN_02913f9a-f696-40cf-acdf-32032afab32c, "SHA_TortureTrial_Barbarian", "SHA_TORTURETRIAL_DOUBLE_BARBARIAN");
DB_SHA_MirrorEncounter_ClassData(BARD_d93434bd-6b71-4789-b128-ee24156057cc, "SHA_TortureTrial_Bard", "SHA_TORTURETRIAL_DOUBLE_BARD");
DB_SHA_MirrorEncounter_ClassData(CLERIC_1671b4bf-4f47-4bb7-9cb9-80bb1f6009d5, "SHA_TortureTrial_Cleric", "SHA_TORTURETRIAL_DOUBLE_CLERIC");
DB_SHA_MirrorEncounter_ClassData(DRUID_44ac4317-4d38-4d28-80e2-94024c6e42f0, "SHA_TortureTrial_Druid", "SHA_TORTURETRIAL_DOUBLE_DRUID");
DB_SHA_MirrorEncounter_ClassData(FIGHTER_1ae7017c-4884-4a43-bc4a-742fa0d201c0, "SHA_TortureTrial_Fighter", "SHA_TORTURETRIAL_DOUBLE_FIGHTER");
DB_SHA_MirrorEncounter_ClassData(PALADIN_6d85ab2d-5c23-498c-a61e-98f05a00177a, "SHA_TortureTrial_Paladin", "SHA_TORTURETRIAL_DOUBLE_PALADIN");
DB_SHA_MirrorEncounter_ClassData(MONK_e1e460bb-d0ae-4452-8529-c9e176558731, "SHA_TortureTrial_Monk", "SHA_TORTURETRIAL_DOUBLE_MONK");
DB_SHA_MirrorEncounter_ClassData(RANGER_37a733c1-a862-4157-b92a-9cff46232c6a, "SHA_TortureTrial_Ranger", "SHA_TORTURETRIAL_DOUBLE_RANGER");
DB_SHA_MirrorEncounter_ClassData(ROGUE_f8a0608b-666c-4be6-a49c-03b369c10bd2, "SHA_TortureTrial_Rogue", "SHA_TORTURETRIAL_DOUBLE_ROGUE");
DB_SHA_MirrorEncounter_ClassData(SORCERER_18266c0b-efbc-4c80-8784-ada4a37218d7, "SHA_TortureTrial_Sorcerer", "SHA_TORTURETRIAL_DOUBLE_SORCERER");
DB_SHA_MirrorEncounter_ClassData(WARLOCK_5804f55a-93f7-4281-9512-8d548a9e2a22, "SHA_TortureTrial_Warlock", "SHA_TORTURETRIAL_DOUBLE_WARLOCK");
DB_SHA_MirrorEncounter_ClassData(WIZARD_6fe3ae27-dc6c-4fc9-9245-710c790c396c, "SHA_TortureTrial_Wizard", "SHA_TORTURETRIAL_DOUBLE_WIZARD");

PROC
PROC_SHA_Trials_ApplyClassTags((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_ClassData(_Var3, _Var4, _Var5, _Var1, _Var1)
AND
IsTagged(_Var2, _Var3, 1, _Var1, _Var1)
THEN
PROC_SHA_MirrorEncounter_ApplyClassStatus(_Var1, _Var5);
PROC_SHA_MirrorEncounter_AddClassSpells(_Var1, _Var4, 1);

PROC
PROC_SHA_MirrorEncounter_ApplyClassStatus((CHARACTER)_Var1, (STRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
ApplyStatus(_Var1, _Var2, -1, 1);

PROC
PROC_SHA_MirrorEncounter_AddClassSpells((CHARACTER)_Var1, (STRING)_Var2, (INTEGER)_Var3, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
GetSpellFromSet(_Var2, _Var3, _Var4, _Var1, _Var1)
AND
IntegerSum(_Var3, 1, _Var5, _Var1, _Var1)
THEN
PROC_SHA_MirrorEncounter_AddSpell(_Var1, _Var4);
PROC_SHA_MirrorEncounter_AddClassSpells(_Var1, _Var2, _Var5);

PROC
PROC_SHA_MirrorEncounter_AddSpell((CHARACTER)_Var1, (STRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
HasSpell(_Var1, _Var2, 0, _Var1, _Var1)
THEN
AddSpell(_Var1, _Var2, 0);
DB_SHA_MirrorEncounter_AddedSpells(_Var1, _Var2);

PROC
PROC_SHA_Trials_ClearClassTags((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_ClassData(_, _, _Var4, _Var1, _Var1)
THEN
RemoveStatus(_Var1, _Var4);

PROC
PROC_SHA_Trials_ClearClassTags((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_MirrorEncounter_AddedSpells(_Var1, _Var2, _Var1, _Var1, _Var1)
THEN
RemoveSpell(_Var1, _Var2);
NOT DB_SHA_MirrorEncounter_AddedSpells(_Var1, _Var2);

IF
DB_Defeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
PROC_SHA_Trials_UpdateLastCloneToBeDefeated(_Var1);

PROC
PROC_SHA_Trials_UpdateLastCloneToBeDefeated((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_LastCloneToBeDefeated(_Var2);

PROC
PROC_SHA_Trials_UpdateLastCloneToBeDefeated((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
DB_SHA_Trials_LastCloneToBeDefeated(_Var1);

PROC
PROC_StateCleared_Defeated((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_LastCloneToBeDefeated(_Var1);

IF
EnteredChasm((CHARACTER)_Var1, (CHARACTER)_Var2, _, (REAL)_Var4, (REAL)_Var5, (REAL)_Var6, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_MirrorCharacters(_Var1, _, _Var1, _Var1, _Var1)
THEN
DB_SHA_Trials_CloneEnteredChasm(_Var1, _Var2, _Var4, _Var5, _Var6);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND NOT
DB_SHA_Trials_CloneEnteredChasm(_Var1, _, _, _, _)
AND
QRY_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, _Var1, "SHA_ClonesGemAppears");

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _, _, _, _)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_CloneEnteredChasm(_Var1, _Var2, _Var3, _Var4, _Var5)
AND
DB_Players(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, _Var2, "SHA_ClonesGemAppears");

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _, _, _, _)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_CloneEnteredChasm(_Var1, _Var2, _Var3, _Var4, _Var5)
AND
DB_PlayerSummons(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
CharacterGetOwner(_Var2, _Var6, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, _Var6, "SHA_ClonesGemAppears");

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _, _, _, _)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_SHA_MentalTortureTrigger_e272b659-024a-457d-a5f5-a9317d60e1eb, _Var1, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _Var1, _Var1, _Var1, _Var1)
THEN
TeleportTo(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, _Var1, "SHA_ClonesGemAppears");

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _, _, _, _)
AND
DB_SHA_Trials_LastCloneToBeDefeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_CloneEnteredChasm(_Var1, _, _Var3, _Var4, _Var5)
AND
PositionIsInTrigger(_Var3, _Var4, _Var5, S_SHA_MentalTortureTrigger_e272b659-024a-457d-a5f5-a9317d60e1eb, 1)
AND
QRY_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _Var1, _Var1, _Var1, _Var1)
THEN
TeleportToPosition(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, _Var3, _Var4, _Var5, "SHA_ClonesGemAppears", 0);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, _, _, _, _)
AND NOT
DB_OnlyOnce("SHA_CloneCharacterFellIntoChasm", _, _, _, _)
THEN
TeleportTo(S_SHA_TrialGem_001_3c29b3b3-65ec-4d47-b689-e5eca053602b, S_SHA_TrialGem_001_FallbackPos_d54d8bb6-1e1b-440a-83cf-aec48974142a, "SHA_ClonesGemAppears");

IF
EntityEvent((GUIDSTRING)_Var1, "SHA_ClonesGemAppears", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_Foop(_Var1);

IF
EntityEvent((GUIDSTRING)_Var1, "SHA_ClonesGemAppears", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_CloneEnteredChasm(_Var2, _Var3, _Var4, _Var5, _Var6)
THEN
NOT DB_SHA_Trials_CloneEnteredChasm(_Var2, _Var3, _Var4, _Var5, _Var6);

PROC
PROC_SHA_Trials_ApplyClassTags((CHARACTER)_Var1, (GUIDSTRING)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
ApplyStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER", -1, 1);
ApplyStatus(_Var2, "SHA_TORTURETRIAL_DOUBLE_TARGET", -1, 1, _Var1);
DB_SHA_Trials_CharactersWithDoubleStatus(_Var1);
DB_SHA_Trials_CharactersWithDoubleStatus(_Var2);

IF
StatusRemoved((GUIDSTRING)_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER", _, _, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_CharactersWithDoubleStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_CharactersWithDoubleStatus(_Var1);

IF
StatusRemoved((GUIDSTRING)_Var1, "SHA_TORTURETRIAL_DOUBLE_TARGET", _, _, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_CharactersWithDoubleStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_CharactersWithDoubleStatus(_Var1);

IF
StatusRemoved((GUIDSTRING)_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER", _, _, (GUIDSTRING)_Var1)
AND
DB_SHA_MirrorEncounter_Pairs(_Var1, _Var4, _Var1, _Var1, _Var1)
THEN
PROC_SHA_Trials_RemoveDoubleStatuses(_Var4);

PROC
PROC_SHA_Trials_RemoveDoubleStatuses((CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
HasAppliedStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER", 1, _Var1, _Var1)
THEN
RemoveStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_OWNER");

PROC
PROC_SHA_Trials_RemoveDoubleStatuses((GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
HasAppliedStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_TARGET", 1, _Var1, _Var1)
THEN
RemoveStatus(_Var1, "SHA_TORTURETRIAL_DOUBLE_TARGET");

PROC
PROC_SHA_Trials_CustomTrialOutcome(S_SHA_MentalTortureTrial_98811843-1086-4931-a3bd-3fef817347fe, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_CharactersWithDoubleStatus(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_Trials_RemoveDoubleStatuses(_Var1);

IF
DB_SHA_Trials_LightTrialShadow(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
DB_SpotPlayers(_Var1, "SHA_LightTrial_Shadow", NULL_00000000-0000-0000-0000-000000000000, NULL_00000000-0000-0000-0000-000000000000);
DB_SpotPlayers_Continuous(_Var1, "SHA_LightTrial_Shadow");
DB_SpotPlayers_SpotTrigger(_Var1, "SHA_LightTrial_Shadow", S_SHA_LightTrial_SpotTrigger_ed62bf09-4f87-4fb7-993a-ced7453ebe77);
DB_SpotPlayers_SpotterIgnoreCantTalk(_Var1, "SHA_LightTrial_Shadow");
DB_SpotPlayers_IncludeWildshapedPlayers(_Var1, "SHA_LightTrial_Shadow");
DB_SpotPlayers_IncludeSummons(_Var1, "SHA_LightTrial_Shadow");
DB_SpotPlayers_IncludeInconspicuous(_Var1, "SHA_LightTrial_Shadow");
DB_SpotPlayers_IncludeFollowers(_Var1, "SHA_LightTrial_Shadow");
SetCanJoinCombat(_Var1, 0);
SetOnStage(_Var1, 0);
TriggerRegisterForCharacter(S_SHA_LightTrial_SecretRoom_335cae58-3416-41c0-874d-78b16f6bcb45, _Var1);
PROC_CharacterDisableAllCrimes(_Var1);
DB_IgnoreAssault(_Var1);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, _, _, _, _)
THEN
PROC_SHA_Trials_LockAndCloseLighTrialDoors();

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_LightTrialShadow(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_Trials_ResetCharacter(_Var1);

PROC
PROC_SHA_Trials_LockAndCloseLighTrialDoors()
AND
DB_SHA_Trials_LightTrialDoors(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
Close(_Var1);
Lock(_Var1, "storylock");

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, _, (INTEGER)_, (INTEGER)_)
THEN
PROC_Foop(S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, VFX_Script_SCL_Trial_Shar_Teleport_Appear_BodyFX_01_520e41d0-3515-f40c-1ebc-9b6f899ec782);
PROC_SHA_Trials_UnlockAndOpenLighTrialDoors();
PROC_TriggerRegisterForPlayers(S_SHA_LightTrial_GoalTrigger_1d7b2ec2-f9a4-4739-9f72-532fa7159584);

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, _, _, _)
AND
DB_SHA_Trials_LightTrialShadow(_Var2, _, _, _, _)
THEN
PROC_Foop(_Var2);

IF
AddedTo(S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_GemsNotTaken(S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, 1, _Var1, _Var1)
THEN
SetFlag(SHA_Trials_Event_TrialPassed_a2bf1d24-4f81-4bae-ac3f-68a5760d122c, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429);

PROC
PROC_SHA_Trials_CustomTrialOutcome(S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_SHA_Trials_LightTrialShadow(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_Poof(_Var1);

PROC
PROC_SHA_Trials_CustomTrialOutcome(S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, _, _, _, _)
THEN
PROC_TriggerUnregisterForPlayers(S_SHA_LightTrial_GoalTrigger_1d7b2ec2-f9a4-4739-9f72-532fa7159584);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, _, _, _, _)
THEN
PROC_SHA_Trials_ActivateTeleportStone(S_SHA_LightTrial_GoalStatue_dfddbf3e-7ab8-4b65-bc2c-2e50a6ed2e04);

PROC
PROC_SHA_Trials_UnlockAndOpenLighTrialDoors()
AND
DB_SHA_Trials_LightTrialDoors(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_ItemUnlockAndOpen(_Var1);

PROC
PROC_SpotPlayers_Spotted((CHARACTER)_Var1, "SHA_LightTrial_Shadow", (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND NOT
DB_Defeated(_Var2, _Var1, _Var1, _Var1, _Var1)
THEN
PROC_SHA_Trials_ShadowSpotsPlayer(_Var2, _Var1);

PROC
PROC_SHA_Trials_ShadowSpotsPlayer((CHARACTER)_Var1, (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
QRY_StartDialog(SHA_Trials_AD_LightTrialShadow_fb7d5276-d521-6d02-8d50-0ac8aedf66b1, _Var2, _Var1, _Var1, _Var1)
AND
QRY_OncePerUserAndNearbyPlayers(_Var1, "SHA_Trials_PlayerSpotted", _Var1, _Var1, _Var1)
THEN
DB_SHA_Trials_TeleportedByShadowVB(_Var1);

PROC
PROC_SHA_Trials_ShadowSpotsPlayer((CHARACTER)_Var1, (CHARACTER)_Var2, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
ApplyDamage(_Var1, 1, "Psychic", _Var2);
PROC_SHA_Trials_MagicTeleport(_Var1, S_SHA_LightTrial_Start_1a10d90d-bbe3-49c5-b046-56a7a34fceac, _Var2);

IF
AutomatedDialogEnded(SHA_Trials_AD_LightTrialShadow_fb7d5276-d521-6d02-8d50-0ac8aedf66b1, _, _, _, _)
AND
DB_SHA_Trials_TeleportedByShadowVB(_Var2, _, _, _, _)
AND
QRY_SpeakerIsAvailable(_Var2, _, _, _, _)
AND
QRY_OncePerUserAndNearbyPlayers(_Var2, "SHA_Trials_TeleportedByShadowVB", _, _, _)
THEN
StartVoiceBark(SHA_Trials_VB_TeleportedByShadow_af9826e6-1a85-9dcf-cf3c-d0def81d34fb, _Var2);

IF
AutomatedDialogEnded(SHA_Trials_AD_LightTrialShadow_fb7d5276-d521-6d02-8d50-0ac8aedf66b1, _, _, _, _)
AND
DB_SHA_Trials_TeleportedByShadowVB(_Var2, _, _, _, _)
THEN
NOT DB_SHA_Trials_TeleportedByShadowVB(_Var2);

IF
DualEntityEvent(_, _, "SHA_StopObjectOfDarknessTrial", _, _)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429, 1, _, _)
THEN
PROC_Poof(S_SHA_TrialGem_000_5e3d0d3b-6fcf-48b8-a10c-580ff4efd1ff, VFX_Script_SCL_Trial_Shar_Teleport_Disappear_BodyFX_01_0f13f03e-107a-22af-ef1f-5a7a8967d5b9);
SetFlag(SHA_Trials_Event_TrialFailed_e80850ea-ab84-4043-9809-960d4db885f6, S_SHA_ObjectOfDarknessTrial_3892d0a6-24f4-402e-8b51-03ba8cfb4429);

IF
DualEntityEvent(_, _, "SHA_LightTrial_SwitchSecretDoorsState", _, _)
AND NOT
QRY_SHA_Trials_AnySecretDoorMoving()
THEN
PROC_SHA_Trials_SwitchSecretRoomDoorsInLightTrialState();

PROC
PROC_SHA_Trials_SwitchSecretRoomDoorsInLightTrialState()
AND
DB_SHA_Trials_LightTrialSecretDoors_Open(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
IntegerProduct(_Var1, -1, _Var2, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_LightTrialSecretDoors_Open(_Var1);
DB_SHA_Trials_LightTrialSecretDoors_Open(_Var2);

PROC
PROC_SHA_Trials_SwitchSecretRoomDoorsInLightTrialState()
AND
DB_SHA_Trials_LightTrialSecretDoors_Open(-1, _, _, _, _)
AND
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 0, _Var1)
THEN
NOT DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 0);
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 1);
ItemMoveTo(_Var1, _Var2, 3, 0, 0, "SHA_Trials_SecretDoorMovedToPosition", 1);

PROC
PROC_SHA_Trials_SwitchSecretRoomDoorsInLightTrialState()
AND
DB_SHA_Trials_LightTrialSecretDoors_Open(1, _, _, _, _)
AND
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 0, _Var1)
THEN
NOT DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 0);
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 1);
ItemMoveTo(_Var1, _Var3, 3, 0, 0, "SHA_Trials_SecretDoorMovedToPosition", 1);

IF
EntityEvent((GUIDSTRING)_Var1, "SHA_Trials_SecretDoorMovedToPosition", (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 1, _Var1)
THEN
NOT DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 1);
DB_SHA_Trials_LightTrialSecretDoors(_Var1, _Var2, _Var3, 0);

QRY
QRY_SHA_Trials_AnySecretDoorMoving()
AND
DB_SHA_Trials_LightTrialSecretDoors(_, _, _, 1, _)
THEN
DB_NOOP(1);

IF
DB_SHA_Trials_LightTrialSecretDoors_Open(-1, _, _, _, _)
THEN
SetFlag(SHA_Trials_State_SecretRoomClosed_224e42c9-4a5a-4be1-84dd-119e4929cc3b, NULL_00000000-0000-0000-0000-000000000000);

IF
DB_SHA_Trials_LightTrialSecretDoors_Open(1, _, _, _, _)
THEN
ClearFlag(SHA_Trials_State_SecretRoomClosed_224e42c9-4a5a-4be1-84dd-119e4929cc3b, NULL_00000000-0000-0000-0000-000000000000);

IF
DualEntityEvent(_, _, "SHA_LightTrial_ActivateSecretDoor", _, _)
AND
QRY_OnlyOnce_Reset("SHA_LightTrial_SecretDoorActivated", _, _, _, _)
AND
IsOpened(S_SHA_LightTrial_SecretSlidingWall_8b379499-f6c5-479a-9e2b-2e2b51868dde, 0, _, _, _)
AND
QRY_OnlyOnce("SHA_LightTrial_SecretDoorActivated", _, _, _, _)
THEN
Open(S_SHA_LightTrial_SecretSlidingWall_8b379499-f6c5-479a-9e2b-2e2b51868dde);

IF
DualEntityEvent(_, _, "SHA_LightTrial_ActivateSecretDoor", _, _)
AND
IsOpened(S_SHA_LightTrial_SecretSlidingWall_8b379499-f6c5-479a-9e2b-2e2b51868dde, 1, _, _, _)
AND
QRY_OnlyOnce("SHA_LightTrial_SecretDoorActivated", _, _, _, _)
THEN
Close(S_SHA_LightTrial_SecretSlidingWall_8b379499-f6c5-479a-9e2b-2e2b51868dde);

IF
UseStarted((CHARACTER)_Var1, S_SHA_LightTrial_GoalStatue_dfddbf3e-7ab8-4b65-bc2c-2e50a6ed2e04, (CHARACTER)_Var1, (CHARACTER)_Var1, (CHARACTER)_Var1)
THEN
PROC_SHA_Trials_MagicTeleport(_Var1, S_SHA_LightTrial_Start_1a10d90d-bbe3-49c5-b046-56a7a34fceac, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e);

IF
DualEntityEvent(_, _, "SHA_StopPathOfDarknessTrial", _, _)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, 1, _, _)
THEN
SetFlag(SHA_Trials_Event_TrialFailed_e80850ea-ab84-4043-9809-960d4db885f6, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e);

IF
FlagSet(SHA_Trials_Event_TrialFailed_e80850ea-ab84-4043-9809-960d4db885f6, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _)
AND
DB_SHA_Trials_GemsNotTaken(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, _, _, _, _)
THEN
PROC_Poof(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, VFX_Script_SCL_Trial_Shar_Teleport_Disappear_BodyFX_01_0f13f03e-107a-22af-ef1f-5a7a8967d5b9);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _, _)
AND
DB_SHA_Trials_GemsNotTaken(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, _, _, _, _)
THEN
PROC_Poof(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, VFX_Script_SCL_Trial_Shar_Teleport_Disappear_BodyFX_01_0f13f03e-107a-22af-ef1f-5a7a8967d5b9);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1, (INTEGER)_Var1)
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var1, _Var1, _Var1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_InvisiblePlatformsTries(_Var1);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _, _)
AND
DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 1, _, _)
THEN
NOT DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 1);
DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 0);

PROC
PROC_SHA_Trials_RestartTrial(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _, _)
THEN
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles();

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, (INTEGER)_, (INTEGER)_)
THEN
NOT DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 0);
DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 1);
DB_SHA_Trials_InvisiblePlatformsTries(3);
PROC_Foop(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, VFX_Script_SCL_Trial_Shar_Teleport_Appear_BodyFX_01_520e41d0-3515-f40c-1ebc-9b6f899ec782);
PROC_TriggerRegisterForPlayers(S_SHA_PathOfDarknessTrial_GoalTrigger_b4df1e7b-7d4f-42d2-b599-e1dae0c0d15e);
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles();

IF
DB_Defeated(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_InRegion(_Var1, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, _Var1, _Var1, _Var1)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, 1, _Var1, _Var1)
THEN
PROC_SHA_Trials_UpdateInvisiblePlatformsTries();
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles();

PROC
PROC_SHA_Trials_UpdateInvisiblePlatformsTries()
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
IntegerSubtract(_Var1, 1, _Var2, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_InvisiblePlatformsTries(_Var1);
DB_SHA_Trials_InvisiblePlatformsTries(_Var2);

PROC
PROC_SHA_Trials_UpdateInvisiblePlatformsTries()
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
_Var1 < 1
AND
DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 1, _Var1, _Var1)
THEN
NOT DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 1);
DB_SHA_Trials_TrialRoomTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrigger_d535f17f-7d95-4996-b4f7-2f53c4a7348c, 0);

PROC
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles()
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_InvisiblePlatformsCandles(_Var2, _Var3, _Var1, _Var1, _Var1)
AND
_Var1 >= _Var3
AND NOT
DB_LoopEffect(_Var2, _, "SHA_PathOfDarkness_WarningLight", _, _, _, _, _Var1, _Var1, _Var1)
THEN
PROC_LoopEffect(VFX_Status_DancingLights_DummyFX_01_3ba17bb8-7ee3-cf58-c5a9-9b0488cf96f0, _Var2, "SHA_PathOfDarkness_WarningLight", "SCL_Main_A", "", 0.5);

PROC
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles()
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_InvisiblePlatformsCandles(_Var2, _Var3, _Var1, _Var1, _Var1)
AND
_Var1 < _Var3
AND
DB_LoopEffect(_Var2, _, "SHA_PathOfDarkness_WarningLight", _, _, _, _, _Var1, _Var1, _Var1)
THEN
PROC_StopLoopEffect(_Var2, "SHA_PathOfDarkness_WarningLight");

PROC
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles()
AND NOT
DB_SHA_Trials_InvisiblePlatformsTries(_, _, _, _, _)
AND
DB_SHA_Trials_InvisiblePlatformsCandles(_Var2, _, _, _, _)
AND
DB_LoopEffect(_Var2, _, "SHA_PathOfDarkness_WarningLight", _, _, _, _, _, _, _)
THEN
PROC_StopLoopEffect(_Var2, "SHA_PathOfDarkness_WarningLight");

PROC
PROC_SHA_Trials_CharacterEnteredDeathTrigger_Hook(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (TRIGGER)_Var1, (GUIDSTRING)_Var2, (TRIGGER)_Var1, (TRIGGER)_Var1)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, 1, _Var1, _Var1)
THEN
PROC_SHA_Trials_UpdateInvisiblePlatformsTries();
PROC_SHA_Trials_UpdateInvisiblePlatformsCandles();

QRY
QRY_SHA_Trials_BlockKillCharacter(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, 1, _Var1, _Var1)
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var2, _Var1, _Var1, _Var1, _Var1)
AND
_Var2 > 0
THEN
PROC_SHA_Trials_DeathTriggerTeleport(_Var1);

PROC
PROC_SHA_Trials_MagicTeleport((GUIDSTRING)_Var1, (TRIGGER)_Var2, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_SHA_Trials_DeathTriggers(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _Var2, _Var1, _Var1)
AND
QRY_OnlyOnce("SHA_Trials_TrialWarning", _Var1, _Var1, _Var1, _Var1)
THEN
DB_SHA_Trials_TeleportingTo(_Var2);
TimerLaunch("SHA_Trials_TrialWarningDelay", 2500);

IF
TimerFinished("SHA_Trials_TrialWarningDelay", (TRIGGER)_Var1, (TRIGGER)_Var1, (TRIGGER)_Var1, (TRIGGER)_Var1)
AND
DB_SHA_Trials_TeleportingTo(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_PlatformStatue(_Var1, _Var2, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_InvisiblePlatformsTries(_Var3, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_TriesLeftWarning(_Var3, _Var4, _Var1, _Var1, _Var1)
THEN
NOT DB_OnlyOnce("SHA_Trials_TrialWarning");
NOT DB_SHA_Trials_TeleportingTo(_Var1);
PROC_TryStartAD(_Var4, _Var2);

IF
AddedTo(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, (GUIDSTRING)_Var1, _, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
AND
DB_Players(_Var1, _Var1, _Var1, _Var1, _Var1)
AND
DB_SHA_Trials_GemsNotTaken(S_SHA_TrialGem_002_b8dda6e3-8cb8-4287-81a4-0ac5260859c7, _Var1, _Var1, _Var1, _Var1)
AND
GetFlag(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, 1, _Var1, _Var1)
THEN
SetFlag(SHA_Trials_Event_TrialPassed_a2bf1d24-4f81-4bae-ac3f-68a5760d122c, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _, _)
THEN
PROC_SHA_Trials_ActivateTeleportStone(S_SHA_PathOfDarknessTrial_Goal_26c3ff42-4e78-4e4c-a700-bf17052714f6);
RemoveSurfaceLayer(S_SHA_PathOfDarknessTrial_GoalTrigger_b4df1e7b-7d4f-42d2-b599-e1dae0c0d15e, "Cloud", 6);

PROC
PROC_SHA_Trials_TrialPassed(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1, (ITEM)_Var1)
AND
DB_SHA_Trials_InvisiblePlatformsCandles(_Var1, _, _Var1, _Var1, _Var1)
AND
DB_LoopEffect(_Var1, _, "SHA_PathOfDarkness_WarningLight", _, _, _, _, _Var1, _Var1, _Var1)
THEN
PROC_StopLoopEffect(_Var1, "SHA_PathOfDarkness_WarningLight");

PROC
PROC_SHA_Trials_CustomTrialOutcome(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, _, _, _)
THEN
PROC_TriggerUnregisterForPlayers(S_SHA_PathOfDarknessTrial_GoalTrigger_b4df1e7b-7d4f-42d2-b599-e1dae0c0d15e);

IF
UseStarted((GUIDSTRING)_Var1, S_SHA_PathOfDarknessTrial_Goal_26c3ff42-4e78-4e4c-a700-bf17052714f6, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1, (GUIDSTRING)_Var1)
THEN
PROC_SHA_Trials_MagicTeleport(_Var1, S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a, S_SHA_PathOfDarknessTrial_Goal_26c3ff42-4e78-4e4c-a700-bf17052714f6);

IF
FlagSet(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, (INTEGER)_, (INTEGER)_)
THEN
NOT DB_SHA_Trials_AltDeathTriggerTeleport(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);

IF
FlagCleared(SHA_Trials_State_TrialInProgress_87772420-50d7-4937-85ec-95c42fd9fd14, S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, _, (INTEGER)_, (INTEGER)_)
THEN
DB_SHA_Trials_AltDeathTriggerTeleport(S_SHA_PathOfDarknessTrial_ff2af557-dbc2-4e27-9c02-f13b25dbe86e, S_SHA_PathOfDarknessTrial_DeathTriggerTP_000_6a28f53d-3819-4869-b961-fc564615962a);


EXITSECTION
ENDEXITSECTION

ParentTargetEdge "Act2"
